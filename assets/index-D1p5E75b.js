(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}})();function oo(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var Wi={exports:{}},ao=Wi.exports,gs;function lo(){return gs||(gs=1,(function(u){//! openseadragon 5.0.1
//! Built on 2024-12-09
//! Git commit: v5.0.1-0-480de92d
//! http://openseadragon.github.io
//! License: http://openseadragon.github.io/license/
function t(e){return new t.Viewer(e)}(function(e){e.version={versionStr:"5.0.1",major:parseInt("5",10),minor:parseInt("0",10),revision:parseInt("1",10)};var i={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object AsyncFunction]":"function","[object Promise]":"promise","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},r=Object.prototype.toString,s=Object.prototype.hasOwnProperty;e.isFunction=function(n){return e.type(n)==="function"},e.isArray=Array.isArray||function(n){return e.type(n)==="array"},e.isWindow=function(n){return n&&typeof n=="object"&&"setInterval"in n},e.type=function(n){return n==null?String(n):i[r.call(n)]||"object"},e.isPlainObject=function(n){if(!n||t.type(n)!=="object"||n.nodeType||e.isWindow(n)||n.constructor&&!s.call(n,"constructor")&&!s.call(n.constructor.prototype,"isPrototypeOf"))return!1;var o;for(var a in n)o=a;return o===void 0||s.call(n,o)},e.isEmptyObject=function(n){for(var o in n)return!1;return!0},e.freezeObject=function(n){return Object.freeze?e.freezeObject=Object.freeze:e.freezeObject=function(o){return o},e.freezeObject(n)},e.supportsCanvas=(function(){var n=document.createElement("canvas");return!!(e.isFunction(n.getContext)&&n.getContext("2d"))})(),e.isCanvasTainted=function(n){var o=!1;try{n.getContext("2d").getImageData(0,0,1,1)}catch{o=!0}return o},e.supportsAddEventListener=(function(){return!!(document.documentElement.addEventListener&&document.addEventListener)})(),e.supportsRemoveEventListener=(function(){return!!(document.documentElement.removeEventListener&&document.removeEventListener)})(),e.supportsEventListenerOptions=(function(){var n=0;if(e.supportsAddEventListener)try{var o={get capture(){return n++,!1},get once(){return n++,!1},get passive(){return n++,!1}};window.addEventListener("test",null,o),window.removeEventListener("test",null,o)}catch{n=0}return n>=3})(),e.getCurrentPixelDensityRatio=function(){if(e.supportsCanvas){var n=document.createElement("canvas").getContext("2d"),o=window.devicePixelRatio||1,a=n.webkitBackingStorePixelRatio||n.mozBackingStorePixelRatio||n.msBackingStorePixelRatio||n.oBackingStorePixelRatio||n.backingStorePixelRatio||1;return Math.max(o,1)/a}else return 1},e.pixelDensityRatio=e.getCurrentPixelDensityRatio()})(t),(function(e){e.extend=function(){var a,l,h,c,d,g,p=arguments[0]||{},v=arguments.length,w=!1,x=1;for(typeof p=="boolean"&&(w=p,p=arguments[1]||{},x=2),typeof p!="object"&&!t.isFunction(p)&&(p={}),v===x&&(p=this,--x);x<v;x++)if(a=arguments[x],a!==null||a!==void 0)for(l in a){var C=Object.getOwnPropertyDescriptor(a,l);if(C!==void 0){if(C.get||C.set){Object.defineProperty(p,l,C);continue}c=C.value}else{e.console.warn('Could not copy inherited property "'+l+'".');continue}p!==c&&(w&&c&&(t.isPlainObject(c)||(d=t.isArray(c)))?(h=p[l],d?(d=!1,g=h&&t.isArray(h)?h:[]):g=h&&t.isPlainObject(h)?h:{},p[l]=t.extend(w,g,c)):c!==void 0&&(p[l]=c))}return p};var i=function(){if(typeof navigator!="object")return!1;var a=navigator.userAgent;return typeof a!="string"?!1:a.indexOf("iPhone")!==-1||a.indexOf("iPad")!==-1||a.indexOf("iPod")!==-1};e.extend(e,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},splitHashDataForPost:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{dragToPan:!0,scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!1,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerDblClickDrag:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:i(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,maxTilesPerFrame:1,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorElement:null,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,overlayPreserveContentDirection:!0,opacity:1,compositeOperation:null,drawer:["webgl","canvas","html"],drawerOptions:{webgl:{},canvas:{},html:{},custom:{}},preload:!1,imageSmoothingEnabled:!0,placeholderFillStyle:null,subPixelRoundingForTransparency:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,tileRetryMax:0,tileRetryDelay:2500,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"],silenceMultiImageWarnings:!1},delegate:function(a,l){return function(){var h=arguments;return h===void 0&&(h=[]),l.apply(a,h)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5,EDGE:6,CHROMEEDGE:7},SUBPIXEL_ROUNDING_OCCURRENCES:{NEVER:0,ONLY_AT_REST:1,ALWAYS:2},_viewers:new Map,getViewer:function(a){return e._viewers.get(this.getElement(a))},getElement:function(a){return typeof a=="string"&&(a=document.getElementById(a)),a},getElementPosition:function(a){var l=new e.Point,h,c;for(a=e.getElement(a),h=e.getElementStyle(a).position==="fixed",c=o(a,h);c;)l.x+=a.offsetLeft,l.y+=a.offsetTop,h&&(l=l.plus(e.getPageScroll())),a=c,h=e.getElementStyle(a).position==="fixed",c=o(a,h);return l},getElementOffset:function(a){a=e.getElement(a);var l=a&&a.ownerDocument,h,c,d={top:0,left:0};return l?(h=l.documentElement,typeof a.getBoundingClientRect<"u"&&(d=a.getBoundingClientRect()),c=l===l.window?l:l.nodeType===9?l.defaultView||l.parentWindow:!1,new e.Point(d.left+(c.pageXOffset||h.scrollLeft)-(h.clientLeft||0),d.top+(c.pageYOffset||h.scrollTop)-(h.clientTop||0))):new e.Point},getElementSize:function(a){return a=e.getElement(a),new e.Point(a.clientWidth,a.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(a){return a=e.getElement(a),a.currentStyle}:function(a){return a=e.getElement(a),window.getComputedStyle(a,"")},getCssPropertyWithVendorPrefix:function(a){var l={};return e.getCssPropertyWithVendorPrefix=function(h){if(l[h]!==void 0)return l[h];var c=document.createElement("div").style,d=null;if(c[h]!==void 0)d=h;else for(var g=["Webkit","Moz","MS","O","webkit","moz","ms","o"],p=e.capitalizeFirstLetter(h),v=0;v<g.length;v++){var w=g[v]+p;if(c[w]!==void 0){d=w;break}}return l[h]=d,d},e.getCssPropertyWithVendorPrefix(a)},capitalizeFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},positiveModulo:function(a,l){var h=a%l;return h<0&&(h+=l),h},pointInElement:function(a,l){a=e.getElement(a);var h=e.getElementOffset(a),c=e.getElementSize(a);return l.x>=h.x&&l.x<h.x+c.x&&l.y<h.y+c.y&&l.y>=h.y},getMousePosition:function(a){if(typeof a.pageX=="number")e.getMousePosition=function(l){var h=new e.Point;return h.x=l.pageX,h.y=l.pageY,h};else if(typeof a.clientX=="number")e.getMousePosition=function(l){var h=new e.Point;return h.x=l.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,h.y=l.clientY+document.body.scrollTop+document.documentElement.scrollTop,h};else throw new Error("Unknown event mouse position, no known technique.");return e.getMousePosition(a)},getPageScroll:function(){var a=document.documentElement||{},l=document.body||{};if(typeof window.pageXOffset=="number")e.getPageScroll=function(){return new e.Point(window.pageXOffset,window.pageYOffset)};else if(l.scrollLeft||l.scrollTop)e.getPageScroll=function(){return new e.Point(document.body.scrollLeft,document.body.scrollTop)};else if(a.scrollLeft||a.scrollTop)e.getPageScroll=function(){return new e.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)};else return new e.Point(0,0);return e.getPageScroll()},setPageScroll:function(a){if(typeof window.scrollTo<"u")e.setPageScroll=function(c){window.scrollTo(c.x,c.y)};else{var l=e.getPageScroll();if(l.x===a.x&&l.y===a.y)return;document.body.scrollLeft=a.x,document.body.scrollTop=a.y;var h=e.getPageScroll();if(h.x!==l.x&&h.y!==l.y){e.setPageScroll=function(c){document.body.scrollLeft=c.x,document.body.scrollTop=c.y};return}if(document.documentElement.scrollLeft=a.x,document.documentElement.scrollTop=a.y,h=e.getPageScroll(),h.x!==l.x&&h.y!==l.y){e.setPageScroll=function(c){document.documentElement.scrollLeft=c.x,document.documentElement.scrollTop=c.y};return}e.setPageScroll=function(c){}}e.setPageScroll(a)},getWindowSize:function(){var a=document.documentElement||{},l=document.body||{};if(typeof window.innerWidth=="number")e.getWindowSize=function(){return new e.Point(window.innerWidth,window.innerHeight)};else if(a.clientWidth||a.clientHeight)e.getWindowSize=function(){return new e.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else if(l.clientWidth||l.clientHeight)e.getWindowSize=function(){return new e.Point(document.body.clientWidth,document.body.clientHeight)};else throw new Error("Unknown window size, no known technique.");return e.getWindowSize()},makeCenteredNode:function(a){a=e.getElement(a);var l=[e.makeNeutralElement("div"),e.makeNeutralElement("div"),e.makeNeutralElement("div")];return e.extend(l[0].style,{display:"table",height:"100%",width:"100%"}),e.extend(l[1].style,{display:"table-row"}),e.extend(l[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),l[0].appendChild(l[1]),l[1].appendChild(l[2]),l[2].appendChild(a),l[0]},makeNeutralElement:function(a){var l=document.createElement(a),h=l.style;return h.background="transparent none",h.border="none",h.margin="0px",h.padding="0px",h.position="static",l},now:function(){return Date.now?e.now=Date.now:e.now=function(){return new Date().getTime()},e.now()},makeTransparentImage:function(a){var l=e.makeNeutralElement("img");return l.src=a,l},setElementOpacity:function(a,l,h){var c,d;a=e.getElement(a),h&&!e.Browser.alpha&&(l=Math.round(l)),e.Browser.opacity?a.style.opacity=l<1?l:"":l<1?(c=Math.round(100*l),d="alpha(opacity="+c+")",a.style.filter=d):a.style.filter=""},setElementTouchActionNone:function(a){a=e.getElement(a),typeof a.style.touchAction<"u"?a.style.touchAction="none":typeof a.style.msTouchAction<"u"&&(a.style.msTouchAction="none")},setElementPointerEvents:function(a,l){a=e.getElement(a),typeof a.style<"u"&&typeof a.style.pointerEvents<"u"&&(a.style.pointerEvents=l)},setElementPointerEventsNone:function(a){e.setElementPointerEvents(a,"none")},addClass:function(a,l){a=e.getElement(a),a.className?(" "+a.className+" ").indexOf(" "+l+" ")===-1&&(a.className+=" "+l):a.className=l},indexOf:function(a,l,h){return Array.prototype.indexOf?this.indexOf=function(c,d,g){return c.indexOf(d,g)}:this.indexOf=function(c,d,g){var p,v=g||0,w;if(!c)throw new TypeError;if(w=c.length,w===0||v>=w)return-1;for(v<0&&(v=w-Math.abs(v)),p=v;p<w;p++)if(c[p]===d)return p;return-1},this.indexOf(a,l,h)},removeClass:function(a,l){var h,c=[],d;for(a=e.getElement(a),h=a.className.split(/\s+/),d=0;d<h.length;d++)h[d]&&h[d]!==l&&c.push(h[d]);a.className=c.join(" ")},normalizeEventListenerOptions:function(a){var l;return typeof a<"u"?typeof a=="boolean"?l=e.supportsEventListenerOptions?{capture:a}:a:l=e.supportsEventListenerOptions?a:typeof a.capture<"u"?a.capture:!1:l=e.supportsEventListenerOptions?{capture:!1}:!1,l},addEvent:(function(){if(e.supportsAddEventListener)return function(a,l,h,c){c=e.normalizeEventListenerOptions(c),a=e.getElement(a),a.addEventListener(l,h,c)};if(document.documentElement.attachEvent&&document.attachEvent)return function(a,l,h){a=e.getElement(a),a.attachEvent("on"+l,h)};throw new Error("No known event model.")})(),removeEvent:(function(){if(e.supportsRemoveEventListener)return function(a,l,h,c){c=e.normalizeEventListenerOptions(c),a=e.getElement(a),a.removeEventListener(l,h,c)};if(document.documentElement.detachEvent&&document.detachEvent)return function(a,l,h){a=e.getElement(a),a.detachEvent("on"+l,h)};throw new Error("No known event model.")})(),cancelEvent:function(a){a.preventDefault()},eventIsCanceled:function(a){return a.defaultPrevented},stopEvent:function(a){a.stopPropagation()},createCallback:function(a,l){console.error("The createCallback function is deprecated and will be removed in future versions. Please use alternativeFunction instead.");var h=[],c;for(c=2;c<arguments.length;c++)h.push(arguments[c]);return function(){var d=h.concat([]),g;for(g=0;g<arguments.length;g++)d.push(arguments[g]);return l.apply(a,d)}},getUrlParameter:function(a){var l=n[a];return l||null},getUrlProtocol:function(a){var l=a.match(/^([a-z]+:)\/\//i);return l===null?window.location.protocol:l[1].toLowerCase()},createAjaxRequest:function(){if(window.XMLHttpRequest)return e.createAjaxRequest=function(){return new XMLHttpRequest},new XMLHttpRequest;throw new Error("Browser doesn't support XMLHttpRequest.")},makeAjaxRequest:function(a,l,h){var c,d,g,p;e.isPlainObject(a)&&(l=a.success,h=a.error,c=a.withCredentials,d=a.headers,g=a.responseType||null,p=a.postData||null,a=a.url);var v=e.getUrlProtocol(a),w=e.createAjaxRequest();if(!e.isFunction(l))throw new Error("makeAjaxRequest requires a success callback");w.onreadystatechange=function(){w.readyState===4&&(w.onreadystatechange=function(){},w.status>=200&&w.status<300||w.status===0&&v!=="http:"&&v!=="https:"?l(w):e.isFunction(h)?h(w):e.console.error("AJAX request returned %d: %s",w.status,a))};var x=p?"POST":"GET";try{if(w.open(x,a,!0),g&&(w.responseType=g),d)for(var C in d)Object.prototype.hasOwnProperty.call(d,C)&&d[C]&&w.setRequestHeader(C,d[C]);c&&(w.withCredentials=!0),w.send(p)}catch(P){e.console.error("%s while making AJAX request: %s",P.name,P.message),w.onreadystatechange=function(){},e.isFunction(h)&&h(w,P)}return w},jsonp:function(a){var l,h=a.url,c=document.head||document.getElementsByTagName("head")[0]||document.documentElement,d=a.callbackName||"openseadragon"+e.now(),g=window[d],p="$1"+d+"$2",v=a.param||"callback",w=a.callback;h=h.replace(/(=)\?(&|$)|\?\?/i,p),h+=(/\?/.test(h)?"&":"?")+v+"="+d,window[d]=function(x){if(g)window[d]=g;else try{delete window[d]}catch{}w&&e.isFunction(w)&&w(x)},l=document.createElement("script"),(a.async!==void 0||a.async!==!1)&&(l.async="async"),a.scriptCharset&&(l.charset=a.scriptCharset),l.src=h,l.onload=l.onreadystatechange=function(x,C){(C||!l.readyState||/loaded|complete/.test(l.readyState))&&(l.onload=l.onreadystatechange=null,c&&l.parentNode&&c.removeChild(l),l=void 0)},c.insertBefore(l,c.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(a){if(window.DOMParser)e.parseXml=function(l){var h=null,c;return c=new DOMParser,h=c.parseFromString(l,"text/xml"),h};else throw new Error("Browser doesn't support XML DOM.");return e.parseXml(a)},parseJSON:function(a){return e.parseJSON=window.JSON.parse,e.parseJSON(a)},imageFormatSupported:function(a){return a=a||"",!!s[a.toLowerCase()]},setImageFormatsSupported:function(a){e.extend(s,a)}});var r=function(a){};e.console=window.console||{log:r,debug:r,info:r,warn:r,error:r,assert:r},e.Browser={vendor:e.BROWSERS.UNKNOWN,version:0,alpha:!0};var s={avif:!0,bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1,webp:!0},n={};(function(){var a=navigator.appVersion,l=navigator.userAgent,h;switch(navigator.appName){case"Microsoft Internet Explorer":window.attachEvent&&window.ActiveXObject&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(l.substring(l.indexOf("MSIE")+5,l.indexOf(";",l.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(l.indexOf("Edge")>=0?(e.Browser.vendor=e.BROWSERS.EDGE,e.Browser.version=parseFloat(l.substring(l.indexOf("Edge")+5))):l.indexOf("Edg")>=0?(e.Browser.vendor=e.BROWSERS.CHROMEEDGE,e.Browser.version=parseFloat(l.substring(l.indexOf("Edg")+4))):l.indexOf("Firefox")>=0?(e.Browser.vendor=e.BROWSERS.FIREFOX,e.Browser.version=parseFloat(l.substring(l.indexOf("Firefox")+8))):l.indexOf("Safari")>=0?(e.Browser.vendor=l.indexOf("Chrome")>=0?e.BROWSERS.CHROME:e.BROWSERS.SAFARI,e.Browser.version=parseFloat(l.substring(l.substring(0,l.indexOf("Safari")).lastIndexOf("/")+1,l.indexOf("Safari")))):(h=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),h.exec(l)!==null&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(RegExp.$1))));break;case"Opera":e.Browser.vendor=e.BROWSERS.OPERA,e.Browser.version=parseFloat(a);break}var c=window.location.search.substring(1),d=c.split("&"),g,p,v;for(v=0;v<d.length;v++)if(g=d[v],p=g.indexOf("="),p>0){var w=g.substring(0,p),x=g.substring(p+1);try{n[w]=decodeURIComponent(x)}catch{e.console.error("Ignoring malformed URL parameter: %s=%s",w,x)}}e.Browser.alpha=!(e.Browser.vendor===e.BROWSERS.CHROME&&e.Browser.version<2),e.Browser.opacity=!0,e.Browser.vendor===e.BROWSERS.IE&&e.console.error("Internet Explorer is not supported by OpenSeadragon")})(),(function(a){var l=a.requestAnimationFrame||a.mozRequestAnimationFrame||a.webkitRequestAnimationFrame||a.msRequestAnimationFrame,h=a.cancelAnimationFrame||a.mozCancelAnimationFrame||a.webkitCancelAnimationFrame||a.msCancelAnimationFrame;if(l&&h)e.requestAnimationFrame=function(){return l.apply(a,arguments)},e.cancelAnimationFrame=function(){return h.apply(a,arguments)};else{var c=[],d=[],g=0,p;e.requestAnimationFrame=function(v){return c.push([++g,v]),p||(p=setInterval(function(){if(c.length){var w=e.now(),x=d;for(d=c,c=x;d.length;)d.shift()[1](w)}else clearInterval(p),p=void 0},1e3/50)),g},e.cancelAnimationFrame=function(v){var w,x;for(w=0,x=c.length;w<x;w+=1)if(c[w][0]===v){c.splice(w,1);return}for(w=0,x=d.length;w<x;w+=1)if(d[w][0]===v){d.splice(w,1);return}}}})(window);function o(a,l){return l&&a!==document.body?document.body:a.offsetParent}})(t),(function(e,i){u.exports?u.exports=i():e.OpenSeadragon=i()})(ao,function(){return t}),(function(e){class i{constructor(s){s||(s=[0,0,0,0,0,0,0,0,0]),this.values=s}static makeIdentity(){return new i([1,0,0,0,1,0,0,0,1])}static makeTranslation(s,n){return new i([1,0,0,0,1,0,s,n,1])}static makeRotation(s){var n=Math.cos(s),o=Math.sin(s);return new i([n,-o,0,o,n,0,0,0,1])}static makeScaling(s,n){return new i([s,0,0,0,n,0,0,0,1])}multiply(s){let n=this.values,o=s.values;var a=n[0],l=n[1],h=n[2],c=n[3],d=n[4],g=n[5],p=n[6],v=n[7],w=n[8],x=o[0],C=o[1],P=o[2],k=o[3],R=o[4],A=o[5],j=o[6],I=o[7],W=o[8];return new i([x*a+C*c+P*p,x*l+C*d+P*v,x*h+C*g+P*w,k*a+R*c+A*p,k*l+R*d+A*v,k*h+R*g+A*w,j*a+I*c+W*p,j*l+I*d+W*v,j*h+I*g+W*w])}}e.Mat3=i})(t),(function(e){var i={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};document.exitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.fullscreenElement},i.requestFullScreen=function(r){return r.requestFullscreen().catch(function(s){e.console.error("Fullscreen request failed: ",s)})},i.exitFullScreen=function(){document.exitFullscreen().catch(function(r){e.console.error("Error while exiting fullscreen: ",r)})},i.fullScreenEventName="fullscreenchange",i.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.msFullscreenElement},i.requestFullScreen=function(r){return r.msRequestFullscreen()},i.exitFullScreen=function(){document.msExitFullscreen()},i.fullScreenEventName="MSFullscreenChange",i.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitFullscreenElement},i.requestFullScreen=function(r){return r.webkitRequestFullscreen()},i.exitFullScreen=function(){document.webkitExitFullscreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},i.requestFullScreen=function(r){return r.webkitRequestFullScreen()},i.exitFullScreen=function(){document.webkitCancelFullScreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.mozFullScreenElement},i.requestFullScreen=function(r){return r.mozRequestFullScreen()},i.exitFullScreen=function(){document.mozCancelFullScreen()},i.fullScreenEventName="mozfullscreenchange",i.fullScreenErrorEventName="mozfullscreenerror"),i.isFullScreen=function(){return i.getFullScreenElement()!==null},i.cancelFullScreen=function(){e.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),i.exitFullScreen()},e.extend(e,i)})(t),(function(e){e.EventSource=function(){this.events={},this._rejectedEventList={}},e.EventSource.prototype={addOnceHandler:function(i,r,s,n,o){var a=this;n=n||1;var l=0,h=function(c){return l++,l===n&&a.removeHandler(i,h),r(c)};return this.addHandler(i,h,s,o)},addHandler:function(i,r,s,n){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var o=this.events[i];if(o||(this.events[i]=o=[]),r&&e.isFunction(r)){var a=o.length,l={handler:r,userData:s||null,priority:n||0};for(o[a]=l;a>0&&o[a-1].priority<o[a].priority;)o[a]=o[a-1],o[a-1]=l,a--}return!0},removeHandler:function(i,r){var s=this.events[i],n=[],o;if(s&&e.isArray(s)){for(o=0;o<s.length;o++)s[o].handler!==r&&n.push(s[o]);this.events[i]=n}},numberOfHandlers:function(i){var r=this.events[i];return r?r.length:0},removeAllHandlers:function(i){if(i)this.events[i]=[];else for(var r in this.events)this.events[r]=[]},getHandler:function(i){var r=this.events[i];return!r||!r.length?null:(r=r.length===1?[r[0]]:Array.apply(null,r),function(s,n){var o,a=r.length;for(o=0;o<a;o++)r[o]&&(n.eventSource=s,n.userData=r[o].userData,r[o].handler(n))})},raiseEvent:function(i,r){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var s=this.getHandler(i);return s&&s(this,r||{}),!0},rejectEventHandler(i,r=""){this._rejectedEventList[i]=r},allowEventHandler(i){delete this._rejectedEventList[i]}}})(t),(function(e){var i={};e.MouseTracker=function(y){var m=arguments;e.isPlainObject(y)||(y={element:m[0],clickTimeThreshold:m[1],clickDistThreshold:m[2]}),this.hash=Math.random(),this.element=e.getElement(y.element),this.clickTimeThreshold=y.clickTimeThreshold||e.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=y.clickDistThreshold||e.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=y.dblClickTimeThreshold||e.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=y.dblClickDistThreshold||e.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=y.userData||null,this.stopDelay=y.stopDelay||50,this.preProcessEventHandler=y.preProcessEventHandler||null,this.contextMenuHandler=y.contextMenuHandler||null,this.enterHandler=y.enterHandler||null,this.leaveHandler=y.leaveHandler||null,this.exitHandler=y.exitHandler||null,this.overHandler=y.overHandler||null,this.outHandler=y.outHandler||null,this.pressHandler=y.pressHandler||null,this.nonPrimaryPressHandler=y.nonPrimaryPressHandler||null,this.releaseHandler=y.releaseHandler||null,this.nonPrimaryReleaseHandler=y.nonPrimaryReleaseHandler||null,this.moveHandler=y.moveHandler||null,this.scrollHandler=y.scrollHandler||null,this.clickHandler=y.clickHandler||null,this.dblClickHandler=y.dblClickHandler||null,this.dragHandler=y.dragHandler||null,this.dragEndHandler=y.dragEndHandler||null,this.pinchHandler=y.pinchHandler||null,this.stopHandler=y.stopHandler||null,this.keyDownHandler=y.keyDownHandler||null,this.keyUpHandler=y.keyUpHandler||null,this.keyHandler=y.keyHandler||null,this.focusHandler=y.focusHandler||null,this.blurHandler=y.blurHandler||null;var _=this;i[this.hash]={click:function(S){P(_,S)},dblclick:function(S){k(_,S)},keydown:function(S){R(_,S)},keyup:function(S){A(_,S)},keypress:function(S){j(_,S)},focus:function(S){I(_,S)},blur:function(S){W(_,S)},contextmenu:function(S){$(_,S)},wheel:function(S){Z(_,S)},mousewheel:function(S){z(_,S)},DOMMouseScroll:function(S){z(_,S)},MozMousePixelScroll:function(S){z(_,S)},losecapture:function(S){Y(_,S)},mouseenter:function(S){q(_,S)},mouseleave:function(S){ke(_,S)},mouseover:function(S){tt(_,S)},mouseout:function(S){Be(_,S)},mousedown:function(S){Ie(_,S)},mouseup:function(S){kt(_,S)},mousemove:function(S){pi(_,S)},touchstart:function(S){ie(_,S)},touchend:function(S){te(_,S)},touchmove:function(S){se(_,S)},touchcancel:function(S){Q(_,S)},gesturestart:function(S){me(_,S)},gesturechange:function(S){xe(_,S)},gotpointercapture:function(S){pt(_,S)},lostpointercapture:function(S){_t(_,S)},pointerenter:function(S){q(_,S)},pointerleave:function(S){ke(_,S)},pointerover:function(S){tt(_,S)},pointerout:function(S){Be(_,S)},pointerdown:function(S){Ie(_,S)},pointerup:function(S){kt(_,S)},pointermove:function(S){pi(_,S)},pointercancel:function(S){wr(_,S)},pointerupcaptured:function(S){Tt(_,S)},pointermovecaptured:function(S){yr(_,S)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null,sentDragEvent:!1},this.hasGestureHandlers=!!(this.pressHandler||this.nonPrimaryPressHandler||this.releaseHandler||this.nonPrimaryReleaseHandler||this.clickHandler||this.dblClickHandler||this.dragHandler||this.dragEndHandler||this.pinchHandler),this.hasScrollHandler=!!this.scrollHandler,e.MouseTracker.havePointerEvents&&e.setElementPointerEvents(this.element,"auto"),this.exitHandler&&e.console.error("MouseTracker.exitHandler is deprecated. Use MouseTracker.leaveHandler instead."),y.startDisabled||this.setTracking(!0)},e.MouseTracker.prototype={destroy:function(){a(this),this.element=null,i[this.hash]=null,delete i[this.hash]},isTracking:function(){return i[this.hash].tracking},setTracking:function(y){return y?o(this):a(this),this},getActivePointersListByType:function(y){var m=i[this.hash],_,S=m?m.activePointersLists.length:0,M;for(_=0;_<S;_++)if(m.activePointersLists[_].type===y)return m.activePointersLists[_];return M=new e.MouseTracker.GesturePointList(y),m&&m.activePointersLists.push(M),M},getActivePointerCount:function(){var y=i[this.hash],m,_=y.activePointersLists.length,S=0;for(m=0;m<_;m++)S+=y.activePointersLists[m].getLength();return S},preProcessEventHandler:function(){},contextMenuHandler:function(){},enterHandler:function(){},leaveHandler:function(){},exitHandler:function(){},overHandler:function(){},outHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}};var r=(function(){try{return window.self!==window.top}catch{return!0}})();function s(y){try{return y.addEventListener&&y.removeEventListener}catch{return!1}}e.MouseTracker.gesturePointVelocityTracker=(function(){var y=[],m=0,_=0,S=function(ae,X){return ae.hash.toString()+X.type+X.id.toString()},M=function(){var ae,X=y.length,Ae,_e,At=e.now(),cs,us,ds;for(cs=At-_,_=At,ae=0;ae<X;ae++)Ae=y[ae],_e=Ae.gPoint,_e.direction=Math.atan2(_e.currentPos.y-Ae.lastPos.y,_e.currentPos.x-Ae.lastPos.x),us=Ae.lastPos.distanceTo(_e.currentPos),Ae.lastPos=_e.currentPos,ds=1e3*us/(cs+1),_e.speed=.75*ds+.25*_e.speed},B=function(ae,X){var Ae=S(ae,X);y.push({guid:Ae,gPoint:X,lastPos:X.currentPos}),y.length===1&&(_=e.now(),m=window.setInterval(M,50))},G=function(ae,X){var Ae=S(ae,X),_e,At=y.length;for(_e=0;_e<At;_e++)if(y[_e].guid===Ae){y.splice(_e,1),At--,At===0&&window.clearInterval(m);break}};return{addPoint:B,removePoint:G}})(),e.MouseTracker.captureElement=document,e.MouseTracker.wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll",e.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur","contextmenu",e.MouseTracker.wheelEventName],e.MouseTracker.wheelEventName==="DOMMouseScroll"&&e.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent?(e.MouseTracker.havePointerEvents=!0,e.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),e.MouseTracker.havePointerCapture=(function(){var y=document.createElement("div");return e.isFunction(y.setPointerCapture)&&e.isFunction(y.releasePointerCapture)})(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("gotpointercapture","lostpointercapture")):(e.MouseTracker.havePointerEvents=!1,e.MouseTracker.subscribeEvents.push("mouseenter","mouseleave","mouseover","mouseout","mousedown","mouseup","mousemove"),e.MouseTracker.mousePointerId="legacy-mouse",e.MouseTracker.havePointerCapture=(function(){var y=document.createElement("div");return e.isFunction(y.setCapture)&&e.isFunction(y.releaseCapture)})(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("losecapture"),"ontouchstart"in window&&e.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&e.MouseTracker.subscribeEvents.push("gesturestart","gesturechange")),e.MouseTracker.GesturePointList=function(y){this._gPoints=[],this.type=y,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},e.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(y){return this._gPoints.push(y)},removeById:function(y){var m,_=this._gPoints.length;for(m=0;m<_;m++)if(this._gPoints[m].id===y){this._gPoints.splice(m,1);break}return this._gPoints.length},getByIndex:function(y){return y<this._gPoints.length?this._gPoints[y]:null},getById:function(y){var m,_=this._gPoints.length;for(m=0;m<_;m++)if(this._gPoints[m].id===y)return this._gPoints[m];return null},getPrimary:function(y){var m,_=this._gPoints.length;for(m=0;m<_;m++)if(this._gPoints[m].isPrimary)return this._gPoints[m];return null},addContact:function(){++this.contacts,this.contacts>1&&(this.type==="mouse"||this.type==="pen")&&(e.console.warn("GesturePointList.addContact() Implausible contacts value"),this.contacts=1)},removeContact:function(){--this.contacts,this.contacts<0&&(this.contacts=0)}};function n(y){var m=i[y.hash],_,S,M,B,G,ae=m.activePointersLists.length;for(_=0;_<ae;_++)if(M=m.activePointersLists[_],M.getLength()>0){for(G=[],B=M.asArray(),S=0;S<B.length;S++)G.push(B[S]);for(S=0;S<G.length;S++)Ft(y,M,G[S])}for(_=0;_<ae;_++)m.activePointersLists.pop();m.sentDragEvent=!1}function o(y){var m=i[y.hash],_,S;if(!m.tracking){for(S=0;S<e.MouseTracker.subscribeEvents.length;S++)_=e.MouseTracker.subscribeEvents[S],e.addEvent(y.element,_,m[_],_===e.MouseTracker.wheelEventName?{passive:!1,capture:!1}:!1);n(y),m.tracking=!0}}function a(y){var m=i[y.hash],_,S;if(m.tracking){for(S=0;S<e.MouseTracker.subscribeEvents.length;S++)_=e.MouseTracker.subscribeEvents[S],e.removeEvent(y.element,_,m[_],!1);n(y),m.tracking=!1}}function l(y,m){var _=i[y.hash];if(m==="pointerevent")return{upName:"pointerup",upHandler:_.pointerupcaptured,moveName:"pointermove",moveHandler:_.pointermovecaptured};if(m==="mouse")return{upName:"pointerup",upHandler:_.pointerupcaptured,moveName:"pointermove",moveHandler:_.pointermovecaptured};if(m==="touch")return{upName:"touchend",upHandler:_.touchendcaptured,moveName:"touchmove",moveHandler:_.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function h(y,m){var _;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents)try{y.element.setPointerCapture(m.id)}catch{e.console.warn("setPointerCapture() called on invalid pointer ID");return}else y.element.setCapture(!0);else _=l(y,e.MouseTracker.havePointerEvents?"pointerevent":m.type),r&&s(window.top)&&e.addEvent(window.top,_.upName,_.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,_.upName,_.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,_.moveName,_.moveHandler,!0);D(y,m,!0)}function c(y,m){var _,S,M;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents){if(S=y.getActivePointersListByType(m.type),M=S.getById(m.id),!M||!M.captured)return;try{y.element.releasePointerCapture(m.id)}catch{}}else y.element.releaseCapture();else _=l(y,e.MouseTracker.havePointerEvents?"pointerevent":m.type),r&&s(window.top)&&e.removeEvent(window.top,_.upName,_.upHandler,!0),e.removeEvent(e.MouseTracker.captureElement,_.moveName,_.moveHandler,!0),e.removeEvent(e.MouseTracker.captureElement,_.upName,_.upHandler,!0);D(y,m,!1)}function d(y){return e.MouseTracker.havePointerEvents?y.pointerId:e.MouseTracker.mousePointerId}function g(y){return e.MouseTracker.havePointerEvents&&y.pointerType?y.pointerType:"mouse"}function p(y){return e.MouseTracker.havePointerEvents?y.isPrimary:!0}function v(y){return e.getMousePosition(y)}function w(y,m){return x(v(y),m)}function x(y,m){var _=e.getElementOffset(m);return y.minus(_)}function C(y,m){return new e.Point((y.x+m.x)/2,(y.y+m.y)/2)}function P(y,m){var _={originalEvent:m,eventType:"click",pointerType:"mouse",isEmulated:!1};T(y,_),_.preventDefault&&!_.defaultPrevented&&e.cancelEvent(m),_.stopPropagation&&e.stopEvent(m)}function k(y,m){var _={originalEvent:m,eventType:"dblclick",pointerType:"mouse",isEmulated:!1};T(y,_),_.preventDefault&&!_.defaultPrevented&&e.cancelEvent(m),_.stopPropagation&&e.stopEvent(m)}function R(y,m){var _=null,S={originalEvent:m,eventType:"keydown",pointerType:"",isEmulated:!1};T(y,S),y.keyDownHandler&&!S.preventGesture&&!S.defaultPrevented&&(_={eventSource:y,keyCode:m.keyCode?m.keyCode:m.charCode,ctrl:m.ctrlKey,shift:m.shiftKey,alt:m.altKey,meta:m.metaKey,originalEvent:m,preventDefault:S.preventDefault||S.defaultPrevented,userData:y.userData},y.keyDownHandler(_)),(_&&_.preventDefault||S.preventDefault&&!S.defaultPrevented)&&e.cancelEvent(m),S.stopPropagation&&e.stopEvent(m)}function A(y,m){var _=null,S={originalEvent:m,eventType:"keyup",pointerType:"",isEmulated:!1};T(y,S),y.keyUpHandler&&!S.preventGesture&&!S.defaultPrevented&&(_={eventSource:y,keyCode:m.keyCode?m.keyCode:m.charCode,ctrl:m.ctrlKey,shift:m.shiftKey,alt:m.altKey,meta:m.metaKey,originalEvent:m,preventDefault:S.preventDefault||S.defaultPrevented,userData:y.userData},y.keyUpHandler(_)),(_&&_.preventDefault||S.preventDefault&&!S.defaultPrevented)&&e.cancelEvent(m),S.stopPropagation&&e.stopEvent(m)}function j(y,m){var _=null,S={originalEvent:m,eventType:"keypress",pointerType:"",isEmulated:!1};T(y,S),y.keyHandler&&!S.preventGesture&&!S.defaultPrevented&&(_={eventSource:y,keyCode:m.keyCode?m.keyCode:m.charCode,ctrl:m.ctrlKey,shift:m.shiftKey,alt:m.altKey,meta:m.metaKey,originalEvent:m,preventDefault:S.preventDefault||S.defaultPrevented,userData:y.userData},y.keyHandler(_)),(_&&_.preventDefault||S.preventDefault&&!S.defaultPrevented)&&e.cancelEvent(m),S.stopPropagation&&e.stopEvent(m)}function I(y,m){var _={originalEvent:m,eventType:"focus",pointerType:"",isEmulated:!1};T(y,_),y.focusHandler&&!_.preventGesture&&y.focusHandler({eventSource:y,originalEvent:m,userData:y.userData})}function W(y,m){var _={originalEvent:m,eventType:"blur",pointerType:"",isEmulated:!1};T(y,_),y.blurHandler&&!_.preventGesture&&y.blurHandler({eventSource:y,originalEvent:m,userData:y.userData})}function $(y,m){var _=null,S={originalEvent:m,eventType:"contextmenu",pointerType:"mouse",isEmulated:!1};T(y,S),y.contextMenuHandler&&!S.preventGesture&&!S.defaultPrevented&&(_={eventSource:y,position:x(v(m),y.element),originalEvent:S.originalEvent,preventDefault:S.preventDefault||S.defaultPrevented,userData:y.userData},y.contextMenuHandler(_)),(_&&_.preventDefault||S.preventDefault&&!S.defaultPrevented)&&e.cancelEvent(m),S.stopPropagation&&e.stopEvent(m)}function Z(y,m){V(y,m,m)}function z(y,m){var _={target:m.target||m.srcElement,type:"wheel",shiftKey:m.shiftKey||!1,clientX:m.clientX,clientY:m.clientY,pageX:m.pageX?m.pageX:m.clientX,pageY:m.pageY?m.pageY:m.clientY,deltaMode:m.type==="MozMousePixelScroll"?0:1,deltaX:0,deltaZ:0};e.MouseTracker.wheelEventName==="mousewheel"?_.deltaY=-m.wheelDelta/e.DEFAULT_SETTINGS.pixelsPerWheelLine:_.deltaY=m.detail,V(y,_,m)}function V(y,m,_){var S=0,M,B=null;S=m.deltaY?m.deltaY<0?1:-1:0,M={originalEvent:m,eventType:"wheel",pointerType:"mouse",isEmulated:m!==_},T(y,M),y.scrollHandler&&!M.preventGesture&&!M.defaultPrevented&&(B={eventSource:y,pointerType:"mouse",position:w(m,y.element),scroll:S,shift:m.shiftKey,isTouchEvent:!1,originalEvent:_,preventDefault:M.preventDefault||M.defaultPrevented,userData:y.userData},y.scrollHandler(B)),M.stopPropagation&&e.stopEvent(_),(B&&B.preventDefault||M.preventDefault&&!M.defaultPrevented)&&e.cancelEvent(_)}function Y(y,m){var _={id:e.MouseTracker.mousePointerId,type:"mouse"},S={originalEvent:m,eventType:"lostpointercapture",pointerType:"mouse",isEmulated:!1};T(y,S),m.target===y.element&&D(y,_,!1),S.stopPropagation&&e.stopEvent(m)}function ie(y,m){var _,S,M=m.changedTouches.length,B,G=y.getActivePointersListByType("touch");_=e.now(),G.getLength()>m.touches.length-M&&e.console.warn("Tracked touch contact count doesn't match event.touches.length");var ae={originalEvent:m,eventType:"pointerdown",pointerType:"touch",isEmulated:!1};for(T(y,ae),S=0;S<M;S++)B={id:m.changedTouches[S].identifier,type:"touch",isPrimary:G.getLength()===0,currentPos:v(m.changedTouches[S]),currentTime:_},L(y,ae,B),K(y,ae,B,0),D(y,B,!0);ae.preventDefault&&!ae.defaultPrevented&&e.cancelEvent(m),ae.stopPropagation&&e.stopEvent(m)}function te(y,m){var _,S,M=m.changedTouches.length,B;_=e.now();var G={originalEvent:m,eventType:"pointerup",pointerType:"touch",isEmulated:!1};for(T(y,G),S=0;S<M;S++)B={id:m.changedTouches[S].identifier,type:"touch",currentPos:v(m.changedTouches[S]),currentTime:_},ne(y,G,B,0),D(y,B,!1),H(y,G,B);G.preventDefault&&!G.defaultPrevented&&e.cancelEvent(m),G.stopPropagation&&e.stopEvent(m)}function se(y,m){var _,S,M=m.changedTouches.length,B;_=e.now();var G={originalEvent:m,eventType:"pointermove",pointerType:"touch",isEmulated:!1};for(T(y,G),S=0;S<M;S++)B={id:m.changedTouches[S].identifier,type:"touch",currentPos:v(m.changedTouches[S]),currentTime:_},ce(y,G,B);G.preventDefault&&!G.defaultPrevented&&e.cancelEvent(m),G.stopPropagation&&e.stopEvent(m)}function Q(y,m){var _=m.changedTouches.length,S,M,B={originalEvent:m,eventType:"pointercancel",pointerType:"touch",isEmulated:!1};for(T(y,B),S=0;S<_;S++)M={id:m.changedTouches[S].identifier,type:"touch"},J(y,B,M);B.stopPropagation&&e.stopEvent(m)}function me(y,m){return e.eventIsCanceled(m)||m.preventDefault(),!1}function xe(y,m){return e.eventIsCanceled(m)||m.preventDefault(),!1}function pt(y,m){var _={originalEvent:m,eventType:"gotpointercapture",pointerType:g(m),isEmulated:!1};T(y,_),m.target===y.element&&D(y,{id:m.pointerId,type:g(m)},!0),_.stopPropagation&&e.stopEvent(m)}function _t(y,m){var _={originalEvent:m,eventType:"lostpointercapture",pointerType:g(m),isEmulated:!1};T(y,_),m.target===y.element&&D(y,{id:m.pointerId,type:g(m)},!1),_.stopPropagation&&e.stopEvent(m)}function q(y,m){var _={id:d(m),type:g(m),isPrimary:p(m),currentPos:v(m),currentTime:e.now()},S={originalEvent:m,eventType:"pointerenter",pointerType:_.type,isEmulated:!1};T(y,S),L(y,S,_)}function ke(y,m){var _={id:d(m),type:g(m),isPrimary:p(m),currentPos:v(m),currentTime:e.now()},S={originalEvent:m,eventType:"pointerleave",pointerType:_.type,isEmulated:!1};T(y,S),H(y,S,_)}function tt(y,m){var _={id:d(m),type:g(m),isPrimary:p(m),currentPos:v(m),currentTime:e.now()},S={originalEvent:m,eventType:"pointerover",pointerType:_.type,isEmulated:!1};T(y,S),U(y,S,_),S.preventDefault&&!S.defaultPrevented&&e.cancelEvent(m),S.stopPropagation&&e.stopEvent(m)}function Be(y,m){var _={id:d(m),type:g(m),isPrimary:p(m),currentPos:v(m),currentTime:e.now()},S={originalEvent:m,eventType:"pointerout",pointerType:_.type,isEmulated:!1};T(y,S),F(y,S,_),S.preventDefault&&!S.defaultPrevented&&e.cancelEvent(m),S.stopPropagation&&e.stopEvent(m)}function Ie(y,m){var _={id:d(m),type:g(m),isPrimary:p(m),currentPos:v(m),currentTime:e.now()},S=e.MouseTracker.havePointerEvents&&_.type==="touch",M={originalEvent:m,eventType:"pointerdown",pointerType:_.type,isEmulated:!1};T(y,M),K(y,M,_,m.button),M.preventDefault&&!M.defaultPrevented&&e.cancelEvent(m),M.stopPropagation&&e.stopEvent(m),M.shouldCapture&&(S?D(y,_,!0):h(y,_))}function kt(y,m){Fe(y,m)}function Tt(y,m){var _=y.getActivePointersListByType(g(m));_.getById(m.pointerId)&&Fe(y,m),e.stopEvent(m)}function Fe(y,m){var _;_={id:d(m),type:g(m),isPrimary:p(m),currentPos:v(m),currentTime:e.now()};var S={originalEvent:m,eventType:"pointerup",pointerType:_.type,isEmulated:!1};T(y,S),ne(y,S,_,m.button),S.preventDefault&&!S.defaultPrevented&&e.cancelEvent(m),S.stopPropagation&&e.stopEvent(m),S.shouldReleaseCapture&&(m.target===y.element?c(y,_):D(y,_,!1))}function pi(y,m){mi(y,m)}function yr(y,m){var _=y.getActivePointersListByType(g(m));_.getById(m.pointerId)&&mi(y,m),e.stopEvent(m)}function mi(y,m){var _={id:d(m),type:g(m),isPrimary:p(m),currentPos:v(m),currentTime:e.now()},S={originalEvent:m,eventType:"pointermove",pointerType:_.type,isEmulated:!1};T(y,S),ce(y,S,_),S.preventDefault&&!S.defaultPrevented&&e.cancelEvent(m),S.stopPropagation&&e.stopEvent(m)}function wr(y,m){var _={id:m.pointerId,type:g(m)},S={originalEvent:m,eventType:"pointercancel",pointerType:_.type,isEmulated:!1};T(y,S),J(y,S,_),S.stopPropagation&&e.stopEvent(m)}function Qt(y,m){return m.speed=0,m.direction=0,m.contactPos=m.currentPos,m.contactTime=m.currentTime,m.lastPos=m.currentPos,m.lastTime=m.currentTime,y.add(m)}function Ft(y,m,_){var S,M=m.getById(_.id);return M?(M.captured&&(e.console.warn("stopTrackingPointer() called on captured pointer"),c(y,M)),m.removeContact(),S=m.removeById(_.id)):S=m.getLength(),S}function f(y,m){switch(m.eventType){case"pointermove":m.isStoppable=!0,m.isCancelable=!0,m.preventDefault=!1,m.preventGesture=!y.hasGestureHandlers,m.stopPropagation=!1;break;case"pointerover":case"pointerout":case"contextmenu":case"keydown":case"keyup":case"keypress":m.isStoppable=!0,m.isCancelable=!0,m.preventDefault=!1,m.preventGesture=!1,m.stopPropagation=!1;break;case"pointerdown":m.isStoppable=!0,m.isCancelable=!0,m.preventDefault=!1,m.preventGesture=!y.hasGestureHandlers,m.stopPropagation=!1;break;case"pointerup":m.isStoppable=!0,m.isCancelable=!0,m.preventDefault=!1,m.preventGesture=!y.hasGestureHandlers,m.stopPropagation=!1;break;case"wheel":m.isStoppable=!0,m.isCancelable=!0,m.preventDefault=!1,m.preventGesture=!y.hasScrollHandler,m.stopPropagation=!1;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":m.isStoppable=!0,m.isCancelable=!1,m.preventDefault=!1,m.preventGesture=!1,m.stopPropagation=!1;break;case"click":m.isStoppable=!0,m.isCancelable=!0,m.preventDefault=!!y.clickHandler,m.preventGesture=!1,m.stopPropagation=!1;break;case"dblclick":m.isStoppable=!0,m.isCancelable=!0,m.preventDefault=!!y.dblClickHandler,m.preventGesture=!1,m.stopPropagation=!1;break;case"focus":case"blur":case"pointerenter":case"pointerleave":default:m.isStoppable=!1,m.isCancelable=!1,m.preventDefault=!1,m.preventGesture=!1,m.stopPropagation=!1;break}}function T(y,m){m.eventSource=y,m.eventPhase=m.originalEvent&&typeof m.originalEvent.eventPhase<"u"?m.originalEvent.eventPhase:0,m.defaultPrevented=e.eventIsCanceled(m.originalEvent),m.shouldCapture=!1,m.shouldReleaseCapture=!1,m.userData=y.userData,f(y,m),y.preProcessEventHandler&&y.preProcessEventHandler(m)}function D(y,m,_){var S=y.getActivePointersListByType(m.type),M=S.getById(m.id);M?_&&!M.captured?(M.captured=!0,S.captureCount++):!_&&M.captured&&(M.captured=!1,S.captureCount--,S.captureCount<0&&(S.captureCount=0,e.console.warn("updatePointerCaptured() - pointsList.captureCount went negative"))):e.console.warn("updatePointerCaptured() called on untracked pointer")}function L(y,m,_){var S=y.getActivePointersListByType(_.type),M;M=S.getById(_.id),M?(M.insideElement=!0,M.lastPos=M.currentPos,M.lastTime=M.currentTime,M.currentPos=_.currentPos,M.currentTime=_.currentTime,_=M):(_.captured=!1,_.insideElementPressed=!1,_.insideElement=!0,Qt(S,_)),y.enterHandler&&y.enterHandler({eventSource:y,pointerType:_.type,position:x(_.currentPos,y.element),buttons:S.buttons,pointers:y.getActivePointerCount(),insideElementPressed:_.insideElementPressed,buttonDownAny:S.buttons!==0,isTouchEvent:_.type==="touch",originalEvent:m.originalEvent,userData:y.userData})}function H(y,m,_){var S=y.getActivePointersListByType(_.type),M,B;M=S.getById(_.id),M?(M.captured?(M.insideElement=!1,M.lastPos=M.currentPos,M.lastTime=M.currentTime,M.currentPos=_.currentPos,M.currentTime=_.currentTime):Ft(y,S,M),_=M):(_.captured=!1,_.insideElementPressed=!1),(y.leaveHandler||y.exitHandler)&&(B={eventSource:y,pointerType:_.type,position:_.currentPos&&x(_.currentPos,y.element),buttons:S.buttons,pointers:y.getActivePointerCount(),insideElementPressed:_.insideElementPressed,buttonDownAny:S.buttons!==0,isTouchEvent:_.type==="touch",originalEvent:m.originalEvent,userData:y.userData},y.leaveHandler&&y.leaveHandler(B),y.exitHandler&&y.exitHandler(B))}function U(y,m,_){var S,M;S=y.getActivePointersListByType(_.type),M=S.getById(_.id),M?_=M:(_.captured=!1,_.insideElementPressed=!1),y.overHandler&&y.overHandler({eventSource:y,pointerType:_.type,position:x(_.currentPos,y.element),buttons:S.buttons,pointers:y.getActivePointerCount(),insideElementPressed:_.insideElementPressed,buttonDownAny:S.buttons!==0,isTouchEvent:_.type==="touch",originalEvent:m.originalEvent,userData:y.userData})}function F(y,m,_){var S,M;S=y.getActivePointersListByType(_.type),M=S.getById(_.id),M?_=M:(_.captured=!1,_.insideElementPressed=!1),y.outHandler&&y.outHandler({eventSource:y,pointerType:_.type,position:_.currentPos&&x(_.currentPos,y.element),buttons:S.buttons,pointers:y.getActivePointerCount(),insideElementPressed:_.insideElementPressed,buttonDownAny:S.buttons!==0,isTouchEvent:_.type==="touch",originalEvent:m.originalEvent,userData:y.userData})}function K(y,m,_,S){var M=i[y.hash],B=y.getActivePointersListByType(_.type),G;if(typeof m.originalEvent.buttons<"u"?B.buttons=m.originalEvent.buttons:S===0?B.buttons|=1:S===1?B.buttons|=4:S===2?B.buttons|=2:S===3?B.buttons|=8:S===4?B.buttons|=16:S===5&&(B.buttons|=32),S!==0){m.shouldCapture=!1,m.shouldReleaseCapture=!1,y.nonPrimaryPressHandler&&!m.preventGesture&&!m.defaultPrevented&&(m.preventDefault=!0,y.nonPrimaryPressHandler({eventSource:y,pointerType:_.type,position:x(_.currentPos,y.element),button:S,buttons:B.buttons,isTouchEvent:_.type==="touch",originalEvent:m.originalEvent,userData:y.userData}));return}G=B.getById(_.id),G?(G.insideElementPressed=!0,G.insideElement=!0,G.originalTarget=m.originalEvent.target,G.contactPos=_.currentPos,G.contactTime=_.currentTime,G.lastPos=G.currentPos,G.lastTime=G.currentTime,G.currentPos=_.currentPos,G.currentTime=_.currentTime,_=G):(_.captured=!1,_.insideElementPressed=!0,_.insideElement=!0,_.originalTarget=m.originalEvent.target,Qt(B,_)),B.addContact(),!m.preventGesture&&!m.defaultPrevented?(m.shouldCapture=!0,m.shouldReleaseCapture=!1,m.preventDefault=!0,(y.dragHandler||y.dragEndHandler||y.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.addPoint(y,_),B.contacts===1?y.pressHandler&&!m.preventGesture&&y.pressHandler({eventSource:y,pointerType:_.type,position:x(_.contactPos,y.element),buttons:B.buttons,isTouchEvent:_.type==="touch",originalEvent:m.originalEvent,userData:y.userData}):B.contacts===2&&y.pinchHandler&&_.type==="touch"&&(M.pinchGPoints=B.asArray(),M.lastPinchDist=M.currentPinchDist=M.pinchGPoints[0].currentPos.distanceTo(M.pinchGPoints[1].currentPos),M.lastPinchCenter=M.currentPinchCenter=C(M.pinchGPoints[0].currentPos,M.pinchGPoints[1].currentPos))):(m.shouldCapture=!1,m.shouldReleaseCapture=!1)}function ne(y,m,_,S){var M=i[y.hash],B=y.getActivePointersListByType(_.type),G,ae,X,Ae=!1,_e;if(typeof m.originalEvent.buttons<"u"?B.buttons=m.originalEvent.buttons:S===0?B.buttons^=-2:S===1?B.buttons^=-5:S===2?B.buttons^=-3:S===3?B.buttons^=-9:S===4?B.buttons^=-17:S===5&&(B.buttons^=-33),m.shouldCapture=!1,S!==0){m.shouldReleaseCapture=!1,y.nonPrimaryReleaseHandler&&!m.preventGesture&&!m.defaultPrevented&&(m.preventDefault=!0,y.nonPrimaryReleaseHandler({eventSource:y,pointerType:_.type,position:x(_.currentPos,y.element),button:S,buttons:B.buttons,isTouchEvent:_.type==="touch",originalEvent:m.originalEvent,userData:y.userData}));return}X=B.getById(_.id),X?(B.removeContact(),X.captured&&(Ae=!0),X.lastPos=X.currentPos,X.lastTime=X.currentTime,X.currentPos=_.currentPos,X.currentTime=_.currentTime,X.insideElement||Ft(y,B,X),G=X.currentPos,ae=X.currentTime):(_.captured=!1,_.insideElementPressed=!1,_.insideElement=!0,Qt(B,_),X=_),!m.preventGesture&&!m.defaultPrevented&&(Ae?(m.shouldReleaseCapture=!0,m.preventDefault=!0,(y.dragHandler||y.dragEndHandler||y.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.removePoint(y,X),B.contacts===0?(y.releaseHandler&&G&&y.releaseHandler({eventSource:y,pointerType:X.type,position:x(G,y.element),buttons:B.buttons,insideElementPressed:X.insideElementPressed,insideElementReleased:X.insideElement,isTouchEvent:X.type==="touch",originalEvent:m.originalEvent,userData:y.userData}),y.dragEndHandler&&M.sentDragEvent&&y.dragEndHandler({eventSource:y,pointerType:X.type,position:x(X.currentPos,y.element),speed:X.speed,direction:X.direction,shift:m.originalEvent.shiftKey,isTouchEvent:X.type==="touch",originalEvent:m.originalEvent,userData:y.userData}),M.sentDragEvent=!1,(y.clickHandler||y.dblClickHandler)&&X.insideElement&&(_e=ae-X.contactTime<=y.clickTimeThreshold&&X.contactPos.distanceTo(G)<=y.clickDistThreshold,y.clickHandler&&y.clickHandler({eventSource:y,pointerType:X.type,position:x(X.currentPos,y.element),quick:_e,shift:m.originalEvent.shiftKey,isTouchEvent:X.type==="touch",originalEvent:m.originalEvent,originalTarget:X.originalTarget,userData:y.userData}),y.dblClickHandler&&_e&&(B.clicks++,B.clicks===1?(M.lastClickPos=G,M.dblClickTimeOut=setTimeout(function(){B.clicks=0},y.dblClickTimeThreshold)):B.clicks===2&&(clearTimeout(M.dblClickTimeOut),B.clicks=0,M.lastClickPos.distanceTo(G)<=y.dblClickDistThreshold&&y.dblClickHandler({eventSource:y,pointerType:X.type,position:x(X.currentPos,y.element),shift:m.originalEvent.shiftKey,isTouchEvent:X.type==="touch",originalEvent:m.originalEvent,userData:y.userData}),M.lastClickPos=null)))):B.contacts===2&&y.pinchHandler&&X.type==="touch"&&(M.pinchGPoints=B.asArray(),M.lastPinchDist=M.currentPinchDist=M.pinchGPoints[0].currentPos.distanceTo(M.pinchGPoints[1].currentPos),M.lastPinchCenter=M.currentPinchCenter=C(M.pinchGPoints[0].currentPos,M.pinchGPoints[1].currentPos))):(m.shouldReleaseCapture=!1,y.releaseHandler&&G&&(y.releaseHandler({eventSource:y,pointerType:X.type,position:x(G,y.element),buttons:B.buttons,insideElementPressed:X.insideElementPressed,insideElementReleased:X.insideElement,isTouchEvent:X.type==="touch",originalEvent:m.originalEvent,userData:y.userData}),m.preventDefault=!0)))}function ce(y,m,_){var S=i[y.hash],M=y.getActivePointersListByType(_.type),B,G,ae;if(typeof m.originalEvent.buttons<"u"&&(M.buttons=m.originalEvent.buttons),B=M.getById(_.id),B)B.lastPos=B.currentPos,B.lastTime=B.currentTime,B.currentPos=_.currentPos,B.currentTime=_.currentTime;else return;m.shouldCapture=!1,m.shouldReleaseCapture=!1,y.stopHandler&&_.type==="mouse"&&(clearTimeout(y.stopTimeOut),y.stopTimeOut=setTimeout(function(){ge(y,m.originalEvent,_.type)},y.stopDelay)),M.contacts===0?y.moveHandler&&y.moveHandler({eventSource:y,pointerType:_.type,position:x(_.currentPos,y.element),buttons:M.buttons,isTouchEvent:_.type==="touch",originalEvent:m.originalEvent,userData:y.userData}):M.contacts===1?(y.moveHandler&&(B=M.asArray()[0],y.moveHandler({eventSource:y,pointerType:B.type,position:x(B.currentPos,y.element),buttons:M.buttons,isTouchEvent:B.type==="touch",originalEvent:m.originalEvent,userData:y.userData})),y.dragHandler&&!m.preventGesture&&!m.defaultPrevented&&(B=M.asArray()[0],ae=B.currentPos.minus(B.lastPos),y.dragHandler({eventSource:y,pointerType:B.type,position:x(B.currentPos,y.element),buttons:M.buttons,delta:ae,speed:B.speed,direction:B.direction,shift:m.originalEvent.shiftKey,isTouchEvent:B.type==="touch",originalEvent:m.originalEvent,userData:y.userData}),m.preventDefault=!0,S.sentDragEvent=!0)):M.contacts===2&&(y.moveHandler&&(G=M.asArray(),y.moveHandler({eventSource:y,pointerType:G[0].type,position:x(C(G[0].currentPos,G[1].currentPos),y.element),buttons:M.buttons,isTouchEvent:G[0].type==="touch",originalEvent:m.originalEvent,userData:y.userData})),y.pinchHandler&&_.type==="touch"&&!m.preventGesture&&!m.defaultPrevented&&(ae=S.pinchGPoints[0].currentPos.distanceTo(S.pinchGPoints[1].currentPos),ae!==S.currentPinchDist&&(S.lastPinchDist=S.currentPinchDist,S.currentPinchDist=ae,S.lastPinchCenter=S.currentPinchCenter,S.currentPinchCenter=C(S.pinchGPoints[0].currentPos,S.pinchGPoints[1].currentPos),y.pinchHandler({eventSource:y,pointerType:"touch",gesturePoints:S.pinchGPoints,lastCenter:x(S.lastPinchCenter,y.element),center:x(S.currentPinchCenter,y.element),lastDistance:S.lastPinchDist,distance:S.currentPinchDist,shift:m.originalEvent.shiftKey,originalEvent:m.originalEvent,userData:y.userData}),m.preventDefault=!0)))}function J(y,m,_){var S=y.getActivePointersListByType(_.type),M;M=S.getById(_.id),M&&Ft(y,S,M)}function ge(y,m,_){y.stopHandler&&y.stopHandler({eventSource:y,pointerType:_,position:w(m,y.element),buttons:y.getActivePointersListByType(_).buttons,isTouchEvent:_==="touch",originalEvent:m,userData:y.userData})}})(t),(function(e){e.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},e.Control=function(i,r,s){var n=i.parentNode;typeof r=="number"&&(e.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),r={anchor:r}),r.attachToViewer=typeof r.attachToViewer>"u"?!0:r.attachToViewer,this.autoFade=typeof r.autoFade>"u"?!0:r.autoFade,this.element=i,this.anchor=r.anchor,this.container=s,this.anchor===e.ControlAnchor.ABSOLUTE?(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top=typeof r.top=="number"?r.top+"px":r.top,this.wrapper.style.left=typeof r.left=="number"?r.left+"px":r.left,this.wrapper.style.height=typeof r.height=="number"?r.height+"px":r.height,this.wrapper.style.width=typeof r.width=="number"?r.width+"px":r.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor===e.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),r.attachToViewer?this.anchor===e.ControlAnchor.TOP_RIGHT||this.anchor===e.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):n.appendChild(this.wrapper)},e.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.anchor!==e.ControlAnchor.NONE&&this.container.removeChild(this.wrapper)},isVisible:function(){return this.wrapper.style.display!=="none"},setVisible:function(i){this.wrapper.style.display=i?this.anchor===e.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(i){e.setElementOpacity(this.wrapper,i,!0)}}})(t),(function(e){e.ControlDock=function(r){var s=["topleft","topright","bottomright","bottomleft"],n,o;for(e.extend(!0,this,{id:"controldock-"+e.now()+"-"+Math.floor(Math.random()*1e6),container:e.makeNeutralElement("div"),controls:[]},r),this.container.onsubmit=function(){return!1},this.element&&(this.element=e.getElement(this.element),this.element.appendChild(this.container),e.getElementStyle(this.element).position==="static"&&(this.element.style.position="relative"),this.container.style.width="100%",this.container.style.height="100%"),o=0;o<s.length;o++)n=s[o],this.controls[n]=e.makeNeutralElement("div"),this.controls[n].style.position="absolute",n.match("left")&&(this.controls[n].style.left="0px"),n.match("right")&&(this.controls[n].style.right="0px"),n.match("top")&&(this.controls[n].style.top="0px"),n.match("bottom")&&(this.controls[n].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},e.ControlDock.prototype={addControl:function(r,s){r=e.getElement(r);var n=null;if(!(i(this,r)>=0)){switch(s.anchor){case e.ControlAnchor.TOP_RIGHT:n=this.controls.topright,r.style.position="relative",r.style.paddingRight="0px",r.style.paddingTop="0px";break;case e.ControlAnchor.BOTTOM_RIGHT:n=this.controls.bottomright,r.style.position="relative",r.style.paddingRight="0px",r.style.paddingBottom="0px";break;case e.ControlAnchor.BOTTOM_LEFT:n=this.controls.bottomleft,r.style.position="relative",r.style.paddingLeft="0px",r.style.paddingBottom="0px";break;case e.ControlAnchor.TOP_LEFT:n=this.controls.topleft,r.style.position="relative",r.style.paddingLeft="0px",r.style.paddingTop="0px";break;case e.ControlAnchor.ABSOLUTE:n=this.container,r.style.margin="0px",r.style.padding="0px";break;default:case e.ControlAnchor.NONE:n=this.container,r.style.margin="0px",r.style.padding="0px";break}this.controls.push(new e.Control(r,s,n)),r.style.display="inline-block"}},removeControl:function(r){r=e.getElement(r);var s=i(this,r);return s>=0&&(this.controls[s].destroy(),this.controls.splice(s,1)),this},clearControls:function(){for(;this.controls.length>0;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var r;for(r=this.controls.length-1;r>=0;r--)if(this.controls[r].isVisible())return!0;return!1},setControlsEnabled:function(r){var s;for(s=this.controls.length-1;s>=0;s--)this.controls[s].setVisible(r);return this}};function i(r,s){var n=r.controls,o;for(o=n.length-1;o>=0;o--)if(n[o].element===s)return o;return-1}})(t),(function(e){e.Placement=e.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}})})(t),(function(e){var i={},r=1;e.Viewer=function(f){var T=arguments,D=this,L;e.isPlainObject(f)||(f={id:T[0],xmlPath:T.length>1?T[1]:void 0,prefixUrl:T.length>2?T[2]:void 0,controls:T.length>3?T[3]:void 0,overlays:T.length>4?T[4]:void 0}),f.config&&(e.extend(!0,f,f.config),delete f.config);let H=["useCanvas"];if(f.drawerOptions=Object.assign({},H.reduce((F,K)=>(F[K]=f[K],delete f[K],F),{}),f.drawerOptions),e.extend(!0,this,{id:f.id,hash:f.hash||r++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttonGroup:null,profiler:null},e.DEFAULT_SETTINGS,f),typeof this.hash>"u")throw new Error("A hash must be defined, either by specifying options.id or options.hash.");typeof i[this.hash]<"u"&&e.console.warn("Hash "+this.hash+" has already been used."),i[this.hash]={fsBoundsDelta:new e.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,needsResize:!1,forceResize:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null,lastClickTime:null,draggingToZoom:!1},this._sequenceIndex=0,this._firstOpen=!0,this._updateRequestId=null,this._loadQueue=[],this.currentOverlays=[],this._updatePixelDensityRatioBind=null,this._lastScrollTime=e.now(),e.EventSource.call(this),this.addHandler("open-failed",function(F){var K=e.getString("Errors.OpenFailed",F.eventSource,F.message);D._showMessage(K)}),e.ControlDock.call(this,f),this.xmlPath&&(this.tileSources=[this.xmlPath]),this.element=this.element||document.getElementById(this.id),this.canvas=e.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",(function(F){F.width="100%",F.height="100%",F.overflow="hidden",F.position="absolute",F.top="0px",F.left="0px"})(this.canvas.style),e.setElementTouchActionNone(this.canvas),f.tabIndex!==""&&(this.canvas.tabIndex=f.tabIndex===void 0?0:f.tabIndex),this.container.className="openseadragon-container",(function(F){F.width="100%",F.height="100%",F.position="relative",F.overflow="hidden",F.left="0px",F.top="0px",F.textAlign="left"})(this.container.style),e.setElementTouchActionNone(this.container),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new e.MouseTracker({userData:"Viewer.innerTracker",element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,contextMenuHandler:e.delegate(this,w),keyDownHandler:e.delegate(this,x),keyHandler:e.delegate(this,C),clickHandler:e.delegate(this,P),dblClickHandler:e.delegate(this,k),dragHandler:e.delegate(this,R),dragEndHandler:e.delegate(this,A),enterHandler:e.delegate(this,j),leaveHandler:e.delegate(this,I),pressHandler:e.delegate(this,W),releaseHandler:e.delegate(this,$),nonPrimaryPressHandler:e.delegate(this,Z),nonPrimaryReleaseHandler:e.delegate(this,z),scrollHandler:e.delegate(this,te),pinchHandler:e.delegate(this,V),focusHandler:e.delegate(this,Y),blurHandler:e.delegate(this,ie)}),this.outerTracker=new e.MouseTracker({userData:"Viewer.outerTracker",element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:e.delegate(this,se),leaveHandler:e.delegate(this,Q)}),this.toolbar&&(this.toolbar=new e.ControlDock({element:this.toolbar})),this.bindStandardControls(),i[this.hash].prevContainerSize=s(this.container),window.ResizeObserver?(this._autoResizePolling=!1,this._resizeObserver=new ResizeObserver(function(){i[D.hash].needsResize=!0}),this._resizeObserver.observe(this.container,{})):this._autoResizePolling=!0,this.world=new e.World({viewer:this}),this.world.addHandler("add-item",function(F){D.source=D.world.getItemAt(0).source,i[D.hash].forceRedraw=!0,D._updateRequestId||(D._updateRequestId=l(D,me))}),this.world.addHandler("remove-item",function(F){D.world.getItemCount()?D.source=D.world.getItemAt(0).source:D.source=null,i[D.hash].forceRedraw=!0}),this.world.addHandler("metrics-change",function(F){D.viewport&&D.viewport._setContentBounds(D.world.getHomeBounds(),D.world.getContentFactor())}),this.world.addHandler("item-index-change",function(F){D.source=D.world.getItemAt(0).source}),this.viewport=new e.Viewport({containerSize:i[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,overlayPreserveContentDirection:this.overlayPreserveContentDirection,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins,silenceMultiImageWarnings:this.silenceMultiImageWarnings}),this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor()),this.imageLoader=new e.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:f.timeout,tileRetryMax:this.tileRetryMax,tileRetryDelay:this.tileRetryDelay}),this.tileCache=new e.TileCache({maxImageCacheCount:this.maxImageCacheCount}),Object.prototype.hasOwnProperty.call(this.drawerOptions,"useCanvas")&&(e.console.error('useCanvas is deprecated, use the "drawer" option to indicate preferred drawer(s)'),this.drawerOptions.useCanvas||(this.drawer=e.HTMLDrawer),delete this.drawerOptions.useCanvas);let U=Array.isArray(this.drawer)?this.drawer:[this.drawer];U.length===0&&(U=[e.DEFAULT_SETTINGS.drawer].flat(),e.console.warn("No valid drawers were selected. Using the default value.")),this.drawer=null;for(const F of U)if(this.requestDrawer(F,{mainDrawer:!0,redrawImmediately:!1}))break;if(!this.drawer)throw e.console.error("No drawer could be created!"),"Error with creating the selected drawer(s)";for(this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled),this.overlaysContainer=e.makeNeutralElement("div"),this.canvas.appendChild(this.overlaysContainer),this.drawer.canRotate()||(this.rotateLeft&&(L=this.buttonGroup.buttons.indexOf(this.rotateLeft),this.buttonGroup.buttons.splice(L,1),this.buttonGroup.element.removeChild(this.rotateLeft.element)),this.rotateRight&&(L=this.buttonGroup.buttons.indexOf(this.rotateRight),this.buttonGroup.buttons.splice(L,1),this.buttonGroup.element.removeChild(this.rotateRight.element))),this._addUpdatePixelDensityRatioEvent(),this.showNavigator&&(this.navigator=new e.Navigator({element:this.navigatorElement,id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy,animationTime:this.animationTime,drawer:this.drawer.getType(),loadTilesWithAjax:this.loadTilesWithAjax,ajaxHeaders:this.ajaxHeaders,ajaxWithCredentials:this.ajaxWithCredentials})),this.sequenceMode&&this.bindSequenceControls(),this.tileSources&&this.open(this.tileSources),L=0;L<this.customControls.length;L++)this.addControl(this.customControls[L].id,{anchor:this.customControls[L].anchor});e.requestAnimationFrame(function(){c(D)}),e._viewers.set(this.element,this)},e.extend(e.Viewer.prototype,e.EventSource.prototype,e.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},openDzi:function(f){return e.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead."),this.open(f)},openTileSource:function(f){return e.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead."),this.open(f)},get buttons(){return e.console.warn("Viewer.buttons is deprecated; Please use Viewer.buttonGroup"),this.buttonGroup},open:function(f,T){var D=this;if(this.close(),!f)return this;if(this.sequenceMode&&e.isArray(f))return this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),typeof T<"u"&&!isNaN(T)&&(this.initialPage=T),this.tileSources=f,this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage)),this.tileSources.length&&(this.open(this.tileSources[this._sequenceIndex]),this.showReferenceStrip&&this.addReferenceStrip()),this._updateSequenceButtons(this._sequenceIndex),this;if(e.isArray(f)||(f=[f]),!f.length)return this;this._opening=!0;for(var L=f.length,H=0,U=0,F,K=function(){if(H+U===L)if(H){(D._firstOpen||!D.preserveViewport)&&(D.viewport.goHome(!0),D.viewport.update()),D._firstOpen=!1;var J=f[0];if(J.tileSource&&(J=J.tileSource),D.overlays&&!D.preserveOverlays)for(var ge=0;ge<D.overlays.length;ge++)D.currentOverlays[ge]=o(D,D.overlays[ge]);D._drawOverlays(),D._opening=!1,D.raiseEvent("open",{source:J})}else D._opening=!1,D.raiseEvent("open-failed",F)},ne=function(J){(!e.isPlainObject(J)||!J.tileSource)&&(J={tileSource:J}),J.index!==void 0&&(e.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead"),delete J.index),J.collectionImmediately===void 0&&(J.collectionImmediately=!0);var ge=J.success;J.success=function(m){if(H++,J.tileSource.overlays)for(var _=0;_<J.tileSource.overlays.length;_++)D.addOverlay(J.tileSource.overlays[_]);ge&&ge(m),K()};var y=J.error;J.error=function(m){U++,F||(F=m),y&&y(m),K()},D.addTiledImage(J)},ce=0;ce<f.length;ce++)ne(f[ce]);return this},close:function(){return i[this.hash]?(this._opening=!1,this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),i[this.hash].animating=!1,this.world.removeAll(),this.imageLoader.clear(),this.raiseEvent("close"),this):this},destroy:function(){if(i[this.hash]){if(this.raiseEvent("before-destroy"),this._removeUpdatePixelDensityRatioEvent(),this.close(),this.clearOverlays(),this.overlaysContainer.innerHTML="",this._resizeObserver&&this._resizeObserver.disconnect(),this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),this._updateRequestId!==null&&(e.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.drawer&&this.drawer.destroy(),this.navigator&&(this.navigator.destroy(),i[this.navigator.hash]=null,delete i[this.navigator.hash],this.navigator=null),this.buttonGroup)this.buttonGroup.destroy();else if(this.customButtons)for(;this.customButtons.length;)this.customButtons.pop().destroy();if(this.paging&&this.paging.destroy(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.container.onsubmit=null,this.clearControls(),this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),i[this.hash]=null,delete i[this.hash],this.canvas=null,this.container=null,e._viewers.delete(this.element),this.element=null,this.raiseEvent("destroy"),this.removeAllHandlers()}},requestDrawer(f,T){const D={mainDrawer:!0,redrawImmediately:!0,drawerOptions:null};T=e.extend(!0,D,T);const L=T.mainDrawer,H=T.redrawImmediately,U=T.drawerOptions,F=this.drawer;let K=null;if(f&&f.prototype instanceof e.DrawerBase?(K=f,f="custom"):typeof f=="string"&&(K=e.determineDrawer(f)),K||e.console.warn("Unsupported drawer! Drawer must be an existing string type, or a class that extends OpenSeadragon.DrawerBase."),K&&K.isSupported()){F&&L&&F.destroy();const ne=new K({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor,options:U||this.drawerOptions[f]});return L&&(this.drawer=ne,H&&this.forceRedraw()),ne}return!1},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(f){return this.innerTracker.setTracking(f),this.outerTracker.setTracking(f),this.raiseEvent("mouse-enabled",{enabled:f}),this},areControlsEnabled:function(){var f=this.controls.length,T;for(T=0;T<this.controls.length;T++)f=f&&this.controls[T].isVisible();return f},setControlsEnabled:function(f){return f?g(this):c(this),this.raiseEvent("controls-enabled",{enabled:f}),this},setDebugMode:function(f){for(var T=0;T<this.world.getItemCount();T++)this.world.getItemAt(T).debugMode=f;this.debugMode=f,this.forceRedraw()},setAjaxHeaders:function(f,T){if(f===null&&(f={}),!e.isPlainObject(f)){console.error("[Viewer.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}if(T===void 0&&(T=!0),this.ajaxHeaders=f,T){for(var D=0;D<this.world.getItemCount();D++)this.world.getItemAt(D)._updateAjaxHeaders(!0);if(this.navigator&&this.navigator.setAjaxHeaders(this.ajaxHeaders,!0),this.referenceStrip&&this.referenceStrip.miniViewers)for(var L in this.referenceStrip.miniViewers)this.referenceStrip.miniViewers[L].setAjaxHeaders(this.ajaxHeaders,!0)}},addButton:function(f){this.buttonGroup.addButton(f)},isFullPage:function(){return i[this.hash]&&i[this.hash].fullPage},setFullPage:function(f){var T=document.body,D=T.style,L=document.documentElement.style,H=this,U,F;if(f===this.isFullPage())return this;var K={fullPage:f,preventDefaultAction:!1};if(this.raiseEvent("pre-full-page",K),K.preventDefaultAction)return this;if(f&&this.element){for(this.elementSize=e.getElementSize(this.element),this.pageScroll=e.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=D.margin,this.docMargin=L.margin,D.margin="0",L.margin="0",this.bodyPadding=D.padding,this.docPadding=L.padding,D.padding="0",L.padding="0",this.bodyWidth=D.width,this.docWidth=L.width,D.width="100%",L.width="100%",this.bodyHeight=D.height,this.docHeight=L.height,D.height="100%",L.height="100%",this.bodyDisplay=D.display,D.display="block",this.previousBody=[],i[this.hash].prevElementParent=this.element.parentNode,i[this.hash].prevNextSibling=this.element.nextSibling,i[this.hash].prevElementWidth=this.element.style.width,i[this.hash].prevElementHeight=this.element.style.height,U=T.childNodes.length,F=0;F<U;F++)this.previousBody.push(T.childNodes[0]),T.removeChild(T.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,T.appendChild(this.toolbar.element),e.addClass(this.toolbar.element,"fullpage")),e.addClass(this.element,"fullpage"),T.appendChild(this.element),this.element.style.height="100vh",this.element.style.width="100vw",this.toolbar&&this.toolbar.element&&(this.element.style.height=e.getElementSize(this.element).y-e.getElementSize(this.toolbar.element).y+"px"),i[this.hash].fullPage=!0,e.delegate(this,se)({})}else{for(this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,D.margin=this.bodyMargin,L.margin=this.docMargin,D.padding=this.bodyPadding,L.padding=this.docPadding,D.width=this.bodyWidth,L.width=this.docWidth,D.height=this.bodyHeight,L.height=this.docHeight,D.display=this.bodyDisplay,T.removeChild(this.element),U=this.previousBody.length,F=0;F<U;F++)T.appendChild(this.previousBody.shift());e.removeClass(this.element,"fullpage"),i[this.hash].prevElementParent.insertBefore(this.element,i[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(T.removeChild(this.toolbar.element),e.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=i[this.hash].prevElementWidth,this.element.style.height=i[this.hash].prevElementHeight;var ne=0,ce=function(){e.setPageScroll(H.pageScroll);var J=e.getPageScroll();ne++,ne<10&&(J.x!==H.pageScroll.x||J.y!==H.pageScroll.y)&&e.requestAnimationFrame(ce)};e.requestAnimationFrame(ce),i[this.hash].fullPage=!1,e.delegate(this,Q)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:f}),this},setFullScreen:function(f){var T=this;if(!e.supportsFullScreen)return this.setFullPage(f);if(e.isFullScreen()===f)return this;var D={fullScreen:f,preventDefaultAction:!1};if(this.raiseEvent("pre-full-screen",D),D.preventDefaultAction)return this;if(f){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var L=function(){var H=e.isFullScreen();H||(e.removeEvent(document,e.fullScreenEventName,L),e.removeEvent(document,e.fullScreenErrorEventName,L),T.setFullPage(!1),T.isFullPage()&&(T.element.style.width=T.fullPageStyleWidth,T.element.style.height=T.fullPageStyleHeight)),T.navigator&&T.viewport&&setTimeout(function(){T.navigator.update(T.viewport)}),T.raiseEvent("full-screen",{fullScreen:H})};e.addEvent(document,e.fullScreenEventName,L),e.addEvent(document,e.fullScreenErrorEventName,L),e.requestFullScreen(document.body)}else e.exitFullScreen();return this},isVisible:function(){return this.container.style.visibility!=="hidden"},isFullScreen:function(){return e.isFullScreen()&&this.isFullPage()},setVisible:function(f){return this.container.style.visibility=f?"":"hidden",this.raiseEvent("visible",{visible:f}),this},addTiledImage:function(f){e.console.assert(f,"[Viewer.addTiledImage] options is required"),e.console.assert(f.tileSource,"[Viewer.addTiledImage] options.tileSource is required"),e.console.assert(!f.replace||f.index>-1&&f.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var T=this;f.replace&&(f.replaceItem=T.world.getItemAt(f.index)),this._hideMessage(),f.placeholderFillStyle===void 0&&(f.placeholderFillStyle=this.placeholderFillStyle),f.opacity===void 0&&(f.opacity=this.opacity),f.preload===void 0&&(f.preload=this.preload),f.compositeOperation===void 0&&(f.compositeOperation=this.compositeOperation),f.crossOriginPolicy===void 0&&(f.crossOriginPolicy=f.tileSource.crossOriginPolicy!==void 0?f.tileSource.crossOriginPolicy:this.crossOriginPolicy),f.ajaxWithCredentials===void 0&&(f.ajaxWithCredentials=this.ajaxWithCredentials),f.loadTilesWithAjax===void 0&&(f.loadTilesWithAjax=this.loadTilesWithAjax),e.isPlainObject(f.ajaxHeaders)||(f.ajaxHeaders={});var D={options:f};function L(F){for(var K=0;K<T._loadQueue.length;K++)if(T._loadQueue[K]===D){T._loadQueue.splice(K,1);break}T._loadQueue.length===0&&H(D),T.raiseEvent("add-item-failed",F),f.error&&f.error(F)}function H(F){T.collectionMode&&(T.world.arrange({immediately:F.options.collectionImmediately,rows:T.collectionRows,columns:T.collectionColumns,layout:T.collectionLayout,tileSize:T.collectionTileSize,tileMargin:T.collectionTileMargin}),T.world.setAutoRefigureSizes(!0))}if(e.isArray(f.tileSource)){setTimeout(function(){L({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:f.tileSource,options:f})});return}this._loadQueue.push(D);function U(){for(var F,K,ne;T._loadQueue.length&&(F=T._loadQueue[0],!!F.tileSource);){if(T._loadQueue.splice(0,1),F.options.replace){var ce=T.world.getIndexOfItem(F.options.replaceItem);ce!==-1&&(F.options.index=ce),T.world.removeItem(F.options.replaceItem)}K=new e.TiledImage({viewer:T,source:F.tileSource,viewport:T.viewport,drawer:T.drawer,tileCache:T.tileCache,imageLoader:T.imageLoader,x:F.options.x,y:F.options.y,width:F.options.width,height:F.options.height,fitBounds:F.options.fitBounds,fitBoundsPlacement:F.options.fitBoundsPlacement,clip:F.options.clip,placeholderFillStyle:F.options.placeholderFillStyle,opacity:F.options.opacity,preload:F.options.preload,degrees:F.options.degrees,flipped:F.options.flipped,compositeOperation:F.options.compositeOperation,springStiffness:T.springStiffness,animationTime:T.animationTime,minZoomImageRatio:T.minZoomImageRatio,wrapHorizontal:T.wrapHorizontal,wrapVertical:T.wrapVertical,maxTilesPerFrame:T.maxTilesPerFrame,immediateRender:T.immediateRender,blendTime:T.blendTime,alwaysBlend:T.alwaysBlend,minPixelRatio:T.minPixelRatio,smoothTileEdgesMinZoom:T.smoothTileEdgesMinZoom,iOSDevice:T.iOSDevice,crossOriginPolicy:F.options.crossOriginPolicy,ajaxWithCredentials:F.options.ajaxWithCredentials,loadTilesWithAjax:F.options.loadTilesWithAjax,ajaxHeaders:F.options.ajaxHeaders,debugMode:T.debugMode,subPixelRoundingForTransparency:T.subPixelRoundingForTransparency}),T.collectionMode&&T.world.setAutoRefigureSizes(!1),T.navigator&&(ne=e.extend({},F.options,{replace:!1,originalTiledImage:K,tileSource:F.tileSource}),T.navigator.addTiledImage(ne)),T.world.addItem(K,{index:F.options.index}),T._loadQueue.length===0&&H(F),T.world.getItemCount()===1&&!T.preserveViewport&&T.viewport.goHome(!0),F.options.success&&F.options.success({item:K})}}n(this,f.tileSource,f,function(F){D.tileSource=F,U()},function(F){F.options=f,L(F),U()})},addSimpleImage:function(f){e.console.assert(f,"[Viewer.addSimpleImage] options is required"),e.console.assert(f.url,"[Viewer.addSimpleImage] options.url is required");var T=e.extend({},f,{tileSource:{type:"image",url:f.url}});delete T.url,this.addTiledImage(T)},addLayer:function(f){var T=this;e.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead.");var D=e.extend({},f,{success:function(L){T.raiseEvent("add-layer",{options:f,drawer:L.item})},error:function(L){T.raiseEvent("add-layer-failed",L)}});return this.addTiledImage(D),this},getLayerAtLevel:function(f){return e.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead."),this.world.getItemAt(f)},getLevelOfLayer:function(f){return e.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead."),this.world.getIndexOfItem(f)},getLayersCount:function(){return e.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead."),this.world.getItemCount()},setLayerLevel:function(f,T){return e.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead."),this.world.setItemIndex(f,T)},removeLayer:function(f){return e.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead."),this.world.removeItem(f)},forceRedraw:function(){return i[this.hash].forceRedraw=!0,this},forceResize:function(){i[this.hash].needsResize=!0,i[this.hash].forceResize=!0},bindSequenceControls:function(){var f=e.delegate(this,p),T=e.delegate(this,v),D=e.delegate(this,this.goToNextPage),L=e.delegate(this,this.goToPreviousPage),H=this.navImages,U=!0;return this.showSequenceControl&&((this.previousButton||this.nextButton)&&(U=!1),this.previousButton=new e.Button({element:this.previousButton?e.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.PreviousPage"),srcRest:q(this.prefixUrl,H.previous.REST),srcGroup:q(this.prefixUrl,H.previous.GROUP),srcHover:q(this.prefixUrl,H.previous.HOVER),srcDown:q(this.prefixUrl,H.previous.DOWN),onRelease:L,onFocus:f,onBlur:T}),this.nextButton=new e.Button({element:this.nextButton?e.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.NextPage"),srcRest:q(this.prefixUrl,H.next.REST),srcGroup:q(this.prefixUrl,H.next.GROUP),srcHover:q(this.prefixUrl,H.next.HOVER),srcDown:q(this.prefixUrl,H.next.DOWN),onRelease:D,onFocus:f,onBlur:T}),this.navPrevNextWrap||this.previousButton.disable(),(!this.tileSources||!this.tileSources.length)&&this.nextButton.disable(),U&&(this.paging=new e.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:e.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||e.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var f=e.delegate(this,ke),T=e.delegate(this,Be),D=e.delegate(this,Tt),L=e.delegate(this,tt),H=e.delegate(this,Fe),U=e.delegate(this,yr),F=e.delegate(this,mi),K=e.delegate(this,wr),ne=e.delegate(this,Qt),ce=e.delegate(this,Ft),J=e.delegate(this,p),ge=e.delegate(this,v),y=this.navImages,m=[],_=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(_=!1),this.showZoomControl&&(m.push(this.zoomInButton=new e.Button({element:this.zoomInButton?e.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomIn"),srcRest:q(this.prefixUrl,y.zoomIn.REST),srcGroup:q(this.prefixUrl,y.zoomIn.GROUP),srcHover:q(this.prefixUrl,y.zoomIn.HOVER),srcDown:q(this.prefixUrl,y.zoomIn.DOWN),onPress:f,onRelease:T,onClick:D,onEnter:f,onExit:T,onFocus:J,onBlur:ge})),m.push(this.zoomOutButton=new e.Button({element:this.zoomOutButton?e.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomOut"),srcRest:q(this.prefixUrl,y.zoomOut.REST),srcGroup:q(this.prefixUrl,y.zoomOut.GROUP),srcHover:q(this.prefixUrl,y.zoomOut.HOVER),srcDown:q(this.prefixUrl,y.zoomOut.DOWN),onPress:L,onRelease:T,onClick:H,onEnter:L,onExit:T,onFocus:J,onBlur:ge}))),this.showHomeControl&&m.push(this.homeButton=new e.Button({element:this.homeButton?e.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Home"),srcRest:q(this.prefixUrl,y.home.REST),srcGroup:q(this.prefixUrl,y.home.GROUP),srcHover:q(this.prefixUrl,y.home.HOVER),srcDown:q(this.prefixUrl,y.home.DOWN),onRelease:U,onFocus:J,onBlur:ge})),this.showFullPageControl&&m.push(this.fullPageButton=new e.Button({element:this.fullPageButton?e.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.FullPage"),srcRest:q(this.prefixUrl,y.fullpage.REST),srcGroup:q(this.prefixUrl,y.fullpage.GROUP),srcHover:q(this.prefixUrl,y.fullpage.HOVER),srcDown:q(this.prefixUrl,y.fullpage.DOWN),onRelease:F,onFocus:J,onBlur:ge})),this.showRotationControl&&(m.push(this.rotateLeftButton=new e.Button({element:this.rotateLeftButton?e.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateLeft"),srcRest:q(this.prefixUrl,y.rotateleft.REST),srcGroup:q(this.prefixUrl,y.rotateleft.GROUP),srcHover:q(this.prefixUrl,y.rotateleft.HOVER),srcDown:q(this.prefixUrl,y.rotateleft.DOWN),onRelease:K,onFocus:J,onBlur:ge})),m.push(this.rotateRightButton=new e.Button({element:this.rotateRightButton?e.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateRight"),srcRest:q(this.prefixUrl,y.rotateright.REST),srcGroup:q(this.prefixUrl,y.rotateright.GROUP),srcHover:q(this.prefixUrl,y.rotateright.HOVER),srcDown:q(this.prefixUrl,y.rotateright.DOWN),onRelease:ne,onFocus:J,onBlur:ge}))),this.showFlipControl&&m.push(this.flipButton=new e.Button({element:this.flipButton?e.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Flip"),srcRest:q(this.prefixUrl,y.flip.REST),srcGroup:q(this.prefixUrl,y.flip.GROUP),srcHover:q(this.prefixUrl,y.flip.HOVER),srcDown:q(this.prefixUrl,y.flip.DOWN),onRelease:ce,onFocus:J,onBlur:ge})),_?(this.buttonGroup=new e.ButtonGroup({buttons:m,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttonGroup.element,this.addHandler("open",e.delegate(this,pi)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT})):this.customButtons=m),this},currentPage:function(){return this._sequenceIndex},goToPage:function(f){return this.tileSources&&f>=0&&f<this.tileSources.length&&(this._sequenceIndex=f,this._updateSequenceButtons(f),this.open(this.tileSources[f]),this.referenceStrip&&this.referenceStrip.setFocus(f),this.raiseEvent("page",{page:f})),this},addOverlay:function(f,T,D,L){var H;if(e.isPlainObject(f)?H=f:H={element:f,location:T,placement:D,onDraw:L},f=e.getElement(H.element),a(this.currentOverlays,f)>=0)return this;var U=o(this,H);return this.currentOverlays.push(U),U.drawHTML(this.overlaysContainer,this.viewport),this.raiseEvent("add-overlay",{element:f,location:H.location,placement:H.placement}),this},updateOverlay:function(f,T,D){var L;return f=e.getElement(f),L=a(this.currentOverlays,f),L>=0&&(this.currentOverlays[L].update(T,D),i[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:f,location:T,placement:D})),this},removeOverlay:function(f){var T;return f=e.getElement(f),T=a(this.currentOverlays,f),T>=0&&(this.currentOverlays[T].destroy(),this.currentOverlays.splice(T,1),i[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:f})),this},clearOverlays:function(){for(;this.currentOverlays.length>0;)this.currentOverlays.pop().destroy();return i[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},getOverlayById:function(f){var T;return f=e.getElement(f),T=a(this.currentOverlays,f),T>=0?this.currentOverlays[T]:null},_updateSequenceButtons:function(f){this.nextButton&&(!this.tileSources||this.tileSources.length-1===f?this.navPrevNextWrap||this.nextButton.disable():this.nextButton.enable()),this.previousButton&&(f>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(f){this._hideMessage();var T=e.makeNeutralElement("div");T.appendChild(document.createTextNode(f)),this.messageDiv=e.makeCenteredNode(T),e.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var f=this.messageDiv;f&&(f.parentNode.removeChild(f),delete this.messageDiv)},gestureSettingsByDeviceType:function(f){switch(f){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var f,T=this.currentOverlays.length;for(f=0;f<T;f++)this.currentOverlays[f].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1,this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null)},addReferenceStrip:function(){if(this.showReferenceStrip=!0,this.sequenceMode){if(this.referenceStrip)return;this.tileSources.length&&this.tileSources.length>1&&(this.referenceStrip=new e.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,viewer:this}),this.referenceStrip.setFocus(this._sequenceIndex))}else e.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')},_addUpdatePixelDensityRatioEvent:function(){this._updatePixelDensityRatioBind=this._updatePixelDensityRatio.bind(this),e.addEvent(window,"resize",this._updatePixelDensityRatioBind)},_removeUpdatePixelDensityRatioEvent:function(){e.removeEvent(window,"resize",this._updatePixelDensityRatioBind)},_updatePixelDensityRatio:function(){var f=e.pixelDensityRatio,T=e.getCurrentPixelDensityRatio();f!==T&&(e.pixelDensityRatio=T,this.forceResize())},goToPreviousPage:function(){var f=this._sequenceIndex-1;this.navPrevNextWrap&&f<0&&(f+=this.tileSources.length),this.goToPage(f)},goToNextPage:function(){var f=this._sequenceIndex+1;this.navPrevNextWrap&&f>=this.tileSources.length&&(f=0),this.goToPage(f)},isAnimating:function(){return i[this.hash].animating}});function s(f){return f=e.getElement(f),new e.Point(f.clientWidth===0?1:f.clientWidth,f.clientHeight===0?1:f.clientHeight)}function n(f,T,D,L,H){var U=f;if(e.type(T)==="string"){if(T.match(/^\s*<.*>\s*$/))T=e.parseXml(T);else if(T.match(/^\s*[{[].*[}\]]\s*$/))try{var F=e.parseJSON(T);T=F}catch{}}function K(ne,ce){ne.ready?L(ne):(ne.addHandler("ready",function(){L(ne)}),ne.addHandler("open-failed",function(J){H({message:J.message,source:ce})}))}setTimeout(function(){if(e.type(T)==="string")T=new e.TileSource({url:T,crossOriginPolicy:D.crossOriginPolicy!==void 0?D.crossOriginPolicy:f.crossOriginPolicy,ajaxWithCredentials:f.ajaxWithCredentials,ajaxHeaders:D.ajaxHeaders?D.ajaxHeaders:f.ajaxHeaders,splitHashDataForPost:f.splitHashDataForPost,success:function(ge){L(ge.tileSource)}}),T.addHandler("open-failed",function(ge){H(ge)});else if(e.isPlainObject(T)||T.nodeType)if(T.crossOriginPolicy===void 0&&(D.crossOriginPolicy!==void 0||f.crossOriginPolicy!==void 0)&&(T.crossOriginPolicy=D.crossOriginPolicy!==void 0?D.crossOriginPolicy:f.crossOriginPolicy),T.ajaxWithCredentials===void 0&&(T.ajaxWithCredentials=f.ajaxWithCredentials),e.isFunction(T.getTileUrl)){var ne=new e.TileSource(T);ne.getTileUrl=T.getTileUrl,L(ne)}else{var ce=e.TileSource.determineType(U,T);if(!ce){H({message:"Unable to load TileSource",source:T});return}var J=ce.prototype.configure.apply(U,[T]);K(new ce(J),T)}else K(T,T)})}function o(f,T){if(T instanceof e.Overlay)return T;var D=null;if(T.element)D=e.getElement(T.element);else{var L=T.id?T.id:"openseadragon-overlay-"+Math.floor(Math.random()*1e7);D=e.getElement(T.id),D||(D=document.createElement("a"),D.href="#/overlay/"+L),D.id=L,e.addClass(D,T.className?T.className:"openseadragon-overlay")}var H=T.location,U=T.width,F=T.height;if(!H){var K=T.x,ne=T.y;if(T.px!==void 0){var ce=f.viewport.imageToViewportRectangle(new e.Rect(T.px,T.py,U||0,F||0));K=ce.x,ne=ce.y,U=U!==void 0?ce.width:void 0,F=F!==void 0?ce.height:void 0}H=new e.Point(K,ne)}var J=T.placement;return J&&e.type(J)==="string"&&(J=e.Placement[T.placement.toUpperCase()]),new e.Overlay({element:D,location:H,placement:J,onDraw:T.onDraw,checkResize:T.checkResize,width:U,height:F,rotationMode:T.rotationMode})}function a(f,T){var D;for(D=f.length-1;D>=0;D--)if(f[D].element===T)return D;return-1}function l(f,T){return e.requestAnimationFrame(function(){T(f)})}function h(f){e.requestAnimationFrame(function(){d(f)})}function c(f){f.autoHideControls&&(f.controlsShouldFade=!0,f.controlsFadeBeginTime=e.now()+f.controlsFadeDelay,window.setTimeout(function(){h(f)},f.controlsFadeDelay))}function d(f){var T,D,L,H;if(f.controlsShouldFade){for(T=e.now(),D=T-f.controlsFadeBeginTime,L=1-D/f.controlsFadeLength,L=Math.min(1,L),L=Math.max(0,L),H=f.controls.length-1;H>=0;H--)f.controls[H].autoFade&&f.controls[H].setOpacity(L);L>0&&h(f)}}function g(f){var T;for(f.controlsShouldFade=!1,T=f.controls.length-1;T>=0;T--)f.controls[T].setOpacity(1)}function p(){g(this)}function v(){c(this)}function w(f){var T={tracker:f.eventSource,position:f.position,originalEvent:f.originalEvent,preventDefault:f.preventDefault};this.raiseEvent("canvas-contextmenu",T),f.preventDefault=T.preventDefault}function x(f){var T={originalEvent:f.originalEvent,preventDefaultAction:!1,preventVerticalPan:f.preventVerticalPan||!this.panVertical,preventHorizontalPan:f.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",T),!T.preventDefaultAction&&!f.ctrl&&!f.alt&&!f.meta)switch(f.keyCode){case 38:T.preventVerticalPan||(f.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-this.pixelsPerArrowPress))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 40:T.preventVerticalPan||(f.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,this.pixelsPerArrowPress))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 37:T.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 39:T.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 187:this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),f.preventDefault=!0;break;case 189:this.viewport.zoomBy(.9),this.viewport.applyConstraints(),f.preventDefault=!0;break;case 48:this.viewport.goHome(),this.viewport.applyConstraints(),f.preventDefault=!0;break;case 87:T.preventVerticalPan||(f.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-40))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 83:T.preventVerticalPan||(f.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,40))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 65:T.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-40,0))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 68:T.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(40,0))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 82:f.shift?this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement),this.viewport.applyConstraints(),f.preventDefault=!0;break;case 70:this.viewport.toggleFlip(),f.preventDefault=!0;break;case 74:this.goToPreviousPage();break;case 75:this.goToNextPage();break;default:f.preventDefault=!1;break}else f.preventDefault=!1}function C(f){var T={originalEvent:f.originalEvent};this.raiseEvent("canvas-key-press",T)}function P(f){var T,D=document.activeElement===this.canvas;D||this.canvas.focus(),this.viewport.flipped&&(f.position.x=this.viewport.getContainerSize().x-f.position.x);var L={tracker:f.eventSource,position:f.position,quick:f.quick,shift:f.shift,originalEvent:f.originalEvent,originalTarget:f.originalTarget,preventDefaultAction:!1};this.raiseEvent("canvas-click",L),!L.preventDefaultAction&&this.viewport&&f.quick&&(T=this.gestureSettingsByDeviceType(f.pointerType),T.clickToZoom===!0&&(this.viewport.zoomBy(f.shift?1/this.zoomPerClick:this.zoomPerClick,T.zoomToRefPoint?this.viewport.pointFromPixel(f.position,!0):null),this.viewport.applyConstraints()),T.dblClickDragToZoom&&(i[this.hash].draggingToZoom===!0?(i[this.hash].lastClickTime=null,i[this.hash].draggingToZoom=!1):i[this.hash].lastClickTime=e.now()))}function k(f){var T,D={tracker:f.eventSource,position:f.position,shift:f.shift,originalEvent:f.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-double-click",D),!D.preventDefaultAction&&this.viewport&&(T=this.gestureSettingsByDeviceType(f.pointerType),T.dblClickToZoom&&(this.viewport.zoomBy(f.shift?1/this.zoomPerClick:this.zoomPerClick,T.zoomToRefPoint?this.viewport.pointFromPixel(f.position,!0):null),this.viewport.applyConstraints()))}function R(f){var T,D={tracker:f.eventSource,pointerType:f.pointerType,position:f.position,delta:f.delta,speed:f.speed,direction:f.direction,shift:f.shift,originalEvent:f.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag",D),T=this.gestureSettingsByDeviceType(f.pointerType),!D.preventDefaultAction&&this.viewport){if(T.dblClickDragToZoom&&i[this.hash].draggingToZoom){var L=Math.pow(this.zoomPerDblClickDrag,f.delta.y/50);this.viewport.zoomBy(L)}else if(T.dragToPan&&!i[this.hash].draggingToZoom){if(this.panHorizontal||(f.delta.x=0),this.panVertical||(f.delta.y=0),this.viewport.flipped&&(f.delta.x=-f.delta.x),this.constrainDuringPan){var H=this.viewport.deltaPointsFromPixels(f.delta.negate());this.viewport.centerSpringX.target.value+=H.x,this.viewport.centerSpringY.target.value+=H.y;var U=this.viewport.getConstrainedBounds();this.viewport.centerSpringX.target.value-=H.x,this.viewport.centerSpringY.target.value-=H.y,U.xConstrained&&(f.delta.x=0),U.yConstrained&&(f.delta.y=0)}this.viewport.panBy(this.viewport.deltaPointsFromPixels(f.delta.negate()),T.flickEnabled&&!this.constrainDuringPan)}}}function A(f){var T,D={tracker:f.eventSource,pointerType:f.pointerType,position:f.position,speed:f.speed,direction:f.direction,shift:f.shift,originalEvent:f.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag-end",D),T=this.gestureSettingsByDeviceType(f.pointerType),!D.preventDefaultAction&&this.viewport){if(!i[this.hash].draggingToZoom&&T.dragToPan&&T.flickEnabled&&f.speed>=T.flickMinSpeed){var L=0;this.panHorizontal&&(L=T.flickMomentum*f.speed*Math.cos(f.direction));var H=0;this.panVertical&&(H=T.flickMomentum*f.speed*Math.sin(f.direction));var U=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),F=this.viewport.pointFromPixel(new e.Point(U.x-L,U.y-H));this.viewport.panTo(F,!1)}this.viewport.applyConstraints()}T.dblClickDragToZoom&&i[this.hash].draggingToZoom===!0&&(i[this.hash].draggingToZoom=!1)}function j(f){this.raiseEvent("canvas-enter",{tracker:f.eventSource,pointerType:f.pointerType,position:f.position,buttons:f.buttons,pointers:f.pointers,insideElementPressed:f.insideElementPressed,buttonDownAny:f.buttonDownAny,originalEvent:f.originalEvent})}function I(f){this.raiseEvent("canvas-exit",{tracker:f.eventSource,pointerType:f.pointerType,position:f.position,buttons:f.buttons,pointers:f.pointers,insideElementPressed:f.insideElementPressed,buttonDownAny:f.buttonDownAny,originalEvent:f.originalEvent})}function W(f){var T;if(this.raiseEvent("canvas-press",{tracker:f.eventSource,pointerType:f.pointerType,position:f.position,insideElementPressed:f.insideElementPressed,insideElementReleased:f.insideElementReleased,originalEvent:f.originalEvent}),T=this.gestureSettingsByDeviceType(f.pointerType),T.dblClickDragToZoom){var D=i[this.hash].lastClickTime,L=e.now();if(D===null)return;L-D<this.dblClickTimeThreshold&&(i[this.hash].draggingToZoom=!0),i[this.hash].lastClickTime=null}}function $(f){this.raiseEvent("canvas-release",{tracker:f.eventSource,pointerType:f.pointerType,position:f.position,insideElementPressed:f.insideElementPressed,insideElementReleased:f.insideElementReleased,originalEvent:f.originalEvent})}function Z(f){this.raiseEvent("canvas-nonprimary-press",{tracker:f.eventSource,position:f.position,pointerType:f.pointerType,button:f.button,buttons:f.buttons,originalEvent:f.originalEvent})}function z(f){this.raiseEvent("canvas-nonprimary-release",{tracker:f.eventSource,position:f.position,pointerType:f.pointerType,button:f.button,buttons:f.buttons,originalEvent:f.originalEvent})}function V(f){var T,D,L,H,U={tracker:f.eventSource,pointerType:f.pointerType,gesturePoints:f.gesturePoints,lastCenter:f.lastCenter,center:f.center,lastDistance:f.lastDistance,distance:f.distance,shift:f.shift,originalEvent:f.originalEvent,preventDefaultPanAction:!1,preventDefaultZoomAction:!1,preventDefaultRotateAction:!1};if(this.raiseEvent("canvas-pinch",U),this.viewport&&(T=this.gestureSettingsByDeviceType(f.pointerType),T.pinchToZoom&&(!U.preventDefaultPanAction||!U.preventDefaultZoomAction)&&(D=this.viewport.pointFromPixel(f.center,!0),T.zoomToRefPoint&&!U.preventDefaultPanAction&&(L=this.viewport.pointFromPixel(f.lastCenter,!0),H=L.minus(D),this.panHorizontal||(H.x=0),this.panVertical||(H.y=0),this.viewport.panBy(H,!0)),U.preventDefaultZoomAction||this.viewport.zoomBy(f.distance/f.lastDistance,D,!0),this.viewport.applyConstraints()),T.pinchRotate&&!U.preventDefaultRotateAction)){var F=Math.atan2(f.gesturePoints[0].currentPos.y-f.gesturePoints[1].currentPos.y,f.gesturePoints[0].currentPos.x-f.gesturePoints[1].currentPos.x),K=Math.atan2(f.gesturePoints[0].lastPos.y-f.gesturePoints[1].lastPos.y,f.gesturePoints[0].lastPos.x-f.gesturePoints[1].lastPos.x);D=this.viewport.pointFromPixel(f.center,!0),this.viewport.rotateTo(this.viewport.getRotation(!0)+(F-K)*(180/Math.PI),D,!0)}}function Y(f){this.raiseEvent("canvas-focus",{tracker:f.eventSource,originalEvent:f.originalEvent})}function ie(f){this.raiseEvent("canvas-blur",{tracker:f.eventSource,originalEvent:f.originalEvent})}function te(f){var T,D,L,H,U;H=e.now(),U=H-this._lastScrollTime,U>this.minScrollDeltaTime?(this._lastScrollTime=H,T={tracker:f.eventSource,position:f.position,scroll:f.scroll,shift:f.shift,originalEvent:f.originalEvent,preventDefaultAction:!1,preventDefault:!0},this.raiseEvent("canvas-scroll",T),!T.preventDefaultAction&&this.viewport&&(this.viewport.flipped&&(f.position.x=this.viewport.getContainerSize().x-f.position.x),D=this.gestureSettingsByDeviceType(f.pointerType),D.scrollToZoom&&(L=Math.pow(this.zoomPerScroll,f.scroll),this.viewport.zoomBy(L,D.zoomToRefPoint?this.viewport.pointFromPixel(f.position,!0):null),this.viewport.applyConstraints())),f.preventDefault=T.preventDefault):f.preventDefault=!0}function se(f){i[this.hash].mouseInside=!0,g(this),this.raiseEvent("container-enter",{tracker:f.eventSource,pointerType:f.pointerType,position:f.position,buttons:f.buttons,pointers:f.pointers,insideElementPressed:f.insideElementPressed,buttonDownAny:f.buttonDownAny,originalEvent:f.originalEvent})}function Q(f){f.pointers<1&&(i[this.hash].mouseInside=!1,i[this.hash].animating||c(this)),this.raiseEvent("container-exit",{tracker:f.eventSource,pointerType:f.pointerType,position:f.position,buttons:f.buttons,pointers:f.pointers,insideElementPressed:f.insideElementPressed,buttonDownAny:f.buttonDownAny,originalEvent:f.originalEvent})}function me(f){pt(f),f.isOpen()?f._updateRequestId=l(f,me):f._updateRequestId=!1}function xe(f,T){var D=f.viewport,L=D.getZoom(),H=D.getCenter();D.resize(T,f.preserveImageSizeOnResize),D.panTo(H,!0);var U;if(f.preserveImageSizeOnResize)U=i[f.hash].prevContainerSize.x/T.x;else{var F=new e.Point(0,0),K=new e.Point(i[f.hash].prevContainerSize.x,i[f.hash].prevContainerSize.y).distanceTo(F),ne=new e.Point(T.x,T.y).distanceTo(F);U=ne/K*i[f.hash].prevContainerSize.x/T.x}D.zoomTo(L*U,null,!0),i[f.hash].prevContainerSize=T,i[f.hash].forceRedraw=!0,i[f.hash].needsResize=!1,i[f.hash].forceResize=!1}function pt(f){if(!(f._opening||!i[f.hash])){if(f.autoResize||i[f.hash].forceResize){var T;if(f._autoResizePolling){T=s(f.container);var D=i[f.hash].prevContainerSize;T.equals(D)||(i[f.hash].needsResize=!0)}i[f.hash].needsResize&&xe(f,T||s(f.container))}var L=f.viewport.update(),H=f.world.update(L)||L;L&&f.raiseEvent("viewport-change"),f.referenceStrip&&(H=f.referenceStrip.update(f.viewport)||H);var U=i[f.hash].animating;!U&&H&&(f.raiseEvent("animation-start"),g(f));var F=U&&!H;F&&(i[f.hash].animating=!1),(H||F||i[f.hash].forceRedraw||f.world.needsDraw())&&(_t(f),f._drawOverlays(),f.navigator&&f.navigator.update(f.viewport),i[f.hash].forceRedraw=!1,H&&f.raiseEvent("animation")),F&&(f.raiseEvent("animation-finish"),i[f.hash].mouseInside||c(f)),i[f.hash].animating=H}}function _t(f){f.imageLoader.clear(),f.world.draw(),f.raiseEvent("update-viewport",{})}function q(f,T){return f?f+T:T}function ke(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=this.zoomPerSecond,i[this.hash].zooming=!0,Ie(this)}function tt(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=1/this.zoomPerSecond,i[this.hash].zooming=!0,Ie(this)}function Be(){i[this.hash].zooming=!1}function Ie(f){e.requestAnimationFrame(e.delegate(f,kt))}function kt(){var f,T,D;i[this.hash].zooming&&this.viewport&&(f=e.now(),T=f-i[this.hash].lastZoomTime,D=Math.pow(i[this.hash].zoomFactor,T/1e3),this.viewport.zoomBy(D),this.viewport.applyConstraints(),i[this.hash].lastZoomTime=f,Ie(this))}function Tt(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function Fe(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function pi(){this.buttonGroup&&(this.buttonGroup.emulateEnter(),this.buttonGroup.emulateLeave())}function yr(){this.viewport&&this.viewport.goHome()}function mi(){this.isFullPage()&&!e.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttonGroup&&this.buttonGroup.emulateLeave(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function wr(){if(this.viewport){var f=this.viewport.getRotation();this.viewport.flipped?f+=this.rotationIncrement:f-=this.rotationIncrement,this.viewport.setRotation(f)}}function Qt(){if(this.viewport){var f=this.viewport.getRotation();this.viewport.flipped?f-=this.rotationIncrement:f+=this.rotationIncrement,this.viewport.setRotation(f)}}function Ft(){this.viewport.toggleFlip()}e.determineDrawer=function(f){for(let T in t){const D=t[T],L=D.prototype;if(L&&L instanceof t.DrawerBase&&e.isFunction(L.getType)&&L.getType.call(D)===f)return D}return null}})(t),(function(e){e.Navigator=function(l){var h=l.viewer,c=this,d,g;l.element||l.id?(l.element?(l.id&&e.console.warn("Given option.id for Navigator was ignored since option.element was provided and is being used instead."),l.element.id?l.id=l.element.id:l.id="navigator-"+e.now(),this.element=l.element):this.element=document.getElementById(l.id),l.controlOptions={anchor:e.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(l.id="navigator-"+e.now(),this.element=e.makeNeutralElement("div"),l.controlOptions={anchor:e.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:l.autoFade},l.position&&(l.position==="BOTTOM_RIGHT"?l.controlOptions.anchor=e.ControlAnchor.BOTTOM_RIGHT:l.position==="BOTTOM_LEFT"?l.controlOptions.anchor=e.ControlAnchor.BOTTOM_LEFT:l.position==="TOP_RIGHT"?l.controlOptions.anchor=e.ControlAnchor.TOP_RIGHT:l.position==="TOP_LEFT"?l.controlOptions.anchor=e.ControlAnchor.TOP_LEFT:l.position==="ABSOLUTE"&&(l.controlOptions.anchor=e.ControlAnchor.ABSOLUTE,l.controlOptions.top=l.top,l.controlOptions.left=l.left,l.controlOptions.height=l.height,l.controlOptions.width=l.width))),this.element.id=l.id,this.element.className+=" navigator",l=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.navigatorSizeRatio},l,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:l.animationTime,autoResize:!1,minZoomImageRatio:1,background:l.background,opacity:l.opacity,borderColor:l.borderColor,displayRegionColor:l.displayRegionColor}),l.minPixelRatio=this.minPixelRatio=h.minPixelRatio,e.setElementTouchActionNone(this.element),this.borderWidth=2,this.fudge=new e.Point(1,1),this.totalBorderWidths=new e.Point(this.borderWidth*2,this.borderWidth*2).minus(this.fudge),l.controlOptions.anchor!==e.ControlAnchor.NONE&&(function(w,x){w.margin="0px",w.border=x+"px solid "+l.borderColor,w.padding="0px",w.background=l.background,w.opacity=l.opacity,w.overflow="hidden"})(this.element.style,this.borderWidth),this.displayRegion=e.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",(function(w,x){w.position="relative",w.top="0px",w.left="0px",w.fontSize="0px",w.overflow="hidden",w.border=x+"px solid "+l.displayRegionColor,w.margin="0px",w.padding="0px",w.background="transparent",w.float="left",w.cssFloat="left",w.zIndex=999999999,w.cursor="default",w.boxSizing="content-box"})(this.displayRegion.style,this.borderWidth),e.setElementPointerEventsNone(this.displayRegion),e.setElementTouchActionNone(this.displayRegion),this.displayRegionContainer=e.makeNeutralElement("div"),this.displayRegionContainer.id=this.element.id+"-displayregioncontainer",this.displayRegionContainer.className="displayregioncontainer",this.displayRegionContainer.style.width="100%",this.displayRegionContainer.style.height="100%",e.setElementPointerEventsNone(this.displayRegionContainer),e.setElementTouchActionNone(this.displayRegionContainer),h.addControl(this.element,l.controlOptions),this._resizeWithViewer=l.controlOptions.anchor!==e.ControlAnchor.ABSOLUTE&&l.controlOptions.anchor!==e.ControlAnchor.NONE,l.width&&l.height?(this.setWidth(l.width),this.setHeight(l.height)):this._resizeWithViewer&&(d=e.getElementSize(h.element),this.element.style.height=Math.round(d.y*l.sizeRatio)+"px",this.element.style.width=Math.round(d.x*l.sizeRatio)+"px",this.oldViewerSize=d,g=e.getElementSize(this.element),this.elementArea=g.x*g.y),this.oldContainerSize=new e.Point(0,0),e.Viewer.apply(this,[l]),this.displayRegionContainer.appendChild(this.displayRegion),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer);function p(w,x){o(c.displayRegionContainer,w),o(c.displayRegion,-w),c.viewport.setRotation(w,x)}if(l.navigatorRotate){var v=l.viewer.viewport?l.viewer.viewport.getRotation():l.viewer.degrees||0;p(v,!0),l.viewer.addHandler("rotate",function(w){p(w.degrees,w.immediately)})}this.innerTracker.destroy(),this.innerTracker=new e.MouseTracker({userData:"Navigator.innerTracker",element:this.element,dragHandler:e.delegate(this,r),clickHandler:e.delegate(this,i),releaseHandler:e.delegate(this,s),scrollHandler:e.delegate(this,n),preProcessEventHandler:function(w){w.eventType==="wheel"&&(w.preventDefault=!0)}}),this.outerTracker.userData="Navigator.outerTracker",e.setElementPointerEventsNone(this.canvas),e.setElementPointerEventsNone(this.container),this.addHandler("reset-size",function(){c.viewport&&c.viewport.goHome(!0)}),h.world.addHandler("item-index-change",function(w){window.setTimeout(function(){var x=c.world.getItemAt(w.previousIndex);c.world.setItemIndex(x,w.newIndex)},1)}),h.world.addHandler("remove-item",function(w){var x=w.item,C=c._getMatchingItem(x);C&&c.world.removeItem(C)}),this.update(h.viewport)},e.extend(e.Navigator.prototype,e.EventSource.prototype,e.Viewer.prototype,{updateSize:function(){if(this.viewport){var l=new e.Point(this.container.clientWidth===0?1:this.container.clientWidth,this.container.clientHeight===0?1:this.container.clientHeight);l.equals(this.oldContainerSize)||(this.viewport.resize(l,!0),this.viewport.goHome(!0),this.oldContainerSize=l,this.world.update(),this.world.draw(),this.update(this.viewer.viewport))}},setWidth:function(l){this.width=l,this.element.style.width=typeof l=="number"?l+"px":l,this._resizeWithViewer=!1,this.updateSize()},setHeight:function(l){this.height=l,this.element.style.height=typeof l=="number"?l+"px":l,this._resizeWithViewer=!1,this.updateSize()},setFlip:function(l){return this.viewport.setFlip(l),this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)"),this},setDisplayTransform:function(l){a(this.canvas,l),a(this.element,l)},update:function(l){var h,c,d,g,p,v;if(l||(l=this.viewer.viewport),h=e.getElementSize(this.viewer.element),this._resizeWithViewer&&h.x&&h.y&&!h.equals(this.oldViewerSize)&&(this.oldViewerSize=h,this.maintainSizeRatio||!this.elementArea?(c=h.x*this.sizeRatio,d=h.y*this.sizeRatio):(c=Math.sqrt(this.elementArea*(h.x/h.y)),d=this.elementArea/c),this.element.style.width=Math.round(c)+"px",this.element.style.height=Math.round(d)+"px",this.elementArea||(this.elementArea=c*d),this.updateSize()),l&&this.viewport){if(g=l.getBoundsNoRotate(!0),p=this.viewport.pixelFromPointNoRotate(g.getTopLeft(),!1),v=this.viewport.pixelFromPointNoRotate(g.getBottomRight(),!1).minus(this.totalBorderWidths),!this.navigatorRotate){var w=l.getRotation(!0);o(this.displayRegion,-w)}var x=this.displayRegion.style;x.display=this.world.getItemCount()?"block":"none",x.top=p.y.toFixed(2)+"px",x.left=p.x.toFixed(2)+"px";var C=v.x-p.x,P=v.y-p.y;x.width=Math.round(Math.max(C,0))+"px",x.height=Math.round(Math.max(P,0))+"px"}},addTiledImage:function(l){var h=this,c=l.originalTiledImage;delete l.original;var d=e.extend({},l,{success:function(g){var p=g.item;p._originalForNavigator=c,h._matchBounds(p,c,!0),h._matchOpacity(p,c),h._matchCompositeOperation(p,c);function v(){h._matchBounds(p,c)}function w(){h._matchOpacity(p,c)}function x(){h._matchCompositeOperation(p,c)}c.addHandler("bounds-change",v),c.addHandler("clip-change",v),c.addHandler("opacity-change",w),c.addHandler("composite-operation-change",x)}});return e.Viewer.prototype.addTiledImage.apply(this,[d])},destroy:function(){return e.Viewer.prototype.destroy.apply(this)},_getMatchingItem:function(l){for(var h=this.world.getItemCount(),c,d=0;d<h;d++)if(c=this.world.getItemAt(d),c._originalForNavigator===l)return c;return null},_matchBounds:function(l,h,c){var d=h.getBoundsNoRotate();l.setPosition(d.getTopLeft(),c),l.setWidth(d.width,c),l.setRotation(h.getRotation(),c),l.setClip(h.getClip()),l.setFlip(h.getFlip())},_matchOpacity:function(l,h){l.setOpacity(h.opacity)},_matchCompositeOperation:function(l,h){l.setCompositeOperation(h.compositeOperation)}});function i(l){var h={tracker:l.eventSource,position:l.position,quick:l.quick,shift:l.shift,originalEvent:l.originalEvent,preventDefaultAction:!1};if(this.viewer.raiseEvent("navigator-click",h),!h.preventDefaultAction&&l.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)){this.viewer.viewport.flipped&&(l.position.x=this.viewport.getContainerSize().x-l.position.x);var c=this.viewport.pointFromPixel(l.position);this.panVertical?this.panHorizontal||(c.x=this.viewer.viewport.getCenter(!0).x):c.y=this.viewer.viewport.getCenter(!0).y,this.viewer.viewport.panTo(c),this.viewer.viewport.applyConstraints()}}function r(l){var h={tracker:l.eventSource,position:l.position,delta:l.delta,speed:l.speed,direction:l.direction,shift:l.shift,originalEvent:l.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-drag",h),!h.preventDefaultAction&&this.viewer.viewport&&(this.panHorizontal||(l.delta.x=0),this.panVertical||(l.delta.y=0),this.viewer.viewport.flipped&&(l.delta.x=-l.delta.x),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(l.delta)),this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints())}function s(l){l.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function n(l){var h={tracker:l.eventSource,position:l.position,scroll:l.scroll,shift:l.shift,originalEvent:l.originalEvent,preventDefault:l.preventDefault};this.viewer.raiseEvent("navigator-scroll",h),l.preventDefault=h.preventDefault}function o(l,h){a(l,"rotate("+h+"deg)")}function a(l,h){l.style.webkitTransform=h,l.style.mozTransform=h,l.style.msTransform=h,l.style.oTransform=h,l.style.transform=h}})(t),(function(e){var i={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};e.extend(e,{getString:function(r){var s=r.split("."),n=null,o=arguments,a=i,l;for(l=0;l<s.length-1;l++)a=a[s[l]]||{};return n=a[s[l]],typeof n!="string"&&(e.console.error("Untranslated source string:",r),n=""),n.replace(/\{\d+\}/g,function(h){var c=parseInt(h.match(/\d+/),10)+1;return c<o.length?o[c]:""})},setString:function(r,s){var n=r.split("."),o=i,a;for(a=0;a<n.length-1;a++)o[n[a]]||(o[n[a]]={}),o=o[n[a]];o[n[a]]=s}})})(t),(function(e){e.Point=function(i,r){this.x=typeof i=="number"?i:0,this.y=typeof r=="number"?r:0},e.Point.prototype={clone:function(){return new e.Point(this.x,this.y)},plus:function(i){return new e.Point(this.x+i.x,this.y+i.y)},minus:function(i){return new e.Point(this.x-i.x,this.y-i.y)},times:function(i){return new e.Point(this.x*i,this.y*i)},divide:function(i){return new e.Point(this.x/i,this.y/i)},negate:function(){return new e.Point(-this.x,-this.y)},distanceTo:function(i){return Math.sqrt(Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2))},squaredDistanceTo:function(i){return Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2)},apply:function(i){return new e.Point(i(this.x),i(this.y))},equals:function(i){return i instanceof e.Point&&this.x===i.x&&this.y===i.y},rotate:function(i,r){r=r||new e.Point(0,0);var s,n;if(i%90===0){var o=e.positiveModulo(i,360);switch(o){case 0:s=1,n=0;break;case 90:s=0,n=1;break;case 180:s=-1,n=0;break;case 270:s=0,n=-1;break}}else{var a=i*Math.PI/180;s=Math.cos(a),n=Math.sin(a)}var l=s*(this.x-r.x)-n*(this.y-r.y)+r.x,h=n*(this.x-r.x)+s*(this.y-r.y)+r.y;return new e.Point(l,h)},toString:function(){return"("+Math.round(this.x*100)/100+","+Math.round(this.y*100)/100+")"}}})(t),(function(e){e.TileSource=function(r,s,n,o,a,l){var h=this,c=arguments,d,g;if(e.isPlainObject(r)?d=r:d={width:c[0],height:c[1],tileSize:c[2],tileOverlap:c[3],minLevel:c[4],maxLevel:c[5]},e.EventSource.call(this),e.extend(!0,this,d),!this.success){for(g=0;g<arguments.length;g++)if(e.isFunction(arguments[g])){this.success=arguments[g];break}}this.success&&this.addHandler("ready",function(p){h.success(p)}),e.type(arguments[0])==="string"&&(this.url=arguments[0]),this.url?(this.aspectRatio=1,this.dimensions=new e.Point(10,10),this._tileWidth=0,this._tileHeight=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(this.url)):(this.ready=!0,this.aspectRatio=d.width&&d.height?d.width/d.height:1,this.dimensions=new e.Point(d.width,d.height),this.tileSize?(this._tileWidth=this._tileHeight=this.tileSize,delete this.tileSize):(this.tileWidth?(this._tileWidth=this.tileWidth,delete this.tileWidth):this._tileWidth=0,this.tileHeight?(this._tileHeight=this.tileHeight,delete this.tileHeight):this._tileHeight=0),this.tileOverlap=d.tileOverlap?d.tileOverlap:0,this.minLevel=d.minLevel?d.minLevel:0,this.maxLevel=d.maxLevel!==void 0&&d.maxLevel!==null?d.maxLevel:d.width&&d.height?Math.ceil(Math.log(Math.max(d.width,d.height))/Math.log(2)):0,this.success&&e.isFunction(this.success)&&this.success(this))},e.TileSource.prototype={getTileSize:function(r){return e.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead"),this._tileWidth},getTileWidth:function(r){return this._tileWidth?this._tileWidth:this.getTileSize(r)},getTileHeight:function(r){return this._tileHeight?this._tileHeight:this.getTileSize(r)},setMaxLevel:function(r){this.maxLevel=r,this._memoizeLevelScale()},getLevelScale:function(r){return this._memoizeLevelScale(),this.getLevelScale(r)},_memoizeLevelScale:function(){var r={},s;for(s=0;s<=this.maxLevel;s++)r[s]=1/Math.pow(2,this.maxLevel-s);this.getLevelScale=function(n){return r[n]}},getNumTiles:function(r){var s=this.getLevelScale(r),n=Math.ceil(s*this.dimensions.x/this.getTileWidth(r)),o=Math.ceil(s*this.dimensions.y/this.getTileHeight(r));return new e.Point(n,o)},getPixelRatio:function(r){var s=this.dimensions.times(this.getLevelScale(r)),n=1/s.x*e.pixelDensityRatio,o=1/s.y*e.pixelDensityRatio;return new e.Point(n,o)},getClosestLevel:function(){var r,s;for(r=this.minLevel+1;r<=this.maxLevel&&(s=this.getNumTiles(r),!(s.x>1||s.y>1));r++);return r-1},getTileAtPoint:function(r,s){var n=s.x>=0&&s.x<=1&&s.y>=0&&s.y<=1/this.aspectRatio;e.console.assert(n,"[TileSource.getTileAtPoint] must be called with a valid point.");var o=this.dimensions.x*this.getLevelScale(r),a=s.x*o,l=s.y*o,h=Math.floor(a/this.getTileWidth(r)),c=Math.floor(l/this.getTileHeight(r));s.x>=1&&(h=this.getNumTiles(r).x-1);var d=1e-15;return s.y>=1/this.aspectRatio-d&&(c=this.getNumTiles(r).y-1),new e.Point(h,c)},getTileBounds:function(r,s,n,o){var a=this.dimensions.times(this.getLevelScale(r)),l=this.getTileWidth(r),h=this.getTileHeight(r),c=s===0?0:l*s-this.tileOverlap,d=n===0?0:h*n-this.tileOverlap,g=l+(s===0?1:2)*this.tileOverlap,p=h+(n===0?1:2)*this.tileOverlap,v=1/a.x;return g=Math.min(g,a.x-c),p=Math.min(p,a.y-d),o?new e.Rect(0,0,g,p):new e.Rect(c*v,d*v,g*v,p*v)},getImageInfo:function(r){var s=this,n,o,a,l,h,c,d;r&&(h=r.split("/"),c=h[h.length-1],d=c.lastIndexOf("."),d>-1&&(h[h.length-1]=c.slice(0,d)));var g=null;if(this.splitHashDataForPost){var p=r.indexOf("#");p!==-1&&(g=r.substring(p+1),r=r.substr(0,p))}o=function(v){typeof v=="string"&&(v=e.parseXml(v));var w=e.TileSource.determineType(s,v,r);if(!w){s.raiseEvent("open-failed",{message:"Unable to load TileSource",source:r});return}l=w.prototype.configure.apply(s,[v,r,g]),l.ajaxWithCredentials===void 0&&(l.ajaxWithCredentials=s.ajaxWithCredentials),a=new w(l),s.ready=!0,s.raiseEvent("ready",{tileSource:a})},r.match(/\.js$/)?(n=r.split("/").pop().replace(".js",""),e.jsonp({url:r,async:!1,callbackName:n,callback:o})):e.makeAjaxRequest({url:r,postData:g,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(v){var w=i(v);o(w)},error:function(v,w){var x;try{x="HTTP "+v.status+" attempting to load TileSource: "+r}catch{var C;typeof w>"u"||!w.toString?C="Unknown error":C=w.toString(),x=C+" attempting to load TileSource: "+r}e.console.error(x),s.raiseEvent("open-failed",{message:x,source:r,postData:g})}})},supports:function(r,s){return!1},configure:function(r,s,n){throw new Error("Method not implemented.")},getTileUrl:function(r,s,n){throw new Error("Method not implemented.")},getTilePostData:function(r,s,n){return null},getTileAjaxHeaders:function(r,s,n){return{}},getTileHashKey:function(r,s,n,o,a,l){function h(c){return a?c+"+"+JSON.stringify(a):c}return h(typeof o!="string"?r+"/"+s+"_"+n:o)},tileExists:function(r,s,n){var o=this.getNumTiles(r);return r>=this.minLevel&&r<=this.maxLevel&&s>=0&&n>=0&&s<o.x&&n<o.y},hasTransparency:function(r,s,n,o){return!!r||s.match(".png")},downloadTileStart:function(r){var s=r.userData,n=new Image;s.image=n,s.request=null;var o=function(a){if(!n){r.finish(null,s.request,"Image load failed: undefined Image instance.");return}n.onload=n.onerror=n.onabort=null,r.finish(a?null:n,s.request,a)};n.onload=function(){o()},n.onabort=n.onerror=function(){o("Image load aborted.")},r.loadWithAjax?s.request=e.makeAjaxRequest({url:r.src,withCredentials:r.ajaxWithCredentials,headers:r.ajaxHeaders,responseType:"arraybuffer",postData:r.postData,success:function(a){var l;try{l=new window.Blob([a.response])}catch(d){var h=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(d.name==="TypeError"&&h){var c=new h;c.append(a.response),l=c.getBlob()}}l.size===0?o("Empty image response."):n.src=(window.URL||window.webkitURL).createObjectURL(l)},error:function(a){o("Image load aborted - XHR error")}}):(r.crossOriginPolicy!==!1&&(n.crossOrigin=r.crossOriginPolicy),n.src=r.src)},downloadTileAbort:function(r){r.userData.request&&r.userData.request.abort();var s=r.userData.image;r.userData.image&&(s.onload=s.onerror=s.onabort=null)},createTileCache:function(r,s,n){r._data=s},destroyTileCache:function(r){r._data=null,r._renderedContext=null},getTileCacheData:function(r){return r._data},getTileCacheDataAsImage:function(r){return r._data},getTileCacheDataAsContext2D:function(r){if(!r._renderedContext){var s=document.createElement("canvas");s.width=r._data.width,s.height=r._data.height,r._renderedContext=s.getContext("2d"),r._renderedContext.drawImage(r._data,0,0),r._data=null}return r._renderedContext}},e.extend(!0,e.TileSource.prototype,e.EventSource.prototype);function i(r){var s=r.responseText,n=r.status,o,a;if(r){if(r.status!==200&&r.status!==0)throw n=r.status,o=n===404?"Not Found":r.statusText,new Error(e.getString("Errors.Status",n,o))}else throw new Error(e.getString("Errors.Security"));if(s.match(/^\s*<.*/))try{a=r.responseXML&&r.responseXML.documentElement?r.responseXML:e.parseXml(s)}catch{a=r.responseText}else if(s.match(/\s*[{[].*/))try{a=e.parseJSON(s)}catch{a=s}else a=s;return a}e.TileSource.determineType=function(r,s,n){var o;for(o in t)if(o.match(/.+TileSource$/)&&e.isFunction(t[o])&&e.isFunction(t[o].prototype.supports)&&t[o].prototype.supports.call(r,s,n))return t[o];return e.console.error("No TileSource was able to open %s %s",n,s),null}})(t),(function(e){e.DziTileSource=function(s,n,o,a,l,h,c,d,g){var p,v,w,x;if(e.isPlainObject(s)?x=s:x={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4],fileFormat:arguments[5],displayRects:arguments[6],minLevel:arguments[7],maxLevel:arguments[8]},this._levelRects={},this.tilesUrl=x.tilesUrl,this.fileFormat=x.fileFormat,this.displayRects=x.displayRects,this.displayRects)for(p=this.displayRects.length-1;p>=0;p--)for(v=this.displayRects[p],w=v.minLevel;w<=v.maxLevel;w++)this._levelRects[w]||(this._levelRects[w]=[]),this._levelRects[w].push(v);e.TileSource.apply(this,[x])},e.extend(e.DziTileSource.prototype,e.TileSource.prototype,{supports:function(s,n){var o;return s.Image?o=s.Image.xmlns:s.documentElement&&(s.documentElement.localName==="Image"||s.documentElement.tagName==="Image")&&(o=s.documentElement.namespaceURI),o=(o||"").toLowerCase(),o.indexOf("schemas.microsoft.com/deepzoom/2008")!==-1||o.indexOf("schemas.microsoft.com/deepzoom/2009")!==-1},configure:function(s,n,o){var a;return e.isPlainObject(s)?a=r(this,s):a=i(this,s),n&&!a.tilesUrl&&(a.tilesUrl=n.replace(/([^/]+?)(\.(dzi|xml|js)?(\?[^/]*)?)?\/?$/,"$1_files/"),n.search(/\.(dzi|xml|js)\?/)!==-1?a.queryParams=n.match(/\?.*/):a.queryParams=""),a},getTileUrl:function(s,n,o){return[this.tilesUrl,s,"/",n,"_",o,".",this.fileFormat,this.queryParams].join("")},tileExists:function(s,n,o){var a=this._levelRects[s],l,h,c,d,g,p,v;if(this.minLevel&&s<this.minLevel||this.maxLevel&&s>this.maxLevel)return!1;if(!a||!a.length)return!0;for(v=a.length-1;v>=0;v--)if(l=a[v],!(s<l.minLevel||s>l.maxLevel)&&(h=this.getLevelScale(s),c=l.x*h,d=l.y*h,g=c+l.width*h,p=d+l.height*h,c=Math.floor(c/this._tileWidth),d=Math.floor(d/this._tileWidth),g=Math.ceil(g/this._tileWidth),p=Math.ceil(p/this._tileWidth),c<=n&&n<g&&d<=o&&o<p))return!0;return!1}});function i(s,n){if(!n||!n.documentElement)throw new Error(e.getString("Errors.Xml"));var o=n.documentElement,a=o.localName||o.tagName,l=n.documentElement.namespaceURI,h=null,c=[],d,g,p,v,w;if(a==="Image")try{if(v=o.getElementsByTagName("Size")[0],v===void 0&&(v=o.getElementsByTagNameNS(l,"Size")[0]),h={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:o.getAttribute("Url"),Format:o.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(o.getAttribute("Overlap"),10),TileSize:parseInt(o.getAttribute("TileSize"),10),Size:{Height:parseInt(v.getAttribute("Height"),10),Width:parseInt(v.getAttribute("Width"),10)}}},!e.imageFormatSupported(h.Image.Format))throw new Error(e.getString("Errors.ImageFormat",h.Image.Format.toUpperCase()));for(d=o.getElementsByTagName("DisplayRect"),d===void 0&&(d=o.getElementsByTagNameNS(l,"DisplayRect")[0]),w=0;w<d.length;w++)g=d[w],p=g.getElementsByTagName("Rect")[0],p===void 0&&(p=g.getElementsByTagNameNS(l,"Rect")[0]),c.push({Rect:{X:parseInt(p.getAttribute("X"),10),Y:parseInt(p.getAttribute("Y"),10),Width:parseInt(p.getAttribute("Width"),10),Height:parseInt(p.getAttribute("Height"),10),MinLevel:parseInt(g.getAttribute("MinLevel"),10),MaxLevel:parseInt(g.getAttribute("MaxLevel"),10)}});return c.length&&(h.Image.DisplayRect=c),r(s,h)}catch(P){throw P instanceof Error?P:new Error(e.getString("Errors.Dzi"))}else{if(a==="Collection")throw new Error(e.getString("Errors.Dzc"));if(a==="Error"){var x=o.getElementsByTagName("Message")[0],C=x.firstChild.nodeValue;throw new Error(C)}}throw new Error(e.getString("Errors.Dzi"))}function r(s,n){var o=n.Image,a=o.Url,l=o.Format,h=o.Size,c=o.DisplayRect||[],d=parseInt(h.Width,10),g=parseInt(h.Height,10),p=parseInt(o.TileSize,10),v=parseInt(o.Overlap,10),w=[],x,C;for(C=0;C<c.length;C++)x=c[C].Rect,w.push(new e.DisplayRect(parseInt(x.X,10),parseInt(x.Y,10),parseInt(x.Width,10),parseInt(x.Height,10),parseInt(x.MinLevel,10),parseInt(x.MaxLevel,10)));return e.extend(!0,{width:d,height:g,tileSize:p,tileOverlap:v,minLevel:null,maxLevel:null,tilesUrl:a,fileFormat:l,displayRects:w},n)}})(t),(function(e){e.IIIFTileSource=function(o){if(e.extend(!0,this,o),this._id=this["@id"]||this.id||this.identifier||null,!(this.height&&this.width&&this._id))throw new Error("IIIF required parameters (width, height, or id) not provided.");if(o.tileSizePerScaleFactor={},this.tileFormat=this.tileFormat||"jpg",this.version=o.version,this.tile_width&&this.tile_height)o.tileWidth=this.tile_width,o.tileHeight=this.tile_height;else if(this.tile_width)o.tileSize=this.tile_width;else if(this.tile_height)o.tileSize=this.tile_height;else if(this.tiles)if(this.tiles.length===1)o.tileWidth=this.tiles[0].width,o.tileHeight=this.tiles[0].height||this.tiles[0].width,this.scale_factors=this.tiles[0].scaleFactors;else{this.scale_factors=[];for(var a=0;a<this.tiles.length;a++)for(var l=0;l<this.tiles[a].scaleFactors.length;l++){var h=this.tiles[a].scaleFactors[l];this.scale_factors.push(h),o.tileSizePerScaleFactor[h]={width:this.tiles[a].width,height:this.tiles[a].height||this.tiles[a].width}}}else if(i(o)){for(var c=Math.min(this.height,this.width),d=[256,512,1024],g=[],p=0;p<d.length;p++)d[p]<=c&&g.push(d[p]);g.length>0?o.tileSize=Math.max.apply(null,g):o.tileSize=c}else this.sizes&&this.sizes.length>0?(this.emulateLegacyImagePyramid=!0,o.levels=r(this),e.extend(!0,o,{width:o.levels[o.levels.length-1].width,height:o.levels[o.levels.length-1].height,tileSize:Math.max(o.height,o.width),tileOverlap:0,minLevel:0,maxLevel:o.levels.length-1}),this.levels=o.levels):e.console.error("Nothing in the info.json to construct image pyramids from");if(!o.maxLevel&&!this.emulateLegacyImagePyramid)if(!this.scale_factors)o.maxLevel=Number(Math.round(Math.log(Math.max(this.width,this.height),2)));else{var v=Math.max.apply(null,this.scale_factors);o.maxLevel=Math.round(Math.log(v)*Math.LOG2E)}if(this.sizes){var w=this.sizes.length;(w===o.maxLevel||w===o.maxLevel+1)&&(this.levelSizes=this.sizes.slice().sort((x,C)=>x.width-C.width),w===o.maxLevel&&this.levelSizes.push({width:this.width,height:this.height}))}e.TileSource.apply(this,[o])},e.extend(e.IIIFTileSource.prototype,e.TileSource.prototype,{supports:function(o,a){return o.protocol&&o.protocol==="http://iiif.io/api/image"||o["@context"]&&(o["@context"]==="http://library.stanford.edu/iiif/image-api/1.1/context.json"||o["@context"]==="http://iiif.io/api/image/1/context.json")||o.profile&&o.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html")===0||o.identifier&&o.width&&o.height?!0:!!(o.documentElement&&o.documentElement.tagName==="info"&&o.documentElement.namespaceURI==="http://library.stanford.edu/iiif/image-api/ns/")},configure:function(o,a,l){if(e.isPlainObject(o)){if(!o["@context"])o["@context"]="http://iiif.io/api/image/1.0/context.json",o["@id"]=a.replace("/info.json",""),o.version=1;else{var c=o["@context"];if(Array.isArray(c)){for(var d=0;d<c.length;d++)if(typeof c[d]=="string"&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(c[d])||c[d]==="http://library.stanford.edu/iiif/image-api/1.1/context.json")){c=c[d];break}}switch(c){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":o.version=1;break;case"http://iiif.io/api/image/2/context.json":o.version=2;break;case"http://iiif.io/api/image/3/context.json":o.version=3;break;default:e.console.error("Data has a @context property which contains no known IIIF context URI.")}}if(o.preferredFormats){for(var g=0;g<o.preferredFormats.length;g++)if(t.imageFormatSupported(o.preferredFormats[g])){o.tileFormat=o.preferredFormats[g];break}}return o}else{var h=s(o);return h["@context"]="http://iiif.io/api/image/1.0/context.json",h["@id"]=a.replace("/info.xml",""),h.version=1,h}},getTileWidth:function(o){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileWidth.call(this,o);var a=Math.pow(2,this.maxLevel-o);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[a]?this.tileSizePerScaleFactor[a].width:this._tileWidth},getTileHeight:function(o){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileHeight.call(this,o);var a=Math.pow(2,this.maxLevel-o);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[a]?this.tileSizePerScaleFactor[a].height:this._tileHeight},getLevelScale:function(o){if(this.emulateLegacyImagePyramid){var a=NaN;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(a=this.levels[o].width/this.levels[this.maxLevel].width),a}return e.TileSource.prototype.getLevelScale.call(this,o)},getNumTiles:function(o){if(this.emulateLegacyImagePyramid){var a=this.getLevelScale(o);return a?new e.Point(1,1):new e.Point(0,0)}if(this.levelSizes){var l=this.levelSizes[o],h=Math.ceil(l.width/this.getTileWidth(o)),c=Math.ceil(l.height/this.getTileHeight(o));return new e.Point(h,c)}else return e.TileSource.prototype.getNumTiles.call(this,o)},getTileAtPoint:function(o,a){if(this.emulateLegacyImagePyramid)return new e.Point(0,0);if(this.levelSizes){var l=a.x>=0&&a.x<=1&&a.y>=0&&a.y<=1/this.aspectRatio;e.console.assert(l,"[TileSource.getTileAtPoint] must be called with a valid point.");var h=this.levelSizes[o].width,c=a.x*h,d=a.y*h,g=Math.floor(c/this.getTileWidth(o)),p=Math.floor(d/this.getTileHeight(o));a.x>=1&&(g=this.getNumTiles(o).x-1);var v=1e-15;return a.y>=1/this.aspectRatio-v&&(p=this.getNumTiles(o).y-1),new e.Point(g,p)}return e.TileSource.prototype.getTileAtPoint.call(this,o,a)},getTileUrl:function(o,a,l){if(this.emulateLegacyImagePyramid){var h=null;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(h=this.levels[o].url),h}var c="0",d=Math.pow(.5,this.maxLevel-o),g,p,v,w,x,C,P,k,R,A,j,I,W,$,Z,z;return this.levelSizes?(g=this.levelSizes[o].width,p=this.levelSizes[o].height):(g=Math.ceil(this.width*d),p=Math.ceil(this.height*d)),v=this.getTileWidth(o),w=this.getTileHeight(o),x=Math.round(v/d),C=Math.round(w/d),this.version===1?Z="native."+this.tileFormat:Z="default."+this.tileFormat,g<v&&p<w?(this.version===2&&g===this.width?I="full":this.version===3&&g===this.width&&p===this.height?I="max":this.version===3?I=g+","+p:I=g+",",P="full"):(k=a*x,R=l*C,A=Math.min(x,this.width-k),j=Math.min(C,this.height-R),a===0&&l===0&&A===this.width&&j===this.height?P="full":P=[k,R,A,j].join(","),W=Math.min(v,g-a*v),$=Math.min(w,p-l*w),this.version===2&&W===this.width?I="full":this.version===3&&W===this.width&&$===this.height?I="max":this.version===3?I=W+","+$:I=W+","),z=[this._id,P,I,c,Z].join("/"),z},__testonly__:{canBeTiled:i,constructLevels:r}});function i(o){var a=["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"],l=Array.isArray(o.profile)?o.profile[0]:o.profile,h=a.indexOf(l)!==-1,c=!1;return o.version===2&&o.profile.length>1&&o.profile[1].supports&&(c=o.profile[1].supports.indexOf("sizeByW")!==-1),o.version===3&&o.extraFeatures&&(c=o.extraFeatures.indexOf("sizeByWh")!==-1),!h||c}function r(o){for(var a=[],l=0;l<o.sizes.length;l++)a.push({url:o._id+"/full/"+o.sizes[l].width+","+(o.version===3?o.sizes[l].height:"")+"/0/default."+o.tileFormat,width:o.sizes[l].width,height:o.sizes[l].height});return a.sort(function(h,c){return h.width-c.width})}function s(o){if(!o||!o.documentElement)throw new Error(e.getString("Errors.Xml"));var a=o.documentElement,l=a.tagName,h=null;if(l==="info")try{return h={},n(a,h),h}catch(c){throw c instanceof Error?c:new Error(e.getString("Errors.IIIF"))}throw new Error(e.getString("Errors.IIIF"))}function n(o,a,l){var h,c;if(o.nodeType===3&&l)c=o.nodeValue.trim(),c.match(/^\d*$/)&&(c=Number(c)),a[l]?(e.isArray(a[l])||(a[l]=[a[l]]),a[l].push(c)):a[l]=c;else if(o.nodeType===1)for(h=0;h<o.childNodes.length;h++)n(o.childNodes[h],a,o.nodeName)}})(t),(function(e){e.OsmTileSource=function(i,r,s,n,o){var a;e.isPlainObject(i)?a=i:a={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]},(!a.width||!a.height)&&(a.width=65572864,a.height=65572864),a.tileSize||(a.tileSize=256,a.tileOverlap=0),a.tilesUrl||(a.tilesUrl="http://tile.openstreetmap.org/"),a.minLevel=8,e.TileSource.apply(this,[a])},e.extend(e.OsmTileSource.prototype,e.TileSource.prototype,{supports:function(i,r){return i.type&&i.type==="openstreetmaps"},configure:function(i,r,s){return i},getTileUrl:function(i,r,s){return this.tilesUrl+(i-8)+"/"+r+"/"+s+".png"}})})(t),(function(e){e.TmsTileSource=function(i,r,s,n,o){var a;e.isPlainObject(i)?a=i:a={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]};var l=Math.ceil(a.width/256)*256,h=Math.ceil(a.height/256)*256,c;l>h?c=l/256:c=h/256,a.maxLevel=Math.ceil(Math.log(c)/Math.log(2))-1,a.tileSize=256,a.width=l,a.height=h,e.TileSource.apply(this,[a])},e.extend(e.TmsTileSource.prototype,e.TileSource.prototype,{supports:function(i,r){return i.type&&i.type==="tiledmapservice"},configure:function(i,r,s){return i},getTileUrl:function(i,r,s){var n=this.getNumTiles(i).y-1;return this.tilesUrl+i+"/"+r+"/"+(n-s)+".png"}})})(t),(function(e){e.ZoomifyTileSource=function(i){typeof i.tileSize>"u"&&(i.tileSize=256),typeof i.fileFormat>"u"&&(i.fileFormat="jpg",this.fileFormat=i.fileFormat);var r={x:i.width,y:i.height};for(i.imageSizes=[{x:i.width,y:i.height}],i.gridSize=[this._getGridSize(i.width,i.height,i.tileSize)];parseInt(r.x,10)>i.tileSize||parseInt(r.y,10)>i.tileSize;)r.x=Math.floor(r.x/2),r.y=Math.floor(r.y/2),i.imageSizes.push({x:r.x,y:r.y}),i.gridSize.push(this._getGridSize(r.x,r.y,i.tileSize));i.imageSizes.reverse(),i.gridSize.reverse(),i.minLevel=0,i.maxLevel=i.gridSize.length-1,t.TileSource.apply(this,[i])},e.extend(e.ZoomifyTileSource.prototype,e.TileSource.prototype,{_getGridSize:function(i,r,s){return{x:Math.ceil(i/s),y:Math.ceil(r/s)}},_calculateAbsoluteTileNumber:function(i,r,s){for(var n=0,o={},a=0;a<i;a++)o=this.gridSize[a],n+=o.x*o.y;return o=this.gridSize[i],n+=o.x*s+r,n},supports:function(i,r){return i.type&&i.type==="zoomifytileservice"},configure:function(i,r,s){return i},getTileUrl:function(i,r,s){var n=0,o=this._calculateAbsoluteTileNumber(i,r,s);return n=Math.floor(o/256),this.tilesUrl+"TileGroup"+n+"/"+i+"-"+r+"-"+s+"."+this.fileFormat}})})(t),(function(e){e.LegacyTileSource=function(n){var o,a,l;e.isArray(n)&&(o={type:"legacy-image-pyramid",levels:n}),o.levels=i(o.levels),o.levels.length>0?(a=o.levels[o.levels.length-1].width,l=o.levels[o.levels.length-1].height):(a=0,l=0,e.console.error("No supported image formats found")),e.extend(!0,o,{width:a,height:l,tileSize:Math.max(l,a),tileOverlap:0,minLevel:0,maxLevel:o.levels.length>0?o.levels.length-1:0}),e.TileSource.apply(this,[o]),this.levels=o.levels},e.extend(e.LegacyTileSource.prototype,e.TileSource.prototype,{supports:function(n,o){return n.type&&n.type==="legacy-image-pyramid"||n.documentElement&&n.documentElement.getAttribute("type")==="legacy-image-pyramid"},configure:function(n,o,a){var l;return e.isPlainObject(n)?l=s(this,n):l=r(this,n),l},getLevelScale:function(n){var o=NaN;return this.levels.length>0&&n>=this.minLevel&&n<=this.maxLevel&&(o=this.levels[n].width/this.levels[this.maxLevel].width),o},getNumTiles:function(n){var o=this.getLevelScale(n);return o?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(n,o,a){var l=null;return this.levels.length>0&&n>=this.minLevel&&n<=this.maxLevel&&(l=this.levels[n].url),l}});function i(n){var o=[],a,l;for(l=0;l<n.length;l++)a=n[l],a.height&&a.width&&a.url?o.push({url:a.url,width:Number(a.width),height:Number(a.height)}):e.console.error("Unsupported image format: %s",a.url?a.url:"<no URL>");return o.sort(function(h,c){return h.height-c.height})}function r(n,o){if(!o||!o.documentElement)throw new Error(e.getString("Errors.Xml"));var a=o.documentElement,l=a.tagName,h=null,c=[],d,g;if(l==="image")try{for(h={type:a.getAttribute("type"),levels:[]},c=a.getElementsByTagName("level"),g=0;g<c.length;g++)d=c[g],h.levels.push({url:d.getAttribute("url"),width:parseInt(d.getAttribute("width"),10),height:parseInt(d.getAttribute("height"),10)});return s(n,h)}catch(p){throw p instanceof Error?p:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if(l==="collection")throw new Error("Legacy Image Pyramid Collections not yet supported.");if(l==="error")throw new Error("Error: "+o)}throw new Error("Unknown element "+l)}function s(n,o){return o.levels}})(t),(function(e){e.ImageTileSource=function(i){i=e.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1},i),e.TileSource.apply(this,[i])},e.extend(e.ImageTileSource.prototype,e.TileSource.prototype,{supports:function(i,r){return i.type&&i.type==="image"},configure:function(i,r,s){return i},getImageInfo:function(i){var r=this._image=new Image,s=this;this.crossOriginPolicy&&(r.crossOrigin=this.crossOriginPolicy),this.ajaxWithCredentials&&(r.useCredentials=this.ajaxWithCredentials),e.addEvent(r,"load",function(){s.width=r.naturalWidth,s.height=r.naturalHeight,s.aspectRatio=s.width/s.height,s.dimensions=new e.Point(s.width,s.height),s._tileWidth=s.width,s._tileHeight=s.height,s.tileOverlap=0,s.minLevel=0,s.levels=s._buildLevels(),s.maxLevel=s.levels.length-1,s.ready=!0,s.raiseEvent("ready",{tileSource:s})}),e.addEvent(r,"error",function(){s.raiseEvent("open-failed",{message:"Error loading image at "+i,source:i})}),r.src=i},getLevelScale:function(i){var r=NaN;return i>=this.minLevel&&i<=this.maxLevel&&(r=this.levels[i].width/this.levels[this.maxLevel].width),r},getNumTiles:function(i){var r=this.getLevelScale(i);return r?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(i,r,s){var n=null;return i>=this.minLevel&&i<=this.maxLevel&&(n=this.levels[i].url),n},getContext2D:function(i,r,s){var n=null;return i>=this.minLevel&&i<=this.maxLevel&&(n=this.levels[i].context2D),n},destroy:function(i){this._freeupCanvasMemory(i)},_buildLevels:function(){var i=[{url:this._image.src,width:this._image.naturalWidth,height:this._image.naturalHeight}];if(!this.buildPyramid||!e.supportsCanvas)return delete this._image,i;var r=this._image.naturalWidth,s=this._image.naturalHeight,n=document.createElement("canvas"),o=n.getContext("2d");if(n.width=r,n.height=s,o.drawImage(this._image,0,0,r,s),i[0].context2D=o,delete this._image,e.isCanvasTainted(n))return i;for(;r>=2&&s>=2;){r=Math.floor(r/2),s=Math.floor(s/2);var a=document.createElement("canvas"),l=a.getContext("2d");a.width=r,a.height=s,l.drawImage(n,0,0,r,s),i.splice(0,0,{context2D:l,width:r,height:s}),n=a,o=l}return i},_freeupCanvasMemory:function(i){for(var r=0;r<this.levels.length;r++)this.levels[r].context2D&&(this.levels[r].context2D.canvas.height=0,this.levels[r].context2D.canvas.width=0,i&&i.raiseEvent("image-unloaded",{context2D:this.levels[r].context2D}))}})})(t),(function(e){e.TileSourceCollection=function(i,r,s,n){e.console.error("TileSourceCollection is deprecated; use World instead")}})(t),(function(e){e.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},e.Button=function(l){var h=this;e.EventSource.call(this),e.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null,userData:null},l),this.element=l.element||e.makeNeutralElement("div"),l.element||(this.imgRest=e.makeTransparentImage(this.srcRest),this.imgGroup=e.makeTransparentImage(this.srcGroup),this.imgHover=e.makeTransparentImage(this.srcHover),this.imgDown=e.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,e.setElementPointerEventsNone(this.imgRest),e.setElementPointerEventsNone(this.imgGroup),e.setElementPointerEventsNone(this.imgHover),e.setElementPointerEventsNone(this.imgDown),this.element.style.position="relative",e.setElementTouchActionNone(this.element),this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=e.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new e.MouseTracker({userData:"Button.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(c){c.insideElementPressed?(o(h,e.ButtonState.DOWN),h.raiseEvent("enter",{originalEvent:c.originalEvent})):c.buttonDownAny||o(h,e.ButtonState.HOVER)},focusHandler:function(c){h.tracker.enterHandler(c),h.raiseEvent("focus",{originalEvent:c.originalEvent})},leaveHandler:function(c){a(h,e.ButtonState.GROUP),c.insideElementPressed&&h.raiseEvent("exit",{originalEvent:c.originalEvent})},blurHandler:function(c){h.tracker.leaveHandler(c),h.raiseEvent("blur",{originalEvent:c.originalEvent})},pressHandler:function(c){o(h,e.ButtonState.DOWN),h.raiseEvent("press",{originalEvent:c.originalEvent})},releaseHandler:function(c){c.insideElementPressed&&c.insideElementReleased?(a(h,e.ButtonState.HOVER),h.raiseEvent("release",{originalEvent:c.originalEvent})):c.insideElementPressed?a(h,e.ButtonState.GROUP):o(h,e.ButtonState.HOVER)},clickHandler:function(c){c.quick&&h.raiseEvent("click",{originalEvent:c.originalEvent})},keyHandler:function(c){c.keyCode===13?(h.raiseEvent("click",{originalEvent:c.originalEvent}),h.raiseEvent("release",{originalEvent:c.originalEvent}),c.preventDefault=!0):c.preventDefault=!1}}),a(this,e.ButtonState.REST)},e.extend(e.Button.prototype,e.EventSource.prototype,{notifyGroupEnter:function(){o(this,e.ButtonState.GROUP)},notifyGroupExit:function(){a(this,e.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,this.tracker.setTracking(!1),e.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,this.tracker.setTracking(!0),e.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()},destroy:function(){this.imgRest&&(this.element.removeChild(this.imgRest),this.imgRest=null),this.imgGroup&&(this.element.removeChild(this.imgGroup),this.imgGroup=null),this.imgHover&&(this.element.removeChild(this.imgHover),this.imgHover=null),this.imgDown&&(this.element.removeChild(this.imgDown),this.imgDown=null),this.removeAllHandlers(),this.tracker.destroy(),this.element=null}});function i(l){e.requestAnimationFrame(function(){r(l)})}function r(l){var h,c,d;l.shouldFade&&(h=e.now(),c=h-l.fadeBeginTime,d=1-c/l.fadeLength,d=Math.min(1,d),d=Math.max(0,d),l.imgGroup&&e.setElementOpacity(l.imgGroup,d,!0),d>0&&i(l))}function s(l){l.shouldFade=!0,l.fadeBeginTime=e.now()+l.fadeDelay,window.setTimeout(function(){i(l)},l.fadeDelay)}function n(l){l.shouldFade=!1,l.imgGroup&&e.setElementOpacity(l.imgGroup,1,!0)}function o(l,h){l.element.disabled||(h>=e.ButtonState.GROUP&&l.currentState===e.ButtonState.REST&&(n(l),l.currentState=e.ButtonState.GROUP),h>=e.ButtonState.HOVER&&l.currentState===e.ButtonState.GROUP&&(l.imgHover&&(l.imgHover.style.visibility=""),l.currentState=e.ButtonState.HOVER),h>=e.ButtonState.DOWN&&l.currentState===e.ButtonState.HOVER&&(l.imgDown&&(l.imgDown.style.visibility=""),l.currentState=e.ButtonState.DOWN))}function a(l,h){l.element.disabled||(h<=e.ButtonState.HOVER&&l.currentState===e.ButtonState.DOWN&&(l.imgDown&&(l.imgDown.style.visibility="hidden"),l.currentState=e.ButtonState.HOVER),h<=e.ButtonState.GROUP&&l.currentState===e.ButtonState.HOVER&&(l.imgHover&&(l.imgHover.style.visibility="hidden"),l.currentState=e.ButtonState.GROUP),h<=e.ButtonState.REST&&l.currentState===e.ButtonState.GROUP&&(s(l),l.currentState=e.ButtonState.REST))}})(t),(function(e){e.ButtonGroup=function(i){e.extend(!0,this,{buttons:[],clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},i);var r=this.buttons.concat([]),s=this,n;if(this.element=i.element||e.makeNeutralElement("div"),!i.group)for(this.element.style.display="inline-block",n=0;n<r.length;n++)this.element.appendChild(r[n].element);e.setElementTouchActionNone(this.element),this.tracker=new e.MouseTracker({userData:"ButtonGroup.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(o){var a;for(a=0;a<s.buttons.length;a++)s.buttons[a].notifyGroupEnter()},leaveHandler:function(o){var a;if(!o.insideElementPressed)for(a=0;a<s.buttons.length;a++)s.buttons[a].notifyGroupExit()}})},e.ButtonGroup.prototype={addButton:function(i){this.buttons.push(i),this.element.appendChild(i.element)},emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateLeave:function(){this.tracker.leaveHandler({eventSource:this.tracker})},destroy:function(){for(;this.buttons.length;){var i=this.buttons.pop();this.element.removeChild(i.element),i.destroy()}this.tracker.destroy(),this.element=null}}})(t),(function(e){e.Rect=function(i,r,s,n,o){this.x=typeof i=="number"?i:0,this.y=typeof r=="number"?r:0,this.width=typeof s=="number"?s:0,this.height=typeof n=="number"?n:0,this.degrees=typeof o=="number"?o:0,this.degrees=e.positiveModulo(this.degrees,360);var a,l;this.degrees>=270?(a=this.getTopRight(),this.x=a.x,this.y=a.y,l=this.height,this.height=this.width,this.width=l,this.degrees-=270):this.degrees>=180?(a=this.getBottomRight(),this.x=a.x,this.y=a.y,this.degrees-=180):this.degrees>=90&&(a=this.getBottomLeft(),this.x=a.x,this.y=a.y,l=this.height,this.height=this.width,this.width=l,this.degrees-=90)},e.Rect.fromSummits=function(i,r,s){var n=i.distanceTo(r),o=i.distanceTo(s),a=r.minus(i),l=Math.atan(a.y/a.x);return a.x<0?l+=Math.PI:a.y<0&&(l+=2*Math.PI),new e.Rect(i.x,i.y,n,o,l/Math.PI*180)},e.Rect.prototype={clone:function(){return new e.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new e.Point(this.x,this.y)},getBottomRight:function(){return new e.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new e.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new e.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new e.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new e.Point(this.width,this.height)},equals:function(i){return i instanceof e.Rect&&this.x===i.x&&this.y===i.y&&this.width===i.width&&this.height===i.height&&this.degrees===i.degrees},times:function(i){return new e.Rect(this.x*i,this.y*i,this.width*i,this.height*i,this.degrees)},translate:function(i){return new e.Rect(this.x+i.x,this.y+i.y,this.width,this.height,this.degrees)},union:function(i){var r=this.getBoundingBox(),s=i.getBoundingBox(),n=Math.min(r.x,s.x),o=Math.min(r.y,s.y),a=Math.max(r.x+r.width,s.x+s.width),l=Math.max(r.y+r.height,s.y+s.height);return new e.Rect(n,o,a-n,l-o)},intersection:function(i){var r=1e-10,s=[],n=this.getTopLeft();i.containsPoint(n,r)&&s.push(n);var o=this.getTopRight();i.containsPoint(o,r)&&s.push(o);var a=this.getBottomLeft();i.containsPoint(a,r)&&s.push(a);var l=this.getBottomRight();i.containsPoint(l,r)&&s.push(l);var h=i.getTopLeft();this.containsPoint(h,r)&&s.push(h);var c=i.getTopRight();this.containsPoint(c,r)&&s.push(c);var d=i.getBottomLeft();this.containsPoint(d,r)&&s.push(d);var g=i.getBottomRight();this.containsPoint(g,r)&&s.push(g);for(var p=this._getSegments(),v=i._getSegments(),w=0;w<p.length;w++)for(var x=p[w],C=0;C<v.length;C++){var P=v[C],k=R(x[0],x[1],P[0],P[1]);k&&s.push(k)}function R(z,V,Y,ie){var te=V.minus(z),se=ie.minus(Y),Q=-se.x*te.y+te.x*se.y;if(Q===0)return null;var me=(te.x*(z.y-Y.y)-te.y*(z.x-Y.x))/Q,xe=(se.x*(z.y-Y.y)-se.y*(z.x-Y.x))/Q;return-r<=me&&me<=1-r&&-r<=xe&&xe<=1-r?new e.Point(z.x+xe*te.x,z.y+xe*te.y):null}if(s.length===0)return null;for(var A=s[0].x,j=s[0].x,I=s[0].y,W=s[0].y,$=1;$<s.length;$++){var Z=s[$];Z.x<A&&(A=Z.x),Z.x>j&&(j=Z.x),Z.y<I&&(I=Z.y),Z.y>W&&(W=Z.y)}return new e.Rect(A,I,j-A,W-I)},_getSegments:function(){var i=this.getTopLeft(),r=this.getTopRight(),s=this.getBottomLeft(),n=this.getBottomRight();return[[i,r],[r,n],[n,s],[s,i]]},rotate:function(i,r){if(i=e.positiveModulo(i,360),i===0)return this.clone();r=r||this.getCenter();var s=this.getTopLeft().rotate(i,r),n=this.getTopRight().rotate(i,r),o=n.minus(s);o=o.apply(function(l){var h=1e-15;return Math.abs(l)<h?0:l});var a=Math.atan(o.y/o.x);return o.x<0?a+=Math.PI:o.y<0&&(a+=2*Math.PI),new e.Rect(s.x,s.y,this.width,this.height,a/Math.PI*180)},getBoundingBox:function(){if(this.degrees===0)return this.clone();var i=this.getTopLeft(),r=this.getTopRight(),s=this.getBottomLeft(),n=this.getBottomRight(),o=Math.min(i.x,r.x,s.x,n.x),a=Math.max(i.x,r.x,s.x,n.x),l=Math.min(i.y,r.y,s.y,n.y),h=Math.max(i.y,r.y,s.y,n.y);return new e.Rect(o,l,a-o,h-l)},getIntegerBoundingBox:function(){var i=this.getBoundingBox(),r=Math.floor(i.x),s=Math.floor(i.y),n=Math.ceil(i.width+i.x-r),o=Math.ceil(i.height+i.y-s);return new e.Rect(r,s,n,o)},containsPoint:function(i,r){r=r||0;var s=this.getTopLeft(),n=this.getTopRight(),o=this.getBottomLeft(),a=n.minus(s),l=o.minus(s);return(i.x-s.x)*a.x+(i.y-s.y)*a.y>=-r&&(i.x-n.x)*a.x+(i.y-n.y)*a.y<=r&&(i.x-s.x)*l.x+(i.y-s.y)*l.y>=-r&&(i.x-o.x)*l.x+(i.y-o.y)*l.y<=r},toString:function(){return"["+Math.round(this.x*100)/100+", "+Math.round(this.y*100)/100+", "+Math.round(this.width*100)/100+"x"+Math.round(this.height*100)/100+", "+Math.round(this.degrees*100)/100+"deg]"}}})(t),(function(e){var i={};e.ReferenceStrip=function(d){var g=this,p=d.viewer,v=e.getElementSize(p.element),w,x,C;for(d.id||(d.id="referencestrip-"+e.now(),this.element=e.makeNeutralElement("div"),this.element.id=d.id,this.element.className="referencestrip"),d=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.referenceStripSizeRatio,position:e.DEFAULT_SETTINGS.referenceStripPosition,scroll:e.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold},d,{element:this.element}),e.extend(this,d),i[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,this.element.tabIndex=0,x=this.element.style,x.marginTop="0px",x.marginRight="0px",x.marginBottom="0px",x.marginLeft="0px",x.left="0px",x.bottom="0px",x.border="0px",x.background="#000",x.position="relative",e.setElementTouchActionNone(this.element),e.setElementOpacity(this.element,.8),this.viewer=p,this.tracker=new e.MouseTracker({userData:"ReferenceStrip.tracker",element:this.element,clickHandler:e.delegate(this,r),dragHandler:e.delegate(this,s),scrollHandler:e.delegate(this,n),enterHandler:e.delegate(this,a),leaveHandler:e.delegate(this,l),keyDownHandler:e.delegate(this,h),keyHandler:e.delegate(this,c),preProcessEventHandler:function(P){P.eventType==="wheel"&&(P.preventDefault=!0)}}),d.width&&d.height?(this.element.style.width=d.width+"px",this.element.style.height=d.height+"px",p.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):d.scroll==="horizontal"?(this.element.style.width=v.x*d.sizeRatio*p.tileSources.length+12*p.tileSources.length+"px",this.element.style.height=v.y*d.sizeRatio+"px",p.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=v.y*d.sizeRatio*p.tileSources.length+12*p.tileSources.length+"px",this.element.style.width=v.x*d.sizeRatio+"px",p.addControl(this.element,{anchor:e.ControlAnchor.TOP_LEFT})),this.panelWidth=v.x*this.sizeRatio+8,this.panelHeight=v.y*this.sizeRatio+8,this.panels=[],this.miniViewers={},C=0;C<p.tileSources.length;C++)w=e.makeNeutralElement("div"),w.id=this.element.id+"-"+C,w.style.width=g.panelWidth+"px",w.style.height=g.panelHeight+"px",w.style.display="inline",w.style.float="left",w.style.cssFloat="left",w.style.padding="2px",e.setElementTouchActionNone(w),e.setElementPointerEventsNone(w),this.element.appendChild(w),w.activePanel=!1,this.panels.push(w);o(this,this.scroll==="vertical"?v.y:v.x,0),this.setFocus(0)},e.ReferenceStrip.prototype={setFocus:function(d){var g=this.element.querySelector("#"+this.element.id+"-"+d),p=e.getElementSize(this.viewer.canvas),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),x=-Number(this.element.style.marginLeft.replace("px","")),C=-Number(this.element.style.marginTop.replace("px","")),P;this.currentSelected!==g&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=g,this.currentSelected.style.background="#999",this.scroll==="horizontal"?(P=Number(d)*(this.panelWidth+3),P>x+p.x-this.panelWidth?(P=Math.min(P,v-p.x),this.element.style.marginLeft=-P+"px",o(this,p.x,-P)):P<x&&(P=Math.max(0,P-p.x/2),this.element.style.marginLeft=-P+"px",o(this,p.x,-P))):(P=Number(d)*(this.panelHeight+3),P>C+p.y-this.panelHeight?(P=Math.min(P,w-p.y),this.element.style.marginTop=-P+"px",o(this,p.y,-P)):P<C&&(P=Math.max(0,P-p.y/2),this.element.style.marginTop=-P+"px",o(this,p.y,-P))),this.currentPage=d,a.call(this,{eventSource:this.tracker}))},update:function(){return!!i[this.id].animating},destroy:function(){if(this.miniViewers)for(var d in this.miniViewers)this.miniViewers[d].destroy();this.tracker.destroy(),this.element&&this.viewer.removeControl(this.element)}};function r(d){if(d.quick){var g;this.scroll==="horizontal"?g=Math.floor(d.position.x/(this.panelWidth+4)):g=Math.floor(d.position.y/this.panelHeight),this.viewer.goToPage(g)}this.element.focus()}function s(d){if(this.dragging=!0,this.element){var g=Number(this.element.style.marginLeft.replace("px","")),p=Number(this.element.style.marginTop.replace("px","")),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),x=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?-d.delta.x>0?g>-(v-x.x)&&(this.element.style.marginLeft=g+d.delta.x*2+"px",o(this,x.x,g+d.delta.x*2)):-d.delta.x<0&&g<0&&(this.element.style.marginLeft=g+d.delta.x*2+"px",o(this,x.x,g+d.delta.x*2)):-d.delta.y>0?p>-(w-x.y)&&(this.element.style.marginTop=p+d.delta.y*2+"px",o(this,x.y,p+d.delta.y*2)):-d.delta.y<0&&p<0&&(this.element.style.marginTop=p+d.delta.y*2+"px",o(this,x.y,p+d.delta.y*2))}}function n(d){if(this.element){var g=Number(this.element.style.marginLeft.replace("px","")),p=Number(this.element.style.marginTop.replace("px","")),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),x=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?d.scroll>0?g>-(v-x.x)&&(this.element.style.marginLeft=g-d.scroll*60+"px",o(this,x.x,g-d.scroll*60)):d.scroll<0&&g<0&&(this.element.style.marginLeft=g-d.scroll*60+"px",o(this,x.x,g-d.scroll*60)):d.scroll<0?p>x.y-w&&(this.element.style.marginTop=p+d.scroll*60+"px",o(this,x.y,p+d.scroll*60)):d.scroll>0&&p<0&&(this.element.style.marginTop=p+d.scroll*60+"px",o(this,x.y,p+d.scroll*60)),d.preventDefault=!0}}function o(d,g,p){var v,w,x,C,P,k;for(d.scroll==="horizontal"?v=d.panelWidth:v=d.panelHeight,w=Math.ceil(g/v)+5,x=Math.ceil((Math.abs(p)+g)/v)+1,w=x-w,w=w<0?0:w,P=w;P<x&&P<d.panels.length;P++)if(k=d.panels[P],!k.activePanel){var R,A=d.viewer.tileSources[P];A.referenceStripThumbnailUrl?R={type:"image",url:A.referenceStripThumbnailUrl}:R=A,C=new e.Viewer({id:k.id,tileSources:[R],element:k,navigatorSizeRatio:d.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:d.viewer.loadTilesWithAjax,ajaxHeaders:d.viewer.ajaxHeaders,drawer:"canvas"}),e.setElementPointerEventsNone(C.canvas),e.setElementPointerEventsNone(C.container),C.innerTracker.setTracking(!1),C.outerTracker.setTracking(!1),d.miniViewers[k.id]=C,k.activePanel=!0}}function a(d){var g=d.eventSource.element;this.scroll==="horizontal"?g.style.marginBottom="0px":g.style.marginLeft="0px"}function l(d){var g=d.eventSource.element;this.scroll==="horizontal"?g.style.marginBottom="-"+e.getElementSize(g).y/2+"px":g.style.marginLeft="-"+e.getElementSize(g).x/2+"px"}function h(d){if(!d.ctrl&&!d.alt&&!d.meta)switch(d.keyCode){case 38:n.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),d.preventDefault=!0;break;case 40:n.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),d.preventDefault=!0;break;case 37:n.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),d.preventDefault=!0;break;case 39:n.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),d.preventDefault=!0;break;default:d.preventDefault=!1;break}else d.preventDefault=!1}function c(d){if(!d.ctrl&&!d.alt&&!d.meta)switch(d.keyCode){case 61:n.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),d.preventDefault=!0;break;case 45:n.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),d.preventDefault=!0;break;case 48:case 119:case 87:n.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),d.preventDefault=!0;break;case 115:case 83:n.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),d.preventDefault=!0;break;case 97:n.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),d.preventDefault=!0;break;case 100:n.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),d.preventDefault=!0;break;default:d.preventDefault=!1;break}else d.preventDefault=!1}})(t),(function(e){e.DisplayRect=function(i,r,s,n,o,a){e.Rect.apply(this,[i,r,s,n]),this.minLevel=o,this.maxLevel=a},e.extend(e.DisplayRect.prototype,e.Rect.prototype)})(t),(function(e){e.Spring=function(r){var s=arguments;typeof r!="object"&&(r={initial:s.length&&typeof s[0]=="number"?s[0]:void 0,springStiffness:s.length>1?s[1].springStiffness:5,animationTime:s.length>1?s[1].animationTime:1.5}),e.console.assert(typeof r.springStiffness=="number"&&r.springStiffness!==0,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number"),e.console.assert(typeof r.animationTime=="number"&&r.animationTime>=0,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0"),r.exponential&&(this._exponential=!0,delete r.exponential),e.extend(!0,this,r),this.current={value:typeof this.initial=="number"?this.initial:this._exponential?0:1,time:e.now()},e.console.assert(!this._exponential||this.current.value!==0,"[OpenSeadragon.Spring] value must be non-zero for exponential springs"),this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time},this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},e.Spring.prototype={resetTo:function(r){e.console.assert(!this._exponential||r!==0,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs"),this.start.value=this.target.value=this.current.value=r,this.start.time=this.target.time=this.current.time=e.now(),this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},springTo:function(r){e.console.assert(!this._exponential||r!==0,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs"),this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=r,this.target.time=this.start.time+1e3*this.animationTime,this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},shiftBy:function(r){this.start.value+=r,this.target.value+=r,this._exponential&&(e.console.assert(this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},setExponential:function(r){this._exponential=r,this._exponential&&(e.console.assert(this.current.value!==0&&this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},update:function(){this.current.time=e.now();let r,s;if(this._exponential?(r=this.start._logValue,s=this.target._logValue):(r=this.start.value,s=this.target.value),this.current.time>=this.target.time)this.current.value=this.target.value;else{let n=r+(s-r)*i(this.springStiffness,(this.current.time-this.start.time)/(this.target.time-this.start.time));this._exponential?this.current.value=Math.exp(n):this.current.value=n}return this.current.value!==this.target.value},isAtTargetValue:function(){return this.current.value===this.target.value}};function i(r,s){return(1-Math.exp(r*-s))/(1-Math.exp(-r))}})(t),(function(e){e.ImageJob=function(r){e.extend(!0,this,{timeout:e.DEFAULT_SETTINGS.timeout,jobId:null,tries:0},r),this.data=null,this.userData={},this.errorMsg=null},e.ImageJob.prototype={start:function(){this.tries++;var r=this,s=this.abort;this.jobId=window.setTimeout(function(){r.finish(null,null,"Image load exceeded timeout ("+r.timeout+" ms)")},this.timeout),this.abort=function(){r.source.downloadTileAbort(r),typeof s=="function"&&s()},this.source.downloadTileStart(this)},finish:function(r,s,n){this.data=r,this.request=s,this.errorMsg=n,this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},e.ImageLoader=function(r){e.extend(!0,this,{jobLimit:e.DEFAULT_SETTINGS.imageLoaderLimit,timeout:e.DEFAULT_SETTINGS.timeout,jobQueue:[],failedTiles:[],jobsInProgress:0},r)},e.ImageLoader.prototype={addJob:function(r){if(!r.source){e.console.error("ImageLoader.prototype.addJob() requires [options.source]. TileSource since new API defines how images are fetched. Creating a dummy TileSource.");var s=e.TileSource.prototype;r.source={downloadTileStart:s.downloadTileStart,downloadTileAbort:s.downloadTileAbort}}var n=this,o=function(h){i(n,h,r.callback)},a={src:r.src,tile:r.tile||{},source:r.source,loadWithAjax:r.loadWithAjax,ajaxHeaders:r.loadWithAjax?r.ajaxHeaders:null,crossOriginPolicy:r.crossOriginPolicy,ajaxWithCredentials:r.ajaxWithCredentials,postData:r.postData,callback:o,abort:r.abort,timeout:this.timeout},l=new e.ImageJob(a);!this.jobLimit||this.jobsInProgress<this.jobLimit?(l.start(),this.jobsInProgress++):this.jobQueue.push(l)},clear:function(){for(var r=0;r<this.jobQueue.length;r++){var s=this.jobQueue[r];typeof s.abort=="function"&&s.abort()}this.jobQueue=[]}};function i(r,s,n){s.errorMsg!==""&&(s.data===null||s.data===void 0)&&s.tries<1+r.tileRetryMax&&r.failedTiles.push(s);var o;r.jobsInProgress--,(!r.jobLimit||r.jobsInProgress<r.jobLimit)&&r.jobQueue.length>0&&(o=r.jobQueue.shift(),o.start(),r.jobsInProgress++),r.tileRetryMax>0&&r.jobQueue.length===0&&(!r.jobLimit||r.jobsInProgress<r.jobLimit)&&r.failedTiles.length>0&&(o=r.failedTiles.shift(),setTimeout(function(){o.start()},r.tileRetryDelay),r.jobsInProgress++),n(s.data,s.errorMsg,s.request)}})(t),(function(e){e.Tile=function(i,r,s,n,o,a,l,h,c,d,g,p){this.level=i,this.x=r,this.y=s,this.bounds=n,this.positionedBounds=new t.Rect(n.x,n.y,n.width,n.height),this.sourceBounds=d,this.exists=o,this._url=a,this.postData=g,this.context2D=l,this.loadWithAjax=h,this.ajaxHeaders=c,p===void 0&&(e.console.warn("Tile constructor needs 'cacheKey' variable: creation tile cache in Tile class is deprecated. TileSource.prototype.getTileHashKey will be used."),p=e.TileSource.prototype.getTileHashKey(i,r,s,a,c,g)),this.cacheKey=p,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.style=null,this.position=null,this.size=null,this.flipped=!1,this.blendStart=null,this.opacity=null,this.squaredDistance=null,this.visibility=null,this.hasTransparency=!1,this.beingDrawn=!1,this.lastTouchTime=0,this.isRightMost=!1,this.isBottomMost=!1},e.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},_hasTransparencyChannel:function(){return console.warn("Tile.prototype._hasTransparencyChannel() has been deprecated and will be removed in the future. Use TileSource.prototype.hasTransparency() instead."),!!this.context2D||this.getUrl().match(".png")},get image(){return e.console.error("[Tile.image] property has been deprecated. Use [Tile.prototype.getImage] instead."),this.getImage()},get url(){return e.console.error("[Tile.url] property has been deprecated. Use [Tile.prototype.getUrl] instead."),this.getUrl()},getImage:function(){return this.cacheImageRecord.getImage()},getUrl:function(){return typeof this._url=="function"?this._url():this._url},getCanvasContext:function(){return this.context2D||this.cacheImageRecord&&this.cacheImageRecord.getRenderedContext()},getScaleForEdgeSmoothing:function(){var i;if(this.cacheImageRecord)i=this.cacheImageRecord.getRenderedContext();else if(this.context2D)i=this.context2D;else return e.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString()),1;return i.canvas.width/(this.size.x*e.pixelDensityRatio)},getTranslationForEdgeSmoothing:function(i,r,s){var n=Math.max(1,Math.ceil((s.x-r.x)/2)),o=Math.max(1,Math.ceil((s.y-r.y)/2));return new e.Point(n,o).minus(this.position.times(e.pixelDensityRatio).times(i||1).apply(function(a){return a%1}))},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.imgElement=null,this.loaded=!1,this.loading=!1}}})(t),(function(e){e.OverlayPlacement=e.Placement,e.OverlayRotationMode=e.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3}),e.Overlay=function(i,r,s){var n;e.isPlainObject(i)?n=i:n={element:i,location:r,placement:s},this.elementWrapper=document.createElement("div"),this.element=n.element,this.elementWrapper.appendChild(this.element),this.element.id?this.elementWrapper.id="overlay-wrapper-"+this.element.id:this.elementWrapper.id="overlay-wrapper",this.style=this.elementWrapper.style,this._init(n)},e.Overlay.prototype={_init:function(i){this.location=i.location,this.placement=i.placement===void 0?e.Placement.TOP_LEFT:i.placement,this.onDraw=i.onDraw,this.checkResize=i.checkResize===void 0?!0:i.checkResize,this.width=i.width===void 0?null:i.width,this.height=i.height===void 0?null:i.height,this.rotationMode=i.rotationMode||e.OverlayRotationMode.EXACT,this.location instanceof e.Rect&&(this.width=this.location.width,this.height=this.location.height,this.location=this.location.getTopLeft(),this.placement=e.Placement.TOP_LEFT),this.scales=this.width!==null&&this.height!==null,this.bounds=new e.Rect(this.location.x,this.location.y,this.width,this.height),this.position=this.location},adjust:function(i,r){var s=e.Placement.properties[this.placement];s&&(s.isHorizontallyCentered?i.x-=r.x/2:s.isRight&&(i.x-=r.x),s.isVerticallyCentered?i.y-=r.y/2:s.isBottom&&(i.y-=r.y))},destroy:function(){var i=this.elementWrapper,r=this.style;i.parentNode&&(i.parentNode.removeChild(i),i.prevElementParent&&(r.display="none",document.body.appendChild(i))),this.onDraw=null,r.top="",r.left="",r.position="",this.width!==null&&(r.width=""),this.height!==null&&(r.height="");var s=e.getCssPropertyWithVendorPrefix("transformOrigin"),n=e.getCssPropertyWithVendorPrefix("transform");s&&n&&(r[s]="",r[n]="")},drawHTML:function(i,r){var s=this.elementWrapper;s.parentNode!==i&&(s.prevElementParent=s.parentNode,s.prevNextSibling=s.nextSibling,i.appendChild(s),this.style.position="absolute",this.size=e.getElementSize(this.elementWrapper));var n=this._getOverlayPositionAndSize(r),o=n.position,a=this.size=n.size,l="";r.overlayPreserveContentDirection&&(l=r.flipped?" scaleX(-1)":" scaleX(1)");var h=r.flipped?-n.rotate:n.rotate,c=r.flipped?" scaleX(-1)":"";if(this.onDraw)this.onDraw(o,a,this.element);else{var d=this.style,g=this.element.style;g.display="block",d.left=o.x+"px",d.top=o.y+"px",this.width!==null&&(g.width=a.x+"px"),this.height!==null&&(g.height=a.y+"px");var p=e.getCssPropertyWithVendorPrefix("transformOrigin"),v=e.getCssPropertyWithVendorPrefix("transform");p&&v&&(h&&!r.flipped?(g[v]="",d[p]=this._getTransformOrigin(),d[v]="rotate("+h+"deg)"):!h&&r.flipped?(g[v]=l,d[p]=this._getTransformOrigin(),d[v]=c):h&&r.flipped?(g[v]=l,d[p]=this._getTransformOrigin(),d[v]="rotate("+h+"deg)"+c):(g[v]="",d[p]="",d[v]="")),d.display="flex"}},_getOverlayPositionAndSize:function(i){var r=i.pixelFromPoint(this.location,!0),s=this._getSizeInPixels(i);this.adjust(r,s);var n=0;if(i.getRotation(!0)&&this.rotationMode!==e.OverlayRotationMode.NO_ROTATION)if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX&&this.width!==null&&this.height!==null){var o=new e.Rect(r.x,r.y,s.x,s.y),a=this._getBoundingBox(o,i.getRotation(!0));r=a.getTopLeft(),s=a.getSize()}else n=i.getRotation(!0);return i.flipped&&(r.x=i.getContainerSize().x-r.x),{position:r,size:s,rotate:n}},_getSizeInPixels:function(i){var r=this.size.x,s=this.size.y;if(this.width!==null||this.height!==null){var n=i.deltaPixelsFromPointsNoRotate(new e.Point(this.width||0,this.height||0),!0);this.width!==null&&(r=n.x),this.height!==null&&(s=n.y)}if(this.checkResize&&(this.width===null||this.height===null)){var o=this.size=e.getElementSize(this.elementWrapper);this.width===null&&(r=o.x),this.height===null&&(s=o.y)}return new e.Point(r,s)},_getBoundingBox:function(i,r){var s=this._getPlacementPoint(i);return i.rotate(r,s).getBoundingBox()},_getPlacementPoint:function(i){var r=new e.Point(i.x,i.y),s=e.Placement.properties[this.placement];return s&&(s.isHorizontallyCentered?r.x+=i.width/2:s.isRight&&(r.x+=i.width),s.isVerticallyCentered?r.y+=i.height/2:s.isBottom&&(r.y+=i.height)),r},_getTransformOrigin:function(){var i="",r=e.Placement.properties[this.placement];return r&&(r.isLeft?i="left":r.isRight&&(i="right"),r.isTop?i+=" top":r.isBottom&&(i+=" bottom")),i},update:function(i,r){var s=e.isPlainObject(i)?i:{location:i,placement:r};this._init({location:s.location||this.location,placement:s.placement!==void 0?s.placement:this.placement,onDraw:s.onDraw||this.onDraw,checkResize:s.checkResize||this.checkResize,width:s.width!==void 0?s.width:this.width,height:s.height!==void 0?s.height:this.height,rotationMode:s.rotationMode||this.rotationMode})},getBounds:function(i){e.console.assert(i,"A viewport must now be passed to Overlay.getBounds.");var r=this.width,s=this.height;if(r===null||s===null){var n=i.deltaPointsFromPixelsNoRotate(this.size,!0);r===null&&(r=n.x),s===null&&(s=n.y)}var o=this.location.clone();return this.adjust(o,new e.Point(r,s)),this._adjustBoundsForRotation(i,new e.Rect(o.x,o.y,r,s))},_adjustBoundsForRotation:function(i,r){if(!i||i.getRotation(!0)===0||this.rotationMode===e.OverlayRotationMode.EXACT)return r;if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX){if(this.width===null||this.height===null)return r;var s=this._getOverlayPositionAndSize(i);return i.viewerElementToViewportRectangle(new e.Rect(s.position.x,s.position.y,s.size.x,s.size.y))}return r.rotate(-i.getRotation(!0),this._getPlacementPoint(r))}}})(t),(function(e){const i=e;i.DrawerBase=class{constructor(s){e.console.assert(s.viewer,"[Drawer] options.viewer is required"),e.console.assert(s.viewport,"[Drawer] options.viewport is required"),e.console.assert(s.element,"[Drawer] options.element is required"),this.viewer=s.viewer,this.viewport=s.viewport,this.debugGridColor=typeof s.debugGridColor=="string"?[s.debugGridColor]:s.debugGridColor||e.DEFAULT_SETTINGS.debugGridColor,this.options=s.options||{},this.container=e.getElement(s.element),this._renderingTarget=this._createDrawingElement(),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",this.canvas.style.left="0",e.setElementOpacity(this.canvas,this.viewer.opacity,!0),e.setElementPointerEventsNone(this.canvas),e.setElementTouchActionNone(this.canvas),this.container.style.textAlign="left",this.container.appendChild(this.canvas),this._checkForAPIOverrides()}get canvas(){return this._renderingTarget}get element(){return e.console.error("Drawer.element is deprecated. Use Drawer.container instead."),this.container}getType(){e.console.error("Drawer.getType must be implemented by child class")}static isSupported(){e.console.error("Drawer.isSupported must be implemented by child class")}_createDrawingElement(){return e.console.error("Drawer._createDrawingElement must be implemented by child class"),null}draw(s){e.console.error("Drawer.draw must be implemented by child class")}canRotate(){e.console.error("Drawer.canRotate must be implemented by child class")}destroy(){e.console.error("Drawer.destroy must be implemented by child class")}minimumOverlapRequired(s){return!1}setImageSmoothingEnabled(s){e.console.error("Drawer.setImageSmoothingEnabled must be implemented by child class")}drawDebuggingRect(s){e.console.warn("[drawer].drawDebuggingRect is not implemented by this drawer")}clear(){e.console.warn("[drawer].clear() is deprecated. The drawer is responsible for clearing itself as needed before drawing tiles.")}_checkForAPIOverrides(){if(this._createDrawingElement===e.DrawerBase.prototype._createDrawingElement)throw new Error("[drawer]._createDrawingElement must be implemented by child class");if(this.draw===e.DrawerBase.prototype.draw)throw new Error("[drawer].draw must be implemented by child class");if(this.canRotate===e.DrawerBase.prototype.canRotate)throw new Error("[drawer].canRotate must be implemented by child class");if(this.destroy===e.DrawerBase.prototype.destroy)throw new Error("[drawer].destroy must be implemented by child class");if(this.setImageSmoothingEnabled===e.DrawerBase.prototype.setImageSmoothingEnabled)throw new Error("[drawer].setImageSmoothingEnabled must be implemented by child class")}viewportToDrawerRectangle(s){var n=this.viewport.pixelFromPointNoRotate(s.getTopLeft(),!0),o=this.viewport.deltaPixelsFromPointsNoRotate(s.getSize(),!0);return new e.Rect(n.x*e.pixelDensityRatio,n.y*e.pixelDensityRatio,o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio)}viewportCoordToDrawerCoord(s){var n=this.viewport.pixelFromPointNoRotate(s,!0);return new e.Point(n.x*e.pixelDensityRatio,n.y*e.pixelDensityRatio)}_calculateCanvasSize(){var s=e.pixelDensityRatio,n=this.viewport.getContainerSize();return new i.Point(Math.round(n.x*s),Math.round(n.y*s))}_raiseTiledImageDrawnEvent(s,n){this.viewer&&this.viewer.raiseEvent("tiled-image-drawn",{tiledImage:s,tiles:n})}_raiseDrawerErrorEvent(s,n){this.viewer&&this.viewer.raiseEvent("drawer-error",{tiledImage:s,drawer:this,error:n})}}})(t),(function(e){const i=e;class r extends i.DrawerBase{constructor(n){super(n),this.viewer.rejectEventHandler("tile-drawing","The HTMLDrawer does not raise the tile-drawing event"),this.viewer.allowEventHandler("tile-drawn")}static isSupported(){return!0}getType(){return"html"}minimumOverlapRequired(n){return!0}_createDrawingElement(){return e.makeNeutralElement("div")}draw(n){var o=this;this._prepareNewFrame(),n.forEach(function(a){a.opacity!==0&&o._drawTiles(a)})}canRotate(){return!1}destroy(){this.container.removeChild(this.canvas)}setImageSmoothingEnabled(){}_prepareNewFrame(){this.canvas.innerHTML=""}_drawTiles(n){var o=n.getTilesToDraw().map(h=>h.tile);if(!(n.opacity===0||o.length===0&&!n.placeholderFillStyle))for(var a=o.length-1;a>=0;a--){var l=o[a];this._drawTile(l),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:n,tile:l})}}_drawTile(n){e.console.assert(n,"[Drawer._drawTile] tile is required");let o=this.canvas;if(!n.cacheImageRecord){e.console.warn("[Drawer._drawTileToHTML] attempting to draw tile %s when it's not cached",n.toString());return}if(!n.loaded){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",n.toString());return}if(!n.element){var a=n.getImage();if(!a)return;n.element=e.makeNeutralElement("div"),n.imgElement=a.cloneNode(),n.imgElement.style.msInterpolationMode="nearest-neighbor",n.imgElement.style.width="100%",n.imgElement.style.height="100%",n.style=n.element.style,n.style.position="absolute"}n.element.parentNode!==o&&o.appendChild(n.element),n.imgElement.parentNode!==n.element&&n.element.appendChild(n.imgElement),n.style.top=n.position.y+"px",n.style.left=n.position.x+"px",n.style.height=n.size.y+"px",n.style.width=n.size.x+"px",n.flipped&&(n.style.transform="scaleX(-1)"),e.setElementOpacity(n.element,n.opacity)}}e.HTMLDrawer=r})(t),(function(e){const i=e;class r extends i.DrawerBase{constructor(h){super(h),this.context=this.canvas.getContext("2d"),this.sketchCanvas=null,this.sketchContext=null,this._imageSmoothingEnabled=!0,this.viewer.allowEventHandler("tile-drawn"),this.viewer.allowEventHandler("tile-drawing")}static isSupported(){return e.supportsCanvas}getType(){return"canvas"}_createDrawingElement(){let h=e.makeNeutralElement("canvas"),c=this._calculateCanvasSize();return h.width=c.x,h.height=c.y,h}draw(h){this._prepareNewFrame(),this.viewer.viewport.getFlip()!==this._viewportFlipped&&this._flip();for(const c of h)c.opacity!==0&&this._drawTiles(c)}canRotate(){return!0}destroy(){this.canvas.width=1,this.canvas.height=1,this.sketchCanvas=null,this.sketchContext=null,this.container.removeChild(this.canvas)}minimumOverlapRequired(h){return!0}setImageSmoothingEnabled(h){this._imageSmoothingEnabled=!!h,this._updateImageSmoothingEnabled(this.context),this.viewer.forceRedraw()}drawDebuggingRect(h){var c=this.context;c.save(),c.lineWidth=2*e.pixelDensityRatio,c.strokeStyle=this.debugGridColor[0],c.fillStyle=this.debugGridColor[0],c.strokeRect(h.x*e.pixelDensityRatio,h.y*e.pixelDensityRatio,h.width*e.pixelDensityRatio,h.height*e.pixelDensityRatio),c.restore()}get _viewportFlipped(){return this.context.getTransform().a<0}_raiseTileDrawingEvent(h,c,d,g){this.viewer.raiseEvent("tile-drawing",{tiledImage:h,context:c,tile:d,rendered:g})}_prepareNewFrame(){var h=this._calculateCanvasSize();if((this.canvas.width!==h.x||this.canvas.height!==h.y)&&(this.canvas.width=h.x,this.canvas.height=h.y,this._updateImageSmoothingEnabled(this.context),this.sketchCanvas!==null)){var c=this._calculateSketchCanvasSize();this.sketchCanvas.width=c.x,this.sketchCanvas.height=c.y,this._updateImageSmoothingEnabled(this.sketchContext)}this._clear()}_clear(h,c){var d=this._getContext(h);if(c)d.clearRect(c.x,c.y,c.width,c.height);else{var g=d.canvas;d.clearRect(0,0,g.width,g.height)}}_drawTiles(h){var c=h.getTilesToDraw().map(z=>z.tile);if(!(h.opacity===0||c.length===0&&!h.placeholderFillStyle)){var d=c[0],g;d&&(g=h.opacity<1||h.compositeOperation&&h.compositeOperation!=="source-over"||!h._isBottomItem()&&h.source.hasTransparency(d.context2D,d.getUrl(),d.ajaxHeaders,d.postData));var p,v,w=this.viewport.getZoom(!0),x=h.viewportToImageZoom(w);c.length>1&&x>h.smoothTileEdgesMinZoom&&!h.iOSDevice&&h.getRotation(!0)%360===0&&(g=!0,p=d.getScaleForEdgeSmoothing(),v=d.getTranslationForEdgeSmoothing(p,this._getCanvasSize(!1),this._getCanvasSize(!0)));var C;g&&(p||(C=this.viewport.viewportToViewerElementRectangle(h.getClippedBounds(!0)).getIntegerBoundingBox(),C=C.times(e.pixelDensityRatio)),this._clear(!0,C)),p||this._setRotations(h,g);var P=!1;if(h._clip){this._saveContext(g);var k=h.imageToViewportRectangle(h._clip,!0);k=k.rotate(-h.getRotation(!0),h._getRotationPoint(!0));var R=this.viewportToDrawerRectangle(k);p&&(R=R.times(p)),v&&(R=R.translate(v)),this._setClip(R,g),P=!0}if(h._croppingPolygons){var A=this;P||this._saveContext(g);try{var j=h._croppingPolygons.map(function(z){return z.map(function(V){var Y=h.imageToViewportCoordinates(V.x,V.y,!0).rotate(-h.getRotation(!0),h._getRotationPoint(!0)),ie=A.viewportCoordToDrawerCoord(Y);return p&&(ie=ie.times(p)),v&&(ie=ie.plus(v)),ie})});this._clipWithPolygons(j,g)}catch(z){e.console.error(z)}P=!0}if(h._hasOpaqueTile=!1,h.placeholderFillStyle&&h._hasOpaqueTile===!1){let z=this.viewportToDrawerRectangle(h.getBoundsNoRotate(!0));p&&(z=z.times(p)),v&&(z=z.translate(v));let V=null;typeof h.placeholderFillStyle=="function"?V=h.placeholderFillStyle(h,this.context):V=h.placeholderFillStyle,this._drawRectangle(z,V,g)}var I=a(h.subPixelRoundingForTransparency),W=!1;if(I===e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS)W=!0;else if(I===e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST){var $=this.viewer&&this.viewer.isAnimating();W=!$}for(var Z=0;Z<c.length;Z++)d=c[Z],this._drawTile(d,h,g,p,v,W,h.source),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:h,tile:d});P&&this._restoreContext(g),p||(h.getRotation(!0)%360!==0&&this._restoreRotationChanges(g),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(g)),g&&(p&&this._setRotations(h),this.blendSketch({opacity:h.opacity,scale:p,translate:v,compositeOperation:h.compositeOperation,bounds:C}),p&&(h.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1))),this._drawDebugInfo(h,c),this._raiseTiledImageDrawnEvent(h,c)}}_drawDebugInfo(h,c){if(h.debugMode)for(var d=c.length-1;d>=0;d--){var g=c[d];try{this._drawDebugInfoOnTile(g,c.length,d,h)}catch(p){e.console.error(p)}}}_clipWithPolygons(h,c){var d=this._getContext(c);d.beginPath();for(const g of h)for(const[p,v]of g.entries())d[p===0?"moveTo":"lineTo"](v.x,v.y);d.clip()}_drawTile(h,c,d,g,p,v,w){e.console.assert(h,"[Drawer._drawTile] tile is required"),e.console.assert(c,"[Drawer._drawTile] drawingHandler is required");var x=this._getContext(d);g=g||1,this._drawTileToCanvas(h,x,c,g,p,v,w)}_drawTileToCanvas(h,c,d,g,p,v,w){var x=h.position.times(e.pixelDensityRatio),C=h.size.times(e.pixelDensityRatio),P;if(!h.context2D&&!h.cacheImageRecord){e.console.warn("[Drawer._drawTileToCanvas] attempting to draw tile %s when it's not cached",h.toString());return}if(P=h.getCanvasContext(),!h.loaded||!P){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",h.toString());return}c.save(),typeof g=="number"&&g!==1&&(x=x.times(g),C=C.times(g)),p instanceof e.Point&&(x=x.plus(p)),c.globalAlpha===1&&h.hasTransparency&&(v&&(x.x=Math.round(x.x),x.y=Math.round(x.y),C.x=Math.round(C.x),C.y=Math.round(C.y)),c.clearRect(x.x,x.y,C.x,C.y)),this._raiseTileDrawingEvent(d,c,h,P);var k,R;h.sourceBounds?(k=Math.min(h.sourceBounds.width,P.canvas.width),R=Math.min(h.sourceBounds.height,P.canvas.height)):(k=P.canvas.width,R=P.canvas.height),c.translate(x.x+C.x/2,0),h.flipped&&c.scale(-1,1),c.drawImage(P.canvas,0,0,k,R,-C.x/2,x.y,C.x,C.y),c.restore()}_getContext(h){var c=this.context;if(h){if(this.sketchCanvas===null){this.sketchCanvas=document.createElement("canvas");var d=this._calculateSketchCanvasSize();if(this.sketchCanvas.width=d.x,this.sketchCanvas.height=d.y,this.sketchContext=this.sketchCanvas.getContext("2d"),this.viewport.getRotation()===0){var g=this;this.viewer.addHandler("rotate",function p(){if(g.viewport.getRotation()!==0){g.viewer.removeHandler("rotate",p);var v=g._calculateSketchCanvasSize();g.sketchCanvas.width=v.x,g.sketchCanvas.height=v.y}})}this._updateImageSmoothingEnabled(this.sketchContext)}c=this.sketchContext}return c}_saveContext(h){this._getContext(h).save()}_restoreContext(h){this._getContext(h).restore()}_setClip(h,c){var d=this._getContext(c);d.beginPath(),d.rect(h.x,h.y,h.width,h.height),d.clip()}_drawRectangle(h,c,d){var g=this._getContext(d);g.save(),g.fillStyle=c,g.fillRect(h.x,h.y,h.width,h.height),g.restore()}blendSketch(h,c,d,g){var p=h;e.isPlainObject(p)||(p={opacity:h,scale:c,translate:d,compositeOperation:g}),h=p.opacity,g=p.compositeOperation;var v=p.bounds;if(this.context.save(),this.context.globalAlpha=h,g&&(this.context.globalCompositeOperation=g),v)v.x<0&&(v.width+=v.x,v.x=0),v.x+v.width>this.canvas.width&&(v.width=this.canvas.width-v.x),v.y<0&&(v.height+=v.y,v.y=0),v.y+v.height>this.canvas.height&&(v.height=this.canvas.height-v.y),this.context.drawImage(this.sketchCanvas,v.x,v.y,v.width,v.height,v.x,v.y,v.width,v.height);else{c=p.scale||1,d=p.translate;var w=d instanceof e.Point?d:new e.Point(0,0),x=0,C=0;if(d){var P=this.sketchCanvas.width-this.canvas.width,k=this.sketchCanvas.height-this.canvas.height;x=Math.round(P/2),C=Math.round(k/2)}this.context.drawImage(this.sketchCanvas,w.x-x*c,w.y-C*c,(this.canvas.width+2*x)*c,(this.canvas.height+2*C)*c,-x,-C,this.canvas.width+2*x,this.canvas.height+2*C)}this.context.restore()}_drawDebugInfoOnTile(h,c,d,g){var p=this.viewer.world.getIndexOfItem(g)%this.debugGridColor.length,v=this.context;v.save(),v.lineWidth=2*e.pixelDensityRatio,v.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",v.strokeStyle=this.debugGridColor[p],v.fillStyle=this.debugGridColor[p],this._setRotations(g),this._viewportFlipped&&this._flip({point:h.position.plus(h.size.divide(2))}),v.strokeRect(h.position.x*e.pixelDensityRatio,h.position.y*e.pixelDensityRatio,h.size.x*e.pixelDensityRatio,h.size.y*e.pixelDensityRatio);var w=(h.position.x+h.size.x/2)*e.pixelDensityRatio,x=(h.position.y+h.size.y/2)*e.pixelDensityRatio;v.translate(w,x);const C=this.viewport.getRotation(!0);v.rotate(Math.PI/180*-C),v.translate(-w,-x),h.x===0&&h.y===0&&(v.fillText("Zoom: "+this.viewport.getZoom(),h.position.x*e.pixelDensityRatio,(h.position.y-30)*e.pixelDensityRatio),v.fillText("Pan: "+this.viewport.getBounds().toString(),h.position.x*e.pixelDensityRatio,(h.position.y-20)*e.pixelDensityRatio)),v.fillText("Level: "+h.level,(h.position.x+10)*e.pixelDensityRatio,(h.position.y+20)*e.pixelDensityRatio),v.fillText("Column: "+h.x,(h.position.x+10)*e.pixelDensityRatio,(h.position.y+30)*e.pixelDensityRatio),v.fillText("Row: "+h.y,(h.position.x+10)*e.pixelDensityRatio,(h.position.y+40)*e.pixelDensityRatio),v.fillText("Order: "+d+" of "+c,(h.position.x+10)*e.pixelDensityRatio,(h.position.y+50)*e.pixelDensityRatio),v.fillText("Size: "+h.size.toString(),(h.position.x+10)*e.pixelDensityRatio,(h.position.y+60)*e.pixelDensityRatio),v.fillText("Position: "+h.position.toString(),(h.position.x+10)*e.pixelDensityRatio,(h.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),g.getRotation(!0)%360!==0&&this._restoreRotationChanges(),v.restore()}_updateImageSmoothingEnabled(h){h.msImageSmoothingEnabled=this._imageSmoothingEnabled,h.imageSmoothingEnabled=this._imageSmoothingEnabled}_getCanvasSize(h){var c=this._getContext(h).canvas;return new e.Point(c.width,c.height)}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_setRotations(h,c=!1){var d=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),useSketch:c,saveContext:d}),d=!1),h.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:h.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(h._getRotationPoint(!0),!0),useSketch:c,saveContext:d})}_offsetForRotation(h){var c=h.point?h.point.times(e.pixelDensityRatio):this._getCanvasCenter(),d=this._getContext(h.useSketch);d.save(),d.translate(c.x,c.y),d.rotate(Math.PI/180*h.degrees),d.translate(-c.x,-c.y)}_flip(h){h=h||{};var c=h.point?h.point.times(e.pixelDensityRatio):this._getCanvasCenter(),d=this._getContext(h.useSketch);d.translate(c.x,0),d.scale(-1,1),d.translate(-c.x,0)}_restoreRotationChanges(h){var c=this._getContext(h);c.restore()}_calculateCanvasSize(){var h=e.pixelDensityRatio,c=this.viewport.getContainerSize();return{x:Math.round(c.x*h),y:Math.round(c.y*h)}}_calculateSketchCanvasSize(){var h=this._calculateCanvasSize();if(this.viewport.getRotation()===0)return h;var c=Math.ceil(Math.sqrt(h.x*h.x+h.y*h.y));return{x:c,y:c}}}e.CanvasDrawer=r;var s=e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER;function n(l){return l!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS&&l!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&l!==e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER}function o(l){return n(l)?s:l}function a(l){if(typeof l=="number")return o(l);if(!l||!e.Browser)return s;var h=l[e.Browser.vendor];return n(h)&&(h=l["*"]),o(h)}})(t),(function(e){const i=e;i.WebGLDrawer=class extends i.DrawerBase{constructor(s){super(s),this._destroyed=!1,this._TextureMap=new Map,this._TileMap=new Map,this._gl=null,this._firstPass=null,this._secondPass=null,this._glFrameBuffer=null,this._renderToTexture=null,this._glFramebufferToCanvasTransform=null,this._outputCanvas=null,this._outputContext=null,this._clippingCanvas=null,this._clippingContext=null,this._renderingCanvas=null,this._backupCanvasDrawer=null,this._imageSmoothingEnabled=!0,this._boundToTileReady=n=>this._tileReadyHandler(n),this._boundToImageUnloaded=n=>this._imageUnloadedHandler(n),this.viewer.addHandler("tile-ready",this._boundToTileReady),this.viewer.addHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.rejectEventHandler("tile-drawn","The WebGLDrawer does not raise the tile-drawn event"),this.viewer.rejectEventHandler("tile-drawing","The WebGLDrawer does not raise the tile-drawing event"),this._setupCanvases(),this._setupRenderer(),this.context=this._outputContext}destroy(){if(this._destroyed)return;let s=this._gl;var n=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS);for(let a=0;a<n;++a)s.activeTexture(s.TEXTURE0+a),s.bindTexture(s.TEXTURE_2D,null),s.bindTexture(s.TEXTURE_CUBE_MAP,null);s.bindBuffer(s.ARRAY_BUFFER,null),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),s.bindRenderbuffer(s.RENDERBUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,null),this._unloadTextures(),s.deleteBuffer(this._secondPass.bufferOutputPosition),s.deleteFramebuffer(this._glFrameBuffer),this._renderingCanvas.width=this._renderingCanvas.height=1,this._clippingCanvas.width=this._clippingCanvas.height=1,this._outputCanvas.width=this._outputCanvas.height=1,this._renderingCanvas=null,this._clippingCanvas=this._clippingContext=null,this._outputCanvas=this._outputContext=null;let o=s.getExtension("WEBGL_lose_context");o&&o.loseContext(),this.viewer.removeHandler("tile-ready",this._boundToTileReady),this.viewer.removeHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.removeHandler("resize",this._resizeHandler),this._gl=null,this._backupCanvasDrawer&&(this._backupCanvasDrawer.destroy(),this._backupCanvasDrawer=null),this.container.removeChild(this.canvas),this.viewer.drawer===this&&(this.viewer.drawer=null),this._destroyed=!0}canRotate(){return!0}static isSupported(){let s=document.createElement("canvas"),n=e.isFunction(s.getContext)&&s.getContext("webgl"),o=n&&n.getExtension("WEBGL_lose_context");return o&&o.loseContext(),!!n}getType(){return"webgl"}minimumOverlapRequired(s){return s.isTainted()}_createDrawingElement(){let s=e.makeNeutralElement("canvas"),n=this._calculateCanvasSize();return s.width=n.x,s.height=n.y,s}_getBackupCanvasDrawer(){return this._backupCanvasDrawer||(this._backupCanvasDrawer=this.viewer.requestDrawer("canvas",{mainDrawer:!1}),this._backupCanvasDrawer.canvas.style.setProperty("visibility","hidden")),this._backupCanvasDrawer}draw(s){let n=this._gl;const o=this.viewport.getBoundsNoRotateWithMargins(!0);let a={bounds:o,center:new i.Point(o.x+o.width/2,o.y+o.height/2),rotation:this.viewport.getRotation(!0)*Math.PI/180},l=this.viewport.flipped?-1:1,h=e.Mat3.makeTranslation(-a.center.x,-a.center.y),c=e.Mat3.makeScaling(2/a.bounds.width*l,-2/a.bounds.height),d=e.Mat3.makeRotation(-a.rotation),g=c.multiply(d).multiply(h);n.bindFramebuffer(n.FRAMEBUFFER,null),n.clear(n.COLOR_BUFFER_BIT),this._outputContext.clearRect(0,0,this._outputCanvas.width,this._outputCanvas.height);let p=!1;s.forEach((v,w)=>{if(v.isTainted()){p&&(this._outputContext.drawImage(this._renderingCanvas,0,0),n.bindFramebuffer(n.FRAMEBUFFER,null),n.clear(n.COLOR_BUFFER_BIT),p=!1);const x=this._getBackupCanvasDrawer();x.draw([v]),this._outputContext.drawImage(x.canvas,0,0)}else{let x=v.getTilesToDraw();if(v.placeholderFillStyle&&v._hasOpaqueTile===!1&&this._drawPlaceholder(v),x.length===0||v.getOpacity()===0)return;let C=x[0],P=v.compositeOperation||this.viewer.compositeOperation||v._clip||v._croppingPolygons||v.debugMode,k=P||v.opacity<1||C.hasTransparency;P&&(p&&this._outputContext.drawImage(this._renderingCanvas,0,0),n.bindFramebuffer(n.FRAMEBUFFER,null),n.clear(n.COLOR_BUFFER_BIT)),n.useProgram(this._firstPass.shaderProgram),k?(n.bindFramebuffer(n.FRAMEBUFFER,this._glFrameBuffer),n.clear(n.COLOR_BUFFER_BIT)):n.bindFramebuffer(n.FRAMEBUFFER,null);let R=g,A=v.getRotation(!0);if(A%360!==0){let z=e.Mat3.makeRotation(-A*Math.PI/180),V=v.getBoundsNoRotate(!0).getCenter(),Y=e.Mat3.makeTranslation(V.x,V.y),ie=e.Mat3.makeTranslation(-V.x,-V.y),te=Y.multiply(z).multiply(ie);R=g.multiply(te)}let j=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);if(j<=0)throw new Error(`WegGL error: bad value for gl parameter MAX_TEXTURE_IMAGE_UNITS (${j}). This could happen
                        if too many contexts have been created and not released, or there is another problem with the graphics card.`);let I=new Float32Array(j*12),W=new Array(j),$=new Array(j),Z=new Array(j);for(let z=0;z<x.length;z++){let V=x[z].tile,Y=z%j,ie=Y+1,te=V.getCanvasContext(),se=te?this._TextureMap.get(te.canvas):null;if(se||(this._tileReadyHandler({tile:V,tiledImage:v}),se=te?this._TextureMap.get(te.canvas):null),se&&this._getTileData(V,v,se,R,Y,I,W,$,Z),ie===j||z===x.length-1){for(let Q=0;Q<=ie;Q++)n.activeTexture(n.TEXTURE0+Q),n.bindTexture(n.TEXTURE_2D,W[Q]);n.bindBuffer(n.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),n.bufferData(n.ARRAY_BUFFER,I,n.DYNAMIC_DRAW),$.forEach((Q,me)=>{n.uniformMatrix3fv(this._firstPass.uTransformMatrices[me],!1,Q)}),n.uniform1fv(this._firstPass.uOpacities,new Float32Array(Z)),n.bindBuffer(n.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),n.vertexAttribPointer(this._firstPass.aOutputPosition,2,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),n.vertexAttribPointer(this._firstPass.aTexturePosition,2,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._firstPass.bufferIndex),n.vertexAttribPointer(this._firstPass.aIndex,1,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLES,0,6*ie)}}k&&(n.useProgram(this._secondPass.shaderProgram),n.bindFramebuffer(n.FRAMEBUFFER,null),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._renderToTexture),this._gl.uniform1f(this._secondPass.uOpacityMultiplier,v.opacity),n.bindBuffer(n.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),n.vertexAttribPointer(this._secondPass.aTexturePosition,2,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),n.vertexAttribPointer(this._secondPass.aOutputPosition,2,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLES,0,6)),p=!0,P&&(this._applyContext2dPipeline(v,x,w),p=!1,n.bindFramebuffer(n.FRAMEBUFFER,null),n.clear(n.COLOR_BUFFER_BIT)),w===0&&this._raiseTiledImageDrawnEvent(v,x.map(z=>z.tile))}}),p&&this._outputContext.drawImage(this._renderingCanvas,0,0)}setImageSmoothingEnabled(s){this._imageSmoothingEnabled!==s&&(this._imageSmoothingEnabled=s,this._unloadTextures(),this.viewer.world.draw())}drawDebuggingRect(s){let n=this._outputContext;n.save(),n.lineWidth=2*e.pixelDensityRatio,n.strokeStyle=this.debugGridColor[0],n.fillStyle=this.debugGridColor[0],n.strokeRect(s.x*e.pixelDensityRatio,s.y*e.pixelDensityRatio,s.width*e.pixelDensityRatio,s.height*e.pixelDensityRatio),n.restore()}_getTextureDataFromTile(s){return s.getCanvasContext().canvas}_applyContext2dPipeline(s,n,o){if(this._outputContext.save(),this._outputContext.globalCompositeOperation=o===0?null:s.compositeOperation||this.viewer.compositeOperation,s._croppingPolygons||s._clip?(this._renderToClippingCanvas(s),this._outputContext.drawImage(this._clippingCanvas,0,0)):this._outputContext.drawImage(this._renderingCanvas,0,0),this._outputContext.restore(),s.debugMode){const a=this.viewer.viewport.getFlip();a&&this._flip(),this._drawDebugInfo(n,s,a),a&&this._flip()}}_getTileData(s,n,o,a,l,h,c,d,g){let p=o.texture,v=o.position;h.set(v,l*12);let w=this._calculateOverlapFraction(s,n),x=s.positionedBounds.width*w.x,C=s.positionedBounds.height*w.y,P=s.positionedBounds.x+(s.x===0?0:x),k=s.positionedBounds.y+(s.y===0?0:C),R=s.positionedBounds.x+s.positionedBounds.width-(s.isRightMost?0:x),A=s.positionedBounds.y+s.positionedBounds.height-(s.isBottomMost?0:C),j=R-P,I=A-k,W=new e.Mat3([j,0,0,0,I,0,P,k,1]);if(s.flipped){let Z=e.Mat3.makeTranslation(.5,0),z=e.Mat3.makeTranslation(-.5,0),V=Z.multiply(e.Mat3.makeScaling(-1,1)).multiply(z);W=W.multiply(V)}let $=a.multiply(W);g[l]=s.opacity,c[l]=p,d[l]=$.values}_textureFilter(){return this._imageSmoothingEnabled?this._gl.LINEAR:this._gl.NEAREST}_setupRenderer(){let s=this._gl;s||e.console.error("_setupCanvases must be called before _setupRenderer"),this._unitQuad=this._makeQuadVertexBuffer(0,1,0,1),this._makeFirstPassShaderProgram(),this._makeSecondPassShaderProgram(),this._renderToTexture=s.createTexture(),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._renderToTexture),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,this._renderingCanvas.width,this._renderingCanvas.height,0,s.RGBA,s.UNSIGNED_BYTE,null),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,this._textureFilter()),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),this._glFrameBuffer=s.createFramebuffer(),s.bindFramebuffer(s.FRAMEBUFFER,this._glFrameBuffer),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this._renderToTexture,0),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA)}_makeFirstPassShaderProgram(){let s=this._glNumTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),n=()=>[...Array(s).keys()].map(p=>`uniform mat3 u_matrix_${p};`).join(`
`),o=()=>[...Array(s).keys()].map(p=>`${p>0?"else ":""}if(int(a_index) == ${p}) { transform_matrix = u_matrix_${p}; }`).join(`
`);const a=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;
            attribute float a_index;

            ${n()} // create a uniform mat3 for each potential tile to draw

            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {

                mat3 transform_matrix; // value will be set by the if/elses in makeConditional()

                ${o()}

                gl_Position = vec4(transform_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
                v_image_index = a_index;
            }
            `,l=`
            precision mediump float;

            // our textures
            uniform sampler2D u_images[${s}];
            // our opacities
            uniform float u_opacities[${s}];

            // the varyings passed in from the vertex shader.
            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {
                // can't index directly with a variable, need to use a loop iterator hack
                for(int i = 0; i < ${s}; ++i){
                    if(i == int(v_image_index)){
                        gl_FragColor = texture2D(u_images[i], v_texture_position) * u_opacities[i];
                    }
                }
            }
            `;let h=this._gl,c=this.constructor.initShaderProgram(h,a,l);h.useProgram(c),this._firstPass={shaderProgram:c,aOutputPosition:h.getAttribLocation(c,"a_output_position"),aTexturePosition:h.getAttribLocation(c,"a_texture_position"),aIndex:h.getAttribLocation(c,"a_index"),uTransformMatrices:[...Array(this._glNumTextures).keys()].map(p=>h.getUniformLocation(c,`u_matrix_${p}`)),uImages:h.getUniformLocation(c,"u_images"),uOpacities:h.getUniformLocation(c,"u_opacities"),bufferOutputPosition:h.createBuffer(),bufferTexturePosition:h.createBuffer(),bufferIndex:h.createBuffer()},h.uniform1iv(this._firstPass.uImages,[...Array(s).keys()]);let d=new Float32Array(s*12);for(let p=0;p<s;++p)d.set(Float32Array.from(this._unitQuad),p*12);h.bindBuffer(h.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),h.bufferData(h.ARRAY_BUFFER,d,h.STATIC_DRAW),h.enableVertexAttribArray(this._firstPass.aOutputPosition),h.bindBuffer(h.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),h.enableVertexAttribArray(this._firstPass.aTexturePosition),h.bindBuffer(h.ARRAY_BUFFER,this._firstPass.bufferIndex);let g=[...Array(this._glNumTextures).keys()].map(p=>Array(6).fill(p)).flat();h.bufferData(h.ARRAY_BUFFER,new Float32Array(g),h.STATIC_DRAW),h.enableVertexAttribArray(this._firstPass.aIndex)}_makeSecondPassShaderProgram(){const s=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;

            uniform mat3 u_matrix;

            varying vec2 v_texture_position;

            void main() {
                gl_Position = vec4(u_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
            }
            `,n=`
            precision mediump float;

            // our texture
            uniform sampler2D u_image;

            // the texCoords passed in from the vertex shader.
            varying vec2 v_texture_position;

            // the opacity multiplier for the image
            uniform float u_opacity_multiplier;

            void main() {
                gl_FragColor = texture2D(u_image, v_texture_position);
                gl_FragColor *= u_opacity_multiplier;
            }
            `;let o=this._gl,a=this.constructor.initShaderProgram(o,s,n);o.useProgram(a),this._secondPass={shaderProgram:a,aOutputPosition:o.getAttribLocation(a,"a_output_position"),aTexturePosition:o.getAttribLocation(a,"a_texture_position"),uMatrix:o.getUniformLocation(a,"u_matrix"),uImage:o.getUniformLocation(a,"u_image"),uOpacityMultiplier:o.getUniformLocation(a,"u_opacity_multiplier"),bufferOutputPosition:o.createBuffer(),bufferTexturePosition:o.createBuffer()},o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),o.bufferData(o.ARRAY_BUFFER,this._unitQuad,o.STATIC_DRAW),o.enableVertexAttribArray(this._secondPass.aOutputPosition),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),o.bufferData(o.ARRAY_BUFFER,this._unitQuad,o.DYNAMIC_DRAW),o.enableVertexAttribArray(this._secondPass.aTexturePosition);let l=e.Mat3.makeScaling(2,2).multiply(e.Mat3.makeTranslation(-.5,-.5));o.uniformMatrix3fv(this._secondPass.uMatrix,!1,l.values)}_resizeRenderer(){let s=this._gl,n=this._renderingCanvas.width,o=this._renderingCanvas.height;s.viewport(0,0,n,o),s.deleteTexture(this._renderToTexture),this._renderToTexture=s.createTexture(),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._renderToTexture),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,n,o,0,s.RGBA,s.UNSIGNED_BYTE,null),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,this._textureFilter()),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.bindFramebuffer(s.FRAMEBUFFER,this._glFrameBuffer),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this._renderToTexture,0)}_setupCanvases(){let s=this;this._outputCanvas=this.canvas,this._outputContext=this._outputCanvas.getContext("2d"),this._renderingCanvas=document.createElement("canvas"),this._clippingCanvas=document.createElement("canvas"),this._clippingContext=this._clippingCanvas.getContext("2d"),this._renderingCanvas.width=this._clippingCanvas.width=this._outputCanvas.width,this._renderingCanvas.height=this._clippingCanvas.height=this._outputCanvas.height,this._gl=this._renderingCanvas.getContext("webgl"),this._resizeHandler=function(){s._outputCanvas!==s.viewer.drawer.canvas&&(s._outputCanvas.style.width=s.viewer.drawer.canvas.clientWidth+"px",s._outputCanvas.style.height=s.viewer.drawer.canvas.clientHeight+"px");let n=s._calculateCanvasSize();(s._outputCanvas.width!==n.x||s._outputCanvas.height!==n.y)&&(s._outputCanvas.width=n.x,s._outputCanvas.height=n.y),s._renderingCanvas.style.width=s._outputCanvas.clientWidth+"px",s._renderingCanvas.style.height=s._outputCanvas.clientHeight+"px",s._renderingCanvas.width=s._clippingCanvas.width=s._outputCanvas.width,s._renderingCanvas.height=s._clippingCanvas.height=s._outputCanvas.height,s._resizeRenderer()},this.viewer.addHandler("resize",this._resizeHandler)}_makeQuadVertexBuffer(s,n,o,a){return new Float32Array([s,a,n,a,s,o,s,o,n,a,n,o])}_tileReadyHandler(s){let n=s.tile,o=s.tiledImage;if(o.isTainted())return;let a=n.getCanvasContext(),l=a&&a.canvas;if(!l||e.isCanvasTainted(l)){o.isTainted()||(o.setTainted(!0),e.console.warn("WebGL cannot be used to draw this TiledImage because it has tainted data. Does crossOriginPolicy need to be set?"),this._raiseDrawerErrorEvent(o,"Tainted data cannot be used by the WebGLDrawer. Falling back to CanvasDrawer for this TiledImage."));return}if(!this._TextureMap.get(l)){let c=this._gl,d=c.createTexture(),g,p=o.source.tileOverlap,v,w;if(n.sourceBounds?(v=Math.min(n.sourceBounds.width,l.width)/l.width,w=Math.min(n.sourceBounds.height,l.height)/l.height):(v=1,w=1),p>0){let C=this._calculateOverlapFraction(n,o),P=(n.x===0?0:C.x)*v,k=(n.y===0?0:C.y)*w,R=(n.isRightMost?1:1-C.x)*v,A=(n.isBottomMost?1:1-C.y)*w;g=this._makeQuadVertexBuffer(P,R,k,A)}else v===1&&w===1?g=this._unitQuad:g=this._makeQuadVertexBuffer(0,v,0,w);let x={texture:d,position:g};this._TextureMap.set(l,x),c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,d),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,this._textureFilter()),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,this._textureFilter()),this._uploadImageData(a)}}_calculateOverlapFraction(s,n){let o=n.source.tileOverlap,a=s.sourceBounds.width,l=s.sourceBounds.height,h=(s.x===0?0:o)+(s.isRightMost?0:o),c=(s.y===0?0:o)+(s.isBottomMost?0:o),d=o/(a+h),g=o/(l+c);return{x:d,y:g}}_unloadTextures(){Array.from(this._TextureMap.keys()).forEach(n=>{this._cleanupImageData(n)})}_uploadImageData(s){let n=this._gl,o=s.canvas;try{if(!o)throw s;n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,o)}catch(a){e.console.error("Error uploading image data to WebGL",a)}}_imageUnloadedHandler(s){let n=s.context2D.canvas;this._cleanupImageData(n)}_cleanupImageData(s){let n=this._TextureMap.get(s);this._TextureMap.delete(s),n&&this._gl.deleteTexture(n.texture)}_setClip(){}_renderToClippingCanvas(s){if(this._clippingContext.clearRect(0,0,this._clippingCanvas.width,this._clippingCanvas.height),this._clippingContext.save(),this.viewer.viewport.getFlip()){const n=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(n.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-n.x,0)}if(s._clip){let o=[{x:s._clip.x,y:s._clip.y},{x:s._clip.x+s._clip.width,y:s._clip.y},{x:s._clip.x+s._clip.width,y:s._clip.y+s._clip.height},{x:s._clip.x,y:s._clip.y+s._clip.height}].map(a=>{let l=s.imageToViewportCoordinates(a.x,a.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(l)});this._clippingContext.beginPath(),o.forEach((a,l)=>{this._clippingContext[l===0?"moveTo":"lineTo"](a.x,a.y)}),this._clippingContext.clip(),this._setClip()}if(s._croppingPolygons){let n=s._croppingPolygons.map(o=>o.map(a=>{let l=s.imageToViewportCoordinates(a.x,a.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(l)}));this._clippingContext.beginPath(),n.forEach(o=>{o.forEach((a,l)=>{this._clippingContext[l===0?"moveTo":"lineTo"](a.x,a.y)})}),this._clippingContext.clip()}if(this.viewer.viewport.getFlip()){const n=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(n.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-n.x,0)}this._clippingContext.drawImage(this._renderingCanvas,0,0),this._clippingContext.restore()}_setRotations(s){var n=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),saveContext:n}),n=!1),s.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:s.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(s._getRotationPoint(!0),!0),saveContext:n})}_offsetForRotation(s){var n=s.point?s.point.times(e.pixelDensityRatio):this._getCanvasCenter(),o=this._outputContext;o.save(),o.translate(n.x,n.y),o.rotate(Math.PI/180*s.degrees),o.translate(-n.x,-n.y)}_flip(s){s=s||{};var n=s.point?s.point.times(e.pixelDensityRatio):this._getCanvasCenter(),o=this._outputContext;o.translate(n.x,0),o.scale(-1,1),o.translate(-n.x,0)}_drawDebugInfo(s,n,o){for(var a=s.length-1;a>=0;a--){var l=s[a].tile;try{this._drawDebugInfoOnTile(l,s.length,a,n,o)}catch(h){e.console.error(h)}}}_drawDebugInfoOnTile(s,n,o,a,l){var h=this.viewer.world.getIndexOfItem(a)%this.debugGridColor.length,c=this.context;c.save(),c.lineWidth=2*e.pixelDensityRatio,c.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",c.strokeStyle=this.debugGridColor[h],c.fillStyle=this.debugGridColor[h],this._setRotations(a),l&&this._flip({point:s.position.plus(s.size.divide(2))}),c.strokeRect(s.position.x*e.pixelDensityRatio,s.position.y*e.pixelDensityRatio,s.size.x*e.pixelDensityRatio,s.size.y*e.pixelDensityRatio);var d=(s.position.x+s.size.x/2)*e.pixelDensityRatio,g=(s.position.y+s.size.y/2)*e.pixelDensityRatio;c.translate(d,g);const p=this.viewport.getRotation(!0);c.rotate(Math.PI/180*-p),c.translate(-d,-g),s.x===0&&s.y===0&&(c.fillText("Zoom: "+this.viewport.getZoom(),s.position.x*e.pixelDensityRatio,(s.position.y-30)*e.pixelDensityRatio),c.fillText("Pan: "+this.viewport.getBounds().toString(),s.position.x*e.pixelDensityRatio,(s.position.y-20)*e.pixelDensityRatio)),c.fillText("Level: "+s.level,(s.position.x+10)*e.pixelDensityRatio,(s.position.y+20)*e.pixelDensityRatio),c.fillText("Column: "+s.x,(s.position.x+10)*e.pixelDensityRatio,(s.position.y+30)*e.pixelDensityRatio),c.fillText("Row: "+s.y,(s.position.x+10)*e.pixelDensityRatio,(s.position.y+40)*e.pixelDensityRatio),c.fillText("Order: "+o+" of "+n,(s.position.x+10)*e.pixelDensityRatio,(s.position.y+50)*e.pixelDensityRatio),c.fillText("Size: "+s.size.toString(),(s.position.x+10)*e.pixelDensityRatio,(s.position.y+60)*e.pixelDensityRatio),c.fillText("Position: "+s.position.toString(),(s.position.x+10)*e.pixelDensityRatio,(s.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),a.getRotation(!0)%360!==0&&this._restoreRotationChanges(),c.restore()}_drawPlaceholder(s){const n=s.getBounds(!0),o=this.viewportToDrawerRectangle(s.getBounds(!0)),a=this._outputContext;let l;typeof s.placeholderFillStyle=="function"?l=s.placeholderFillStyle(s,a):l=s.placeholderFillStyle,this._offsetForRotation({degrees:this.viewer.viewport.getRotation(!0)}),a.fillStyle=l,a.translate(o.x,o.y),a.rotate(Math.PI/180*n.degrees),a.translate(-o.x,-o.y),a.fillRect(o.x,o.y,o.width,o.height),this._restoreRotationChanges()}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_restoreRotationChanges(){var s=this._outputContext;s.restore()}static initShaderProgram(s,n,o){function a(d,g,p){const v=d.createShader(g);return d.shaderSource(v,p),d.compileShader(v),d.getShaderParameter(v,d.COMPILE_STATUS)?v:(e.console.error(`An error occurred compiling the shaders: ${d.getShaderInfoLog(v)}`),d.deleteShader(v),null)}const l=a(s,s.VERTEX_SHADER,n),h=a(s,s.FRAGMENT_SHADER,o),c=s.createProgram();return s.attachShader(c,l),s.attachShader(c,h),s.linkProgram(c),s.getProgramParameter(c,s.LINK_STATUS)?c:(e.console.error(`Unable to initialize the shader program: ${s.getProgramInfoLog(c)}`),null)}}})(t),(function(e){e.Viewport=function(i){var r=arguments;r.length&&r[0]instanceof e.Point&&(i={containerSize:r[0],contentSize:r[1],config:r[2]}),i.config&&(e.extend(!0,i,i.config),delete i.config),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i.margins||{}),delete i.margins,i.initialDegrees=i.degrees,delete i.degrees,e.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,rotationPivot:null,viewer:null,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:e.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:e.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:e.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:e.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:e.DEFAULT_SETTINGS.maxZoomLevel,initialDegrees:e.DEFAULT_SETTINGS.degrees,flipped:e.DEFAULT_SETTINGS.flipped,homeFillsViewer:e.DEFAULT_SETTINGS.homeFillsViewer,silenceMultiImageWarnings:e.DEFAULT_SETTINGS.silenceMultiImageWarnings},i),this._updateContainerInnerSize(),this.centerSpringX=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new e.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.degreesSpring=new e.Spring({initial:i.initialDegrees,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value,this._setContentBounds(new e.Rect(0,0,1,1),1),this.goHome(!0),this.update()},e.Viewport.prototype={get degrees(){return e.console.warn("Accessing [Viewport.degrees] is deprecated. Use viewport.getRotation instead."),this.getRotation()},set degrees(i){e.console.warn("Setting [Viewport.degrees] is deprecated. Use viewport.rotateTo, viewport.rotateBy, or viewport.setRotation instead."),this.rotateTo(i)},resetContentSize:function(i){return e.console.assert(i,"[Viewport.resetContentSize] contentSize is required"),e.console.assert(i instanceof e.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point"),e.console.assert(i.x>0,"[Viewport.resetContentSize] contentSize.x must be greater than 0"),e.console.assert(i.y>0,"[Viewport.resetContentSize] contentSize.y must be greater than 0"),this._setContentBounds(new e.Rect(0,0,1,i.y/i.x),i.x),this},setHomeBounds:function(i,r){e.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually."),this._setContentBounds(i,r)},_setContentBounds:function(i,r){e.console.assert(i,"[Viewport._setContentBounds] bounds is required"),e.console.assert(i instanceof e.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),e.console.assert(i.width>0,"[Viewport._setContentBounds] bounds.width must be greater than 0"),e.console.assert(i.height>0,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=i.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(r),this._contentBounds=i.rotate(this.getRotation()).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(r),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:r,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var i=this._contentAspectRatio/this.getAspectRatio(),r;return this.homeFillsViewer?r=i>=1?i:1:r=i>=1?1:i,r/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var i=this._contentBounds.getCenter(),r=1/this.getHomeZoom(),s=r/this.getAspectRatio();return new e.Rect(i.x-r/2,i.y-s/2,r,s)},goHome:function(i){return this.viewer&&this.viewer.raiseEvent("home",{immediately:i}),this.fitBounds(this.getHomeBounds(),i)},getMinZoom:function(){var i=this.getHomeZoom(),r=this.minZoomLevel?this.minZoomLevel:this.minZoomImageRatio*i;return r},getMaxZoom:function(){var i=this.maxZoomLevel;return i||(i=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x,i/=this._contentBounds.width),Math.max(i,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new e.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return e.extend({},this._margins)},setMargins:function(i){e.console.assert(e.type(i)==="object","[Viewport.setMargins] margins must be an object"),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i),this._updateContainerInnerSize(),this.viewer&&this.viewer.forceRedraw()},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(-this.getRotation(i))},getBoundsNoRotate:function(i){var r=this.getCenter(i),s=1/this.getZoom(i),n=s/this.getAspectRatio();return new e.Rect(r.x-s/2,r.y-n/2,s,n)},getBoundsWithMargins:function(i){return this.getBoundsNoRotateWithMargins(i).rotate(-this.getRotation(i),this.getCenter(i))},getBoundsNoRotateWithMargins:function(i){var r=this.getBoundsNoRotate(i),s=this._containerInnerSize.x*this.getZoom(i);return r.x-=this._margins.left/s,r.y-=this._margins.top/s,r.width+=(this._margins.left+this._margins.right)/s,r.height+=(this._margins.top+this._margins.bottom)/s,r},getCenter:function(i){var r=new e.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),s=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value),n,o,a,l,h,c,d,g;return i?r:this.zoomPoint?(n=this.pixelFromPoint(this.zoomPoint,!0),o=this.getZoom(),a=1/o,l=a/this.getAspectRatio(),h=new e.Rect(r.x-a/2,r.y-l/2,a,l),c=this._pixelFromPoint(this.zoomPoint,h),d=c.minus(n).rotate(-this.getRotation(!0)),g=d.divide(this._containerInnerSize.x*o),s.plus(g)):s},getZoom:function(i){return i?this.zoomSpring.current.value:this.zoomSpring.target.value},_applyZoomConstraints:function(i){return Math.max(Math.min(i,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(i){var r=this.viewportToViewerElementRectangle(i).getBoundingBox(),s=this.viewportToViewerElementRectangle(this._contentBoundsNoRotate).getBoundingBox(),n=!1,o=!1;if(!this.wrapHorizontal){var a=r.x+r.width,l=s.x+s.width,h,c,d;r.width>s.width?h=this.visibilityRatio*s.width:h=this.visibilityRatio*r.width,c=s.x-a+h,d=l-r.x-h,h>s.width?(r.x+=(c+d)/2,n=!0):d<0?(r.x+=d,n=!0):c>0&&(r.x+=c,n=!0)}if(!this.wrapVertical){var g=r.y+r.height,p=s.y+s.height,v,w,x;r.height>s.height?v=this.visibilityRatio*s.height:v=this.visibilityRatio*r.height,w=s.y-g+v,x=p-r.y-v,v>s.height?(r.y+=(w+x)/2,o=!0):x<0?(r.y+=x,o=!0):w>0&&(r.y+=w,o=!0)}var C=n||o,P=C?this.viewerElementToViewportRectangle(r):i.clone();return P.xConstrained=n,P.yConstrained=o,P.constraintApplied=C,P},_raiseConstraintsEvent:function(i){this.viewer&&this.viewer.raiseEvent("constrain",{immediately:i})},applyConstraints:function(i){var r=this.getZoom(),s=this._applyZoomConstraints(r);r!==s&&this.zoomTo(s,this.zoomPoint,i);var n=this.getConstrainedBounds(!1);return n.constraintApplied&&(this.fitBounds(n,i),this._raiseConstraintsEvent(i)),this},ensureVisible:function(i){return this.applyConstraints(i)},_fitBounds:function(i,r){r=r||{};var s=r.immediately||!1,n=r.constraints||!1,o=this.getAspectRatio(),a=i.getCenter(),l=new e.Rect(i.x,i.y,i.width,i.height,i.degrees+this.getRotation()).getBoundingBox();l.getAspectRatio()>=o?l.height=l.width/o:l.width=l.height*o,l.x=a.x-l.width/2,l.y=a.y-l.height/2;var h=1/l.width;if(s)return this.panTo(a,!0),this.zoomTo(h,null,!0),n&&this.applyConstraints(!0),this;var c=this.getCenter(!0),d=this.getZoom(!0);this.panTo(c,!0),this.zoomTo(d,null,!0);var g=this.getBounds(),p=this.getZoom();if(p===0||Math.abs(h/p-1)<1e-8)return this.zoomTo(h,null,!0),this.panTo(a,s),n&&this.applyConstraints(!1),this;if(n){this.panTo(a,!1),h=this._applyZoomConstraints(h),this.zoomTo(h,null,!1);var v=this.getConstrainedBounds();this.panTo(c,!0),this.zoomTo(d,null,!0),this.fitBounds(v)}else{var w=l.rotate(-this.getRotation()),x=w.getTopLeft().times(h).minus(g.getTopLeft().times(p)).divide(h-p);this.zoomTo(h,x,s)}return this},fitBounds:function(i,r){return this._fitBounds(i,{immediately:r,constraints:!1})},fitBoundsWithConstraints:function(i,r){return this._fitBounds(i,{immediately:r,constraints:!0})},fitVertically:function(i){var r=new e.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(r,i)},fitHorizontally:function(i){var r=new e.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(r,i)},getConstrainedBounds:function(i){var r,s;return r=this.getBounds(i),s=this._applyBoundaryConstraints(r),s},panBy:function(i,r){var s=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return this.panTo(s.plus(i),r)},panTo:function(i,r){return r?(this.centerSpringX.resetTo(i.x),this.centerSpringY.resetTo(i.y)):(this.centerSpringX.springTo(i.x),this.centerSpringY.springTo(i.y)),this.viewer&&this.viewer.raiseEvent("pan",{center:i,immediately:r}),this},zoomBy:function(i,r,s){return this.zoomTo(this.zoomSpring.target.value*i,r,s)},zoomTo:function(i,r,s){var n=this;return this.zoomPoint=r instanceof e.Point&&!isNaN(r.x)&&!isNaN(r.y)?r:null,s?this._adjustCenterSpringsForZoomPoint(function(){n.zoomSpring.resetTo(i)}):this.zoomSpring.springTo(i),this.viewer&&this.viewer.raiseEvent("zoom",{zoom:i,refPoint:r,immediately:s}),this},setRotation:function(i,r){return this.rotateTo(i,null,r)},getRotation:function(i){return i?this.degreesSpring.current.value:this.degreesSpring.target.value},setRotationWithPivot:function(i,r,s){return this.rotateTo(i,r,s)},rotateTo:function(i,r,s){if(!this.viewer||!this.viewer.drawer.canRotate())return this;if(this.degreesSpring.target.value===i&&this.degreesSpring.isAtTargetValue())return this;if(this.rotationPivot=r instanceof e.Point&&!isNaN(r.x)&&!isNaN(r.y)?r:null,s)if(this.rotationPivot){var n=i-this._oldDegrees;if(!n)return this.rotationPivot=null,this;this._rotateAboutPivot(i)}else this.degreesSpring.resetTo(i);else{var o=e.positiveModulo(this.degreesSpring.current.value,360),a=e.positiveModulo(i,360),l=a-o;l>180?a-=360:l<-180&&(a+=360);var h=o-a;this.degreesSpring.resetTo(i+h),this.degreesSpring.springTo(i)}return this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor()),this.viewer.forceRedraw(),this.viewer.raiseEvent("rotate",{degrees:i,immediately:!!s,pivot:this.rotationPivot||this.getCenter()}),this},rotateBy:function(i,r,s){return this.rotateTo(this.degreesSpring.target.value+i,r,s)},resize:function(i,r){var s=this.getBoundsNoRotate(),n=s,o;this.containerSize.x=i.x,this.containerSize.y=i.y,this._updateContainerInnerSize(),r&&(o=i.x/this.containerSize.x,n.width=s.width*o,n.height=n.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:i,maintain:r});var a=this.fitBounds(n,!0);return this.viewer&&this.viewer.raiseEvent("after-resize",{newContainerSize:i,maintain:r}),a},_updateContainerInnerSize:function(){this._containerInnerSize=new e.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var i=this;this._adjustCenterSpringsForZoomPoint(function(){i.zoomSpring.update()}),this.degreesSpring.isAtTargetValue()&&(this.rotationPivot=null),this.centerSpringX.update(),this.centerSpringY.update(),this.rotationPivot?this._rotateAboutPivot(!0):this.degreesSpring.update();var r=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom||this.degreesSpring.current.value!==this._oldDegrees;this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value;var s=r||!this.zoomSpring.isAtTargetValue()||!this.centerSpringX.isAtTargetValue()||!this.centerSpringY.isAtTargetValue()||!this.degreesSpring.isAtTargetValue();return s},_rotateAboutPivot:function(i){var r=i===!0,s=this.rotationPivot.minus(this.getCenter());this.centerSpringX.shiftBy(s.x),this.centerSpringY.shiftBy(s.y),r?this.degreesSpring.update():this.degreesSpring.resetTo(i);var n=this.degreesSpring.current.value-this._oldDegrees,o=s.rotate(n*-1).times(-1);this.centerSpringX.shiftBy(o.x),this.centerSpringY.shiftBy(o.y)},_adjustCenterSpringsForZoomPoint:function(i){if(this.zoomPoint){var r=this.pixelFromPoint(this.zoomPoint,!0);i();var s=this.pixelFromPoint(this.zoomPoint,!0),n=s.minus(r),o=this.deltaPointsFromPixels(n,!0);this.centerSpringX.shiftBy(o.x),this.centerSpringY.shiftBy(o.y),this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else i()},deltaPixelsFromPointsNoRotate:function(i,r){return i.times(this._containerInnerSize.x*this.getZoom(r))},deltaPixelsFromPoints:function(i,r){return this.deltaPixelsFromPointsNoRotate(i.rotate(this.getRotation(r)),r)},deltaPointsFromPixelsNoRotate:function(i,r){return i.divide(this._containerInnerSize.x*this.getZoom(r))},deltaPointsFromPixels:function(i,r){return this.deltaPointsFromPixelsNoRotate(i,r).rotate(-this.getRotation(r))},pixelFromPointNoRotate:function(i,r){return this._pixelFromPointNoRotate(i,this.getBoundsNoRotate(r))},pixelFromPoint:function(i,r){return this._pixelFromPoint(i,this.getBoundsNoRotate(r))},_pixelFromPointNoRotate:function(i,r){return i.minus(r.getTopLeft()).times(this._containerInnerSize.x/r.width).plus(new e.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(i,r){return this._pixelFromPointNoRotate(i.rotate(this.getRotation(!0),this.getCenter(!0)),r)},pointFromPixelNoRotate:function(i,r){var s=this.getBoundsNoRotate(r);return i.minus(new e.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/s.width).plus(s.getTopLeft())},pointFromPixel:function(i,r){return this.pointFromPixelNoRotate(i,r).rotate(-this.getRotation(r),this.getCenter(r))},_viewportToImageDelta:function(i,r){var s=this._contentBoundsNoRotate.width;return new e.Point(i*this._contentSizeNoRotate.x/s,r*this._contentSizeNoRotate.x/s)},viewportToImageCoordinates:function(i,r){if(i instanceof e.Point)return this.viewportToImageCoordinates(i.x,i.y);if(this.viewer){var s=this.viewer.world.getItemCount();if(s>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(s===1){var n=this.viewer.world.getItemAt(0);return n.viewportToImageCoordinates(i,r,!0)}}return this._viewportToImageDelta(i-this._contentBoundsNoRotate.x,r-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(i,r){var s=this._contentBoundsNoRotate.width;return new e.Point(i/this._contentSizeNoRotate.x*s,r/this._contentSizeNoRotate.x*s)},imageToViewportCoordinates:function(i,r){if(i instanceof e.Point)return this.imageToViewportCoordinates(i.x,i.y);if(this.viewer){var s=this.viewer.world.getItemCount();if(s>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(s===1){var n=this.viewer.world.getItemAt(0);return n.imageToViewportCoordinates(i,r,!0)}}var o=this._imageToViewportDelta(i,r);return o.x+=this._contentBoundsNoRotate.x,o.y+=this._contentBoundsNoRotate.y,o},imageToViewportRectangle:function(i,r,s,n){var o=i;if(o instanceof e.Rect||(o=new e.Rect(i,r,s,n)),this.viewer){var a=this.viewer.world.getItemCount();if(a>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(a===1){var l=this.viewer.world.getItemAt(0);return l.imageToViewportRectangle(i,r,s,n,!0)}}var h=this.imageToViewportCoordinates(o.x,o.y),c=this._imageToViewportDelta(o.width,o.height);return new e.Rect(h.x,h.y,c.x,c.y,o.degrees)},viewportToImageRectangle:function(i,r,s,n){var o=i;if(o instanceof e.Rect||(o=new e.Rect(i,r,s,n)),this.viewer){var a=this.viewer.world.getItemCount();if(a>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(a===1){var l=this.viewer.world.getItemAt(0);return l.viewportToImageRectangle(i,r,s,n,!0)}}var h=this.viewportToImageCoordinates(o.x,o.y),c=this._viewportToImageDelta(o.width,o.height);return new e.Rect(h.x,h.y,c.x,c.y,o.degrees)},viewerElementToImageCoordinates:function(i){var r=this.pointFromPixel(i,!0);return this.viewportToImageCoordinates(r)},imageToViewerElementCoordinates:function(i){var r=this.imageToViewportCoordinates(i);return this.pixelFromPoint(r,!0)},windowToImageCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer.");var r=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(r)},imageToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer.");var r=this.imageToViewerElementCoordinates(i);return r.plus(e.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(i){return this.pointFromPixel(i,!0)},viewportToViewerElementCoordinates:function(i){return this.pixelFromPoint(i,!0)},viewerElementToViewportRectangle:function(i){return e.Rect.fromSummits(this.pointFromPixel(i.getTopLeft(),!0),this.pointFromPixel(i.getTopRight(),!0),this.pointFromPixel(i.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(i){return e.Rect.fromSummits(this.pixelFromPoint(i.getTopLeft(),!0),this.pixelFromPoint(i.getTopRight(),!0),this.pixelFromPoint(i.getBottomLeft(),!0))},windowToViewportCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer.");var r=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(r)},viewportToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer.");var r=this.viewportToViewerElementCoordinates(i);return r.plus(e.getElementPosition(this.viewer.element))},viewportToImageZoom:function(i){if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(r===1){var s=this.viewer.world.getItemAt(0);return s.viewportToImageZoom(i)}}var n=this._contentSizeNoRotate.x,o=this._containerInnerSize.x,a=this._contentBoundsNoRotate.width,l=o/n*a;return i*l},imageToViewportZoom:function(i){if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image. Instead, use [TiledImage.imageToViewportZoom] for the specific image of interest");else if(r===1){var s=this.viewer.world.getItemAt(0);return s.imageToViewportZoom(i)}}var n=this._contentSizeNoRotate.x,o=this._containerInnerSize.x,a=this._contentBoundsNoRotate.width,l=n/o/a;return i*l},toggleFlip:function(){return this.setFlip(!this.getFlip()),this},getFlip:function(){return this.flipped},setFlip:function(i){return this.flipped===i?this:(this.flipped=i,this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip()),this.viewer.forceRedraw(),this.viewer.raiseEvent("flip",{flipped:i}),this)},getMaxZoomPixelRatio:function(){return this.maxZoomPixelRatio},setMaxZoomPixelRatio:function(i,r=!0,s=!1){e.console.assert(!isNaN(i),"[Viewport.setMaxZoomPixelRatio] ratio must be a number"),!isNaN(i)&&(this.maxZoomPixelRatio=i,r&&this.getZoom()>this.getMaxZoom()&&this.applyConstraints(s))}}})(t),(function(e){e.TiledImage=function(i){this._initialized=!1,e.console.assert(i.tileCache,"[TiledImage] options.tileCache is required"),e.console.assert(i.drawer,"[TiledImage] options.drawer is required"),e.console.assert(i.viewer,"[TiledImage] options.viewer is required"),e.console.assert(i.imageLoader,"[TiledImage] options.imageLoader is required"),e.console.assert(i.source,"[TiledImage] options.source is required"),e.console.assert(!i.clip||i.clip instanceof e.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present"),e.EventSource.call(this),this._tileCache=i.tileCache,delete i.tileCache,this._drawer=i.drawer,delete i.drawer,this._imageLoader=i.imageLoader,delete i.imageLoader,i.clip instanceof e.Rect&&(this._clip=i.clip.clone()),delete i.clip;var r=i.x||0;delete i.x;var s=i.y||0;delete i.y,this.normHeight=i.source.dimensions.y/i.source.dimensions.x,this.contentAspectX=i.source.dimensions.x/i.source.dimensions.y;var n=1;i.width?(n=i.width,delete i.width,i.height&&(e.console.error("specifying both width and height to a tiledImage is not supported"),delete i.height)):i.height&&(n=i.height/this.normHeight,delete i.height);var o=i.fitBounds;delete i.fitBounds;var a=i.fitBoundsPlacement||t.Placement.CENTER;delete i.fitBoundsPlacement;var l=i.degrees||0;delete i.degrees;var h=i.ajaxHeaders;delete i.ajaxHeaders,e.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_needsDraw:!0,_needsUpdate:!0,_hasOpaqueTile:!1,_tilesLoading:0,_tilesToDraw:[],_lastDrawn:[],_isBlending:!1,_wasBlending:!1,_isTainted:!1,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,immediateRender:e.DEFAULT_SETTINGS.immediateRender,blendTime:e.DEFAULT_SETTINGS.blendTime,alwaysBlend:e.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:e.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:e.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:e.DEFAULT_SETTINGS.iOSDevice,debugMode:e.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:e.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:e.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:e.DEFAULT_SETTINGS.placeholderFillStyle,opacity:e.DEFAULT_SETTINGS.opacity,preload:e.DEFAULT_SETTINGS.preload,compositeOperation:e.DEFAULT_SETTINGS.compositeOperation,subPixelRoundingForTransparency:e.DEFAULT_SETTINGS.subPixelRoundingForTransparency,maxTilesPerFrame:e.DEFAULT_SETTINGS.maxTilesPerFrame},i),this._preload=this.preload,delete this.preload,this._fullyLoaded=!1,this._xSpring=new e.Spring({initial:r,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._ySpring=new e.Spring({initial:s,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._scaleSpring=new e.Spring({initial:n,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._degreesSpring=new e.Spring({initial:l,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._updateForScale(),o&&this.fitBounds(o,a,!0),this._ownAjaxHeaders={},this.setAjaxHeaders(h,!1),this._initialized=!0},e.extend(e.TiledImage.prototype,e.EventSource.prototype,{needsDraw:function(){return this._needsDraw},redraw:function(){this._needsDraw=!0},getFullyLoaded:function(){return this._fullyLoaded},_setFullyLoaded:function(i){i!==this._fullyLoaded&&(this._fullyLoaded=i,this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded}))},reset:function(){this._tileCache.clearTilesFor(this),this.lastResetTime=e.now(),this._needsDraw=!0},update:function(i){let r=this._xSpring.update(),s=this._ySpring.update(),n=this._scaleSpring.update(),o=this._degreesSpring.update(),a=r||s||n||o||this._needsUpdate;if(a||i||!this._fullyLoaded){let l=this._updateLevelsForViewport();this._setFullyLoaded(l)}return this._needsUpdate=!1,a?(this._updateForScale(),this._raiseBoundsChange(),this._needsDraw=!0,!0):!1},setDrawn:function(){return this._needsDraw=this._isBlending||this._wasBlending,this._needsDraw},setTainted(i){this._isTainted=i},isTainted(){return this._isTainted},destroy:function(){this.reset(),this.source.destroy&&this.source.destroy(this.viewer)},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(this.getRotation(i),this._getRotationPoint(i))},getBoundsNoRotate:function(i){return i?new e.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new e.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){return e.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead"),this.getBounds()},getClippedBounds:function(i){var r=this.getBoundsNoRotate(i);if(this._clip){var s=i?this._worldWidthCurrent:this._worldWidthTarget,n=s/this.source.dimensions.x,o=this._clip.times(n);r=new e.Rect(r.x+o.x,r.y+o.y,o.width,o.height)}return r.rotate(this.getRotation(i),this._getRotationPoint(i))},getTileBounds:function(i,r,s){var n=this.source.getNumTiles(i),o=(n.x+r%n.x)%n.x,a=(n.y+s%n.y)%n.y,l=this.source.getTileBounds(i,o,a);return this.getFlip()&&(l.x=Math.max(0,1-l.x-l.width)),l.x+=(r-o)/n.x,l.y+=this._worldHeightCurrent/this._worldWidthCurrent*((s-a)/n.y),l},getContentSize:function(){return new e.Point(this.source.dimensions.x,this.source.dimensions.y)},getSizeInWindowCoordinates:function(){var i=this.imageToWindowCoordinates(new e.Point(0,0)),r=this.imageToWindowCoordinates(this.getContentSize());return new e.Point(r.x-i.x,r.y-i.y)},_viewportToImageDelta:function(i,r,s){var n=s?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i*(this.source.dimensions.x/n),r*(this.source.dimensions.y*this.contentAspectX/n))},viewportToImageCoordinates:function(i,r,s){var n;return i instanceof e.Point?(s=r,n=i):n=new e.Point(i,r),n=n.rotate(-this.getRotation(s),this._getRotationPoint(s)),s?this._viewportToImageDelta(n.x-this._xSpring.current.value,n.y-this._ySpring.current.value):this._viewportToImageDelta(n.x-this._xSpring.target.value,n.y-this._ySpring.target.value)},_imageToViewportDelta:function(i,r,s){var n=s?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i/this.source.dimensions.x*n,r/this.source.dimensions.y/this.contentAspectX*n)},imageToViewportCoordinates:function(i,r,s){i instanceof e.Point&&(s=r,r=i.y,i=i.x);var n=this._imageToViewportDelta(i,r,s);return s?(n.x+=this._xSpring.current.value,n.y+=this._ySpring.current.value):(n.x+=this._xSpring.target.value,n.y+=this._ySpring.target.value),n.rotate(this.getRotation(s),this._getRotationPoint(s))},imageToViewportRectangle:function(i,r,s,n,o){var a=i;a instanceof e.Rect?o=r:a=new e.Rect(i,r,s,n);var l=this.imageToViewportCoordinates(a.getTopLeft(),o),h=this._imageToViewportDelta(a.width,a.height,o);return new e.Rect(l.x,l.y,h.x,h.y,a.degrees+this.getRotation(o))},viewportToImageRectangle:function(i,r,s,n,o){var a=i;i instanceof e.Rect?o=r:a=new e.Rect(i,r,s,n);var l=this.viewportToImageCoordinates(a.getTopLeft(),o),h=this._viewportToImageDelta(a.width,a.height,o);return new e.Rect(l.x,l.y,h.x,h.y,a.degrees-this.getRotation(o))},viewerElementToImageCoordinates:function(i){var r=this.viewport.pointFromPixel(i,!0);return this.viewportToImageCoordinates(r)},imageToViewerElementCoordinates:function(i){var r=this.imageToViewportCoordinates(i);return this.viewport.pixelFromPoint(r,!0)},windowToImageCoordinates:function(i){var r=i.minus(t.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(r)},imageToWindowCoordinates:function(i){var r=this.imageToViewerElementCoordinates(i);return r.plus(t.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(i){var r=this._scaleSpring.current.value;return i=i.rotate(-this.getRotation(!0),this._getRotationPoint(!0)),new e.Rect((i.x-this._xSpring.current.value)/r,(i.y-this._ySpring.current.value)/r,i.width/r,i.height/r,i.degrees)},viewportToImageZoom:function(i){var r=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return r*i},imageToViewportZoom:function(i){var r=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return i/r},setPosition:function(i,r){var s=this._xSpring.target.value===i.x&&this._ySpring.target.value===i.y;if(r){if(s&&this._xSpring.current.value===i.x&&this._ySpring.current.value===i.y)return;this._xSpring.resetTo(i.x),this._ySpring.resetTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}else{if(s)return;this._xSpring.springTo(i.x),this._ySpring.springTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}s||this._raiseBoundsChange()},setWidth:function(i,r){this._setScale(i,r)},setHeight:function(i,r){this._setScale(i/this.normHeight,r)},setCroppingPolygons:function(i){var r=function(n){return n instanceof e.Point||typeof n.x=="number"&&typeof n.y=="number"},s=function(n){return n.map(function(o){try{if(r(o))return{x:o.x,y:o.y};throw new Error}catch{throw new Error("A Provided cropping polygon point is not supported")}})};try{if(!e.isArray(i))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=i.map(function(n){return s(n)}),this._needsDraw=!0}catch(n){e.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported"),e.console.error(n),this.resetCroppingPolygons()}},resetCroppingPolygons:function(){this._croppingPolygons=null,this._needsDraw=!0},fitBounds:function(i,r,s){r=r||e.Placement.CENTER;var n=e.Placement.properties[r],o=this.contentAspectX,a=0,l=0,h=1,c=1;if(this._clip&&(o=this._clip.getAspectRatio(),h=this._clip.width/this.source.dimensions.x,c=this._clip.height/this.source.dimensions.y,i.getAspectRatio()>o?(a=this._clip.x/this._clip.height*i.height,l=this._clip.y/this._clip.height*i.height):(a=this._clip.x/this._clip.width*i.width,l=this._clip.y/this._clip.width*i.width)),i.getAspectRatio()>o){var d=i.height/c,g=0;n.isHorizontallyCentered?g=(i.width-i.height*o)/2:n.isRight&&(g=i.width-i.height*o),this.setPosition(new e.Point(i.x-a+g,i.y-l),s),this.setHeight(d,s)}else{var p=i.width/h,v=0;n.isVerticallyCentered?v=(i.height-i.width/o)/2:n.isBottom&&(v=i.height-i.width/o),this.setPosition(new e.Point(i.x-a,i.y-l+v),s),this.setWidth(p,s)}},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(i){e.console.assert(!i||i instanceof e.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null"),i instanceof e.Rect?this._clip=i.clone():this._clip=null,this._needsUpdate=!0,this._needsDraw=!0,this.raiseEvent("clip-change")},getFlip:function(){return this.flipped},setFlip:function(i){this.flipped=i},get flipped(){return this._flipped},set flipped(i){let r=this._flipped!==!!i;this._flipped=!!i,r&&(this.update(!0),this._needsDraw=!0,this._raiseBoundsChange())},get wrapHorizontal(){return this._wrapHorizontal},set wrapHorizontal(i){let r=this._wrapHorizontal!==!!i;this._wrapHorizontal=!!i,this._initialized&&r&&(this.update(!0),this._needsDraw=!0)},get wrapVertical(){return this._wrapVertical},set wrapVertical(i){let r=this._wrapVertical!==!!i;this._wrapVertical=!!i,this._initialized&&r&&(this.update(!0),this._needsDraw=!0)},get debugMode(){return this._debugMode},set debugMode(i){this._debugMode=!!i,this._needsDraw=!0},getOpacity:function(){return this.opacity},setOpacity:function(i){this.opacity=i},get opacity(){return this._opacity},set opacity(i){i!==this.opacity&&(this._opacity=i,this._needsDraw=!0,this.raiseEvent("opacity-change",{opacity:this.opacity}))},getPreload:function(){return this._preload},setPreload:function(i){this._preload=!!i,this._needsDraw=!0},getRotation:function(i){return i?this._degreesSpring.current.value:this._degreesSpring.target.value},setRotation:function(i,r){this._degreesSpring.target.value===i&&this._degreesSpring.isAtTargetValue()||(r?this._degreesSpring.resetTo(i):this._degreesSpring.springTo(i),this._needsDraw=!0,this._needsUpdate=!0,this._raiseBoundsChange())},getDrawArea:function(){if(this._opacity===0&&!this._preload)return!1;var i=this._viewportToTiledImageRectangle(this.viewport.getBoundsWithMargins(!0));if(!this.wrapHorizontal&&!this.wrapVertical){var r=this._viewportToTiledImageRectangle(this.getClippedBounds(!0));i=i.intersection(r)}return i},getTilesToDraw:function(){let i=this._tilesToDraw.flat();return this._updateTilesInViewport(i),i=this._tilesToDraw.flat(),i.forEach(r=>{r.tile.beingDrawn=!0}),this._lastDrawn=i,i},_getRotationPoint:function(i){return this.getBoundsNoRotate(i).getCenter()},get compositeOperation(){return this._compositeOperation},set compositeOperation(i){i!==this._compositeOperation&&(this._compositeOperation=i,this._needsDraw=!0,this.raiseEvent("composite-operation-change",{compositeOperation:this._compositeOperation}))},getCompositeOperation:function(){return this._compositeOperation},setCompositeOperation:function(i){this.compositeOperation=i},setAjaxHeaders:function(i,r){if(i===null&&(i={}),!e.isPlainObject(i)){console.error("[TiledImage.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}this._ownAjaxHeaders=i,this._updateAjaxHeaders(r)},_updateAjaxHeaders:function(i){if(i===void 0&&(i=!0),e.isPlainObject(this.viewer.ajaxHeaders)?this.ajaxHeaders=e.extend({},this.viewer.ajaxHeaders,this._ownAjaxHeaders):this.ajaxHeaders=this._ownAjaxHeaders,i){var r,s,n,o;for(var a in this.tilesMatrix){r=this.source.getNumTiles(a);for(var l in this.tilesMatrix[a]){s=(r.x+l%r.x)%r.x;for(var h in this.tilesMatrix[a][l])if(n=(r.y+h%r.y)%r.y,o=this.tilesMatrix[a][l][h],o.loadWithAjax=this.loadTilesWithAjax,o.loadWithAjax){var c=this.source.getTileAjaxHeaders(a,s,n);o.ajaxHeaders=e.extend({},this.ajaxHeaders,c)}else o.ajaxHeaders=null}}for(var d=0;d<this._imageLoader.jobQueue.length;d++){var g=this._imageLoader.jobQueue[d];g.loadWithAjax=g.tile.loadWithAjax,g.ajaxHeaders=g.tile.loadWithAjax?g.tile.ajaxHeaders:null}}},_setScale:function(i,r){var s=this._scaleSpring.target.value===i;if(r){if(s&&this._scaleSpring.current.value===i)return;this._scaleSpring.resetTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}else{if(s)return;this._scaleSpring.springTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}s||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value,this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value,this._worldWidthCurrent=this._scaleSpring.current.value,this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var i=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2))),r=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value,s=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(r/this.minPixelRatio)/Math.log(2))));return s=Math.max(s,this.source.minLevel||0),i=Math.min(i,s),{lowestLevel:i,highestLevel:s}},_updateLevelsForViewport:function(){var i=this._getLevelsInterval(),r=i.lowestLevel,s=i.highestLevel,n=[],o=this.getDrawArea(),a=e.now();if(this._lastDrawn.forEach(R=>{R.tile.beingDrawn=!1}),this._tilesToDraw=[],this._tilesLoading=0,this.loadingCoverage={},!o)return this._needsDraw=!1,this._fullyLoaded;var l=new Array(s-r+1);for(let R=0,A=s;A>=r;A--,R++)l[R]=A;for(let R=s+1;R<=this.source.maxLevel;R++){var h=this.tilesMatrix[R]&&this.tilesMatrix[R][0]&&this.tilesMatrix[R][0][0];if(h&&h.isBottomMost&&h.isRightMost&&h.loaded){l.push(R);break}}let c=!1;for(let R=0;R<l.length;R++){let A=l[R];var d=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(A),!0).x*this._scaleSpring.current.value;if(R===l.length-1||d>=this.minPixelRatio)c=!0;else if(!c)continue;var g=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(A),!1).x*this._scaleSpring.current.value,p=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value,v=this.immediateRender?1:p,w=Math.min(1,(d-.5)/.5),x=v/Math.abs(v-g),C=this._updateLevel(A,w,x,o,a,n);n=C.bestTiles;var P=C.updatedTiles.filter(j=>j.loaded),k=(function(j,I,W){return function($){return{tile:$,level:j,levelOpacity:I,currentTime:W}}})(A,w,a);if(this._tilesToDraw[A]=P.map(k),this._providesCoverage(this.coverage,A))break}return n&&n.length>0?(n.forEach(function(R){R&&!R.context2D&&this._loadTile(R,a)},this),this._needsDraw=!0,!1):this._tilesLoading===0},_updateTilesInViewport:function(i){let r=e.now(),s=this;this._tilesLoading=0,this._wasBlending=this._isBlending,this._isBlending=!1,this.loadingCoverage={};let n=i.length?i[0].level:0;if(!this.getDrawArea())return;function a(h){let c=h.tile;if(c&&c.loaded){let d=s._blendTile(c,c.x,c.y,h.level,h.levelOpacity,r,n);s._isBlending=s._isBlending||d,s._needsDraw=s._needsDraw||d||s._wasBlending}}let l=0;for(let h=0;h<i.length;h++){let c=i[h];a(c),this._providesCoverage(this.coverage,c.level)&&(l=Math.max(l,c.level))}if(l>0)for(let h in this._tilesToDraw)h<l&&delete this._tilesToDraw[h]},_blendTile:function(i,r,s,n,o,a,l){let h=1e3*this.blendTime,c,d;return i.blendStart||(i.blendStart=a),c=a-i.blendStart,d=h?Math.min(1,c/h):1,n===l&&(d=1,c=h),this.alwaysBlend&&(d*=o),i.opacity=d,d===1&&(this._setCoverage(this.coverage,n,r,s,!0),this._hasOpaqueTile=!0),c<h},_updateLevel:function(i,r,s,n,o,a){var l=n.getBoundingBox().getTopLeft(),h=n.getBoundingBox().getBottomRight();this.viewer&&this.viewer.raiseEvent("update-level",{tiledImage:this,havedrawn:!0,level:i,opacity:r,visibility:s,drawArea:n,topleft:l,bottomright:h,currenttime:o,best:a}),this._resetCoverage(this.coverage,i),this._resetCoverage(this.loadingCoverage,i);var c=this._getCornerTiles(i,l,h),d=c.topLeft,g=c.bottomRight,p=this.source.getNumTiles(i),v=this.viewport.pixelFromPoint(this.viewport.getCenter());this.getFlip()&&(g.x+=1,this.wrapHorizontal||(g.x=Math.min(g.x,p.x-1)));for(var w=Math.max(0,(g.x-d.x)*(g.y-d.y)),x=new Array(w),C=0,P=d.x;P<=g.x;P++)for(var k=d.y;k<=g.y;k++){var R;if(this.getFlip()){var A=(p.x+P%p.x)%p.x;R=P+p.x-A-A-1}else R=P;if(n.intersection(this.getTileBounds(i,R,k))!==null){var j=this._updateTile(R,k,i,s,v,p,o,a);a=j.bestTiles,x[C]=j.tile,C+=1}}return{bestTiles:a,updatedTiles:x}},_positionTile:function(i,r,s,n,o){var a=i.bounds.getTopLeft();a.x*=this._scaleSpring.current.value,a.y*=this._scaleSpring.current.value,a.x+=this._xSpring.current.value,a.y+=this._ySpring.current.value;var l=i.bounds.getSize();l.x*=this._scaleSpring.current.value,l.y*=this._scaleSpring.current.value,i.positionedBounds.x=a.x,i.positionedBounds.y=a.y,i.positionedBounds.width=l.x,i.positionedBounds.height=l.y;var h=s.pixelFromPointNoRotate(a,!0),c=s.pixelFromPointNoRotate(a,!1),d=s.deltaPixelsFromPointsNoRotate(l,!0),g=s.deltaPixelsFromPointsNoRotate(l,!1),p=c.plus(g.divide(2)),v=n.squaredDistanceTo(p);this.viewer.drawer.minimumOverlapRequired(this)&&(r||(d=d.plus(new e.Point(1,1))),i.isRightMost&&this.wrapHorizontal&&(d.x+=.75),i.isBottomMost&&this.wrapVertical&&(d.y+=.75)),i.position=h,i.size=d,i.squaredDistance=v,i.visibility=o},_updateTile:function(i,r,s,n,o,a,l,h){var c=this._getTile(i,r,s,l,a);this.viewer&&this.viewer.raiseEvent("update-tile",{tiledImage:this,tile:c}),this._setCoverage(this.coverage,s,i,r,!1);var d=c.loaded||c.loading||this._isCovered(this.loadingCoverage,s,i,r);if(this._setCoverage(this.loadingCoverage,s,i,r,d),!c.exists)return{bestTiles:h,tile:c};if(c.loaded&&c.opacity===1&&this._setCoverage(this.coverage,s,i,r,!0),this._positionTile(c,this.source.tileOverlap,this.viewport,o,n),!c.loaded)if(c.context2D)this._setTileLoaded(c);else{var g=this._tileCache.getImageRecord(c.cacheKey);g&&this._setTileLoaded(c,g.getData())}return c.loading?this._tilesLoading++:d||(h=this._compareTiles(h,c,this.maxTilesPerFrame)),{bestTiles:h,tile:c}},_getCornerTiles:function(i,r,s){var n,o;this.wrapHorizontal?(n=e.positiveModulo(r.x,1),o=e.positiveModulo(s.x,1)):(n=Math.max(0,r.x),o=Math.min(1,s.x));var a,l,h=1/this.source.aspectRatio;this.wrapVertical?(a=e.positiveModulo(r.y,h),l=e.positiveModulo(s.y,h)):(a=Math.max(0,r.y),l=Math.min(h,s.y));var c=this.source.getTileAtPoint(i,new e.Point(n,a)),d=this.source.getTileAtPoint(i,new e.Point(o,l)),g=this.source.getNumTiles(i);return this.wrapHorizontal&&(c.x+=g.x*Math.floor(r.x),d.x+=g.x*Math.floor(s.x)),this.wrapVertical&&(c.y+=g.y*Math.floor(r.y/h),d.y+=g.y*Math.floor(s.y/h)),{topLeft:c,bottomRight:d}},_getTile:function(i,r,s,n,o){var a,l,h,c,d,g,p,v,w,x,C=this.tilesMatrix,P=this.source;return C[s]||(C[s]={}),C[s][i]||(C[s][i]={}),(!C[s][i][r]||!C[s][i][r].flipped!=!this.flipped)&&(a=(o.x+i%o.x)%o.x,l=(o.y+r%o.y)%o.y,h=this.getTileBounds(s,i,r),c=P.getTileBounds(s,a,l,!0),d=P.tileExists(s,a,l),g=P.getTileUrl(s,a,l),p=P.getTilePostData(s,a,l),this.loadTilesWithAjax?(v=P.getTileAjaxHeaders(s,a,l),e.isPlainObject(this.ajaxHeaders)&&(v=e.extend({},this.ajaxHeaders,v))):v=null,w=P.getContext2D?P.getContext2D(s,a,l):void 0,x=new e.Tile(s,i,r,h,d,g,w,this.loadTilesWithAjax,v,c,p,P.getTileHashKey(s,a,l,g,v,p)),this.getFlip()?a===0&&(x.isRightMost=!0):a===o.x-1&&(x.isRightMost=!0),l===o.y-1&&(x.isBottomMost=!0),x.flipped=this.flipped,C[s][i][r]=x),x=C[s][i][r],x.lastTouchTime=n,x},_loadTile:function(i,r){var s=this;i.loading=!0,this._imageLoader.addJob({src:i.getUrl(),tile:i,source:this.source,postData:i.postData,loadWithAjax:i.loadWithAjax,ajaxHeaders:i.ajaxHeaders,crossOriginPolicy:this.crossOriginPolicy,ajaxWithCredentials:this.ajaxWithCredentials,callback:function(n,o,a){s._onTileLoad(i,r,n,o,a)},abort:function(){i.loading=!1}})},_onTileLoad:function(i,r,s,n,o){if(s)i.exists=!0;else{e.console.error("Tile %s failed to load: %s - error: %s",i,i.getUrl(),n),this.viewer.raiseEvent("tile-load-failed",{tile:i,tiledImage:this,time:r,message:n,tileRequest:o}),i.loading=!1,i.exists=!1;return}if(r<this.lastResetTime){e.console.warn("Ignoring tile %s loaded before reset: %s",i,i.getUrl()),i.loading=!1;return}var a=this,l=function(){var h=a.source,c=h.getClosestLevel();a._setTileLoaded(i,s,c,o)};l()},_setTileLoaded:function(i,r,s,n){var o=0,a=!1,l=this;function h(){return a&&e.console.error("Event 'tile-loaded' argument getCompletionCallback must be called synchronously. Its return value should be called asynchronously."),o++,c}function c(){o--,o===0&&(i.loading=!1,i.loaded=!0,i.hasTransparency=l.source.hasTransparency(i.context2D,i.getUrl(),i.ajaxHeaders,i.postData),i.context2D||l._tileCache.cacheTile({data:r,tile:i,cutoff:s,tiledImage:l}),l.viewer.raiseEvent("tile-ready",{tile:i,tiledImage:l,tileRequest:n}),l._needsDraw=!0)}var d=h();this.viewer.raiseEvent("tile-loaded",{tile:i,tiledImage:this,tileRequest:n,get image(){return e.console.error("[tile-loaded] event 'image' has been deprecated. Use 'data' property instead."),r},data:r,getCompletionCallback:h}),a=!0,d()},_compareTiles:function(i,r,s){return i?(i.push(r),this._sortTiles(i),i.length>s&&i.pop(),i):[r]},_sortTiles:function(i){i.sort(function(r,s){return r===null?1:s===null?-1:r.visibility===s.visibility?r.squaredDistance-s.squaredDistance:s.visibility-r.visibility})},_providesCoverage:function(i,r,s,n){var o,a,l,h;if(!i[r])return!1;if(s===void 0||n===void 0){o=i[r];for(l in o)if(Object.prototype.hasOwnProperty.call(o,l)){a=o[l];for(h in a)if(Object.prototype.hasOwnProperty.call(a,h)&&!a[h])return!1}return!0}return i[r][s]===void 0||i[r][s][n]===void 0||i[r][s][n]===!0},_isCovered:function(i,r,s,n){return s===void 0||n===void 0?this._providesCoverage(i,r+1):this._providesCoverage(i,r+1,2*s,2*n)&&this._providesCoverage(i,r+1,2*s,2*n+1)&&this._providesCoverage(i,r+1,2*s+1,2*n)&&this._providesCoverage(i,r+1,2*s+1,2*n+1)},_setCoverage:function(i,r,s,n,o){if(!i[r]){e.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",r);return}i[r][s]||(i[r][s]={}),i[r][s][n]=o},_resetCoverage:function(i,r){i[r]={}}})})(t),(function(e){var i=function(s){e.console.assert(s,"[TileCache.cacheTile] options is required"),e.console.assert(s.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(s.tiledImage,"[TileCache.cacheTile] options.tiledImage is required"),this.tile=s.tile,this.tiledImage=s.tiledImage},r=function(s){e.console.assert(s,"[ImageRecord] options is required"),e.console.assert(s.data,"[ImageRecord] options.data is required"),this._tiles=[],s.create.apply(null,[this,s.data,s.ownerTile]),this._destroyImplementation=s.destroy.bind(null,this),this.getImage=s.getImage.bind(null,this),this.getData=s.getData.bind(null,this),this.getRenderedContext=s.getRenderedContext.bind(null,this)};r.prototype={destroy:function(){this._destroyImplementation(),this._tiles=null},addTile:function(s){e.console.assert(s,"[ImageRecord.addTile] tile is required"),this._tiles.push(s)},removeTile:function(s){for(var n=0;n<this._tiles.length;n++)if(this._tiles[n]===s){this._tiles.splice(n,1);return}e.console.warn("[ImageRecord.removeTile] trying to remove unknown tile",s)},getTileCount:function(){return this._tiles.length}},e.TileCache=function(s){s=s||{},this._maxImageCacheCount=s.maxImageCacheCount||e.DEFAULT_SETTINGS.maxImageCacheCount,this._tilesLoaded=[],this._imagesLoaded=[],this._imagesLoadedCount=0},e.TileCache.prototype={numTilesLoaded:function(){return this._tilesLoaded.length},cacheTile:function(s){e.console.assert(s,"[TileCache.cacheTile] options is required"),e.console.assert(s.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(s.tile.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required"),e.console.assert(s.tiledImage,"[TileCache.cacheTile] options.tiledImage is required");var n=s.cutoff||0,o=this._tilesLoaded.length,a=this._imagesLoaded[s.tile.cacheKey];if(a||(s.data||(e.console.error("[TileCache.cacheTile] options.image was renamed to options.data. '.image' attribute has been deprecated and will be removed in the future."),s.data=s.image),e.console.assert(s.data,"[TileCache.cacheTile] options.data is required to create an ImageRecord"),a=this._imagesLoaded[s.tile.cacheKey]=new r({data:s.data,ownerTile:s.tile,create:s.tiledImage.source.createTileCache,destroy:s.tiledImage.source.destroyTileCache,getImage:s.tiledImage.source.getTileCacheDataAsImage,getData:s.tiledImage.source.getTileCacheData,getRenderedContext:s.tiledImage.source.getTileCacheDataAsContext2D}),this._imagesLoadedCount++),a.addTile(s.tile),s.tile.cacheImageRecord=a,this._imagesLoadedCount>this._maxImageCacheCount){for(var l=null,h=-1,c=null,d,g,p,v,w,x,C=this._tilesLoaded.length-1;C>=0;C--)if(x=this._tilesLoaded[C],d=x.tile,!(d.level<=n||d.beingDrawn)){if(!l){l=d,h=C,c=x;continue}v=d.lastTouchTime,g=l.lastTouchTime,w=d.level,p=l.level,(v<g||v===g&&w>p)&&(l=d,h=C,c=x)}l&&h>=0&&(this._unloadTile(c),o=h)}this._tilesLoaded[o]=new i({tile:s.tile,tiledImage:s.tiledImage})},clearTilesFor:function(s){e.console.assert(s,"[TileCache.clearTilesFor] tiledImage is required");for(var n,o=0;o<this._tilesLoaded.length;++o)n=this._tilesLoaded[o],n.tiledImage===s&&(this._unloadTile(n),this._tilesLoaded.splice(o,1),o--)},getImageRecord:function(s){return e.console.assert(s,"[TileCache.getImageRecord] cacheKey is required"),this._imagesLoaded[s]},_unloadTile:function(s){e.console.assert(s,"[TileCache._unloadTile] tileRecord is required");var n=s.tile,o=s.tiledImage;let a=n.getCanvasContext&&n.getCanvasContext();n.unload(),n.cacheImageRecord=null;var l=this._imagesLoaded[n.cacheKey];l&&(l.removeTile(n),l.getTileCount()||(l.destroy(),delete this._imagesLoaded[n.cacheKey],this._imagesLoadedCount--,a&&(a.canvas.width=0,a.canvas.height=0,o.viewer.raiseEvent("image-unloaded",{context2D:a,tile:n}))),o.viewer.raiseEvent("tile-unloaded",{tile:n,tiledImage:o}))}}})(t),(function(e){e.World=function(i){var r=this;e.console.assert(i.viewer,"[World] options.viewer is required"),e.EventSource.call(this),this.viewer=i.viewer,this._items=[],this._needsDraw=!1,this._autoRefigureSizes=!0,this._needsSizesFigured=!1,this._delegatedFigureSizes=function(s){r._autoRefigureSizes?r._figureSizes():r._needsSizesFigured=!0},this._figureSizes()},e.extend(e.World.prototype,e.EventSource.prototype,{addItem:function(i,r){if(e.console.assert(i,"[World.addItem] item is required"),e.console.assert(i instanceof e.TiledImage,"[World.addItem] only TiledImages supported at this time"),r=r||{},r.index!==void 0){var s=Math.max(0,Math.min(this._items.length,r.index));this._items.splice(s,0,i)}else this._items.push(i);this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0,this._needsDraw=!0,i.addHandler("bounds-change",this._delegatedFigureSizes),i.addHandler("clip-change",this._delegatedFigureSizes),this.raiseEvent("add-item",{item:i})},getItemAt:function(i){return e.console.assert(i!==void 0,"[World.getItemAt] index is required"),this._items[i]},getIndexOfItem:function(i){return e.console.assert(i,"[World.getIndexOfItem] item is required"),e.indexOf(this._items,i)},getItemCount:function(){return this._items.length},setItemIndex:function(i,r){e.console.assert(i,"[World.setItemIndex] item is required"),e.console.assert(r!==void 0,"[World.setItemIndex] index is required");var s=this.getIndexOfItem(i);if(r>=this._items.length)throw new Error("Index bigger than number of layers.");r===s||s===-1||(this._items.splice(s,1),this._items.splice(r,0,i),this._needsDraw=!0,this.raiseEvent("item-index-change",{item:i,previousIndex:s,newIndex:r}))},removeItem:function(i){e.console.assert(i,"[World.removeItem] item is required");var r=e.indexOf(this._items,i);r!==-1&&(i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy(),this._items.splice(r,1),this._figureSizes(),this._needsDraw=!0,this._raiseRemoveItem(i))},removeAll:function(){this.viewer._cancelPendingImages();var i,r;for(r=0;r<this._items.length;r++)i=this._items[r],i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy();var s=this._items;for(this._items=[],this._figureSizes(),this._needsDraw=!0,r=0;r<s.length;r++)i=s[r],this._raiseRemoveItem(i)},resetItems:function(){for(var i=0;i<this._items.length;i++)this._items[i].reset()},update:function(i){for(var r=!1,s=0;s<this._items.length;s++)r=this._items[s].update(i)||r;return r},draw:function(){this.viewer.drawer.draw(this._items),this._needsDraw=!1,this._items.forEach(i=>{this._needsDraw=i.setDrawn()||this._needsDraw})},needsDraw:function(){for(var i=0;i<this._items.length;i++)if(this._items[i].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(i){this._autoRefigureSizes=i,i&this._needsSizesFigured&&(this._figureSizes(),this._needsSizesFigured=!1)},arrange:function(i){i=i||{};var r=i.immediately||!1,s=i.layout||e.DEFAULT_SETTINGS.collectionLayout,n=i.rows||e.DEFAULT_SETTINGS.collectionRows,o=i.columns||e.DEFAULT_SETTINGS.collectionColumns,a=i.tileSize||e.DEFAULT_SETTINGS.collectionTileSize,l=i.tileMargin||e.DEFAULT_SETTINGS.collectionTileMargin,h=a+l,c;!i.rows&&o?c=o:c=Math.ceil(this._items.length/n);var d=0,g=0,p,v,w,x,C;this.setAutoRefigureSizes(!1);for(var P=0;P<this._items.length;P++)P&&P%c===0&&(s==="horizontal"?(g+=h,d=0):(d+=h,g=0)),p=this._items[P],v=p.getBounds(),v.width>v.height?w=a:w=a*(v.width/v.height),x=w*(v.height/v.width),C=new e.Point(d+(a-w)/2,g+(a-x)/2),p.setPosition(C,r),p.setWidth(w,r),s==="horizontal"?d+=h:g+=h;this.setAutoRefigureSizes(!0)},_figureSizes:function(){var i=this._homeBounds?this._homeBounds.clone():null,r=this._contentSize?this._contentSize.clone():null,s=this._contentFactor||0;if(!this._items.length)this._homeBounds=new e.Rect(0,0,1,1),this._contentSize=new e.Point(1,1),this._contentFactor=1;else{var n=this._items[0],o=n.getBounds();this._contentFactor=n.getContentSize().x/o.width;for(var a=n.getClippedBounds().getBoundingBox(),l=a.x,h=a.y,c=a.x+a.width,d=a.y+a.height,g=1;g<this._items.length;g++)n=this._items[g],o=n.getBounds(),this._contentFactor=Math.max(this._contentFactor,n.getContentSize().x/o.width),a=n.getClippedBounds().getBoundingBox(),l=Math.min(l,a.x),h=Math.min(h,a.y),c=Math.max(c,a.x+a.width),d=Math.max(d,a.y+a.height);this._homeBounds=new e.Rect(l,h,c-l,d-h),this._contentSize=new e.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}(this._contentFactor!==s||!this._homeBounds.equals(i)||!this._contentSize.equals(r))&&this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(i){this.raiseEvent("remove-item",{item:i})}})})(t)})(Wi)),Wi.exports}var ho=lo();const qi=oo(ho);function b(u,t,e){return(t=(function(i){var r=(function(s,n){if(typeof s!="object"||!s)return s;var o=s[Symbol.toPrimitive];if(o!==void 0){var a=o.call(s,n);if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(s)})(i,"string");return typeof r=="symbol"?r:r+""})(t))in u?Object.defineProperty(u,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):u[t]=e,u}function fs(u,t){var e=Object.keys(u);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(u);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(u,r).enumerable}))),e.push.apply(e,i)}return e}function E(u){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?fs(Object(e),!0).forEach((function(i){b(u,i,e[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(e)):fs(Object(e)).forEach((function(i){Object.defineProperty(u,i,Object.getOwnPropertyDescriptor(e,i))}))}return u}function ue(u,t){if(u==null)return{};var e,i,r=(function(n,o){if(n==null)return{};var a={};for(var l in n)if({}.hasOwnProperty.call(n,l)){if(o.indexOf(l)>=0)continue;a[l]=n[l]}return a})(u,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(u);for(i=0;i<s.length;i++)e=s[i],t.indexOf(e)>=0||{}.propertyIsEnumerable.call(u,e)&&(r[e]=u[e])}return r}function et(u,t){return t||(t=u.slice(0)),Object.freeze(Object.defineProperties(u,{raw:{value:Object.freeze(t)}}))}class ps{constructor(){b(this,"browserShadowBlurConstant",1),b(this,"DPI",96),b(this,"devicePixelRatio",typeof window<"u"?window.devicePixelRatio:1),b(this,"perfLimitSizeTotal",2097152),b(this,"maxCacheSideLimit",4096),b(this,"minCacheSideLimit",256),b(this,"disableStyleCopyPaste",!1),b(this,"enableGLFiltering",!0),b(this,"textureSize",4096),b(this,"forceGLPutImageData",!1),b(this,"cachesBoundsOfCurve",!1),b(this,"fontPaths",{}),b(this,"NUM_FRACTION_DIGITS",4)}}const re=new class extends ps{constructor(u){super(),this.configure(u)}configure(){let u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Object.assign(this,u)}addFonts(){let u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.fontPaths=E(E({},this.fontPaths),u)}removeFonts(){(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).forEach((u=>{delete this.fontPaths[u]}))}clearFonts(){this.fontPaths={}}restoreDefaults(u){const t=new ps,e=u?.reduce(((i,r)=>(i[r]=t[r],i)),{})||t;this.configure(e)}},yt=function(u){for(var t=arguments.length,e=new Array(t>1?t-1:0),i=1;i<t;i++)e[i-1]=arguments[i];return console[u]("fabric",...e)};class Qe extends Error{constructor(t,e){super("fabric: ".concat(t),e)}}class co extends Qe{constructor(t){super("".concat(t," 'options.signal' is in 'aborted' state"))}}class uo{}class go extends uo{testPrecision(t,e){const i="precision ".concat(e,` float;
void main(){}`),r=t.createShader(t.FRAGMENT_SHADER);return!!r&&(t.shaderSource(r,i),t.compileShader(r),!!t.getShaderParameter(r,t.COMPILE_STATUS))}queryWebGL(t){const e=t.getContext("webgl");e&&(this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.GLPrecision=["highp","mediump","lowp"].find((i=>this.testPrecision(e,i))),e.getExtension("WEBGL_lose_context").loseContext(),yt("log","WebGL: max texture size ".concat(this.maxTextureSize)))}isSupported(t){return!!this.maxTextureSize&&this.maxTextureSize>=t}}const fo={};let ms;const $e=()=>ms||(ms={document,window,isTouchSupported:"ontouchstart"in window||"ontouchstart"in document||window&&window.navigator&&window.navigator.maxTouchPoints>0,WebGLProbe:new go,dispose(){},copyPasteData:fo}),Gt=()=>$e().document,ar=()=>$e().window,tn=()=>{var u;return Math.max((u=re.devicePixelRatio)!==null&&u!==void 0?u:ar().devicePixelRatio,1)},ii=new class{constructor(){b(this,"charWidthsCache",{}),b(this,"boundsOfCurveCache",{})}getFontCache(u){let{fontFamily:t,fontStyle:e,fontWeight:i}=u;t=t.toLowerCase(),this.charWidthsCache[t]||(this.charWidthsCache[t]={});const r=this.charWidthsCache[t],s="".concat(e.toLowerCase(),"_").concat((i+"").toLowerCase());return r[s]||(r[s]={}),r[s]}clearFontCache(u){(u=(u||"").toLowerCase())?this.charWidthsCache[u]&&delete this.charWidthsCache[u]:this.charWidthsCache={}}limitDimsByArea(u){const{perfLimitSizeTotal:t}=re,e=Math.sqrt(t*u);return[Math.floor(e),Math.floor(t/e)]}},Fr="6.7.1";function Ui(){}const di=Math.PI/2,Zi=2*Math.PI,Gr=Math.PI/180,Ee=Object.freeze([1,0,0,1,0,0]),Xr=16,mt=.4477152502,ee="center",oe="left",De="top",Ar="bottom",fe="right",Oe="none",Yr=/\r?\n/,rn="moving",lr="scaling",sn="rotating",qr="rotate",nn="skewing",oi="resizing",po="modifyPoly",mo="modifyPath",Ki="changed",hr="scale",Me="scaleX",Ne="scaleY",Xt="skewX",Yt="skewY",ye="fill",Re="stroke",Ji="modified",Lt="json",xr="svg",N=new class{constructor(){this[Lt]=new Map,this[xr]=new Map}has(u){return this[Lt].has(u)}getClass(u){const t=this[Lt].get(u);if(!t)throw new Qe("No class registered for ".concat(u));return t}setClass(u,t){t?this[Lt].set(t,u):(this[Lt].set(u.type,u),this[Lt].set(u.type.toLowerCase(),u))}getSVGClass(u){return this[xr].get(u)}setSVGClass(u,t){this[xr].set(t??u.type.toLowerCase(),u)}},Qi=new class extends Array{remove(u){const t=this.indexOf(u);t>-1&&this.splice(t,1)}cancelAll(){const u=this.splice(0);return u.forEach((t=>t.abort())),u}cancelByCanvas(u){if(!u)return[];const t=this.filter((e=>{var i;return e.target===u||typeof e.target=="object"&&((i=e.target)===null||i===void 0?void 0:i.canvas)===u}));return t.forEach((e=>e.abort())),t}cancelByTarget(u){if(!u)return[];const t=this.filter((e=>e.target===u));return t.forEach((e=>e.abort())),t}};class vo{constructor(){b(this,"__eventListeners",{})}on(t,e){if(this.__eventListeners||(this.__eventListeners={}),typeof t=="object")return Object.entries(t).forEach((i=>{let[r,s]=i;this.on(r,s)})),()=>this.off(t);if(e){const i=t;return this.__eventListeners[i]||(this.__eventListeners[i]=[]),this.__eventListeners[i].push(e),()=>this.off(i,e)}return()=>!1}once(t,e){if(typeof t=="object"){const i=[];return Object.entries(t).forEach((r=>{let[s,n]=r;i.push(this.once(s,n))})),()=>i.forEach((r=>r()))}if(e){const i=this.on(t,(function(){for(var r=arguments.length,s=new Array(r),n=0;n<r;n++)s[n]=arguments[n];e.call(this,...s),i()}));return i}return()=>!1}_removeEventListener(t,e){if(this.__eventListeners[t])if(e){const i=this.__eventListeners[t],r=i.indexOf(e);r>-1&&i.splice(r,1)}else this.__eventListeners[t]=[]}off(t,e){if(this.__eventListeners)if(t===void 0)for(const i in this.__eventListeners)this._removeEventListener(i);else typeof t=="object"?Object.entries(t).forEach((i=>{let[r,s]=i;this._removeEventListener(r,s)})):this._removeEventListener(t,e)}fire(t,e){var i;if(!this.__eventListeners)return;const r=(i=this.__eventListeners[t])===null||i===void 0?void 0:i.concat();if(r)for(let s=0;s<r.length;s++)r[s].call(this,e||{})}}const It=(u,t)=>{const e=u.indexOf(t);return e!==-1&&u.splice(e,1),u},ht=u=>{if(u===0)return 1;switch(Math.abs(u)/di){case 1:case 3:return 0;case 2:return-1}return Math.cos(u)},ct=u=>{if(u===0)return 0;const t=u/di,e=Math.sign(u);switch(t){case 1:return e;case 2:return 0;case 3:return-e}return Math.sin(u)};class O{constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;typeof t=="object"?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e)}add(t){return new O(this.x+t.x,this.y+t.y)}addEquals(t){return this.x+=t.x,this.y+=t.y,this}scalarAdd(t){return new O(this.x+t,this.y+t)}scalarAddEquals(t){return this.x+=t,this.y+=t,this}subtract(t){return new O(this.x-t.x,this.y-t.y)}subtractEquals(t){return this.x-=t.x,this.y-=t.y,this}scalarSubtract(t){return new O(this.x-t,this.y-t)}scalarSubtractEquals(t){return this.x-=t,this.y-=t,this}multiply(t){return new O(this.x*t.x,this.y*t.y)}scalarMultiply(t){return new O(this.x*t,this.y*t)}scalarMultiplyEquals(t){return this.x*=t,this.y*=t,this}divide(t){return new O(this.x/t.x,this.y/t.y)}scalarDivide(t){return new O(this.x/t,this.y/t)}scalarDivideEquals(t){return this.x/=t,this.y/=t,this}eq(t){return this.x===t.x&&this.y===t.y}lt(t){return this.x<t.x&&this.y<t.y}lte(t){return this.x<=t.x&&this.y<=t.y}gt(t){return this.x>t.x&&this.y>t.y}gte(t){return this.x>=t.x&&this.y>=t.y}lerp(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:.5;return e=Math.max(Math.min(1,e),0),new O(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e)}distanceFrom(t){const e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)}midPointFrom(t){return this.lerp(t)}min(t){return new O(Math.min(this.x,t.x),Math.min(this.y,t.y))}max(t){return new O(Math.max(this.x,t.x),Math.max(this.y,t.y))}toString(){return"".concat(this.x,",").concat(this.y)}setXY(t,e){return this.x=t,this.y=e,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setFromPoint(t){return this.x=t.x,this.y=t.y,this}swap(t){const e=this.x,i=this.y;this.x=t.x,this.y=t.y,t.x=e,t.y=i}clone(){return new O(this.x,this.y)}rotate(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Zr;const i=ct(t),r=ht(t),s=this.subtract(e);return new O(s.x*r-s.y*i,s.x*i+s.y*r).add(e)}transform(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new O(t[0]*this.x+t[2]*this.y+(e?0:t[4]),t[1]*this.x+t[3]*this.y+(e?0:t[5]))}}const Zr=new O(0,0),Vi=u=>!!u&&Array.isArray(u._objects);function on(u){class t extends u{constructor(){super(...arguments),b(this,"_objects",[])}_onObjectAdded(i){}_onObjectRemoved(i){}_onStackOrderChanged(i){}add(){for(var i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];const n=this._objects.push(...r);return r.forEach((o=>this._onObjectAdded(o))),n}insertAt(i){for(var r=arguments.length,s=new Array(r>1?r-1:0),n=1;n<r;n++)s[n-1]=arguments[n];return this._objects.splice(i,0,...s),s.forEach((o=>this._onObjectAdded(o))),this._objects.length}remove(){const i=this._objects,r=[];for(var s=arguments.length,n=new Array(s),o=0;o<s;o++)n[o]=arguments[o];return n.forEach((a=>{const l=i.indexOf(a);l!==-1&&(i.splice(l,1),r.push(a),this._onObjectRemoved(a))})),r}forEachObject(i){this.getObjects().forEach(((r,s,n)=>i(r,s,n)))}getObjects(){for(var i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return r.length===0?[...this._objects]:this._objects.filter((n=>n.isType(...r)))}item(i){return this._objects[i]}isEmpty(){return this._objects.length===0}size(){return this._objects.length}contains(i,r){return!!this._objects.includes(i)||!!r&&this._objects.some((s=>s instanceof t&&s.contains(i,!0)))}complexity(){return this._objects.reduce(((i,r)=>i+=r.complexity?r.complexity():0),0)}sendObjectToBack(i){return!(!i||i===this._objects[0])&&(It(this._objects,i),this._objects.unshift(i),this._onStackOrderChanged(i),!0)}bringObjectToFront(i){return!(!i||i===this._objects[this._objects.length-1])&&(It(this._objects,i),this._objects.push(i),this._onStackOrderChanged(i),!0)}sendObjectBackwards(i,r){if(!i)return!1;const s=this._objects.indexOf(i);if(s!==0){const n=this.findNewLowerIndex(i,s,r);return It(this._objects,i),this._objects.splice(n,0,i),this._onStackOrderChanged(i),!0}return!1}bringObjectForward(i,r){if(!i)return!1;const s=this._objects.indexOf(i);if(s!==this._objects.length-1){const n=this.findNewUpperIndex(i,s,r);return It(this._objects,i),this._objects.splice(n,0,i),this._onStackOrderChanged(i),!0}return!1}moveObjectTo(i,r){return i!==this._objects[r]&&(It(this._objects,i),this._objects.splice(r,0,i),this._onStackOrderChanged(i),!0)}findNewLowerIndex(i,r,s){let n;if(s){n=r;for(let o=r-1;o>=0;--o)if(i.isOverlapping(this._objects[o])){n=o;break}}else n=r-1;return n}findNewUpperIndex(i,r,s){let n;if(s){n=r;for(let o=r+1;o<this._objects.length;++o)if(i.isOverlapping(this._objects[o])){n=o;break}}else n=r+1;return n}collectObjects(i){let{left:r,top:s,width:n,height:o}=i,{includeIntersecting:a=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const l=[],h=new O(r,s),c=h.add(new O(n,o));for(let d=this._objects.length-1;d>=0;d--){const g=this._objects[d];g.selectable&&g.visible&&(a&&g.intersectsWithRect(h,c)||g.isContainedWithinRect(h,c)||a&&g.containsPoint(h)||a&&g.containsPoint(c))&&l.push(g)}return l}}return t}class an extends vo{_setOptions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};for(const e in t)this.set(e,t[e])}_setObject(t){for(const e in t)this._set(e,t[e])}set(t,e){return typeof t=="object"?this._setObject(t):this._set(t,e),this}_set(t,e){this[t]=e}toggle(t){const e=this.get(t);return typeof e=="boolean"&&this.set(t,!e),this}get(t){return this[t]}}function Gi(u){return ar().requestAnimationFrame(u)}function yo(u){return ar().cancelAnimationFrame(u)}let wo=0;const wt=()=>wo++,ut=()=>{const u=Gt().createElement("canvas");if(!u||u.getContext===void 0)throw new Qe("Failed to create `canvas` element");return u},xo=()=>Gt().createElement("img"),We=u=>{const t=ut();return t.width=u.width,t.height=u.height,t},ln=(u,t,e)=>u.toDataURL("image/".concat(t),e),hn=(u,t,e)=>new Promise(((i,r)=>{u.toBlob(i,"image/".concat(t),e)})),pe=u=>u*Gr,dt=u=>u/Gr,_o=u=>u.every(((t,e)=>t===Ee[e])),Pe=(u,t,e)=>new O(u).transform(t,e),qe=u=>{const t=1/(u[0]*u[3]-u[1]*u[2]),e=[t*u[3],-t*u[1],-t*u[2],t*u[0],0,0],{x:i,y:r}=new O(u[4],u[5]).transform(e,!0);return e[4]=-i,e[5]=-r,e},Te=(u,t,e)=>[u[0]*t[0]+u[2]*t[1],u[1]*t[0]+u[3]*t[1],u[0]*t[2]+u[2]*t[3],u[1]*t[2]+u[3]*t[3],e?0:u[0]*t[4]+u[2]*t[5]+u[4],e?0:u[1]*t[4]+u[3]*t[5]+u[5]],Kr=(u,t)=>u.reduceRight(((e,i)=>i&&e?Te(i,e,t):i||e),void 0)||Ee.concat(),cn=u=>{let[t,e]=u;return Math.atan2(e,t)},$i=u=>{const t=cn(u),e=Math.pow(u[0],2)+Math.pow(u[1],2),i=Math.sqrt(e),r=(u[0]*u[3]-u[2]*u[1])/i,s=Math.atan2(u[0]*u[2]+u[1]*u[3],e);return{angle:dt(t),scaleX:i,scaleY:r,skewX:dt(s),skewY:0,translateX:u[4]||0,translateY:u[5]||0}},gi=function(u){return[1,0,0,1,u,arguments.length>1&&arguments[1]!==void 0?arguments[1]:0]};function qt(){let{angle:u=0}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{x:t=0,y:e=0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const i=pe(u),r=ht(i),s=ct(i);return[r,s,-s,r,t?t-(r*t-s*e):0,e?e-(s*t+r*e):0]}const Jr=function(u){return[u,0,0,arguments.length>1&&arguments[1]!==void 0?arguments[1]:u,0,0]},un=u=>Math.tan(pe(u)),dn=u=>[1,0,un(u),1,0,0],gn=u=>[1,un(u),0,1,0,0],cr=u=>{let{scaleX:t=1,scaleY:e=1,flipX:i=!1,flipY:r=!1,skewX:s=0,skewY:n=0}=u,o=Jr(i?-t:t,r?-e:e);return s&&(o=Te(o,dn(s),!0)),n&&(o=Te(o,gn(n),!0)),o},To=u=>{const{translateX:t=0,translateY:e=0,angle:i=0}=u;let r=gi(t,e);i&&(r=Te(r,qt({angle:i})));const s=cr(u);return _o(s)||(r=Te(r,s)),r},Xi=function(u){let{signal:t,crossOrigin:e=null}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return new Promise((function(i,r){if(t&&t.aborted)return r(new co("loadImage"));const s=xo();let n;t&&(n=function(a){s.src="",r(a)},t.addEventListener("abort",n,{once:!0}));const o=function(){s.onload=s.onerror=null,n&&t?.removeEventListener("abort",n),i(s)};u?(s.onload=o,s.onerror=function(){n&&t?.removeEventListener("abort",n),r(new Qe("Error loading ".concat(s.src)))},e&&(s.crossOrigin=e),s.src=u):o()}))},ai=function(u){let{signal:t,reviver:e=Ui}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return new Promise(((i,r)=>{const s=[];t&&t.addEventListener("abort",r,{once:!0}),Promise.all(u.map((n=>N.getClass(n.type).fromObject(n,{signal:t}).then((o=>(e(n,o),s.push(o),o)))))).then(i).catch((n=>{s.forEach((o=>{o.dispose&&o.dispose()})),r(n)})).finally((()=>{t&&t.removeEventListener("abort",r)}))}))},ur=function(u){let{signal:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return new Promise(((e,i)=>{const r=[];t&&t.addEventListener("abort",i,{once:!0});const s=Object.values(u).map((o=>o&&o.type&&N.has(o.type)?ai([o],{signal:t}).then((a=>{let[l]=a;return r.push(l),l})):o)),n=Object.keys(u);Promise.all(s).then((o=>o.reduce(((a,l,h)=>(a[n[h]]=l,a)),{}))).then(e).catch((o=>{r.forEach((a=>{a.dispose&&a.dispose()})),i(o)})).finally((()=>{t&&t.removeEventListener("abort",i)}))}))},Zt=function(u){return(arguments.length>1&&arguments[1]!==void 0?arguments[1]:[]).reduce(((t,e)=>(e in u&&(t[e]=u[e]),t)),{})},Qr=(u,t)=>Object.keys(u).reduce(((e,i)=>(t(u[i],i,u)&&(e[i]=u[i]),e)),{}),he=(u,t)=>parseFloat(Number(u).toFixed(t)),li=u=>"matrix("+u.map((t=>he(t,re.NUM_FRACTION_DIGITS))).join(" ")+")",ze=u=>!!u&&u.toLive!==void 0,vs=u=>!!u&&typeof u.toObject=="function",ys=u=>!!u&&u.offsetX!==void 0&&"source"in u,St=u=>!!u&&"multiSelectionStacking"in u;function fn(u){const t=u&&Ye(u);let e=0,i=0;if(!u||!t)return{left:e,top:i};let r=u;const s=t.documentElement,n=t.body||{scrollLeft:0,scrollTop:0};for(;r&&(r.parentNode||r.host)&&(r=r.parentNode||r.host,r===t?(e=n.scrollLeft||s.scrollLeft||0,i=n.scrollTop||s.scrollTop||0):(e+=r.scrollLeft||0,i+=r.scrollTop||0),r.nodeType!==1||r.style.position!=="fixed"););return{left:e,top:i}}const Ye=u=>u.ownerDocument||null,pn=u=>{var t;return((t=u.ownerDocument)===null||t===void 0?void 0:t.defaultView)||null},mn=function(u,t,e){let{width:i,height:r}=e,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;u.width=i,u.height=r,s>1&&(u.setAttribute("width",(i*s).toString()),u.setAttribute("height",(r*s).toString()),t.scale(s,s))},Lr=(u,t)=>{let{width:e,height:i}=t;e&&(u.style.width=typeof e=="number"?"".concat(e,"px"):e),i&&(u.style.height=typeof i=="number"?"".concat(i,"px"):i)};function ws(u){return u.onselectstart!==void 0&&(u.onselectstart=()=>!1),u.style.userSelect=Oe,u}class vn{constructor(t){b(this,"_originalCanvasStyle",void 0),b(this,"lower",void 0);const e=this.createLowerCanvas(t);this.lower={el:e,ctx:e.getContext("2d")}}createLowerCanvas(t){const e=(i=t)&&i.getContext!==void 0?t:t&&Gt().getElementById(t)||ut();var i;if(e.hasAttribute("data-fabric"))throw new Qe("Trying to initialize a canvas that has already been initialized. Did you forget to dispose the canvas?");return this._originalCanvasStyle=e.style.cssText,e.setAttribute("data-fabric","main"),e.classList.add("lower-canvas"),e}cleanupDOM(t){let{width:e,height:i}=t;const{el:r}=this.lower;r.classList.remove("lower-canvas"),r.removeAttribute("data-fabric"),r.setAttribute("width","".concat(e)),r.setAttribute("height","".concat(i)),r.style.cssText=this._originalCanvasStyle||"",this._originalCanvasStyle=void 0}setDimensions(t,e){const{el:i,ctx:r}=this.lower;mn(i,r,t,e)}setCSSDimensions(t){Lr(this.lower.el,t)}calcOffset(){return(function(t){var e;const i=t&&Ye(t),r={left:0,top:0};if(!i)return r;const s=((e=pn(t))===null||e===void 0?void 0:e.getComputedStyle(t,null))||{};r.left+=parseInt(s.borderLeftWidth,10)||0,r.top+=parseInt(s.borderTopWidth,10)||0,r.left+=parseInt(s.paddingLeft,10)||0,r.top+=parseInt(s.paddingTop,10)||0;let n={left:0,top:0};const o=i.documentElement;t.getBoundingClientRect!==void 0&&(n=t.getBoundingClientRect());const a=fn(t);return{left:n.left+a.left-(o.clientLeft||0)+r.left,top:n.top+a.top-(o.clientTop||0)+r.top}})(this.lower.el)}dispose(){$e().dispose(this.lower.el),delete this.lower}}const So={backgroundVpt:!0,backgroundColor:"",overlayVpt:!0,overlayColor:"",includeDefaultValues:!0,svgViewportTransformation:!0,renderOnAddRemove:!0,skipOffscreen:!0,enableRetinaScaling:!0,imageSmoothingEnabled:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,viewportTransform:[...Ee]};class fi extends on(an){get lowerCanvasEl(){var t;return(t=this.elements.lower)===null||t===void 0?void 0:t.el}get contextContainer(){var t;return(t=this.elements.lower)===null||t===void 0?void 0:t.ctx}static getDefaults(){return fi.ownDefaults}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),Object.assign(this,this.constructor.getDefaults()),this.set(e),this.initElements(t),this._setDimensionsImpl({width:this.width||this.elements.lower.el.width||0,height:this.height||this.elements.lower.el.height||0}),this.skipControlsDrawing=!1,this.viewportTransform=[...this.viewportTransform],this.calcViewportBoundaries()}initElements(t){this.elements=new vn(t)}add(){const t=super.add(...arguments);return arguments.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),t}insertAt(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];const s=super.insertAt(t,...i);return i.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),s}remove(){const t=super.remove(...arguments);return t.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),t}_onObjectAdded(t){t.canvas&&t.canvas!==this&&(yt("warn",`Canvas is trying to add an object that belongs to a different canvas.
Resulting to default behavior: removing object from previous canvas and adding to new canvas`),t.canvas.remove(t)),t._set("canvas",this),t.setCoords(),this.fire("object:added",{target:t}),t.fire("added",{target:this})}_onObjectRemoved(t){t._set("canvas",void 0),this.fire("object:removed",{target:t}),t.fire("removed",{target:this})}_onStackOrderChanged(){this.renderOnAddRemove&&this.requestRenderAll()}getRetinaScaling(){return this.enableRetinaScaling?tn():1}calcOffset(){return this._offset=this.elements.calcOffset()}getWidth(){return this.width}getHeight(){return this.height}setWidth(t,e){return this.setDimensions({width:t},e)}setHeight(t,e){return this.setDimensions({height:t},e)}_setDimensionsImpl(t){let{cssOnly:e=!1,backstoreOnly:i=!1}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!e){const r=E({width:this.width,height:this.height},t);this.elements.setDimensions(r,this.getRetinaScaling()),this.hasLostContext=!0,this.width=r.width,this.height=r.height}i||this.elements.setCSSDimensions(t),this.calcOffset()}setDimensions(t,e){this._setDimensionsImpl(t,e),e&&e.cssOnly||this.requestRenderAll()}getZoom(){return this.viewportTransform[0]}setViewportTransform(t){this.viewportTransform=t,this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll()}zoomToPoint(t,e){const i=t,r=[...this.viewportTransform],s=Pe(t,qe(r));r[0]=e,r[3]=e;const n=Pe(s,r);r[4]+=i.x-n.x,r[5]+=i.y-n.y,this.setViewportTransform(r)}setZoom(t){this.zoomToPoint(new O(0,0),t)}absolutePan(t){const e=[...this.viewportTransform];return e[4]=-t.x,e[5]=-t.y,this.setViewportTransform(e)}relativePan(t){return this.absolutePan(new O(-t.x-this.viewportTransform[4],-t.y-this.viewportTransform[5]))}getElement(){return this.elements.lower.el}clearContext(t){t.clearRect(0,0,this.width,this.height)}getContext(){return this.elements.lower.ctx}clear(){this.remove(...this.getObjects()),this.backgroundImage=void 0,this.overlayImage=void 0,this.backgroundColor="",this.overlayColor="",this.clearContext(this.getContext()),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll()}renderAll(){this.cancelRequestedRender(),this.destroyed||this.renderCanvas(this.getContext(),this._objects)}renderAndReset(){this.nextRenderHandle=0,this.renderAll()}requestRenderAll(){this.nextRenderHandle||this.disposed||this.destroyed||(this.nextRenderHandle=Gi((()=>this.renderAndReset())))}calcViewportBoundaries(){const t=this.width,e=this.height,i=qe(this.viewportTransform),r=Pe({x:0,y:0},i),s=Pe({x:t,y:e},i),n=r.min(s),o=r.max(s);return this.vptCoords={tl:n,tr:new O(o.x,n.y),bl:new O(n.x,o.y),br:o}}cancelRequestedRender(){this.nextRenderHandle&&(yo(this.nextRenderHandle),this.nextRenderHandle=0)}drawControls(t){}renderCanvas(t,e){if(this.destroyed)return;const i=this.viewportTransform,r=this.clipPath;this.calcViewportBoundaries(),this.clearContext(t),t.imageSmoothingEnabled=this.imageSmoothingEnabled,t.patternQuality="best",this.fire("before:render",{ctx:t}),this._renderBackground(t),t.save(),t.transform(i[0],i[1],i[2],i[3],i[4],i[5]),this._renderObjects(t,e),t.restore(),this.controlsAboveOverlay||this.skipControlsDrawing||this.drawControls(t),r&&(r._set("canvas",this),r.shouldCache(),r._transformDone=!0,r.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(t,r)),this._renderOverlay(t),this.controlsAboveOverlay&&!this.skipControlsDrawing&&this.drawControls(t),this.fire("after:render",{ctx:t}),this.__cleanupTask&&(this.__cleanupTask(),this.__cleanupTask=void 0)}drawClipPathOnCanvas(t,e){const i=this.viewportTransform;t.save(),t.transform(...i),t.globalCompositeOperation="destination-in",e.transform(t),t.scale(1/e.zoomX,1/e.zoomY),t.drawImage(e._cacheCanvas,-e.cacheTranslationX,-e.cacheTranslationY),t.restore()}_renderObjects(t,e){for(let i=0,r=e.length;i<r;++i)e[i]&&e[i].render(t)}_renderBackgroundOrOverlay(t,e){const i=this["".concat(e,"Color")],r=this["".concat(e,"Image")],s=this.viewportTransform,n=this["".concat(e,"Vpt")];if(!i&&!r)return;const o=ze(i);if(i){if(t.save(),t.beginPath(),t.moveTo(0,0),t.lineTo(this.width,0),t.lineTo(this.width,this.height),t.lineTo(0,this.height),t.closePath(),t.fillStyle=o?i.toLive(t):i,n&&t.transform(...s),o){t.transform(1,0,0,1,i.offsetX||0,i.offsetY||0);const a=i.gradientTransform||i.patternTransform;a&&t.transform(...a)}t.fill(),t.restore()}if(r){t.save();const{skipOffscreen:a}=this;this.skipOffscreen=n,n&&t.transform(...s),r.render(t),this.skipOffscreen=a,t.restore()}}_renderBackground(t){this._renderBackgroundOrOverlay(t,"background")}_renderOverlay(t){this._renderBackgroundOrOverlay(t,"overlay")}getCenter(){return{top:this.height/2,left:this.width/2}}getCenterPoint(){return new O(this.width/2,this.height/2)}centerObjectH(t){return this._centerObject(t,new O(this.getCenterPoint().x,t.getCenterPoint().y))}centerObjectV(t){return this._centerObject(t,new O(t.getCenterPoint().x,this.getCenterPoint().y))}centerObject(t){return this._centerObject(t,this.getCenterPoint())}viewportCenterObject(t){return this._centerObject(t,this.getVpCenter())}viewportCenterObjectH(t){return this._centerObject(t,new O(this.getVpCenter().x,t.getCenterPoint().y))}viewportCenterObjectV(t){return this._centerObject(t,new O(t.getCenterPoint().x,this.getVpCenter().y))}getVpCenter(){return Pe(this.getCenterPoint(),qe(this.viewportTransform))}_centerObject(t,e){t.setXY(e,ee,ee),t.setCoords(),this.renderOnAddRemove&&this.requestRenderAll()}toDatalessJSON(t){return this.toDatalessObject(t)}toObject(t){return this._toObjectMethod("toObject",t)}toJSON(){return this.toObject()}toDatalessObject(t){return this._toObjectMethod("toDatalessObject",t)}_toObjectMethod(t,e){const i=this.clipPath,r=i&&!i.excludeFromExport?this._toObject(i,t,e):null;return E(E(E({version:Fr},Zt(this,e)),{},{objects:this._objects.filter((s=>!s.excludeFromExport)).map((s=>this._toObject(s,t,e)))},this.__serializeBgOverlay(t,e)),r?{clipPath:r}:null)}_toObject(t,e,i){let r;this.includeDefaultValues||(r=t.includeDefaultValues,t.includeDefaultValues=!1);const s=t[e](i);return this.includeDefaultValues||(t.includeDefaultValues=!!r),s}__serializeBgOverlay(t,e){const i={},r=this.backgroundImage,s=this.overlayImage,n=this.backgroundColor,o=this.overlayColor;return ze(n)?n.excludeFromExport||(i.background=n.toObject(e)):n&&(i.background=n),ze(o)?o.excludeFromExport||(i.overlay=o.toObject(e)):o&&(i.overlay=o),r&&!r.excludeFromExport&&(i.backgroundImage=this._toObject(r,t,e)),s&&!s.excludeFromExport&&(i.overlayImage=this._toObject(s,t,e)),i}toSVG(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1?arguments[1]:void 0;t.reviver=e;const i=[];return this._setSVGPreamble(i,t),this._setSVGHeader(i,t),this.clipPath&&i.push('<g clip-path="url(#'.concat(this.clipPath.clipPathId,`)" >
`)),this._setSVGBgOverlayColor(i,"background"),this._setSVGBgOverlayImage(i,"backgroundImage",e),this._setSVGObjects(i,e),this.clipPath&&i.push(`</g>
`),this._setSVGBgOverlayColor(i,"overlay"),this._setSVGBgOverlayImage(i,"overlayImage",e),i.push("</svg>"),i.join("")}_setSVGPreamble(t,e){e.suppressPreamble||t.push('<?xml version="1.0" encoding="',e.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)}_setSVGHeader(t,e){const i=e.width||"".concat(this.width),r=e.height||"".concat(this.height),s=re.NUM_FRACTION_DIGITS,n=e.viewBox;let o;if(n)o='viewBox="'.concat(n.x," ").concat(n.y," ").concat(n.width," ").concat(n.height,'" ');else if(this.svgViewportTransformation){const a=this.viewportTransform;o='viewBox="'.concat(he(-a[4]/a[0],s)," ").concat(he(-a[5]/a[3],s)," ").concat(he(this.width/a[0],s)," ").concat(he(this.height/a[3],s),'" ')}else o='viewBox="0 0 '.concat(this.width," ").concat(this.height,'" ');t.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',i,'" ','height="',r,'" ',o,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",Fr,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(e),`</defs>
`)}createSVGClipPathMarkup(t){const e=this.clipPath;return e?(e.clipPathId="CLIPPATH_".concat(wt()),'<clipPath id="'.concat(e.clipPathId,`" >
`).concat(e.toClipPathSVG(t.reviver),`</clipPath>
`)):""}createSVGRefElementsMarkup(){return["background","overlay"].map((t=>{const e=this["".concat(t,"Color")];if(ze(e)){const i=this["".concat(t,"Vpt")],r=this.viewportTransform,s={isType:()=>!1,width:this.width/(i?r[0]:1),height:this.height/(i?r[3]:1)};return e.toSVG(s,{additionalTransform:i?li(r):""})}})).join("")}createSVGFontFacesMarkup(){const t=[],e={},i=re.fontPaths;this._objects.forEach((function s(n){t.push(n),Vi(n)&&n._objects.forEach(s)})),t.forEach((s=>{if(!(n=s)||typeof n._renderText!="function")return;var n;const{styles:o,fontFamily:a}=s;!e[a]&&i[a]&&(e[a]=!0,o&&Object.values(o).forEach((l=>{Object.values(l).forEach((h=>{let{fontFamily:c=""}=h;!e[c]&&i[c]&&(e[c]=!0)}))})))}));const r=Object.keys(e).map((s=>`		@font-face {
			font-family: '`.concat(s,`';
			src: url('`).concat(i[s],`');
		}
`))).join("");return r?`	<style type="text/css"><![CDATA[
`.concat(r,`]]></style>
`):""}_setSVGObjects(t,e){this.forEachObject((i=>{i.excludeFromExport||this._setSVGObject(t,i,e)}))}_setSVGObject(t,e,i){t.push(e.toSVG(i))}_setSVGBgOverlayImage(t,e,i){const r=this[e];r&&!r.excludeFromExport&&r.toSVG&&t.push(r.toSVG(i))}_setSVGBgOverlayColor(t,e){const i=this["".concat(e,"Color")];if(i)if(ze(i)){const r=i.repeat||"",s=this.width,n=this.height,o=this["".concat(e,"Vpt")]?li(qe(this.viewportTransform)):"";t.push('<rect transform="'.concat(o," translate(").concat(s/2,",").concat(n/2,')" x="').concat(i.offsetX-s/2,'" y="').concat(i.offsetY-n/2,'" width="').concat(r!=="repeat-y"&&r!=="no-repeat"||!ys(i)?s:i.source.width,'" height="').concat(r!=="repeat-x"&&r!=="no-repeat"||!ys(i)?n:i.source.height,'" fill="url(#SVGID_').concat(i.id,`)"></rect>
`))}else t.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',i,'"',`></rect>
`)}loadFromJSON(t,e){let{signal:i}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(!t)return Promise.reject(new Qe("`json` is undefined"));const r=typeof t=="string"?JSON.parse(t):t,{objects:s=[],backgroundImage:n,background:o,overlayImage:a,overlay:l,clipPath:h}=r,c=this.renderOnAddRemove;return this.renderOnAddRemove=!1,Promise.all([ai(s,{reviver:e,signal:i}),ur({backgroundImage:n,backgroundColor:o,overlayImage:a,overlayColor:l,clipPath:h},{signal:i})]).then((d=>{let[g,p]=d;return this.clear(),this.add(...g),this.set(r),this.set(p),this.renderOnAddRemove=c,this}))}clone(t){const e=this.toObject(t);return this.cloneWithoutData().loadFromJSON(e)}cloneWithoutData(){const t=We(this);return new this.constructor(t)}toDataURL(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{format:e="png",quality:i=1,multiplier:r=1,enableRetinaScaling:s=!1}=t,n=r*(s?this.getRetinaScaling():1);return ln(this.toCanvasElement(n,t),e,i)}toBlob(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{format:e="png",quality:i=1,multiplier:r=1,enableRetinaScaling:s=!1}=t,n=r*(s?this.getRetinaScaling():1);return hn(this.toCanvasElement(n,t),e,i)}toCanvasElement(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,{width:e,height:i,left:r,top:s,filter:n}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const o=(e||this.width)*t,a=(i||this.height)*t,l=this.getZoom(),h=this.width,c=this.height,d=this.skipControlsDrawing,g=l*t,p=this.viewportTransform,v=[g,0,0,g,(p[4]-(r||0))*t,(p[5]-(s||0))*t],w=this.enableRetinaScaling,x=We({width:o,height:a}),C=n?this._objects.filter((P=>n(P))):this._objects;return this.enableRetinaScaling=!1,this.viewportTransform=v,this.width=o,this.height=a,this.skipControlsDrawing=!0,this.calcViewportBoundaries(),this.renderCanvas(x.getContext("2d"),C),this.viewportTransform=p,this.width=h,this.height=c,this.calcViewportBoundaries(),this.enableRetinaScaling=w,this.skipControlsDrawing=d,x}dispose(){return!this.disposed&&this.elements.cleanupDOM({width:this.width,height:this.height}),Qi.cancelByCanvas(this),this.disposed=!0,new Promise(((t,e)=>{const i=()=>{this.destroy(),t(!0)};i.kill=e,this.__cleanupTask&&this.__cleanupTask.kill("aborted"),this.destroyed?t(!1):this.nextRenderHandle?this.__cleanupTask=i:i()}))}destroy(){this.destroyed=!0,this.cancelRequestedRender(),this.forEachObject((t=>t.dispose())),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose(),this.backgroundImage=void 0,this.overlayImage&&this.overlayImage.dispose(),this.overlayImage=void 0,this.elements.dispose()}toString(){return"#<Canvas (".concat(this.complexity(),"): { objects: ").concat(this._objects.length," }>")}}b(fi,"ownDefaults",So);const Co=["touchstart","touchmove","touchend"],bo=u=>{const t=fn(u.target),e=(function(i){const r=i.changedTouches;return r&&r[0]?r[0]:i})(u);return new O(e.clientX+t.left,e.clientY+t.top)},Br=u=>Co.includes(u.type)||u.pointerType==="touch",xs=u=>{u.preventDefault(),u.stopPropagation()},at=u=>{let t=0,e=0,i=0,r=0;for(let s=0,n=u.length;s<n;s++){const{x:o,y:a}=u[s];(o>i||!s)&&(i=o),(o<t||!s)&&(t=o),(a>r||!s)&&(r=a),(a<e||!s)&&(e=a)}return{left:t,top:e,width:i-t,height:r-e}},Eo=["translateX","translateY","scaleX","scaleY"],Po=(u,t)=>er(u,Te(t,u.calcOwnMatrix())),er=(u,t)=>{const e=$i(t),{translateX:i,translateY:r,scaleX:s,scaleY:n}=e,o=ue(e,Eo),a=new O(i,r);u.flipX=!1,u.flipY=!1,Object.assign(u,o),u.set({scaleX:s,scaleY:n}),u.setPositionByOrigin(a,ee,ee)},Do=u=>{u.scaleX=1,u.scaleY=1,u.skewX=0,u.skewY=0,u.flipX=!1,u.flipY=!1,u.rotate(0)},yn=u=>({scaleX:u.scaleX,scaleY:u.scaleY,skewX:u.skewX,skewY:u.skewY,angle:u.angle,left:u.left,flipX:u.flipX,flipY:u.flipY,top:u.top}),$r=(u,t,e)=>{const i=u/2,r=t/2,s=[new O(-i,-r),new O(i,-r),new O(-i,r),new O(i,r)].map((o=>o.transform(e))),n=at(s);return new O(n.width,n.height)},dr=function(){let u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Ee;return Te(qe(arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ee),u)},Nt=function(u){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ee,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ee;return u.transform(dr(t,e))},Oo=function(u){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ee,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ee;return u.transform(dr(t,e),!0)},Ro=(u,t,e)=>{const i=dr(t,e);return er(u,Te(i,u.calcOwnMatrix())),i},wn=(u,t)=>{var e;const{transform:{target:i}}=t;(e=i.canvas)===null||e===void 0||e.fire("object:".concat(u),E(E({},t),{},{target:i})),i.fire(u,t)},Mo={left:-.5,top:-.5,center:0,bottom:.5,right:.5},ve=u=>typeof u=="string"?Mo[u]:u-.5,tr="not-allowed";function xn(u){return ve(u.originX)===ve(ee)&&ve(u.originY)===ve(ee)}function _s(u){return .5-ve(u)}const Ke=(u,t)=>u[t],_n=(u,t,e,i)=>({e:u,transform:t,pointer:new O(e,i)});function Tn(u,t){const e=u.getTotalAngle()+dt(Math.atan2(t.y,t.x))+360;return Math.round(e%360/45)}function es(u,t,e,i,r){var s;let{target:n,corner:o}=u;const a=n.controls[o],l=((s=n.canvas)===null||s===void 0?void 0:s.getZoom())||1,h=n.padding/l,c=(function(d,g,p,v){const w=d.getRelativeCenterPoint(),x=p!==void 0&&v!==void 0?d.translateToGivenOrigin(w,ee,ee,p,v):new O(d.left,d.top);return(d.angle?g.rotate(-pe(d.angle),w):g).subtract(x)})(n,new O(i,r),t,e);return c.x>=h&&(c.x-=h),c.x<=-h&&(c.x+=h),c.y>=h&&(c.y-=h),c.y<=h&&(c.y+=h),c.x-=a.offsetX,c.y-=a.offsetY,c}const ko=(u,t,e,i)=>{const{target:r,offsetX:s,offsetY:n}=t,o=e-s,a=i-n,l=!Ke(r,"lockMovementX")&&r.left!==o,h=!Ke(r,"lockMovementY")&&r.top!==a;return l&&r.set(oe,o),h&&r.set(De,a),(l||h)&&wn(rn,_n(u,t,e,i)),l||h},Ts={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#0FF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000",blanchedalmond:"#FFEBCD",blue:"#00F",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#0FF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#F0F",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#789",lightslategrey:"#789",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#0F0",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#F0F",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#639",red:"#F00",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFF",whitesmoke:"#F5F5F5",yellow:"#FF0",yellowgreen:"#9ACD32"},_r=(u,t,e)=>(e<0&&(e+=1),e>1&&(e-=1),e<1/6?u+6*(t-u)*e:e<.5?t:e<2/3?u+(t-u)*(2/3-e)*6:u),Ss=(u,t,e,i)=>{u/=255,t/=255,e/=255;const r=Math.max(u,t,e),s=Math.min(u,t,e);let n,o;const a=(r+s)/2;if(r===s)n=o=0;else{const l=r-s;switch(o=a>.5?l/(2-r-s):l/(r+s),r){case u:n=(t-e)/l+(t<e?6:0);break;case t:n=(e-u)/l+2;break;case e:n=(u-t)/l+4}n/=6}return[Math.round(360*n),Math.round(100*o),Math.round(100*a),i]},Cs=function(){let u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"1";return parseFloat(u)/(u.endsWith("%")?100:1)},vi=u=>Math.min(Math.round(u),255).toString(16).toUpperCase().padStart(2,"0"),bs=u=>{let[t,e,i,r=1]=u;const s=Math.round(.3*t+.59*e+.11*i);return[s,s,s,r]};class le{constructor(t){if(b(this,"isUnrecognised",!1),t)if(t instanceof le)this.setSource([...t._source]);else if(Array.isArray(t)){const[e,i,r,s=1]=t;this.setSource([e,i,r,s])}else this.setSource(this._tryParsingColor(t));else this.setSource([0,0,0,1])}_tryParsingColor(t){return(t=t.toLowerCase())in Ts&&(t=Ts[t]),t==="transparent"?[255,255,255,0]:le.sourceFromHex(t)||le.sourceFromRgb(t)||le.sourceFromHsl(t)||(this.isUnrecognised=!0)&&[0,0,0,1]}getSource(){return this._source}setSource(t){this._source=t}toRgb(){const[t,e,i]=this.getSource();return"rgb(".concat(t,",").concat(e,",").concat(i,")")}toRgba(){return"rgba(".concat(this.getSource().join(","),")")}toHsl(){const[t,e,i]=Ss(...this.getSource());return"hsl(".concat(t,",").concat(e,"%,").concat(i,"%)")}toHsla(){const[t,e,i,r]=Ss(...this.getSource());return"hsla(".concat(t,",").concat(e,"%,").concat(i,"%,").concat(r,")")}toHex(){return this.toHexa().slice(0,6)}toHexa(){const[t,e,i,r]=this.getSource();return"".concat(vi(t)).concat(vi(e)).concat(vi(i)).concat(vi(Math.round(255*r)))}getAlpha(){return this.getSource()[3]}setAlpha(t){return this._source[3]=t,this}toGrayscale(){return this.setSource(bs(this.getSource())),this}toBlackWhite(t){const[e,,,i]=bs(this.getSource()),r=e<(t||127)?0:255;return this.setSource([r,r,r,i]),this}overlayWith(t){t instanceof le||(t=new le(t));const e=this.getSource(),i=t.getSource(),[r,s,n]=e.map(((o,a)=>Math.round(.5*o+.5*i[a])));return this.setSource([r,s,n,e[3]]),this}static fromRgb(t){return le.fromRgba(t)}static fromRgba(t){return new le(le.sourceFromRgb(t))}static sourceFromRgb(t){const e=t.match(/^rgba?\(\s*(\d{0,3}(?:\.\d+)?%?)\s*[\s|,]\s*(\d{0,3}(?:\.\d+)?%?)\s*[\s|,]\s*(\d{0,3}(?:\.\d+)?%?)\s*(?:\s*[,/]\s*(\d{0,3}(?:\.\d+)?%?)\s*)?\)$/i);if(e){const[i,r,s]=e.slice(1,4).map((n=>{const o=parseFloat(n);return n.endsWith("%")?Math.round(2.55*o):o}));return[i,r,s,Cs(e[4])]}}static fromHsl(t){return le.fromHsla(t)}static fromHsla(t){return new le(le.sourceFromHsl(t))}static sourceFromHsl(t){const e=t.match(/^hsla?\(\s*([+-]?\d{0,3}(?:\.\d+)?(?:deg|turn|rad)?)\s*[\s|,]\s*(\d{0,3}(?:\.\d+)?%?)\s*[\s|,]\s*(\d{0,3}(?:\.\d+)?%?)\s*(?:\s*[,/]\s*(\d*(?:\.\d+)?%?)\s*)?\)$/i);if(!e)return;const i=(le.parseAngletoDegrees(e[1])%360+360)%360/360,r=parseFloat(e[2])/100,s=parseFloat(e[3])/100;let n,o,a;if(r===0)n=o=a=s;else{const l=s<=.5?s*(r+1):s+r-s*r,h=2*s-l;n=_r(h,l,i+1/3),o=_r(h,l,i),a=_r(h,l,i-1/3)}return[Math.round(255*n),Math.round(255*o),Math.round(255*a),Cs(e[4])]}static fromHex(t){return new le(le.sourceFromHex(t))}static sourceFromHex(t){if(t.match(/^#?(([0-9a-f]){3,4}|([0-9a-f]{2}){3,4})$/i)){const e=t.slice(t.indexOf("#")+1);let i;i=e.length<=4?e.split("").map((a=>a+a)):e.match(/.{2}/g);const[r,s,n,o=255]=i.map((a=>parseInt(a,16)));return[r,s,n,o/255]}}static parseAngletoDegrees(t){const e=t.toLowerCase(),i=parseFloat(e);return e.includes("rad")?dt(i):e.includes("turn")?360*i:i}}const Wt=function(u){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Xr;const e=/\D{0,2}$/.exec(u),i=parseFloat(u),r=re.DPI;switch(e?.[0]){case"mm":return i*r/25.4;case"cm":return i*r/2.54;case"in":return i*r;case"pt":return i*r/72;case"pc":return i*r/72*12;case"em":return i*t;default:return i}},Fo=u=>{const[t,e]=u.trim().split(" "),[i,r]=(s=t)&&s!==Oe?[s.slice(1,4),s.slice(5,8)]:s===Oe?[s,s]:["Mid","Mid"];var s;return{meetOrSlice:e||"meet",alignX:i,alignY:r}},hi=function(u,t){let e,i,r=!(arguments.length>2&&arguments[2]!==void 0)||arguments[2];if(t)if(t.toLive)e="url(#SVGID_".concat(t.id,")");else{const s=new le(t),n=s.getAlpha();e=s.toRgb(),n!==1&&(i=n.toString())}else e="none";return r?"".concat(u,": ").concat(e,"; ").concat(i?"".concat(u,"-opacity: ").concat(i,"; "):""):"".concat(u,'="').concat(e,'" ').concat(i?"".concat(u,'-opacity="').concat(i,'" '):"")};class Sn{getSvgStyles(t){const e=this.fillRule?this.fillRule:"nonzero",i=this.strokeWidth?this.strokeWidth:"0",r=this.strokeDashArray?this.strokeDashArray.join(" "):Oe,s=this.strokeDashOffset?this.strokeDashOffset:"0",n=this.strokeLineCap?this.strokeLineCap:"butt",o=this.strokeLineJoin?this.strokeLineJoin:"miter",a=this.strokeMiterLimit?this.strokeMiterLimit:"4",l=this.opacity!==void 0?this.opacity:"1",h=this.visible?"":" visibility: hidden;",c=t?"":this.getSvgFilter(),d=hi(ye,this.fill);return[hi(Re,this.stroke),"stroke-width: ",i,"; ","stroke-dasharray: ",r,"; ","stroke-linecap: ",n,"; ","stroke-dashoffset: ",s,"; ","stroke-linejoin: ",o,"; ","stroke-miterlimit: ",a,"; ",d,"fill-rule: ",e,"; ","opacity: ",l,";",c,h].join("")}getSvgFilter(){return this.shadow?"filter: url(#SVGID_".concat(this.shadow.id,");"):""}getSvgCommons(){return[this.id?'id="'.concat(this.id,'" '):"",this.clipPath?'clip-path="url(#'.concat(this.clipPath.clipPathId,')" '):""].join("")}getSvgTransform(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";const i=t?this.calcTransformMatrix():this.calcOwnMatrix(),r='transform="'.concat(li(i));return"".concat(r).concat(e,'" ')}_toSVG(t){return[""]}toSVG(t){return this._createBaseSVGMarkup(this._toSVG(t),{reviver:t})}toClipPathSVG(t){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(t),{reviver:t})}_createBaseClipPathSVGMarkup(t){let{reviver:e,additionalTransform:i=""}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const r=[this.getSvgTransform(!0,i),this.getSvgCommons()].join(""),s=t.indexOf("COMMON_PARTS");return t[s]=r,e?e(t.join("")):t.join("")}_createBaseSVGMarkup(t){let{noStyle:e,reviver:i,withShadow:r,additionalTransform:s}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=e?"":'style="'.concat(this.getSvgStyles(),'" '),o=r?'style="'.concat(this.getSvgFilter(),'" '):"",a=this.clipPath,l=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",h=a&&a.absolutePositioned,c=this.stroke,d=this.fill,g=this.shadow,p=[],v=t.indexOf("COMMON_PARTS");let w;a&&(a.clipPathId="CLIPPATH_".concat(wt()),w='<clipPath id="'.concat(a.clipPathId,`" >
`).concat(a.toClipPathSVG(i),`</clipPath>
`)),h&&p.push("<g ",o,this.getSvgCommons(),` >
`),p.push("<g ",this.getSvgTransform(!1),h?"":o+this.getSvgCommons(),` >
`);const x=[n,l,e?"":this.addPaintOrder()," ",s?'transform="'.concat(s,'" '):""].join("");return t[v]=x,ze(d)&&p.push(d.toSVG(this)),ze(c)&&p.push(c.toSVG(this)),g&&p.push(g.toSVG(this)),a&&p.push(w),p.push(t.join("")),p.push(`</g>
`),h&&p.push(`</g>
`),i?i(p.join("")):p.join("")}addPaintOrder(){return this.paintFirst!==ye?' paint-order="'.concat(this.paintFirst,'" '):""}}function gr(u){return new RegExp("^("+u.join("|")+")\\b","i")}const Rt="textDecorationThickness",Cn=["fontSize","fontWeight","fontFamily","fontStyle"],bn=["underline","overline","linethrough"],En=[...Cn,"lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],Pn=[...En,...bn,"textBackgroundColor","direction",Rt],Ao=[...Cn,...bn,Re,"strokeWidth",ye,"deltaY","textBackgroundColor",Rt],Lo={_reNewline:Yr,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:oe,fontStyle:"normal",lineHeight:1.16,textBackgroundColor:"",stroke:null,shadow:null,path:void 0,pathStartOffset:0,pathSide:oe,pathAlign:"baseline",charSpacing:0,deltaY:0,direction:"ltr",CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.28167,overline:-.81333},_fontSizeMult:1.13,[Rt]:66.667},Je="justify",ir="justify-left",ri="justify-right",si="justify-center";var Es,Ps,Ds;const Ze=String.raw(Es||(Es=et(["[-+]?(?:d*.d+|d+.?)(?:[eE][-+]?d+)?"],["[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?"]))),Tr=String.raw(Ps||(Ps=et(["(?:s*,?s+|s*,s*)"],["(?:\\s*,?\\s+|\\s*,\\s*)"]))),Bo=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+Ze+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+Ze+"))?\\s+(.*)"),Io={cx:oe,x:oe,r:"radius",cy:De,y:De,display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing","text-decoration-thickness":Rt},Sr="font-size",Cr="clip-path";gr(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]);gr(["symbol","image","marker","pattern","view","svg"]);const Os=gr(["symbol","g","a","svg","clipPath","defs"]);new RegExp(String.raw(Ds||(Ds=et(["^s*(",")","(",")","(",")","(",")s*$"],["^\\s*(",")","(",")","(",")","(",")\\s*$"])),Ze,Tr,Ze,Tr,Ze,Tr,Ze));const Ho=new O(1,0),Dn=new O,On=(u,t)=>u.rotate(t),Ir=(u,t)=>new O(t).subtract(u),Hr=u=>u.distanceFrom(Dn),jr=(u,t)=>Math.atan2(ni(u,t),zo(u,t)),jo=u=>jr(Ho,u),ts=u=>u.eq(Dn)?u:u.scalarDivide(Hr(u)),Rn=function(u){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return ts(new O(-u.y,u.x).scalarMultiply(t?1:-1))},ni=(u,t)=>u.x*t.y-u.y*t.x,zo=(u,t)=>u.x*t.x+u.y*t.y,Rs=(u,t,e)=>{if(u.eq(t)||u.eq(e))return!0;const i=ni(t,e),r=ni(t,u),s=ni(e,u);return i>=0?r>=0&&s<=0:!(r<=0&&s>=0)},Ms="(-?\\d+(?:\\.\\d*)?(?:px)?(?:\\s?|$))?",ks=new RegExp("(?:\\s|^)"+Ms+Ms+"("+Ze+"?(?:px)?)?(?:\\s?|$)(?:$|\\s)");class lt{constructor(t){const e=typeof t=="string"?lt.parseShadow(t):t;Object.assign(this,lt.ownDefaults,e),this.id=wt()}static parseShadow(t){const e=t.trim(),[,i=0,r=0,s=0]=(ks.exec(e)||[]).map((n=>parseFloat(n)||0));return{color:(e.replace(ks,"")||"rgb(0,0,0)").trim(),offsetX:i,offsetY:r,blur:s}}toString(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")}toSVG(t){const e=On(new O(this.offsetX,this.offsetY),pe(-t.angle)),i=new le(this.color);let r=40,s=40;return t.width&&t.height&&(r=100*he((Math.abs(e.x)+this.blur)/t.width,re.NUM_FRACTION_DIGITS)+20,s=100*he((Math.abs(e.y)+this.blur)/t.height,re.NUM_FRACTION_DIGITS)+20),t.flipX&&(e.x*=-1),t.flipY&&(e.y*=-1),'<filter id="SVGID_'.concat(this.id,'" y="-').concat(s,'%" height="').concat(100+2*s,'%" x="-').concat(r,'%" width="').concat(100+2*r,`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`).concat(he(this.blur?this.blur/2:0,re.NUM_FRACTION_DIGITS),`"></feGaussianBlur>
	<feOffset dx="`).concat(he(e.x,re.NUM_FRACTION_DIGITS),'" dy="').concat(he(e.y,re.NUM_FRACTION_DIGITS),`" result="oBlur" ></feOffset>
	<feFlood flood-color="`).concat(i.toRgb(),'" flood-opacity="').concat(i.getAlpha(),`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`)}toObject(){const t={color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling,type:this.constructor.type},e=lt.ownDefaults;return this.includeDefaultValues?t:Qr(t,((i,r)=>i!==e[r]))}static async fromObject(t){return new this(t)}}b(lt,"ownDefaults",{color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1}),b(lt,"type","shadow"),N.setClass(lt,"shadow");const Vt=(u,t,e)=>Math.max(u,Math.min(t,e)),No=[De,oe,Me,Ne,"flipX","flipY","originX","originY","angle","opacity","globalCompositeOperation","shadow","visible",Xt,Yt],gt=[ye,Re,"strokeWidth","strokeDashArray","width","height","paintFirst","strokeUniform","strokeLineCap","strokeDashOffset","strokeLineJoin","strokeMiterLimit","backgroundColor","clipPath"],Wo={top:0,left:0,width:0,height:0,angle:0,flipX:!1,flipY:!1,scaleX:1,scaleY:1,minScaleLimit:0,skewX:0,skewY:0,originX:oe,originY:De,strokeWidth:1,strokeUniform:!1,padding:0,opacity:1,paintFirst:ye,fill:"rgb(0,0,0)",fillRule:"nonzero",stroke:null,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,globalCompositeOperation:"source-over",backgroundColor:"",shadow:null,visible:!0,includeDefaultValues:!0,excludeFromExport:!1,objectCaching:!0,clipPath:void 0,inverted:!1,absolutePositioned:!1,centeredRotation:!0,centeredScaling:!1,dirty:!0},Uo=(u,t,e,i)=>-e*Math.cos(u/i*di)+e+t,Vo=()=>!1;class is{constructor(t){let{startValue:e,byValue:i,duration:r=500,delay:s=0,easing:n=Uo,onStart:o=Ui,onChange:a=Ui,onComplete:l=Ui,abort:h=Vo,target:c}=t;b(this,"_state","pending"),b(this,"durationProgress",0),b(this,"valueProgress",0),this.tick=this.tick.bind(this),this.duration=r,this.delay=s,this.easing=n,this._onStart=o,this._onChange=a,this._onComplete=l,this._abort=h,this.target=c,this.startValue=e,this.byValue=i,this.value=this.startValue,this.endValue=Object.freeze(this.calculate(this.duration).value)}get state(){return this._state}isDone(){return this._state==="aborted"||this._state==="completed"}start(){const t=e=>{this._state==="pending"&&(this.startTime=e||+new Date,this._state="running",this._onStart(),this.tick(this.startTime))};this.register(),this.delay>0?setTimeout((()=>Gi(t)),this.delay):Gi(t)}tick(t){const e=(t||+new Date)-this.startTime,i=Math.min(e,this.duration);this.durationProgress=i/this.duration;const{value:r,valueProgress:s}=this.calculate(i);this.value=Object.freeze(r),this.valueProgress=s,this._state!=="aborted"&&(this._abort(this.value,this.valueProgress,this.durationProgress)?(this._state="aborted",this.unregister()):e>=this.duration?(this.durationProgress=this.valueProgress=1,this._onChange(this.endValue,this.valueProgress,this.durationProgress),this._state="completed",this._onComplete(this.endValue,this.valueProgress,this.durationProgress),this.unregister()):(this._onChange(this.value,this.valueProgress,this.durationProgress),Gi(this.tick)))}register(){Qi.push(this)}unregister(){Qi.remove(this)}abort(){this._state="aborted",this.unregister()}}const Go=["startValue","endValue"];class Xo extends is{constructor(t){let{startValue:e=0,endValue:i=100}=t;super(E(E({},ue(t,Go)),{},{startValue:e,byValue:i-e}))}calculate(t){const e=this.easing(t,this.startValue,this.byValue,this.duration);return{value:e,valueProgress:Math.abs((e-this.startValue)/this.byValue)}}}const Yo=["startValue","endValue"];class qo extends is{constructor(t){let{startValue:e=[0],endValue:i=[100]}=t;super(E(E({},ue(t,Yo)),{},{startValue:e,byValue:i.map(((r,s)=>r-e[s]))}))}calculate(t){const e=this.startValue.map(((i,r)=>this.easing(t,i,this.byValue[r],this.duration,r)));return{value:e,valueProgress:Math.abs((e[0]-this.startValue[0])/this.byValue[0])}}}const Zo=["startValue","endValue","easing","onChange","onComplete","abort"],Ko=(u,t,e,i)=>t+e*(1-Math.cos(u/i*di)),br=u=>u&&((t,e,i)=>u(new le(t).toRgba(),e,i));class Jo extends is{constructor(t){let{startValue:e,endValue:i,easing:r=Ko,onChange:s,onComplete:n,abort:o}=t,a=ue(t,Zo);const l=new le(e).getSource(),h=new le(i).getSource();super(E(E({},a),{},{startValue:l,byValue:h.map(((c,d)=>c-l[d])),easing:r,onChange:br(s),onComplete:br(n),abort:br(o)}))}calculate(t){const[e,i,r,s]=this.startValue.map(((o,a)=>this.easing(t,o,this.byValue[a],this.duration,a))),n=[...[e,i,r].map(Math.round),Vt(0,s,1)];return{value:n,valueProgress:n.map(((o,a)=>this.byValue[a]!==0?Math.abs((o-this.startValue[a])/this.byValue[a]):0)).find((o=>o!==0))||0}}}function Mn(u){const t=(e=>Array.isArray(e.startValue)||Array.isArray(e.endValue))(u)?new qo(u):new Xo(u);return t.start(),t}function Qo(u){const t=new Jo(u);return t.start(),t}class de{constructor(t){this.status=t,this.points=[]}includes(t){return this.points.some((e=>e.eq(t)))}append(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.points=this.points.concat(e.filter((r=>!this.includes(r)))),this}static isPointContained(t,e,i){let r=arguments.length>3&&arguments[3]!==void 0&&arguments[3];if(e.eq(i))return t.eq(e);if(e.x===i.x)return t.x===e.x&&(r||t.y>=Math.min(e.y,i.y)&&t.y<=Math.max(e.y,i.y));if(e.y===i.y)return t.y===e.y&&(r||t.x>=Math.min(e.x,i.x)&&t.x<=Math.max(e.x,i.x));{const s=Ir(e,i),n=Ir(e,t).divide(s);return r?Math.abs(n.x)===Math.abs(n.y):n.x===n.y&&n.x>=0&&n.x<=1}}static isPointInPolygon(t,e){const i=new O(t).setX(Math.min(t.x-1,...e.map((s=>s.x))));let r=0;for(let s=0;s<e.length;s++){const n=this.intersectSegmentSegment(e[s],e[(s+1)%e.length],t,i);if(n.includes(t))return!0;r+=+(n.status==="Intersection")}return r%2==1}static intersectLineLine(t,e,i,r){let s=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4],n=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5];const o=e.x-t.x,a=e.y-t.y,l=r.x-i.x,h=r.y-i.y,c=t.x-i.x,d=t.y-i.y,g=l*d-h*c,p=o*d-a*c,v=h*o-l*a;if(v!==0){const w=g/v,x=p/v;return(s||0<=w&&w<=1)&&(n||0<=x&&x<=1)?new de("Intersection").append(new O(t.x+w*o,t.y+w*a)):new de}if(g===0||p===0){const w=s||n||de.isPointContained(t,i,r)||de.isPointContained(e,i,r)||de.isPointContained(i,t,e)||de.isPointContained(r,t,e);return new de(w?"Coincident":void 0)}return new de("Parallel")}static intersectSegmentLine(t,e,i,r){return de.intersectLineLine(t,e,i,r,!1,!0)}static intersectSegmentSegment(t,e,i,r){return de.intersectLineLine(t,e,i,r,!1,!1)}static intersectLinePolygon(t,e,i){let r=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];const s=new de,n=i.length;for(let o,a,l,h=0;h<n;h++){if(o=i[h],a=i[(h+1)%n],l=de.intersectLineLine(t,e,o,a,r,!1),l.status==="Coincident")return l;s.append(...l.points)}return s.points.length>0&&(s.status="Intersection"),s}static intersectSegmentPolygon(t,e,i){return de.intersectLinePolygon(t,e,i,!1)}static intersectPolygonPolygon(t,e){const i=new de,r=t.length,s=[];for(let n=0;n<r;n++){const o=t[n],a=t[(n+1)%r],l=de.intersectSegmentPolygon(o,a,e);l.status==="Coincident"?(s.push(l),i.append(o,a)):i.append(...l.points)}return s.length>0&&s.length===t.length?new de("Coincident"):(i.points.length>0&&(i.status="Intersection"),i)}static intersectPolygonRectangle(t,e,i){const r=e.min(i),s=e.max(i),n=new O(s.x,r.y),o=new O(r.x,s.y);return de.intersectPolygonPolygon(t,[r,n,s,o])}}class $o extends an{getX(){return this.getXY().x}setX(t){this.setXY(this.getXY().setX(t))}getY(){return this.getXY().y}setY(t){this.setXY(this.getXY().setY(t))}getRelativeX(){return this.left}setRelativeX(t){this.left=t}getRelativeY(){return this.top}setRelativeY(t){this.top=t}getXY(){const t=this.getRelativeXY();return this.group?Pe(t,this.group.calcTransformMatrix()):t}setXY(t,e,i){this.group&&(t=Pe(t,qe(this.group.calcTransformMatrix()))),this.setRelativeXY(t,e,i)}getRelativeXY(){return new O(this.left,this.top)}setRelativeXY(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.originX,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.originY;this.setPositionByOrigin(t,e,i)}isStrokeAccountedForInDimensions(){return!1}getCoords(){const{tl:t,tr:e,br:i,bl:r}=this.aCoords||(this.aCoords=this.calcACoords()),s=[t,e,i,r];if(this.group){const n=this.group.calcTransformMatrix();return s.map((o=>Pe(o,n)))}return s}intersectsWithRect(t,e){return de.intersectPolygonRectangle(this.getCoords(),t,e).status==="Intersection"}intersectsWithObject(t){const e=de.intersectPolygonPolygon(this.getCoords(),t.getCoords());return e.status==="Intersection"||e.status==="Coincident"||t.isContainedWithinObject(this)||this.isContainedWithinObject(t)}isContainedWithinObject(t){return this.getCoords().every((e=>t.containsPoint(e)))}isContainedWithinRect(t,e){const{left:i,top:r,width:s,height:n}=this.getBoundingRect();return i>=t.x&&i+s<=e.x&&r>=t.y&&r+n<=e.y}isOverlapping(t){return this.intersectsWithObject(t)||this.isContainedWithinObject(t)||t.isContainedWithinObject(this)}containsPoint(t){return de.isPointInPolygon(t,this.getCoords())}isOnScreen(){if(!this.canvas)return!1;const{tl:t,br:e}=this.canvas.vptCoords;return!!this.getCoords().some((i=>i.x<=e.x&&i.x>=t.x&&i.y<=e.y&&i.y>=t.y))||!!this.intersectsWithRect(t,e)||this.containsPoint(t.midPointFrom(e))}isPartiallyOnScreen(){if(!this.canvas)return!1;const{tl:t,br:e}=this.canvas.vptCoords;return this.intersectsWithRect(t,e)?!0:this.getCoords().every((i=>(i.x>=e.x||i.x<=t.x)&&(i.y>=e.y||i.y<=t.y)))&&this.containsPoint(t.midPointFrom(e))}getBoundingRect(){return at(this.getCoords())}getScaledWidth(){return this._getTransformedDimensions().x}getScaledHeight(){return this._getTransformedDimensions().y}scale(t){this._set(Me,t),this._set(Ne,t),this.setCoords()}scaleToWidth(t){const e=this.getBoundingRect().width/this.getScaledWidth();return this.scale(t/this.width/e)}scaleToHeight(t){const e=this.getBoundingRect().height/this.getScaledHeight();return this.scale(t/this.height/e)}getCanvasRetinaScaling(){var t;return((t=this.canvas)===null||t===void 0?void 0:t.getRetinaScaling())||1}getTotalAngle(){return this.group?dt(cn(this.calcTransformMatrix())):this.angle}getViewportTransform(){var t;return((t=this.canvas)===null||t===void 0?void 0:t.viewportTransform)||Ee.concat()}calcACoords(){const t=qt({angle:this.angle}),{x:e,y:i}=this.getRelativeCenterPoint(),r=gi(e,i),s=Te(r,t),n=this._getTransformedDimensions(),o=n.x/2,a=n.y/2;return{tl:Pe({x:-o,y:-a},s),tr:Pe({x:o,y:-a},s),bl:Pe({x:-o,y:a},s),br:Pe({x:o,y:a},s)}}setCoords(){this.aCoords=this.calcACoords()}transformMatrixKey(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],e=[];return!t&&this.group&&(e=this.group.transformMatrixKey(t)),e.push(this.top,this.left,this.width,this.height,this.scaleX,this.scaleY,this.angle,this.strokeWidth,this.skewX,this.skewY,+this.flipX,+this.flipY,ve(this.originX),ve(this.originY)),e}calcTransformMatrix(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],e=this.calcOwnMatrix();if(t||!this.group)return e;const i=this.transformMatrixKey(t),r=this.matrixCache;return r&&r.key.every(((s,n)=>s===i[n]))?r.value:(this.group&&(e=Te(this.group.calcTransformMatrix(!1),e)),this.matrixCache={key:i,value:e},e)}calcOwnMatrix(){const t=this.transformMatrixKey(!0),e=this.ownMatrixCache;if(e&&e.key===t)return e.value;const i=this.getRelativeCenterPoint(),r={angle:this.angle,translateX:i.x,translateY:i.y,scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY},s=To(r);return this.ownMatrixCache={key:t,value:s},s}_getNonTransformedDimensions(){return new O(this.width,this.height).scalarAdd(this.strokeWidth)}_calculateCurrentDimensions(t){return this._getTransformedDimensions(t).transform(this.getViewportTransform(),!0).scalarAdd(2*this.padding)}_getTransformedDimensions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=E({scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,width:this.width,height:this.height,strokeWidth:this.strokeWidth},t),i=e.strokeWidth;let r=i,s=0;this.strokeUniform&&(r=0,s=i);const n=e.width+r,o=e.height+r;let a;return a=e.skewX===0&&e.skewY===0?new O(n*e.scaleX,o*e.scaleY):$r(n,o,cr(e)),a.scalarAdd(s)}translateToGivenOrigin(t,e,i,r,s){let n=t.x,o=t.y;const a=ve(r)-ve(e),l=ve(s)-ve(i);if(a||l){const h=this._getTransformedDimensions();n+=a*h.x,o+=l*h.y}return new O(n,o)}translateToCenterPoint(t,e,i){if(e===ee&&i===ee)return t;const r=this.translateToGivenOrigin(t,e,i,ee,ee);return this.angle?r.rotate(pe(this.angle),t):r}translateToOriginPoint(t,e,i){const r=this.translateToGivenOrigin(t,ee,ee,e,i);return this.angle?r.rotate(pe(this.angle),t):r}getCenterPoint(){const t=this.getRelativeCenterPoint();return this.group?Pe(t,this.group.calcTransformMatrix()):t}getRelativeCenterPoint(){return this.translateToCenterPoint(new O(this.left,this.top),this.originX,this.originY)}getPointByOrigin(t,e){return this.translateToOriginPoint(this.getRelativeCenterPoint(),t,e)}setPositionByOrigin(t,e,i){const r=this.translateToCenterPoint(t,e,i),s=this.translateToOriginPoint(r,this.originX,this.originY);this.set({left:s.x,top:s.y})}_getLeftTopCoords(){return this.translateToOriginPoint(this.getRelativeCenterPoint(),oe,De)}}const ea=["type"],ta=["extraParam"];let it=class Yi extends $o{static getDefaults(){return Yi.ownDefaults}get type(){const t=this.constructor.type;return t==="FabricObject"?"object":t.toLowerCase()}set type(t){yt("warn","Setting type has no effect",t)}constructor(t){super(),b(this,"_cacheContext",null),Object.assign(this,Yi.ownDefaults),this.setOptions(t)}_createCacheCanvas(){this._cacheCanvas=ut(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0}_limitCacheSize(t){const e=t.width,i=t.height,r=re.maxCacheSideLimit,s=re.minCacheSideLimit;if(e<=r&&i<=r&&e*i<=re.perfLimitSizeTotal)return e<s&&(t.width=s),i<s&&(t.height=s),t;const n=e/i,[o,a]=ii.limitDimsByArea(n),l=Vt(s,o,r),h=Vt(s,a,r);return e>l&&(t.zoomX/=e/l,t.width=l,t.capped=!0),i>h&&(t.zoomY/=i/h,t.height=h,t.capped=!0),t}_getCacheCanvasDimensions(){const t=this.getTotalObjectScaling(),e=this._getTransformedDimensions({skewX:0,skewY:0}),i=e.x*t.x/this.scaleX,r=e.y*t.y/this.scaleY;return{width:Math.ceil(i+2),height:Math.ceil(r+2),zoomX:t.x,zoomY:t.y,x:i,y:r}}_updateCacheCanvas(){const t=this._cacheCanvas,e=this._cacheContext,{width:i,height:r,zoomX:s,zoomY:n,x:o,y:a}=this._limitCacheSize(this._getCacheCanvasDimensions()),l=i!==t.width||r!==t.height,h=this.zoomX!==s||this.zoomY!==n;if(!t||!e)return!1;if(l||h){i!==t.width||r!==t.height?(t.width=i,t.height=r):(e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,t.width,t.height));const c=o/2,d=a/2;return this.cacheTranslationX=Math.round(t.width/2-c)+c,this.cacheTranslationY=Math.round(t.height/2-d)+d,e.translate(this.cacheTranslationX,this.cacheTranslationY),e.scale(s,n),this.zoomX=s,this.zoomY=n,!0}return!1}setOptions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setOptions(t)}transform(t){const e=this.group&&!this.group._transformDone||this.group&&this.canvas&&t===this.canvas.contextTop,i=this.calcTransformMatrix(!e);t.transform(i[0],i[1],i[2],i[3],i[4],i[5])}getObjectScaling(){if(!this.group)return new O(Math.abs(this.scaleX),Math.abs(this.scaleY));const t=$i(this.calcTransformMatrix());return new O(Math.abs(t.scaleX),Math.abs(t.scaleY))}getTotalObjectScaling(){const t=this.getObjectScaling();if(this.canvas){const e=this.canvas.getZoom(),i=this.getCanvasRetinaScaling();return t.scalarMultiply(e*i)}return t}getObjectOpacity(){let t=this.opacity;return this.group&&(t*=this.group.getObjectOpacity()),t}_constrainScale(t){return Math.abs(t)<this.minScaleLimit?t<0?-this.minScaleLimit:this.minScaleLimit:t===0?1e-4:t}_set(t,e){t!==Me&&t!==Ne||(e=this._constrainScale(e)),t===Me&&e<0?(this.flipX=!this.flipX,e*=-1):t==="scaleY"&&e<0?(this.flipY=!this.flipY,e*=-1):t!=="shadow"||!e||e instanceof lt||(e=new lt(e));const i=this[t]!==e;return this[t]=e,i&&this.constructor.cacheProperties.includes(t)&&(this.dirty=!0),this.parent&&(this.dirty||i&&this.constructor.stateProperties.includes(t))&&this.parent._set("dirty",!0),this}isNotVisible(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible}render(t){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(t.save(),this._setupCompositeOperation(t),this.drawSelectionBackground(t),this.transform(t),this._setOpacity(t),this._setShadow(t),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(t)):(this._removeCacheCanvas(),this.drawObject(t,!1,{}),this.dirty=!1),t.restore())}drawSelectionBackground(t){}renderCache(t){if(t=t||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&this._cacheContext){const{zoomX:e,zoomY:i,cacheTranslationX:r,cacheTranslationY:s}=this,{width:n,height:o}=this._cacheCanvas;this.drawObject(this._cacheContext,t.forClipping,{zoomX:e,zoomY:i,cacheTranslationX:r,cacheTranslationY:s,width:n,height:o,parentClipPaths:[]}),this.dirty=!1}}_removeCacheCanvas(){this._cacheCanvas=void 0,this._cacheContext=null}hasStroke(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0}hasFill(){return this.fill&&this.fill!=="transparent"}needsItsOwnCache(){return!!(this.paintFirst===Re&&this.hasFill()&&this.hasStroke()&&this.shadow)||!!this.clipPath}shouldCache(){return this.ownCaching=this.objectCaching&&(!this.parent||!this.parent.isOnACache())||this.needsItsOwnCache(),this.ownCaching}willDrawShadow(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)}drawClipPathOnCache(t,e,i){t.save(),e.inverted?t.globalCompositeOperation="destination-out":t.globalCompositeOperation="destination-in",t.setTransform(1,0,0,1,0,0),t.drawImage(i,0,0),t.restore()}drawObject(t,e,i){const r=this.fill,s=this.stroke;e?(this.fill="black",this.stroke="",this._setClippingProperties(t)):this._renderBackground(t),this._render(t),this._drawClipPath(t,this.clipPath,i),this.fill=r,this.stroke=s}createClipPathLayer(t,e){const i=We(e),r=i.getContext("2d");if(r.translate(e.cacheTranslationX,e.cacheTranslationY),r.scale(e.zoomX,e.zoomY),t._cacheCanvas=i,e.parentClipPaths.forEach((s=>{s.transform(r)})),e.parentClipPaths.push(t),t.absolutePositioned){const s=qe(this.calcTransformMatrix());r.transform(s[0],s[1],s[2],s[3],s[4],s[5])}return t.transform(r),t.drawObject(r,!0,e),i}_drawClipPath(t,e,i){if(!e)return;e._transformDone=!0;const r=this.createClipPathLayer(e,i);this.drawClipPathOnCache(t,e,r)}drawCacheOnCanvas(t){t.scale(1/this.zoomX,1/this.zoomY),t.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)}isCacheDirty(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];if(this.isNotVisible())return!1;const e=this._cacheCanvas,i=this._cacheContext;return!(!e||!i||t||!this._updateCacheCanvas())||!!(this.dirty||this.clipPath&&this.clipPath.absolutePositioned)&&(e&&i&&!t&&(i.save(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,e.width,e.height),i.restore()),!0)}_renderBackground(t){if(!this.backgroundColor)return;const e=this._getNonTransformedDimensions();t.fillStyle=this.backgroundColor,t.fillRect(-e.x/2,-e.y/2,e.x,e.y),this._removeShadow(t)}_setOpacity(t){this.group&&!this.group._transformDone?t.globalAlpha=this.getObjectOpacity():t.globalAlpha*=this.opacity}_setStrokeStyles(t,e){const i=e.stroke;i&&(t.lineWidth=e.strokeWidth,t.lineCap=e.strokeLineCap,t.lineDashOffset=e.strokeDashOffset,t.lineJoin=e.strokeLineJoin,t.miterLimit=e.strokeMiterLimit,ze(i)?i.gradientUnits==="percentage"||i.gradientTransform||i.patternTransform?this._applyPatternForTransformedGradient(t,i):(t.strokeStyle=i.toLive(t),this._applyPatternGradientTransform(t,i)):t.strokeStyle=e.stroke)}_setFillStyles(t,e){let{fill:i}=e;i&&(ze(i)?(t.fillStyle=i.toLive(t),this._applyPatternGradientTransform(t,i)):t.fillStyle=i)}_setClippingProperties(t){t.globalAlpha=1,t.strokeStyle="transparent",t.fillStyle="#000000"}_setLineDash(t,e){e&&e.length!==0&&t.setLineDash(e)}_setShadow(t){if(!this.shadow)return;const e=this.shadow,i=this.canvas,r=this.getCanvasRetinaScaling(),[s,,,n]=i?.viewportTransform||Ee,o=s*r,a=n*r,l=e.nonScaling?new O(1,1):this.getObjectScaling();t.shadowColor=e.color,t.shadowBlur=e.blur*re.browserShadowBlurConstant*(o+a)*(l.x+l.y)/4,t.shadowOffsetX=e.offsetX*o*l.x,t.shadowOffsetY=e.offsetY*a*l.y}_removeShadow(t){this.shadow&&(t.shadowColor="",t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0)}_applyPatternGradientTransform(t,e){if(!ze(e))return{offsetX:0,offsetY:0};const i=e.gradientTransform||e.patternTransform,r=-this.width/2+e.offsetX||0,s=-this.height/2+e.offsetY||0;return e.gradientUnits==="percentage"?t.transform(this.width,0,0,this.height,r,s):t.transform(1,0,0,1,r,s),i&&t.transform(i[0],i[1],i[2],i[3],i[4],i[5]),{offsetX:r,offsetY:s}}_renderPaintInOrder(t){this.paintFirst===Re?(this._renderStroke(t),this._renderFill(t)):(this._renderFill(t),this._renderStroke(t))}_render(t){}_renderFill(t){this.fill&&(t.save(),this._setFillStyles(t,this),this.fillRule==="evenodd"?t.fill("evenodd"):t.fill(),t.restore())}_renderStroke(t){if(this.stroke&&this.strokeWidth!==0){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this.strokeUniform){const e=this.getObjectScaling();t.scale(1/e.x,1/e.y)}this._setLineDash(t,this.strokeDashArray),this._setStrokeStyles(t,this),t.stroke(),t.restore()}}_applyPatternForTransformedGradient(t,e){var i;const r=this._limitCacheSize(this._getCacheCanvasDimensions()),s=this.getCanvasRetinaScaling(),n=r.x/this.scaleX/s,o=r.y/this.scaleY/s,a=We({width:Math.ceil(n),height:Math.ceil(o)}),l=a.getContext("2d");l&&(l.beginPath(),l.moveTo(0,0),l.lineTo(n,0),l.lineTo(n,o),l.lineTo(0,o),l.closePath(),l.translate(n/2,o/2),l.scale(r.zoomX/this.scaleX/s,r.zoomY/this.scaleY/s),this._applyPatternGradientTransform(l,e),l.fillStyle=e.toLive(t),l.fill(),t.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),t.scale(s*this.scaleX/r.zoomX,s*this.scaleY/r.zoomY),t.strokeStyle=(i=l.createPattern(a,"no-repeat"))!==null&&i!==void 0?i:"")}_findCenterFromElement(){return new O(this.left+this.width/2,this.top+this.height/2)}clone(t){const e=this.toObject(t);return this.constructor.fromObject(e)}cloneAsImage(t){const e=this.toCanvasElement(t);return new(N.getClass("image"))(e)}toCanvasElement(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=yn(this),i=this.group,r=this.shadow,s=Math.abs,n=t.enableRetinaScaling?tn():1,o=(t.multiplier||1)*n,a=t.canvasProvider||(C=>new fi(C,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1}));delete this.group,t.withoutTransform&&Do(this),t.withoutShadow&&(this.shadow=null),t.viewportTransform&&Ro(this,this.getViewportTransform()),this.setCoords();const l=ut(),h=this.getBoundingRect(),c=this.shadow,d=new O;if(c){const C=c.blur,P=c.nonScaling?new O(1,1):this.getObjectScaling();d.x=2*Math.round(s(c.offsetX)+C)*s(P.x),d.y=2*Math.round(s(c.offsetY)+C)*s(P.y)}const g=h.width+d.x,p=h.height+d.y;l.width=Math.ceil(g),l.height=Math.ceil(p);const v=a(l);t.format==="jpeg"&&(v.backgroundColor="#fff"),this.setPositionByOrigin(new O(v.width/2,v.height/2),ee,ee);const w=this.canvas;v._objects=[this],this.set("canvas",v),this.setCoords();const x=v.toCanvasElement(o||1,t);return this.set("canvas",w),this.shadow=r,i&&(this.group=i),this.set(e),this.setCoords(),v._objects=[],v.destroy(),x}toDataURL(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ln(this.toCanvasElement(t),t.format||"png",t.quality||1)}toBlob(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return hn(this.toCanvasElement(t),t.format||"png",t.quality||1)}isType(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return e.includes(this.constructor.type)||e.includes(this.type)}complexity(){return 1}toJSON(){return this.toObject()}rotate(t){const{centeredRotation:e,originX:i,originY:r}=this;if(e){const{x:s,y:n}=this.getRelativeCenterPoint();this.originX=ee,this.originY=ee,this.left=s,this.top=n}if(this.set("angle",t),e){const{x:s,y:n}=this.translateToOriginPoint(this.getRelativeCenterPoint(),i,r);this.left=s,this.top=n,this.originX=i,this.originY=r}}setOnGroup(){}_setupCompositeOperation(t){this.globalCompositeOperation&&(t.globalCompositeOperation=this.globalCompositeOperation)}dispose(){Qi.cancelByTarget(this),this.off(),this._set("canvas",void 0),this._cacheCanvas&&$e().dispose(this._cacheCanvas),this._cacheCanvas=void 0,this._cacheContext=null}animate(t,e){return Object.entries(t).reduce(((i,r)=>{let[s,n]=r;return i[s]=this._animate(s,n,e),i}),{})}_animate(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const r=t.split("."),s=this.constructor.colorProperties.includes(r[r.length-1]),{abort:n,startValue:o,onChange:a,onComplete:l}=i,h=E(E({},i),{},{target:this,startValue:o??r.reduce(((c,d)=>c[d]),this),endValue:e,abort:n?.bind(this),onChange:(c,d,g)=>{r.reduce(((p,v,w)=>(w===r.length-1&&(p[v]=c),p[v])),this),a&&a(c,d,g)},onComplete:(c,d,g)=>{this.setCoords(),l&&l(c,d,g)}});return s?Qo(h):Mn(h)}isDescendantOf(t){const{parent:e,group:i}=this;return e===t||i===t||!!e&&e.isDescendantOf(t)||!!i&&i!==e&&i.isDescendantOf(t)}getAncestors(){const t=[];let e=this;do e=e.parent,e&&t.push(e);while(e);return t}findCommonAncestors(t){if(this===t)return{fork:[],otherFork:[],common:[this,...this.getAncestors()]};const e=this.getAncestors(),i=t.getAncestors();if(e.length===0&&i.length>0&&this===i[i.length-1])return{fork:[],otherFork:[t,...i.slice(0,i.length-1)],common:[this]};for(let r,s=0;s<e.length;s++){if(r=e[s],r===t)return{fork:[this,...e.slice(0,s)],otherFork:[],common:e.slice(s)};for(let n=0;n<i.length;n++){if(this===i[n])return{fork:[],otherFork:[t,...i.slice(0,n)],common:[this,...e]};if(r===i[n])return{fork:[this,...e.slice(0,s)],otherFork:[t,...i.slice(0,n)],common:e.slice(s)}}}return{fork:[this,...e],otherFork:[t,...i],common:[]}}hasCommonAncestors(t){const e=this.findCommonAncestors(t);return e&&!!e.common.length}isInFrontOf(t){if(this===t)return;const e=this.findCommonAncestors(t);if(e.fork.includes(t))return!0;if(e.otherFork.includes(this))return!1;const i=e.common[0]||this.canvas;if(!i)return;const r=e.fork.pop(),s=e.otherFork.pop(),n=i._objects.indexOf(r),o=i._objects.indexOf(s);return n>-1&&n>o}toObject(){const t=(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).concat(Yi.customProperties,this.constructor.customProperties||[]);let e;const i=re.NUM_FRACTION_DIGITS,{clipPath:r,fill:s,stroke:n,shadow:o,strokeDashArray:a,left:l,top:h,originX:c,originY:d,width:g,height:p,strokeWidth:v,strokeLineCap:w,strokeDashOffset:x,strokeLineJoin:C,strokeUniform:P,strokeMiterLimit:k,scaleX:R,scaleY:A,angle:j,flipX:I,flipY:W,opacity:$,visible:Z,backgroundColor:z,fillRule:V,paintFirst:Y,globalCompositeOperation:ie,skewX:te,skewY:se}=this;r&&!r.excludeFromExport&&(e=r.toObject(t.concat("inverted","absolutePositioned")));const Q=xe=>he(xe,i),me=E(E({},Zt(this,t)),{},{type:this.constructor.type,version:Fr,originX:c,originY:d,left:Q(l),top:Q(h),width:Q(g),height:Q(p),fill:vs(s)?s.toObject():s,stroke:vs(n)?n.toObject():n,strokeWidth:Q(v),strokeDashArray:a&&a.concat(),strokeLineCap:w,strokeDashOffset:x,strokeLineJoin:C,strokeUniform:P,strokeMiterLimit:Q(k),scaleX:Q(R),scaleY:Q(A),angle:Q(j),flipX:I,flipY:W,opacity:Q($),shadow:o&&o.toObject(),visible:Z,backgroundColor:z,fillRule:V,paintFirst:Y,globalCompositeOperation:ie,skewX:Q(te),skewY:Q(se)},e?{clipPath:e}:null);return this.includeDefaultValues?me:this._removeDefaultValues(me)}toDatalessObject(t){return this.toObject(t)}_removeDefaultValues(t){const e=this.constructor.getDefaults(),i=Object.keys(e).length>0?e:Object.getPrototypeOf(this);return Qr(t,((r,s)=>{if(s===oe||s===De||s==="type")return!0;const n=i[s];return r!==n&&!(Array.isArray(r)&&Array.isArray(n)&&r.length===0&&n.length===0)}))}toString(){return"#<".concat(this.constructor.type,">")}static _fromObject(t){let e=ue(t,ea),i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{extraParam:r}=i,s=ue(i,ta);return ur(e,s).then((n=>r?(delete n[r],new this(e[r],n)):new this(n)))}static fromObject(t,e){return this._fromObject(t,e)}};b(it,"stateProperties",No),b(it,"cacheProperties",gt),b(it,"ownDefaults",Wo),b(it,"type","FabricObject"),b(it,"colorProperties",[ye,Re,"backgroundColor"]),b(it,"customProperties",[]),N.setClass(it),N.setClass(it,"object");const Kt=(u,t,e)=>(i,r,s,n)=>{const o=t(i,r,s,n);return o&&wn(u,E(E({},_n(i,r,s,n)),e)),o};function Jt(u){return(t,e,i,r)=>{const{target:s,originX:n,originY:o}=e,a=s.getRelativeCenterPoint(),l=s.translateToOriginPoint(a,n,o),h=u(t,e,i,r);return s.setPositionByOrigin(l,e.originX,e.originY),h}}const Fs=Kt(oi,Jt(((u,t,e,i)=>{const r=es(t,t.originX,t.originY,e,i);if(ve(t.originX)===ve(ee)||ve(t.originX)===ve(fe)&&r.x<0||ve(t.originX)===ve(oe)&&r.x>0){const{target:s}=t,n=s.strokeWidth/(s.strokeUniform?s.scaleX:1),o=xn(t)?2:1,a=s.width,l=Math.abs(r.x*o/s.scaleX)-n;return s.set("width",Math.max(l,1)),a!==s.width}return!1})));function ia(u,t,e,i,r){i=i||{};const s=this.sizeX||i.cornerSize||r.cornerSize,n=this.sizeY||i.cornerSize||r.cornerSize,o=i.transparentCorners!==void 0?i.transparentCorners:r.transparentCorners,a=o?Re:ye,l=!o&&(i.cornerStrokeColor||r.cornerStrokeColor);let h,c=t,d=e;u.save(),u.fillStyle=i.cornerColor||r.cornerColor||"",u.strokeStyle=i.cornerStrokeColor||r.cornerStrokeColor||"",s>n?(h=s,u.scale(1,n/s),d=e*s/n):n>s?(h=n,u.scale(s/n,1),c=t*n/s):h=s,u.beginPath(),u.arc(c,d,h/2,0,Zi,!1),u[a](),l&&u.stroke(),u.restore()}function ra(u,t,e,i,r){i=i||{};const s=this.sizeX||i.cornerSize||r.cornerSize,n=this.sizeY||i.cornerSize||r.cornerSize,o=i.transparentCorners!==void 0?i.transparentCorners:r.transparentCorners,a=o?Re:ye,l=!o&&(i.cornerStrokeColor||r.cornerStrokeColor),h=s/2,c=n/2;u.save(),u.fillStyle=i.cornerColor||r.cornerColor||"",u.strokeStyle=i.cornerStrokeColor||r.cornerStrokeColor||"",u.translate(t,e);const d=r.getTotalAngle();u.rotate(pe(d)),u["".concat(a,"Rect")](-h,-c,s,n),l&&u.strokeRect(-h,-c,s,n),u.restore()}class Ve{constructor(t){b(this,"visible",!0),b(this,"actionName",hr),b(this,"angle",0),b(this,"x",0),b(this,"y",0),b(this,"offsetX",0),b(this,"offsetY",0),b(this,"sizeX",0),b(this,"sizeY",0),b(this,"touchSizeX",0),b(this,"touchSizeY",0),b(this,"cursorStyle","crosshair"),b(this,"withConnection",!1),Object.assign(this,t)}shouldActivate(t,e,i,r){var s;let{tl:n,tr:o,br:a,bl:l}=r;return((s=e.canvas)===null||s===void 0?void 0:s.getActiveObject())===e&&e.isControlVisible(t)&&de.isPointInPolygon(i,[n,o,a,l])}getActionHandler(t,e,i){return this.actionHandler}getMouseDownHandler(t,e,i){return this.mouseDownHandler}getMouseUpHandler(t,e,i){return this.mouseUpHandler}cursorStyleHandler(t,e,i){return e.cursorStyle}getActionName(t,e,i){return e.actionName}getVisibility(t,e){var i,r;return(i=(r=t._controlsVisibility)===null||r===void 0?void 0:r[e])!==null&&i!==void 0?i:this.visible}setVisibility(t,e,i){this.visible=t}positionHandler(t,e,i,r){return new O(this.x*t.x+this.offsetX,this.y*t.y+this.offsetY).transform(e)}calcCornerCoords(t,e,i,r,s,n){const o=Kr([gi(i,r),qt({angle:t}),Jr((s?this.touchSizeX:this.sizeX)||e,(s?this.touchSizeY:this.sizeY)||e)]);return{tl:new O(-.5,-.5).transform(o),tr:new O(.5,-.5).transform(o),br:new O(.5,.5).transform(o),bl:new O(-.5,.5).transform(o)}}render(t,e,i,r,s){((r=r||{}).cornerStyle||s.cornerStyle)==="circle"?ia.call(this,t,e,i,r,s):ra.call(this,t,e,i,r,s)}}const sa=(u,t,e)=>e.lockRotation?tr:t.cursorStyle,na=Kt(sn,Jt(((u,t,e,i)=>{let{target:r,ex:s,ey:n,theta:o,originX:a,originY:l}=t;const h=r.translateToOriginPoint(r.getRelativeCenterPoint(),a,l);if(Ke(r,"lockRotation"))return!1;const c=Math.atan2(n-h.y,s-h.x),d=Math.atan2(i-h.y,e-h.x);let g=dt(d-c+o);if(r.snapAngle&&r.snapAngle>0){const v=r.snapAngle,w=r.snapThreshold||v,x=Math.ceil(g/v)*v,C=Math.floor(g/v)*v;Math.abs(g-C)<w?g=C:Math.abs(g-x)<w&&(g=x)}g<0&&(g=360+g),g%=360;const p=r.angle!==g;return r.angle=g,p})));function kn(u,t){const e=t.canvas,i=u[e.uniScaleKey];return e.uniformScaling&&!i||!e.uniformScaling&&i}function Fn(u,t,e){const i=Ke(u,"lockScalingX"),r=Ke(u,"lockScalingY");if(i&&r||!t&&(i||r)&&e||i&&t==="x"||r&&t==="y")return!0;const{width:s,height:n,strokeWidth:o}=u;return s===0&&o===0&&t!=="y"||n===0&&o===0&&t!=="x"}const oa=["e","se","s","sw","w","nw","n","ne","e"],ti=(u,t,e)=>{const i=kn(u,e);if(Fn(e,t.x!==0&&t.y===0?"x":t.x===0&&t.y!==0?"y":"",i))return tr;const r=Tn(e,t);return"".concat(oa[r],"-resize")};function rs(u,t,e,i){let r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};const s=t.target,n=r.by,o=kn(u,s);let a,l,h,c,d,g;if(Fn(s,n,o))return!1;if(t.gestureScale)l=t.scaleX*t.gestureScale,h=t.scaleY*t.gestureScale;else{if(a=es(t,t.originX,t.originY,e,i),d=n!=="y"?Math.sign(a.x||t.signX||1):1,g=n!=="x"?Math.sign(a.y||t.signY||1):1,t.signX||(t.signX=d),t.signY||(t.signY=g),Ke(s,"lockScalingFlip")&&(t.signX!==d||t.signY!==g))return!1;if(c=s._getTransformedDimensions(),o&&!n){const w=Math.abs(a.x)+Math.abs(a.y),{original:x}=t,C=w/(Math.abs(c.x*x.scaleX/s.scaleX)+Math.abs(c.y*x.scaleY/s.scaleY));l=x.scaleX*C,h=x.scaleY*C}else l=Math.abs(a.x*s.scaleX/c.x),h=Math.abs(a.y*s.scaleY/c.y);xn(t)&&(l*=2,h*=2),t.signX!==d&&n!=="y"&&(t.originX=_s(t.originX),l*=-1,t.signX=d),t.signY!==g&&n!=="x"&&(t.originY=_s(t.originY),h*=-1,t.signY=g)}const p=s.scaleX,v=s.scaleY;return n?(n==="x"&&s.set(Me,l),n==="y"&&s.set(Ne,h)):(!Ke(s,"lockScalingX")&&s.set(Me,l),!Ke(s,"lockScalingY")&&s.set(Ne,h)),p!==s.scaleX||v!==s.scaleY}const yi=Kt(lr,Jt(((u,t,e,i)=>rs(u,t,e,i)))),aa=Kt(lr,Jt(((u,t,e,i)=>rs(u,t,e,i,{by:"x"})))),la=Kt(lr,Jt(((u,t,e,i)=>rs(u,t,e,i,{by:"y"})))),ha=["target","ex","ey","skewingSide"],Er={x:{counterAxis:"y",scale:Me,skew:Xt,lockSkewing:"lockSkewingX",origin:"originX",flip:"flipX"},y:{counterAxis:"x",scale:Ne,skew:Yt,lockSkewing:"lockSkewingY",origin:"originY",flip:"flipY"}},ca=["ns","nesw","ew","nwse"],ua=(u,t,e)=>{if(t.x!==0&&Ke(e,"lockSkewingY")||t.y!==0&&Ke(e,"lockSkewingX"))return tr;const i=Tn(e,t)%4;return"".concat(ca[i],"-resize")};function An(u,t,e,i,r){const{target:s}=e,{counterAxis:n,origin:o,lockSkewing:a,skew:l,flip:h}=Er[u];if(Ke(s,a))return!1;const{origin:c,flip:d}=Er[n],g=ve(e[c])*(s[d]?-1:1),p=-Math.sign(g)*(s[h]?-1:1),v=.5*-((s[l]===0&&es(e,ee,ee,i,r)[u]>0||s[l]>0?1:-1)*p)+.5;return Kt(nn,Jt(((x,C,P,k)=>(function(R,A,j){let{target:I,ex:W,ey:$,skewingSide:Z}=A,z=ue(A,ha);const{skew:V}=Er[R],Y=j.subtract(new O(W,$)).divide(new O(I.scaleX,I.scaleY))[R],ie=I[V],te=z[V],se=Math.tan(pe(te)),Q=R==="y"?I._getTransformedDimensions({scaleX:1,scaleY:1,skewX:0}).x:I._getTransformedDimensions({scaleX:1,scaleY:1}).y,me=2*Y*Z/Math.max(Q,1)+se,xe=dt(Math.atan(me));I.set(V,xe);const pt=ie!==I[V];if(pt&&R==="y"){const{skewX:_t,scaleX:q}=I,ke=I._getTransformedDimensions({skewY:ie}),tt=I._getTransformedDimensions(),Be=_t!==0?ke.x/tt.x:1;Be!==1&&I.set(Me,Be*q)}return pt})(u,C,new O(P,k)))))(t,E(E({},e),{},{[o]:v,skewingSide:p}),i,r)}const da=(u,t,e,i)=>An("x",u,t,e,i),ga=(u,t,e,i)=>An("y",u,t,e,i);function fr(u,t){return u[t.canvas.altActionKey]}const wi=(u,t,e)=>{const i=fr(u,e);return t.x===0?i?Xt:Ne:t.y===0?i?Yt:Me:""},Ht=(u,t,e)=>fr(u,e)?ua(0,t,e):ti(u,t,e),As=(u,t,e,i)=>fr(u,t.target)?ga(u,t,e,i):aa(u,t,e,i),Ls=(u,t,e,i)=>fr(u,t.target)?da(u,t,e,i):la(u,t,e,i),Ln=()=>({ml:new Ve({x:-.5,y:0,cursorStyleHandler:Ht,actionHandler:As,getActionName:wi}),mr:new Ve({x:.5,y:0,cursorStyleHandler:Ht,actionHandler:As,getActionName:wi}),mb:new Ve({x:0,y:.5,cursorStyleHandler:Ht,actionHandler:Ls,getActionName:wi}),mt:new Ve({x:0,y:-.5,cursorStyleHandler:Ht,actionHandler:Ls,getActionName:wi}),tl:new Ve({x:-.5,y:-.5,cursorStyleHandler:ti,actionHandler:yi}),tr:new Ve({x:.5,y:-.5,cursorStyleHandler:ti,actionHandler:yi}),bl:new Ve({x:-.5,y:.5,cursorStyleHandler:ti,actionHandler:yi}),br:new Ve({x:.5,y:.5,cursorStyleHandler:ti,actionHandler:yi}),mtr:new Ve({x:0,y:-.5,actionHandler:na,cursorStyleHandler:sa,offsetY:-40,withConnection:!0,actionName:qr})}),fa=()=>({mr:new Ve({x:.5,y:0,actionHandler:Fs,cursorStyleHandler:Ht,actionName:oi}),ml:new Ve({x:-.5,y:0,actionHandler:Fs,cursorStyleHandler:Ht,actionName:oi})}),pa=()=>E(E({},Ln()),fa());class ci extends it{static getDefaults(){return E(E({},super.getDefaults()),ci.ownDefaults)}constructor(t){super(),Object.assign(this,this.constructor.createControls(),ci.ownDefaults),this.setOptions(t)}static createControls(){return{controls:Ln()}}_updateCacheCanvas(){const t=this.canvas;if(this.noScaleCache&&t&&t._currentTransform){const e=t._currentTransform,i=e.target,r=e.action;if(this===i&&r&&r.startsWith(hr))return!1}return super._updateCacheCanvas()}getActiveControl(){const t=this.__corner;return t?{key:t,control:this.controls[t],coord:this.oCoords[t]}:void 0}findControl(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!this.hasControls||!this.canvas)return;this.__corner=void 0;const i=Object.entries(this.oCoords);for(let r=i.length-1;r>=0;r--){const[s,n]=i[r],o=this.controls[s];if(o.shouldActivate(s,this,t,e?n.touchCorner:n.corner))return this.__corner=s,{key:s,control:o,coord:this.oCoords[s]}}}calcOCoords(){const t=this.getViewportTransform(),e=this.getCenterPoint(),i=gi(e.x,e.y),r=qt({angle:this.getTotalAngle()-(this.group&&this.flipX?180:0)}),s=Te(i,r),n=Te(t,s),o=Te(n,[1/t[0],0,0,1/t[3],0,0]),a=this.group?$i(this.calcTransformMatrix()):void 0;a&&(a.scaleX=Math.abs(a.scaleX),a.scaleY=Math.abs(a.scaleY));const l=this._calculateCurrentDimensions(a),h={};return this.forEachControl(((c,d)=>{const g=c.positionHandler(l,o,this,c);h[d]=Object.assign(g,this._calcCornerCoords(c,g))})),h}_calcCornerCoords(t,e){const i=this.getTotalAngle();return{corner:t.calcCornerCoords(i,this.cornerSize,e.x,e.y,!1,this),touchCorner:t.calcCornerCoords(i,this.touchCornerSize,e.x,e.y,!0,this)}}setCoords(){super.setCoords(),this.canvas&&(this.oCoords=this.calcOCoords())}forEachControl(t){for(const e in this.controls)t(this.controls[e],e,this)}drawSelectionBackground(t){if(!this.selectionBackgroundColor||this.canvas&&this.canvas._activeObject!==this)return;t.save();const e=this.getRelativeCenterPoint(),i=this._calculateCurrentDimensions(),r=this.getViewportTransform();t.translate(e.x,e.y),t.scale(1/r[0],1/r[3]),t.rotate(pe(this.angle)),t.fillStyle=this.selectionBackgroundColor,t.fillRect(-i.x/2,-i.y/2,i.x,i.y),t.restore()}strokeBorders(t,e){t.strokeRect(-e.x/2,-e.y/2,e.x,e.y)}_drawBorders(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const r=E({hasControls:this.hasControls,borderColor:this.borderColor,borderDashArray:this.borderDashArray},i);t.save(),t.strokeStyle=r.borderColor,this._setLineDash(t,r.borderDashArray),this.strokeBorders(t,e),r.hasControls&&this.drawControlsConnectingLines(t,e),t.restore()}_renderControls(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{hasBorders:i,hasControls:r}=this,s=E({hasBorders:i,hasControls:r},e),n=this.getViewportTransform(),o=s.hasBorders,a=s.hasControls,l=Te(n,this.calcTransformMatrix()),h=$i(l);t.save(),t.translate(h.translateX,h.translateY),t.lineWidth=this.borderScaleFactor,this.group===this.parent&&(t.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(h.angle-=180),t.rotate(pe(this.group?h.angle:this.angle)),o&&this.drawBorders(t,h,e),a&&this.drawControls(t,e),t.restore()}drawBorders(t,e,i){let r;if(i&&i.forActiveSelection||this.group){const s=$r(this.width,this.height,cr(e)),n=this.isStrokeAccountedForInDimensions()?Zr:(this.strokeUniform?new O().scalarAdd(this.canvas?this.canvas.getZoom():1):new O(e.scaleX,e.scaleY)).scalarMultiply(this.strokeWidth);r=s.add(n).scalarAdd(this.borderScaleFactor).scalarAdd(2*this.padding)}else r=this._calculateCurrentDimensions().scalarAdd(this.borderScaleFactor);this._drawBorders(t,r,i)}drawControlsConnectingLines(t,e){let i=!1;t.beginPath(),this.forEachControl(((r,s)=>{r.withConnection&&r.getVisibility(this,s)&&(i=!0,t.moveTo(r.x*e.x,r.y*e.y),t.lineTo(r.x*e.x+r.offsetX,r.y*e.y+r.offsetY))})),i&&t.stroke()}drawControls(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};t.save();const i=this.getCanvasRetinaScaling(),{cornerStrokeColor:r,cornerDashArray:s,cornerColor:n}=this,o=E({cornerStrokeColor:r,cornerDashArray:s,cornerColor:n},e);t.setTransform(i,0,0,i,0,0),t.strokeStyle=t.fillStyle=o.cornerColor,this.transparentCorners||(t.strokeStyle=o.cornerStrokeColor),this._setLineDash(t,o.cornerDashArray),this.forEachControl(((a,l)=>{if(a.getVisibility(this,l)){const h=this.oCoords[l];a.render(t,h.x,h.y,o,this)}})),t.restore()}isControlVisible(t){return this.controls[t]&&this.controls[t].getVisibility(this,t)}setControlVisible(t,e){this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[t]=e}setControlsVisibility(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Object.entries(t).forEach((e=>{let[i,r]=e;return this.setControlVisible(i,r)}))}clearContextTop(t){if(!this.canvas)return;const e=this.canvas.contextTop;if(!e)return;const i=this.canvas.viewportTransform;e.save(),e.transform(i[0],i[1],i[2],i[3],i[4],i[5]),this.transform(e);const r=this.width+4,s=this.height+4;return e.clearRect(-r/2,-s/2,r,s),t||e.restore(),e}onDeselect(t){return!1}onSelect(t){return!1}shouldStartDragging(t){return!1}onDragStart(t){return!1}canDrop(t){return!1}renderDragSourceEffect(t){}renderDropTargetEffect(t){}}function Bn(u,t){return t.forEach((e=>{Object.getOwnPropertyNames(e.prototype).forEach((i=>{i!=="constructor"&&Object.defineProperty(u.prototype,i,Object.getOwnPropertyDescriptor(e.prototype,i)||Object.create(null))}))})),u}b(ci,"ownDefaults",{noScaleCache:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,cornerSize:13,touchCornerSize:24,transparentCorners:!0,cornerColor:"rgb(178,204,255)",cornerStrokeColor:"",cornerStyle:"rect",cornerDashArray:null,hasControls:!0,borderColor:"rgb(178,204,255)",borderDashArray:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,hasBorders:!0,selectionBackgroundColor:"",selectable:!0,evented:!0,perPixelTargetFind:!1,activeOn:"down",hoverCursor:null,moveCursor:null});class Se extends ci{}Bn(Se,[Sn]),N.setClass(Se),N.setClass(Se,"object");const ma=(u,t,e,i)=>{const r=2*(i=Math.round(i))+1,{data:s}=u.getImageData(t-i,e-i,r,r);for(let n=3;n<s.length;n+=4)if(s[n]>0)return!1;return!0};class In{constructor(t){this.options=t,this.strokeProjectionMagnitude=this.options.strokeWidth/2,this.scale=new O(this.options.scaleX,this.options.scaleY),this.strokeUniformScalar=this.options.strokeUniform?new O(1/this.options.scaleX,1/this.options.scaleY):new O(1,1)}createSideVector(t,e){const i=Ir(t,e);return this.options.strokeUniform?i.multiply(this.scale):i}projectOrthogonally(t,e,i){return this.applySkew(t.add(this.calcOrthogonalProjection(t,e,i)))}isSkewed(){return this.options.skewX!==0||this.options.skewY!==0}applySkew(t){const e=new O(t);return e.y+=e.x*Math.tan(pe(this.options.skewY)),e.x+=e.y*Math.tan(pe(this.options.skewX)),e}scaleUnitVector(t,e){return t.multiply(this.strokeUniformScalar).scalarMultiply(e)}}const va=new O;class Ut extends In{static getOrthogonalRotationFactor(t,e){const i=e?jr(t,e):jo(t);return Math.abs(i)<di?-1:1}constructor(t,e,i,r){super(r),b(this,"AB",void 0),b(this,"AC",void 0),b(this,"alpha",void 0),b(this,"bisector",void 0),this.A=new O(t),this.B=new O(e),this.C=new O(i),this.AB=this.createSideVector(this.A,this.B),this.AC=this.createSideVector(this.A,this.C),this.alpha=jr(this.AB,this.AC),this.bisector=ts(On(this.AB.eq(va)?this.AC:this.AB,this.alpha/2))}calcOrthogonalProjection(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.strokeProjectionMagnitude;const r=this.createSideVector(t,e),s=Rn(r),n=Ut.getOrthogonalRotationFactor(s,this.bisector);return this.scaleUnitVector(s,i*n)}projectBevel(){const t=[];return(this.alpha%Zi==0?[this.B]:[this.B,this.C]).forEach((e=>{t.push(this.projectOrthogonally(this.A,e)),t.push(this.projectOrthogonally(this.A,e,-this.strokeProjectionMagnitude))})),t}projectMiter(){const t=[],e=Math.abs(this.alpha),i=1/Math.sin(e/2),r=this.scaleUnitVector(this.bisector,-this.strokeProjectionMagnitude*i),s=this.options.strokeUniform?Hr(this.scaleUnitVector(this.bisector,this.options.strokeMiterLimit)):this.options.strokeMiterLimit;return Hr(r)/this.strokeProjectionMagnitude<=s&&t.push(this.applySkew(this.A.add(r))),t.push(...this.projectBevel()),t}projectRoundNoSkew(t,e){const i=[],r=new O(Ut.getOrthogonalRotationFactor(this.bisector),Ut.getOrthogonalRotationFactor(new O(this.bisector.y,this.bisector.x)));return[new O(1,0).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar).multiply(r),new O(0,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar).multiply(r)].forEach((s=>{Rs(s,t,e)&&i.push(this.A.add(s))})),i}projectRoundWithSkew(t,e){const i=[],{skewX:r,skewY:s,scaleX:n,scaleY:o,strokeUniform:a}=this.options,l=new O(Math.tan(pe(r)),Math.tan(pe(s))),h=this.strokeProjectionMagnitude,c=a?h/o/Math.sqrt(1/o**2+1/n**2*l.y**2):h/Math.sqrt(1+l.y**2),d=new O(Math.sqrt(Math.max(h**2-c**2,0)),c),g=a?h/Math.sqrt(1+l.x**2*(1/o)**2/(1/n+1/n*l.x*l.y)**2):h/Math.sqrt(1+l.x**2/(1+l.x*l.y)**2),p=new O(g,Math.sqrt(Math.max(h**2-g**2,0)));return[p,p.scalarMultiply(-1),d,d.scalarMultiply(-1)].map((v=>this.applySkew(a?v.multiply(this.strokeUniformScalar):v))).forEach((v=>{Rs(v,t,e)&&i.push(this.applySkew(this.A).add(v))})),i}projectRound(){const t=[];t.push(...this.projectBevel());const e=this.alpha%Zi==0,i=this.applySkew(this.A),r=t[e?0:2].subtract(i),s=t[e?1:0].subtract(i),n=e?this.applySkew(this.AB.scalarMultiply(-1)):this.applySkew(this.bisector.multiply(this.strokeUniformScalar).scalarMultiply(-1)),o=ni(r,n)>0,a=o?r:s,l=o?s:r;return this.isSkewed()?t.push(...this.projectRoundWithSkew(a,l)):t.push(...this.projectRoundNoSkew(a,l)),t}projectPoints(){switch(this.options.strokeLineJoin){case"miter":return this.projectMiter();case"round":return this.projectRound();default:return this.projectBevel()}}project(){return this.projectPoints().map((t=>({originPoint:this.A,projectedPoint:t,angle:this.alpha,bisector:this.bisector})))}}class Bs extends In{constructor(t,e,i){super(i),this.A=new O(t),this.T=new O(e)}calcOrthogonalProjection(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.strokeProjectionMagnitude;const r=this.createSideVector(t,e);return this.scaleUnitVector(Rn(r),i)}projectButt(){return[this.projectOrthogonally(this.A,this.T,this.strokeProjectionMagnitude),this.projectOrthogonally(this.A,this.T,-this.strokeProjectionMagnitude)]}projectRound(){const t=[];if(!this.isSkewed()&&this.A.eq(this.T)){const e=new O(1,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar);t.push(this.applySkew(this.A.add(e)),this.applySkew(this.A.subtract(e)))}else t.push(...new Ut(this.A,this.T,this.T,this.options).projectRound());return t}projectSquare(){const t=[];if(this.A.eq(this.T)){const e=new O(1,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar);t.push(this.A.add(e),this.A.subtract(e))}else{const e=this.calcOrthogonalProjection(this.A,this.T,this.strokeProjectionMagnitude),i=this.scaleUnitVector(ts(this.createSideVector(this.A,this.T)),-this.strokeProjectionMagnitude),r=this.A.add(i);t.push(r.add(e),r.subtract(e))}return t.map((e=>this.applySkew(e)))}projectPoints(){switch(this.options.strokeLineCap){case"round":return this.projectRound();case"square":return this.projectSquare();default:return this.projectButt()}}project(){return this.projectPoints().map((t=>({originPoint:this.A,projectedPoint:t})))}}const ya=function(u,t){let e=arguments.length>2&&arguments[2]!==void 0&&arguments[2];const i=[];if(u.length===0)return i;const r=u.reduce(((s,n)=>(s[s.length-1].eq(n)||s.push(new O(n)),s)),[new O(u[0])]);if(r.length===1)e=!0;else if(!e){const s=r[0],n=((o,a)=>{for(let l=o.length-1;l>=0;l--)if(a(o[l],l,o))return l;return-1})(r,(o=>!o.eq(s)));r.splice(n+1)}return r.forEach(((s,n,o)=>{let a,l;n===0?(l=o[1],a=e?s:o[o.length-1]):n===o.length-1?(a=o[n-1],l=e?s:o[0]):(a=o[n-1],l=o[n+1]),e&&o.length===1?i.push(...new Bs(s,s,t).project()):!e||n!==0&&n!==o.length-1?i.push(...new Ut(s,a,l,t).project()):i.push(...new Bs(s,n===0?l:a,t).project())})),i},ss=u=>{const t={};return Object.keys(u).forEach((e=>{t[e]={},Object.keys(u[e]).forEach((i=>{t[e][i]=E({},u[e][i])}))})),t},wa=u=>u.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;");let $t;const ns=u=>{if($t||$t||($t="Intl"in ar()&&"Segmenter"in Intl&&new Intl.Segmenter(void 0,{granularity:"grapheme"})),$t){const t=$t.segment(u);return Array.from(t).map((e=>{let{segment:i}=e;return i}))}return xa(u)},xa=u=>{const t=[];for(let e,i=0;i<u.length;i++)(e=_a(u,i))!==!1&&t.push(e);return t},_a=(u,t)=>{const e=u.charCodeAt(t);if(isNaN(e))return"";if(e<55296||e>57343)return u.charAt(t);if(55296<=e&&e<=56319){if(u.length<=t+1)throw"High surrogate without following low surrogate";const r=u.charCodeAt(t+1);if(56320>r||r>57343)throw"High surrogate without following low surrogate";return u.charAt(t)+u.charAt(t+1)}if(t===0)throw"Low surrogate without preceding high surrogate";const i=u.charCodeAt(t-1);if(55296>i||i>56319)throw"Low surrogate without preceding high surrogate";return!1},os=function(u,t){let e=arguments.length>2&&arguments[2]!==void 0&&arguments[2];return u.fill!==t.fill||u.stroke!==t.stroke||u.strokeWidth!==t.strokeWidth||u.fontSize!==t.fontSize||u.fontFamily!==t.fontFamily||u.fontWeight!==t.fontWeight||u.fontStyle!==t.fontStyle||u.textDecorationThickness!==t.textDecorationThickness||u.textBackgroundColor!==t.textBackgroundColor||u.deltaY!==t.deltaY||e&&(u.overline!==t.overline||u.underline!==t.underline||u.linethrough!==t.linethrough)},Ta=(u,t)=>{const e=t.split(`
`),i=[];let r=-1,s={};u=ss(u);for(let n=0;n<e.length;n++){const o=ns(e[n]);if(u[n])for(let a=0;a<o.length;a++){r++;const l=u[n][a];l&&Object.keys(l).length>0&&(os(s,l,!0)?i.push({start:r,end:r+1,style:l}):i[i.length-1].end++),s=l||{}}else r+=o.length,s={}}return i},Sa=(u,t)=>{if(!Array.isArray(u))return ss(u);const e=t.split(Yr),i={};let r=-1,s=0;for(let n=0;n<e.length;n++){const o=ns(e[n]);for(let a=0;a<o.length;a++)r++,u[s]&&u[s].start<=r&&r<u[s].end&&(i[n]=i[n]||{},i[n][a]=E({},u[s].style),r===u[s].end-1&&s++)}return i},xt=["display","transform",ye,"fill-opacity","fill-rule","opacity",Re,"stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"];function Is(u,t){const e=u.nodeName,i=u.getAttribute("class"),r=u.getAttribute("id"),s="(?![a-zA-Z\\-]+)";let n;if(n=new RegExp("^"+e,"i"),t=t.replace(n,""),r&&t.length&&(n=new RegExp("#"+r+s,"i"),t=t.replace(n,"")),i&&t.length){const o=i.split(" ");for(let a=o.length;a--;)n=new RegExp("\\."+o[a]+s,"i"),t=t.replace(n,"")}return t.length===0}function Ca(u,t){let e=!0;const i=Is(u,t.pop());return i&&t.length&&(e=(function(r,s){let n,o=!0;for(;r.parentElement&&r.parentElement.nodeType===1&&s.length;)o&&(n=s.pop()),o=Is(r=r.parentElement,n);return s.length===0})(u,t)),i&&e&&t.length===0}const ba=u=>{var t;return(t=Io[u])!==null&&t!==void 0?t:u},Ea=new RegExp("(".concat(Ze,")"),"gi"),Pa=u=>u.replace(Ea," $1 ").replace(/,/gi," ").replace(/\s+/gi," ");var Hs,js,zs,Ns,Ws,Us,Vs;const be="(".concat(Ze,")"),Da=String.raw(Hs||(Hs=et(["(skewX)(",")"],["(skewX)\\(","\\)"])),be),Oa=String.raw(js||(js=et(["(skewY)(",")"],["(skewY)\\(","\\)"])),be),Ra=String.raw(zs||(zs=et(["(rotate)(","(?: "," ",")?)"],["(rotate)\\(","(?: "," ",")?\\)"])),be,be,be),Ma=String.raw(Ns||(Ns=et(["(scale)(","(?: ",")?)"],["(scale)\\(","(?: ",")?\\)"])),be,be),ka=String.raw(Ws||(Ws=et(["(translate)(","(?: ",")?)"],["(translate)\\(","(?: ",")?\\)"])),be,be),Fa=String.raw(Us||(Us=et(["(matrix)("," "," "," "," "," ",")"],["(matrix)\\("," "," "," "," "," ","\\)"])),be,be,be,be,be,be),as="(?:".concat(Fa,"|").concat(ka,"|").concat(Ra,"|").concat(Ma,"|").concat(Da,"|").concat(Oa,")"),Aa="(?:".concat(as,"*)"),La=String.raw(Vs||(Vs=et(["^s*(?:","?)s*$"],["^\\s*(?:","?)\\s*$"])),Aa),Ba=new RegExp(La),Ia=new RegExp(as),Ha=new RegExp(as,"g");function zr(u){const t=[];if(!(u=Pa(u).replace(/\s*([()])\s*/gi,"$1"))||u&&!Ba.test(u))return[...Ee];for(const e of u.matchAll(Ha)){const i=Ia.exec(e[0]);if(!i)continue;let r=Ee;const s=i.filter((p=>!!p)),[,n,...o]=s,[a,l,h,c,d,g]=o.map((p=>parseFloat(p)));switch(n){case"translate":r=gi(a,l);break;case qr:r=qt({angle:a},{x:l,y:h});break;case hr:r=Jr(a,l);break;case Xt:r=dn(a);break;case Yt:r=gn(a);break;case"matrix":r=[a,l,h,c,d,g]}t.push(r)}return Kr(t)}function ja(u,t,e,i){const r=Array.isArray(t);let s,n=t;if(u!==ye&&u!==Re||t!==Oe){if(u==="strokeUniform")return t==="non-scaling-stroke";if(u==="strokeDashArray")n=t===Oe?null:t.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(u==="transformMatrix")n=e&&e.transformMatrix?Te(e.transformMatrix,zr(t)):zr(t);else if(u==="visible")n=t!==Oe&&t!=="hidden",e&&e.visible===!1&&(n=!1);else if(u==="opacity")n=parseFloat(t),e&&e.opacity!==void 0&&(n*=e.opacity);else if(u==="textAnchor")n=t==="start"?oe:t==="end"?fe:ee;else if(u==="charSpacing"||u===Rt)s=Wt(t,i)/i*1e3;else if(u==="paintFirst"){const o=t.indexOf(ye),a=t.indexOf(Re);n=ye,(o>-1&&a>-1&&a<o||o===-1&&a>-1)&&(n=Re)}else{if(u==="href"||u==="xlink:href"||u==="font"||u==="id")return t;if(u==="imageSmoothing")return t==="optimizeQuality";s=r?t.map(Wt):Wt(t,i)}}else n="";return!r&&isNaN(s)?n:s}function za(u,t){const e=u.match(Bo);if(!e)return;const i=e[1],r=e[3],s=e[4],n=e[5],o=e[6];i&&(t.fontStyle=i),r&&(t.fontWeight=isNaN(parseFloat(r))?r:parseFloat(r)),s&&(t.fontSize=Wt(s)),o&&(t.fontFamily=o),n&&(t.lineHeight=n==="normal"?1:n)}function Na(u,t){u.replace(/;\s*$/,"").split(";").forEach((e=>{if(!e)return;const[i,r]=e.split(":");t[i.trim().toLowerCase()]=r.trim()}))}function Wa(u){const t={},e=u.getAttribute("style");return e&&(typeof e=="string"?Na(e,t):(function(i,r){Object.entries(i).forEach((s=>{let[n,o]=s;o!==void 0&&(r[n.toLowerCase()]=o)}))})(e,t)),t}const Ua={stroke:"strokeOpacity",fill:"fillOpacity"};function ft(u,t,e){if(!u)return{};let i,r={},s=Xr;u.parentNode&&Os.test(u.parentNode.nodeName)&&(r=ft(u.parentElement,t,e),r.fontSize&&(i=s=Wt(r.fontSize)));const n=E(E(E({},t.reduce(((l,h)=>{const c=u.getAttribute(h);return c&&(l[h]=c),l}),{})),(function(l){let h=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},c={};for(const d in h)Ca(l,d.split(" "))&&(c=E(E({},c),h[d]));return c})(u,e)),Wa(u));n[Cr]&&u.setAttribute(Cr,n[Cr]),n[Sr]&&(i=Wt(n[Sr],s),n[Sr]="".concat(i));const o={};for(const l in n){const h=ba(l),c=ja(h,n[l],r,i);o[h]=c}o&&o.font&&za(o.font,o);const a=E(E({},r),o);return Os.test(u.nodeName)?a:(function(l){const h=Se.getDefaults();return Object.entries(Ua).forEach((c=>{let[d,g]=c;if(l[g]===void 0||l[d]==="")return;if(l[d]===void 0){if(!h[d])return;l[d]=h[d]}if(l[d].indexOf("url(")===0)return;const p=new le(l[d]);l[d]=p.setAlpha(he(p.getAlpha()*l[g],2)).toRgba()})),l})(a)}const Va=["left","top","width","height","visible"],Hn=["rx","ry"];class Xe extends Se{static getDefaults(){return E(E({},super.getDefaults()),Xe.ownDefaults)}constructor(t){super(),Object.assign(this,Xe.ownDefaults),this.setOptions(t),this._initRxRy()}_initRxRy(){const{rx:t,ry:e}=this;t&&!e?this.ry=t:e&&!t&&(this.rx=e)}_render(t){const{width:e,height:i}=this,r=-e/2,s=-i/2,n=this.rx?Math.min(this.rx,e/2):0,o=this.ry?Math.min(this.ry,i/2):0,a=n!==0||o!==0;t.beginPath(),t.moveTo(r+n,s),t.lineTo(r+e-n,s),a&&t.bezierCurveTo(r+e-mt*n,s,r+e,s+mt*o,r+e,s+o),t.lineTo(r+e,s+i-o),a&&t.bezierCurveTo(r+e,s+i-mt*o,r+e-mt*n,s+i,r+e-n,s+i),t.lineTo(r+n,s+i),a&&t.bezierCurveTo(r+mt*n,s+i,r,s+i-mt*o,r,s+i-o),t.lineTo(r,s+o),a&&t.bezierCurveTo(r,s+mt*o,r+mt*n,s,r+n,s),t.closePath(),this._renderPaintInOrder(t)}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return super.toObject([...Hn,...t])}_toSVG(){const{width:t,height:e,rx:i,ry:r}=this;return["<rect ","COMMON_PARTS",'x="'.concat(-t/2,'" y="').concat(-e/2,'" rx="').concat(i,'" ry="').concat(r,'" width="').concat(t,'" height="').concat(e,`" />
`)]}static async fromElement(t,e,i){const r=ft(t,this.ATTRIBUTE_NAMES,i),{left:s=0,top:n=0,width:o=0,height:a=0,visible:l=!0}=r,h=ue(r,Va);return new this(E(E(E({},e),h),{},{left:s,top:n,width:o,height:a,visible:!!(l&&o&&a)}))}}b(Xe,"type","Rect"),b(Xe,"cacheProperties",[...gt,...Hn]),b(Xe,"ownDefaults",{rx:0,ry:0}),b(Xe,"ATTRIBUTE_NAMES",[...xt,"x","y","rx","ry","width","height"]),N.setClass(Xe),N.setSVGClass(Xe);const nt="initialization",rr="added",ls="removed",sr="imperative",jn=(u,t)=>{const{strokeUniform:e,strokeWidth:i,width:r,height:s,group:n}=t,o=n&&n!==u?dr(n.calcTransformMatrix(),u.calcTransformMatrix()):null,a=o?t.getRelativeCenterPoint().transform(o):t.getRelativeCenterPoint(),l=!t.isStrokeAccountedForInDimensions(),h=e&&l?Oo(new O(i,i),void 0,u.calcTransformMatrix()):Zr,c=!e&&l?i:0,d=$r(r+c,s+c,Kr([o,t.calcOwnMatrix()],!0)).add(h).scalarDivide(2);return[a.subtract(d),a.add(d)]};class pr{calcLayoutResult(t,e){if(this.shouldPerformLayout(t))return this.calcBoundingBox(e,t)}shouldPerformLayout(t){let{type:e,prevStrategy:i,strategy:r}=t;return e===nt||e===sr||!!i&&r!==i}shouldLayoutClipPath(t){let{type:e,target:{clipPath:i}}=t;return e!==nt&&i&&!i.absolutePositioned}getInitialSize(t,e){return e.size}calcBoundingBox(t,e){const{type:i,target:r}=e;if(i===sr&&e.overrides)return e.overrides;if(t.length===0)return;const{left:s,top:n,width:o,height:a}=at(t.map((c=>jn(r,c))).reduce(((c,d)=>c.concat(d)),[])),l=new O(o,a),h=new O(s,n).add(l.scalarDivide(2));if(i===nt){const c=this.getInitialSize(e,{size:l,center:h});return{center:h,relativeCorrection:new O(0,0),size:c}}return{center:h.transform(r.calcOwnMatrix()),size:l}}}b(pr,"type","strategy");class Nr extends pr{shouldPerformLayout(t){return!0}}b(Nr,"type","fit-content"),N.setClass(Nr);const Ga=["strategy"],Xa=["target","strategy","bubbles","prevStrategy"],zn="layoutManager";class ui{constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:new Nr;b(this,"strategy",void 0),this.strategy=t,this._subscriptions=new Map}performLayout(t){const e=E(E({bubbles:!0,strategy:this.strategy},t),{},{prevStrategy:this._prevLayoutStrategy,stopPropagation(){this.bubbles=!1}});this.onBeforeLayout(e);const i=this.getLayoutResult(e);i&&this.commitLayout(e,i),this.onAfterLayout(e,i),this._prevLayoutStrategy=e.strategy}attachHandlers(t,e){const{target:i}=e;return[Ji,rn,oi,sn,lr,nn,Ki,po,mo].map((r=>t.on(r,(s=>this.performLayout(r===Ji?{type:"object_modified",trigger:r,e:s,target:i}:{type:"object_modifying",trigger:r,e:s,target:i})))))}subscribe(t,e){this.unsubscribe(t,e);const i=this.attachHandlers(t,e);this._subscriptions.set(t,i)}unsubscribe(t,e){(this._subscriptions.get(t)||[]).forEach((i=>i())),this._subscriptions.delete(t)}unsubscribeTargets(t){t.targets.forEach((e=>this.unsubscribe(e,t)))}subscribeTargets(t){t.targets.forEach((e=>this.subscribe(e,t)))}onBeforeLayout(t){const{target:e,type:i}=t,{canvas:r}=e;if(i===nt||i===rr?this.subscribeTargets(t):i===ls&&this.unsubscribeTargets(t),e.fire("layout:before",{context:t}),r&&r.fire("object:layout:before",{target:e,context:t}),i===sr&&t.deep){const s=ue(t,Ga);e.forEachObject((n=>n.layoutManager&&n.layoutManager.performLayout(E(E({},s),{},{bubbles:!1,target:n}))))}}getLayoutResult(t){const{target:e,strategy:i,type:r}=t,s=i.calcLayoutResult(t,e.getObjects());if(!s)return;const n=r===nt?new O:e.getRelativeCenterPoint(),{center:o,correction:a=new O,relativeCorrection:l=new O}=s,h=n.subtract(o).add(a).transform(r===nt?Ee:qe(e.calcOwnMatrix()),!0).add(l);return{result:s,prevCenter:n,nextCenter:o,offset:h}}commitLayout(t,e){const{target:i}=t,{result:{size:r},nextCenter:s}=e;var n,o;i.set({width:r.x,height:r.y}),this.layoutObjects(t,e),t.type===nt?i.set({left:(n=t.x)!==null&&n!==void 0?n:s.x+r.x*ve(i.originX),top:(o=t.y)!==null&&o!==void 0?o:s.y+r.y*ve(i.originY)}):(i.setPositionByOrigin(s,ee,ee),i.setCoords(),i.set("dirty",!0))}layoutObjects(t,e){const{target:i}=t;i.forEachObject((r=>{r.group===i&&this.layoutObject(t,e,r)})),t.strategy.shouldLayoutClipPath(t)&&this.layoutObject(t,e,i.clipPath)}layoutObject(t,e,i){let{offset:r}=e;i.set({left:i.left+r.x,top:i.top+r.y})}onAfterLayout(t,e){const{target:i,strategy:r,bubbles:s,prevStrategy:n}=t,o=ue(t,Xa),{canvas:a}=i;i.fire("layout:after",{context:t,result:e}),a&&a.fire("object:layout:after",{context:t,result:e,target:i});const l=i.parent;s&&l!=null&&l.layoutManager&&((o.path||(o.path=[])).push(i),l.layoutManager.performLayout(E(E({},o),{},{target:l}))),i.set("dirty",!0)}dispose(){const{_subscriptions:t}=this;t.forEach((e=>e.forEach((i=>i())))),t.clear()}toObject(){return{type:zn,strategy:this.strategy.constructor.type}}toJSON(){return this.toObject()}}N.setClass(ui,zn);const Ya=["type","objects","layoutManager"];class qa extends ui{performLayout(){}}class Ot extends on(Se){static getDefaults(){return E(E({},super.getDefaults()),Ot.ownDefaults)}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),b(this,"_activeObjects",[]),b(this,"__objectSelectionTracker",void 0),b(this,"__objectSelectionDisposer",void 0),Object.assign(this,Ot.ownDefaults),this.setOptions(e),this.groupInit(t,e)}groupInit(t,e){var i;this._objects=[...t],this.__objectSelectionTracker=this.__objectSelectionMonitor.bind(this,!0),this.__objectSelectionDisposer=this.__objectSelectionMonitor.bind(this,!1),this.forEachObject((r=>{this.enterGroup(r,!1)})),this.layoutManager=(i=e.layoutManager)!==null&&i!==void 0?i:new ui,this.layoutManager.performLayout({type:nt,target:this,targets:[...t],x:e.left,y:e.top})}canEnterGroup(t){return t===this||this.isDescendantOf(t)?(yt("error","Group: circular object trees are not supported, this call has no effect"),!1):this._objects.indexOf(t)===-1||(yt("error","Group: duplicate objects are not supported inside group, this call has no effect"),!1)}_filterObjectsBeforeEnteringGroup(t){return t.filter(((e,i,r)=>this.canEnterGroup(e)&&r.indexOf(e)===i))}add(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const r=this._filterObjectsBeforeEnteringGroup(e),s=super.add(...r);return this._onAfterObjectsChange(rr,r),s}insertAt(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];const s=this._filterObjectsBeforeEnteringGroup(i),n=super.insertAt(t,...s);return this._onAfterObjectsChange(rr,s),n}remove(){const t=super.remove(...arguments);return this._onAfterObjectsChange(ls,t),t}_onObjectAdded(t){this.enterGroup(t,!0),this.fire("object:added",{target:t}),t.fire("added",{target:this})}_onObjectRemoved(t,e){this.exitGroup(t,e),this.fire("object:removed",{target:t}),t.fire("removed",{target:this})}_onAfterObjectsChange(t,e){this.layoutManager.performLayout({type:t,targets:e,target:this})}_onStackOrderChanged(){this._set("dirty",!0)}_set(t,e){const i=this[t];return super._set(t,e),t==="canvas"&&i!==e&&(this._objects||[]).forEach((r=>{r._set(t,e)})),this}_shouldSetNestedCoords(){return this.subTargetCheck}removeAll(){return this._activeObjects=[],this.remove(...this._objects)}__objectSelectionMonitor(t,e){let{target:i}=e;const r=this._activeObjects;if(t)r.push(i),this._set("dirty",!0);else if(r.length>0){const s=r.indexOf(i);s>-1&&(r.splice(s,1),this._set("dirty",!0))}}_watchObject(t,e){t&&this._watchObject(!1,e),t?(e.on("selected",this.__objectSelectionTracker),e.on("deselected",this.__objectSelectionDisposer)):(e.off("selected",this.__objectSelectionTracker),e.off("deselected",this.__objectSelectionDisposer))}enterGroup(t,e){t.group&&t.group.remove(t),t._set("parent",this),this._enterGroup(t,e)}_enterGroup(t,e){e&&er(t,Te(qe(this.calcTransformMatrix()),t.calcTransformMatrix())),this._shouldSetNestedCoords()&&t.setCoords(),t._set("group",this),t._set("canvas",this.canvas),this._watchObject(!0,t);const i=this.canvas&&this.canvas.getActiveObject&&this.canvas.getActiveObject();i&&(i===t||t.isDescendantOf(i))&&this._activeObjects.push(t)}exitGroup(t,e){this._exitGroup(t,e),t._set("parent",void 0),t._set("canvas",void 0)}_exitGroup(t,e){t._set("group",void 0),e||(er(t,Te(this.calcTransformMatrix(),t.calcTransformMatrix())),t.setCoords()),this._watchObject(!1,t);const i=this._activeObjects.length>0?this._activeObjects.indexOf(t):-1;i>-1&&this._activeObjects.splice(i,1)}shouldCache(){const t=Se.prototype.shouldCache.call(this);if(t){for(let e=0;e<this._objects.length;e++)if(this._objects[e].willDrawShadow())return this.ownCaching=!1,!1}return t}willDrawShadow(){if(super.willDrawShadow())return!0;for(let t=0;t<this._objects.length;t++)if(this._objects[t].willDrawShadow())return!0;return!1}isOnACache(){return this.ownCaching||!!this.parent&&this.parent.isOnACache()}drawObject(t,e,i){this._renderBackground(t);for(let s=0;s<this._objects.length;s++){var r;const n=this._objects[s];(r=this.canvas)!==null&&r!==void 0&&r.preserveObjectStacking&&n.group!==this?(t.save(),t.transform(...qe(this.calcTransformMatrix())),n.render(t),t.restore()):n.group===this&&n.render(t)}this._drawClipPath(t,this.clipPath,i)}setCoords(){super.setCoords(),this._shouldSetNestedCoords()&&this.forEachObject((t=>t.setCoords()))}triggerLayout(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.layoutManager.performLayout(E({target:this,type:sr},t))}render(t){this._transformDone=!0,super.render(t),this._transformDone=!1}__serializeObjects(t,e){const i=this.includeDefaultValues;return this._objects.filter((function(r){return!r.excludeFromExport})).map((function(r){const s=r.includeDefaultValues;r.includeDefaultValues=i;const n=r[t||"toObject"](e);return r.includeDefaultValues=s,n}))}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const e=this.layoutManager.toObject();return E(E(E({},super.toObject(["subTargetCheck","interactive",...t])),e.strategy!=="fit-content"||this.includeDefaultValues?{layoutManager:e}:{}),{},{objects:this.__serializeObjects("toObject",t)})}toString(){return"#<Group: (".concat(this.complexity(),")>")}dispose(){this.layoutManager.unsubscribeTargets({targets:this.getObjects(),target:this}),this._activeObjects=[],this.forEachObject((t=>{this._watchObject(!1,t),t.dispose()})),super.dispose()}_createSVGBgRect(t){if(!this.backgroundColor)return"";const e=Xe.prototype._toSVG.call(this),i=e.indexOf("COMMON_PARTS");e[i]='for="group" ';const r=e.join("");return t?t(r):r}_toSVG(t){const e=["<g ","COMMON_PARTS",` >
`],i=this._createSVGBgRect(t);i&&e.push("		",i);for(let r=0;r<this._objects.length;r++)e.push("		",this._objects[r].toSVG(t));return e.push(`</g>
`),e}getSvgStyles(){const t=this.opacity!==void 0&&this.opacity!==1?"opacity: ".concat(this.opacity,";"):"",e=this.visible?"":" visibility: hidden;";return[t,this.getSvgFilter(),e].join("")}toClipPathSVG(t){const e=[],i=this._createSVGBgRect(t);i&&e.push("	",i);for(let r=0;r<this._objects.length;r++)e.push("	",this._objects[r].toClipPathSVG(t));return this._createBaseClipPathSVGMarkup(e,{reviver:t})}static fromObject(t,e){let{type:i,objects:r=[],layoutManager:s}=t,n=ue(t,Ya);return Promise.all([ai(r,e),ur(n,e)]).then((o=>{let[a,l]=o;const h=new this(a,E(E(E({},n),l),{},{layoutManager:new qa}));if(s){const c=N.getClass(s.type),d=N.getClass(s.strategy);h.layoutManager=new c(new d)}else h.layoutManager=new ui;return h.layoutManager.subscribeTargets({type:nt,target:h,targets:h.getObjects()}),h.setCoords(),h}))}}b(Ot,"type","Group"),b(Ot,"ownDefaults",{strokeWidth:0,subTargetCheck:!1,interactive:!1}),N.setClass(Ot);const Za=(u,t)=>Math.min(t.width/u.width,t.height/u.height),Ka=(u,t)=>Math.max(t.width/u.width,t.height/u.height),Wr="\\s*,?\\s*",ei="".concat(Wr,"(").concat(Ze,")"),Ja="".concat(ei).concat(ei).concat(ei).concat(Wr,"([01])").concat(Wr,"([01])").concat(ei).concat(ei),Qa={m:"l",M:"L"},$a=(u,t,e,i,r,s,n,o,a,l,h)=>{const c=ht(u),d=ct(u),g=ht(t),p=ct(t),v=e*r*g-i*s*p+n,w=i*r*g+e*s*p+o;return["C",l+a*(-e*r*d-i*s*c),h+a*(-i*r*d+e*s*c),v+a*(e*r*p+i*s*g),w+a*(i*r*p-e*s*g),v,w]},Gs=(u,t,e,i)=>{const r=Math.atan2(t,u),s=Math.atan2(i,e);return s>=r?s-r:2*Math.PI-(r-s)};function Xs(u,t,e,i,r,s,n,o){let a;if(re.cachesBoundsOfCurve&&(a=[...arguments].join(),ii.boundsOfCurveCache[a]))return ii.boundsOfCurveCache[a];const l=Math.sqrt,h=Math.abs,c=[],d=[[0,0],[0,0]];let g=6*u-12*e+6*r,p=-3*u+9*e-9*r+3*n,v=3*e-3*u;for(let k=0;k<2;++k){if(k>0&&(g=6*t-12*i+6*s,p=-3*t+9*i-9*s+3*o,v=3*i-3*t),h(p)<1e-12){if(h(g)<1e-12)continue;const W=-v/g;0<W&&W<1&&c.push(W);continue}const R=g*g-4*v*p;if(R<0)continue;const A=l(R),j=(-g+A)/(2*p);0<j&&j<1&&c.push(j);const I=(-g-A)/(2*p);0<I&&I<1&&c.push(I)}let w=c.length;const x=w,C=Nn(u,t,e,i,r,s,n,o);for(;w--;){const{x:k,y:R}=C(c[w]);d[0][w]=k,d[1][w]=R}d[0][x]=u,d[1][x]=t,d[0][x+1]=n,d[1][x+1]=o;const P=[new O(Math.min(...d[0]),Math.min(...d[1])),new O(Math.max(...d[0]),Math.max(...d[1]))];return re.cachesBoundsOfCurve&&(ii.boundsOfCurveCache[a]=P),P}const el=(u,t,e)=>{let[i,r,s,n,o,a,l,h]=e;const c=((d,g,p,v,w,x,C)=>{if(p===0||v===0)return[];let P=0,k=0,R=0;const A=Math.PI,j=C*Gr,I=ct(j),W=ht(j),$=.5*(-W*d-I*g),Z=.5*(-W*g+I*d),z=p**2,V=v**2,Y=Z**2,ie=$**2,te=z*V-z*Y-V*ie;let se=Math.abs(p),Q=Math.abs(v);if(te<0){const Fe=Math.sqrt(1-te/(z*V));se*=Fe,Q*=Fe}else R=(w===x?-1:1)*Math.sqrt(te/(z*Y+V*ie));const me=R*se*Z/Q,xe=-R*Q*$/se,pt=W*me-I*xe+.5*d,_t=I*me+W*xe+.5*g;let q=Gs(1,0,($-me)/se,(Z-xe)/Q),ke=Gs(($-me)/se,(Z-xe)/Q,(-$-me)/se,(-Z-xe)/Q);x===0&&ke>0?ke-=2*A:x===1&&ke<0&&(ke+=2*A);const tt=Math.ceil(Math.abs(ke/A*2)),Be=[],Ie=ke/tt,kt=8/3*Math.sin(Ie/4)*Math.sin(Ie/4)/Math.sin(Ie/2);let Tt=q+Ie;for(let Fe=0;Fe<tt;Fe++)Be[Fe]=$a(q,Tt,W,I,se,Q,pt,_t,kt,P,k),P=Be[Fe][5],k=Be[Fe][6],q=Tt,Tt+=Ie;return Be})(l-u,h-t,r,s,o,a,n);for(let d=0,g=c.length;d<g;d++)c[d][1]+=u,c[d][2]+=t,c[d][3]+=u,c[d][4]+=t,c[d][5]+=u,c[d][6]+=t;return c},tl=u=>{let t=0,e=0,i=0,r=0;const s=[];let n,o=0,a=0;for(const l of u){const h=[...l];let c;switch(h[0]){case"l":h[1]+=t,h[2]+=e;case"L":t=h[1],e=h[2],c=["L",t,e];break;case"h":h[1]+=t;case"H":t=h[1],c=["L",t,e];break;case"v":h[1]+=e;case"V":e=h[1],c=["L",t,e];break;case"m":h[1]+=t,h[2]+=e;case"M":t=h[1],e=h[2],i=h[1],r=h[2],c=["M",t,e];break;case"c":h[1]+=t,h[2]+=e,h[3]+=t,h[4]+=e,h[5]+=t,h[6]+=e;case"C":o=h[3],a=h[4],t=h[5],e=h[6],c=["C",h[1],h[2],o,a,t,e];break;case"s":h[1]+=t,h[2]+=e,h[3]+=t,h[4]+=e;case"S":n==="C"?(o=2*t-o,a=2*e-a):(o=t,a=e),t=h[3],e=h[4],c=["C",o,a,h[1],h[2],t,e],o=c[3],a=c[4];break;case"q":h[1]+=t,h[2]+=e,h[3]+=t,h[4]+=e;case"Q":o=h[1],a=h[2],t=h[3],e=h[4],c=["Q",o,a,t,e];break;case"t":h[1]+=t,h[2]+=e;case"T":n==="Q"?(o=2*t-o,a=2*e-a):(o=t,a=e),t=h[1],e=h[2],c=["Q",o,a,t,e];break;case"a":h[6]+=t,h[7]+=e;case"A":el(t,e,h).forEach((d=>s.push(d))),t=h[6],e=h[7];break;case"z":case"Z":t=i,e=r,c=["Z"]}c?(s.push(c),n=c[0]):n=""}return s},nr=(u,t,e,i)=>Math.sqrt((e-u)**2+(i-t)**2),Nn=(u,t,e,i,r,s,n,o)=>a=>{const l=a**3,h=(g=>3*g**2*(1-g))(a),c=(g=>3*g*(1-g)**2)(a),d=(g=>(1-g)**3)(a);return new O(n*l+r*h+e*c+u*d,o*l+s*h+i*c+t*d)},Wn=u=>u**2,Un=u=>2*u*(1-u),Vn=u=>(1-u)**2,il=(u,t,e,i,r,s,n,o)=>a=>{const l=Wn(a),h=Un(a),c=Vn(a),d=3*(c*(e-u)+h*(r-e)+l*(n-r)),g=3*(c*(i-t)+h*(s-i)+l*(o-s));return Math.atan2(g,d)},rl=(u,t,e,i,r,s)=>n=>{const o=Wn(n),a=Un(n),l=Vn(n);return new O(r*o+e*a+u*l,s*o+i*a+t*l)},sl=(u,t,e,i,r,s)=>n=>{const o=1-n,a=2*(o*(e-u)+n*(r-e)),l=2*(o*(i-t)+n*(s-i));return Math.atan2(l,a)},Ys=(u,t,e)=>{let i=new O(t,e),r=0;for(let s=1;s<=100;s+=1){const n=u(s/100);r+=nr(i.x,i.y,n.x,n.y),i=n}return r},nl=(u,t)=>{let e,i=0,r=0,s={x:u.x,y:u.y},n=E({},s),o=.01,a=0;const l=u.iterator,h=u.angleFinder;for(;r<t&&o>1e-4;)n=l(i),a=i,e=nr(s.x,s.y,n.x,n.y),e+r>t?(i-=o,o/=2):(s=n,i+=o,r+=e);return E(E({},n),{},{angle:h(a)})},Gn=u=>{let t,e,i=0,r=0,s=0,n=0,o=0;const a=[];for(const l of u){const h={x:r,y:s,command:l[0],length:0};switch(l[0]){case"M":e=h,e.x=n=r=l[1],e.y=o=s=l[2];break;case"L":e=h,e.length=nr(r,s,l[1],l[2]),r=l[1],s=l[2];break;case"C":t=Nn(r,s,l[1],l[2],l[3],l[4],l[5],l[6]),e=h,e.iterator=t,e.angleFinder=il(r,s,l[1],l[2],l[3],l[4],l[5],l[6]),e.length=Ys(t,r,s),r=l[5],s=l[6];break;case"Q":t=rl(r,s,l[1],l[2],l[3],l[4]),e=h,e.iterator=t,e.angleFinder=sl(r,s,l[1],l[2],l[3],l[4]),e.length=Ys(t,r,s),r=l[3],s=l[4];break;case"Z":e=h,e.destX=n,e.destY=o,e.length=nr(r,s,n,o),r=n,s=o}i+=e.length,a.push(e)}return a.push({length:i,x:r,y:s}),a},ol=function(u,t){let e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Gn(u),i=0;for(;t-e[i].length>0&&i<e.length-2;)t-=e[i].length,i++;const r=e[i],s=t/r.length,n=u[i];switch(r.command){case"M":return{x:r.x,y:r.y,angle:0};case"Z":return E(E({},new O(r.x,r.y).lerp(new O(r.destX,r.destY),s)),{},{angle:Math.atan2(r.destY-r.y,r.destX-r.x)});case"L":return E(E({},new O(r.x,r.y).lerp(new O(n[1],n[2]),s)),{},{angle:Math.atan2(n[2]-r.y,n[1]-r.x)});case"C":case"Q":return nl(r,t)}},al=new RegExp("[mzlhvcsqta][^mzlhvcsqta]*","gi"),qs=new RegExp(Ja,"g"),ll=new RegExp(Ze,"gi"),hl={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},cl=u=>{var t;const e=[],i=(t=u.match(al))!==null&&t!==void 0?t:[];for(const r of i){const s=r[0];if(s==="z"||s==="Z"){e.push([s]);continue}const n=hl[s.toLowerCase()];let o=[];if(s==="a"||s==="A"){qs.lastIndex=0;for(let a=null;a=qs.exec(r);)o.push(...a.slice(1))}else o=r.match(ll)||[];for(let a=0;a<o.length;a+=n){const l=new Array(n),h=Qa[s];l[0]=a>0&&h?h:s;for(let c=0;c<n;c++)l[c+1]=parseFloat(o[a+c]);e.push(l)}}return e},ul=(u,t)=>u.map((e=>e.map(((i,r)=>r===0||t===void 0?i:he(i,t))).join(" "))).join(" ");function Ur(u,t){const e=u.style;e&&t&&(typeof t=="string"?e.cssText+=";"+t:Object.entries(t).forEach((i=>{let[r,s]=i;return e.setProperty(r,s)})))}class dl extends vn{constructor(t){let{allowTouchScrolling:e=!1,containerClass:i=""}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(t),b(this,"upper",void 0),b(this,"container",void 0);const{el:r}=this.lower,s=this.createUpperCanvas();this.upper={el:s,ctx:s.getContext("2d")},this.applyCanvasStyle(r,{allowTouchScrolling:e}),this.applyCanvasStyle(s,{allowTouchScrolling:e,styles:{position:"absolute",left:"0",top:"0"}});const n=this.createContainerElement();n.classList.add(i),r.parentNode&&r.parentNode.replaceChild(n,r),n.append(r,s),this.container=n}createUpperCanvas(){const{el:t}=this.lower,e=ut();return e.className=t.className,e.classList.remove("lower-canvas"),e.classList.add("upper-canvas"),e.setAttribute("data-fabric","top"),e.style.cssText=t.style.cssText,e.setAttribute("draggable","true"),e}createContainerElement(){const t=Gt().createElement("div");return t.setAttribute("data-fabric","wrapper"),Ur(t,{position:"relative"}),ws(t),t}applyCanvasStyle(t,e){const{styles:i,allowTouchScrolling:r}=e;Ur(t,E(E({},i),{},{"touch-action":r?"manipulation":Oe})),ws(t)}setDimensions(t,e){super.setDimensions(t,e);const{el:i,ctx:r}=this.upper;mn(i,r,t,e)}setCSSDimensions(t){super.setCSSDimensions(t),Lr(this.upper.el,t),Lr(this.container,t)}cleanupDOM(t){const e=this.container,{el:i}=this.lower,{el:r}=this.upper;super.cleanupDOM(t),e.removeChild(r),e.removeChild(i),e.parentNode&&e.parentNode.replaceChild(i,e)}dispose(){super.dispose(),$e().dispose(this.upper.el),delete this.upper,delete this.container}}class mr extends fi{constructor(){super(...arguments),b(this,"targets",[]),b(this,"_hoveredTargets",[]),b(this,"_objectsToRender",void 0),b(this,"_currentTransform",null),b(this,"_groupSelector",null),b(this,"contextTopDirty",!1)}static getDefaults(){return E(E({},super.getDefaults()),mr.ownDefaults)}get upperCanvasEl(){var t;return(t=this.elements.upper)===null||t===void 0?void 0:t.el}get contextTop(){var t;return(t=this.elements.upper)===null||t===void 0?void 0:t.ctx}get wrapperEl(){return this.elements.container}initElements(t){this.elements=new dl(t,{allowTouchScrolling:this.allowTouchScrolling,containerClass:this.containerClass}),this._createCacheCanvas()}_onObjectAdded(t){this._objectsToRender=void 0,super._onObjectAdded(t)}_onObjectRemoved(t){this._objectsToRender=void 0,t===this._activeObject&&(this.fire("before:selection:cleared",{deselected:[t]}),this._discardActiveObject(),this.fire("selection:cleared",{deselected:[t]}),t.fire("deselected",{target:t})),t===this._hoveredTarget&&(this._hoveredTarget=void 0,this._hoveredTargets=[]),super._onObjectRemoved(t)}_onStackOrderChanged(){this._objectsToRender=void 0,super._onStackOrderChanged()}_chooseObjectsToRender(){const t=this._activeObject;return!this.preserveObjectStacking&&t?this._objects.filter((e=>!e.group&&e!==t)).concat(t):this._objects}renderAll(){this.cancelRequestedRender(),this.destroyed||(!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1),!this._objectsToRender&&(this._objectsToRender=this._chooseObjectsToRender()),this.renderCanvas(this.getContext(),this._objectsToRender))}renderTopLayer(t){t.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(t),this.contextTopDirty=!0),t.restore()}renderTop(){const t=this.contextTop;this.clearContext(t),this.renderTopLayer(t),this.fire("after:render",{ctx:t})}setTargetFindTolerance(t){t=Math.round(t),this.targetFindTolerance=t;const e=this.getRetinaScaling(),i=Math.ceil((2*t+1)*e);this.pixelFindCanvasEl.width=this.pixelFindCanvasEl.height=i,this.pixelFindContext.scale(e,e)}isTargetTransparent(t,e,i){const r=this.targetFindTolerance,s=this.pixelFindContext;this.clearContext(s),s.save(),s.translate(-e+r,-i+r),s.transform(...this.viewportTransform);const n=t.selectionBackgroundColor;t.selectionBackgroundColor="",t.render(s),t.selectionBackgroundColor=n,s.restore();const o=Math.round(r*this.getRetinaScaling());return ma(s,o,o,o)}_isSelectionKeyPressed(t){const e=this.selectionKey;return!!e&&(Array.isArray(e)?!!e.find((i=>!!i&&t[i]===!0)):t[e])}_shouldClearSelection(t,e){const i=this.getActiveObjects(),r=this._activeObject;return!!(!e||e&&r&&i.length>1&&i.indexOf(e)===-1&&r!==e&&!this._isSelectionKeyPressed(t)||e&&!e.evented||e&&!e.selectable&&r&&r!==e)}_shouldCenterTransform(t,e,i){if(!t)return;let r;return e===hr||e===Me||e===Ne||e===oi?r=this.centeredScaling||t.centeredScaling:e===qr&&(r=this.centeredRotation||t.centeredRotation),r?!i:i}_getOriginFromCorner(t,e){const i={x:t.originX,y:t.originY};return e&&(["ml","tl","bl"].includes(e)?i.x=fe:["mr","tr","br"].includes(e)&&(i.x=oe),["tl","mt","tr"].includes(e)?i.y=Ar:["bl","mb","br"].includes(e)&&(i.y=De)),i}_setupCurrentTransform(t,e,i){var r;const s=e.group?Nt(this.getScenePoint(t),void 0,e.group.calcTransformMatrix()):this.getScenePoint(t),{key:n="",control:o}=e.getActiveControl()||{},a=i&&o?(r=o.getActionHandler(t,e,o))===null||r===void 0?void 0:r.bind(o):ko,l=((g,p,v,w)=>{if(!p||!g)return"drag";const x=w.controls[p];return x.getActionName(v,x,w)})(i,n,t,e),h=t[this.centeredKey],c=this._shouldCenterTransform(e,l,h)?{x:ee,y:ee}:this._getOriginFromCorner(e,n),d={target:e,action:l,actionHandler:a,actionPerformed:!1,corner:n,scaleX:e.scaleX,scaleY:e.scaleY,skewX:e.skewX,skewY:e.skewY,offsetX:s.x-e.left,offsetY:s.y-e.top,originX:c.x,originY:c.y,ex:s.x,ey:s.y,lastX:s.x,lastY:s.y,theta:pe(e.angle),width:e.width,height:e.height,shiftKey:t.shiftKey,altKey:h,original:E(E({},yn(e)),{},{originX:c.x,originY:c.y})};this._currentTransform=d,this.fire("before:transform",{e:t,transform:d})}setCursor(t){this.upperCanvasEl.style.cursor=t}_drawSelection(t){const{x:e,y:i,deltaX:r,deltaY:s}=this._groupSelector,n=new O(e,i).transform(this.viewportTransform),o=new O(e+r,i+s).transform(this.viewportTransform),a=this.selectionLineWidth/2;let l=Math.min(n.x,o.x),h=Math.min(n.y,o.y),c=Math.max(n.x,o.x),d=Math.max(n.y,o.y);this.selectionColor&&(t.fillStyle=this.selectionColor,t.fillRect(l,h,c-l,d-h)),this.selectionLineWidth&&this.selectionBorderColor&&(t.lineWidth=this.selectionLineWidth,t.strokeStyle=this.selectionBorderColor,l+=a,h+=a,c-=a,d-=a,Se.prototype._setLineDash.call(this,t,this.selectionDashArray),t.strokeRect(l,h,c-l,d-h))}findTarget(t){if(this.skipTargetFind)return;const e=this.getViewportPoint(t),i=this._activeObject,r=this.getActiveObjects();if(this.targets=[],i&&r.length>=1){if(i.findControl(e,Br(t))||r.length>1&&this.searchPossibleTargets([i],e))return i;if(i===this.searchPossibleTargets([i],e)){if(this.preserveObjectStacking){const s=this.targets;this.targets=[];const n=this.searchPossibleTargets(this._objects,e);return t[this.altSelectionKey]&&n&&n!==i?(this.targets=s,i):n}return i}}return this.searchPossibleTargets(this._objects,e)}_pointIsInObjectSelectionArea(t,e){let i=t.getCoords();const r=this.getZoom(),s=t.padding/r;if(s){const[n,o,a,l]=i,h=Math.atan2(o.y-n.y,o.x-n.x),c=ht(h)*s,d=ct(h)*s,g=c+d,p=c-d;i=[new O(n.x-p,n.y-g),new O(o.x+g,o.y-p),new O(a.x+p,a.y+g),new O(l.x-g,l.y+p)]}return de.isPointInPolygon(e,i)}_checkTarget(t,e){return!!(t&&t.visible&&t.evented&&this._pointIsInObjectSelectionArea(t,Nt(e,void 0,this.viewportTransform))&&(!this.perPixelTargetFind&&!t.perPixelTargetFind||t.isEditing||!this.isTargetTransparent(t,e.x,e.y)))}_searchPossibleTargets(t,e){let i=t.length;for(;i--;){const r=t[i];if(this._checkTarget(r,e)){if(Vi(r)&&r.subTargetCheck){const s=this._searchPossibleTargets(r._objects,e);s&&this.targets.push(s)}return r}}}searchPossibleTargets(t,e){const i=this._searchPossibleTargets(t,e);if(i&&Vi(i)&&i.interactive&&this.targets[0]){const r=this.targets;for(let s=r.length-1;s>0;s--){const n=r[s];if(!Vi(n)||!n.interactive)return n}return r[0]}return i}getViewportPoint(t){return this._pointer?this._pointer:this.getPointer(t,!0)}getScenePoint(t){return this._absolutePointer?this._absolutePointer:this.getPointer(t)}getPointer(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i=this.upperCanvasEl,r=i.getBoundingClientRect();let s=bo(t),n=r.width||0,o=r.height||0;n&&o||(De in r&&Ar in r&&(o=Math.abs(r.top-r.bottom)),fe in r&&oe in r&&(n=Math.abs(r.right-r.left))),this.calcOffset(),s.x=s.x-this._offset.left,s.y=s.y-this._offset.top,e||(s=Nt(s,void 0,this.viewportTransform));const a=this.getRetinaScaling();a!==1&&(s.x/=a,s.y/=a);const l=n===0||o===0?new O(1,1):new O(i.width/n,i.height/o);return s.multiply(l)}_setDimensionsImpl(t,e){this._resetTransformEventData(),super._setDimensionsImpl(t,e),this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop)}_createCacheCanvas(){this.pixelFindCanvasEl=ut(),this.pixelFindContext=this.pixelFindCanvasEl.getContext("2d",{willReadFrequently:!0}),this.setTargetFindTolerance(this.targetFindTolerance)}getTopContext(){return this.elements.upper.ctx}getSelectionContext(){return this.elements.upper.ctx}getSelectionElement(){return this.elements.upper.el}getActiveObject(){return this._activeObject}getActiveObjects(){const t=this._activeObject;return St(t)?t.getObjects():t?[t]:[]}_fireSelectionEvents(t,e){let i=!1,r=!1;const s=this.getActiveObjects(),n=[],o=[];t.forEach((a=>{s.includes(a)||(i=!0,a.fire("deselected",{e,target:a}),o.push(a))})),s.forEach((a=>{t.includes(a)||(i=!0,a.fire("selected",{e,target:a}),n.push(a))})),t.length>0&&s.length>0?(r=!0,i&&this.fire("selection:updated",{e,selected:n,deselected:o})):s.length>0?(r=!0,this.fire("selection:created",{e,selected:n})):t.length>0&&(r=!0,this.fire("selection:cleared",{e,deselected:o})),r&&(this._objectsToRender=void 0)}setActiveObject(t,e){const i=this.getActiveObjects(),r=this._setActiveObject(t,e);return this._fireSelectionEvents(i,e),r}_setActiveObject(t,e){const i=this._activeObject;return i!==t&&!(!this._discardActiveObject(e,t)&&this._activeObject)&&!t.onSelect({e})&&(this._activeObject=t,St(t)&&i!==t&&t.set("canvas",this),t.setCoords(),!0)}_discardActiveObject(t,e){const i=this._activeObject;return!!i&&!i.onDeselect({e:t,object:e})&&(this._currentTransform&&this._currentTransform.target===i&&this.endCurrentTransform(t),St(i)&&i===this._hoveredTarget&&(this._hoveredTarget=void 0),this._activeObject=void 0,!0)}discardActiveObject(t){const e=this.getActiveObjects(),i=this.getActiveObject();e.length&&this.fire("before:selection:cleared",{e:t,deselected:[i]});const r=this._discardActiveObject(t);return this._fireSelectionEvents(e,t),r}endCurrentTransform(t){const e=this._currentTransform;this._finalizeCurrentTransform(t),e&&e.target&&(e.target.isMoving=!1),this._currentTransform=null}_finalizeCurrentTransform(t){const e=this._currentTransform,i=e.target,r={e:t,target:i,transform:e,action:e.action};i._scaling&&(i._scaling=!1),i.setCoords(),e.actionPerformed&&(this.fire("object:modified",r),i.fire(Ji,r))}setViewportTransform(t){super.setViewportTransform(t);const e=this._activeObject;e&&e.setCoords()}destroy(){const t=this._activeObject;St(t)&&(t.removeAll(),t.dispose()),delete this._activeObject,super.destroy(),this.pixelFindContext=null,this.pixelFindCanvasEl=void 0}clear(){this.discardActiveObject(),this._activeObject=void 0,this.clearContext(this.contextTop),super.clear()}drawControls(t){const e=this._activeObject;e&&e._renderControls(t)}_toObject(t,e,i){const r=this._realizeGroupTransformOnObject(t),s=super._toObject(t,e,i);return t.set(r),s}_realizeGroupTransformOnObject(t){const{group:e}=t;if(e&&St(e)&&this._activeObject===e){const i=Zt(t,["angle","flipX","flipY",oe,Me,Ne,Xt,Yt,De]);return Po(t,e.calcOwnMatrix()),i}return{}}_setSVGObject(t,e,i){const r=this._realizeGroupTransformOnObject(e);super._setSVGObject(t,e,i),e.set(r)}}b(mr,"ownDefaults",{uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",selection:!0,selectionKey:"shiftKey",selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,enablePointerEvents:!1,containerClass:"canvas-container",preserveObjectStacking:!1});class gl{constructor(t){b(this,"targets",[]),b(this,"__disposer",void 0);const e=()=>{const{hiddenTextarea:r}=t.getActiveObject()||{};r&&r.focus()},i=t.upperCanvasEl;i.addEventListener("click",e),this.__disposer=()=>i.removeEventListener("click",e)}exitTextEditing(){this.target=void 0,this.targets.forEach((t=>{t.isEditing&&t.exitEditing()}))}add(t){this.targets.push(t)}remove(t){this.unregister(t),It(this.targets,t)}register(t){this.target=t}unregister(t){t===this.target&&(this.target=void 0)}onMouseMove(t){var e;!((e=this.target)===null||e===void 0)&&e.isEditing&&this.target.updateSelectionOnMouseMove(t)}clear(){this.targets=[],this.target=void 0}dispose(){this.clear(),this.__disposer(),delete this.__disposer}}const fl=["target","oldTarget","fireCanvas","e"],Le={passive:!1},Bt=(u,t)=>{const e=u.getViewportPoint(t),i=u.getScenePoint(t);return{viewportPoint:e,scenePoint:i,pointer:e,absolutePointer:i}},vt=function(u){for(var t=arguments.length,e=new Array(t>1?t-1:0),i=1;i<t;i++)e[i-1]=arguments[i];return u.addEventListener(...e)},He=function(u){for(var t=arguments.length,e=new Array(t>1?t-1:0),i=1;i<t;i++)e[i-1]=arguments[i];return u.removeEventListener(...e)},pl={mouse:{in:"over",out:"out",targetIn:"mouseover",targetOut:"mouseout",canvasIn:"mouse:over",canvasOut:"mouse:out"},drag:{in:"enter",out:"leave",targetIn:"dragenter",targetOut:"dragleave",canvasIn:"drag:enter",canvasOut:"drag:leave"}};class or extends mr{constructor(t){super(t,arguments.length>1&&arguments[1]!==void 0?arguments[1]:{}),b(this,"_isClick",void 0),b(this,"textEditingManager",new gl(this)),["_onMouseDown","_onTouchStart","_onMouseMove","_onMouseUp","_onTouchEnd","_onResize","_onMouseWheel","_onMouseOut","_onMouseEnter","_onContextMenu","_onClick","_onDragStart","_onDragEnd","_onDragProgress","_onDragOver","_onDragEnter","_onDragLeave","_onDrop"].forEach((e=>{this[e]=this[e].bind(this)})),this.addOrRemove(vt,"add")}_getEventPrefix(){return this.enablePointerEvents?"pointer":"mouse"}addOrRemove(t,e){const i=this.upperCanvasEl,r=this._getEventPrefix();t(pn(i),"resize",this._onResize),t(i,r+"down",this._onMouseDown),t(i,"".concat(r,"move"),this._onMouseMove,Le),t(i,"".concat(r,"out"),this._onMouseOut),t(i,"".concat(r,"enter"),this._onMouseEnter),t(i,"wheel",this._onMouseWheel),t(i,"contextmenu",this._onContextMenu),t(i,"click",this._onClick),t(i,"dblclick",this._onClick),t(i,"dragstart",this._onDragStart),t(i,"dragend",this._onDragEnd),t(i,"dragover",this._onDragOver),t(i,"dragenter",this._onDragEnter),t(i,"dragleave",this._onDragLeave),t(i,"drop",this._onDrop),this.enablePointerEvents||t(i,"touchstart",this._onTouchStart,Le)}removeListeners(){this.addOrRemove(He,"remove");const t=this._getEventPrefix(),e=Ye(this.upperCanvasEl);He(e,"".concat(t,"up"),this._onMouseUp),He(e,"touchend",this._onTouchEnd,Le),He(e,"".concat(t,"move"),this._onMouseMove,Le),He(e,"touchmove",this._onMouseMove,Le),clearTimeout(this._willAddMouseDown)}_onMouseWheel(t){this.__onMouseWheel(t)}_onMouseOut(t){const e=this._hoveredTarget,i=E({e:t},Bt(this,t));this.fire("mouse:out",E(E({},i),{},{target:e})),this._hoveredTarget=void 0,e&&e.fire("mouseout",E({},i)),this._hoveredTargets.forEach((r=>{this.fire("mouse:out",E(E({},i),{},{target:r})),r&&r.fire("mouseout",E({},i))})),this._hoveredTargets=[]}_onMouseEnter(t){this._currentTransform||this.findTarget(t)||(this.fire("mouse:over",E({e:t},Bt(this,t))),this._hoveredTarget=void 0,this._hoveredTargets=[])}_onDragStart(t){this._isClick=!1;const e=this.getActiveObject();if(e&&e.onDragStart(t)){this._dragSource=e;const i={e:t,target:e};return this.fire("dragstart",i),e.fire("dragstart",i),void vt(this.upperCanvasEl,"drag",this._onDragProgress)}xs(t)}_renderDragEffects(t,e,i){let r=!1;const s=this._dropTarget;s&&s!==e&&s!==i&&(s.clearContextTop(),r=!0),e?.clearContextTop(),i!==e&&i?.clearContextTop();const n=this.contextTop;n.save(),n.transform(...this.viewportTransform),e&&(n.save(),e.transform(n),e.renderDragSourceEffect(t),n.restore(),r=!0),i&&(n.save(),i.transform(n),i.renderDropTargetEffect(t),n.restore(),r=!0),n.restore(),r&&(this.contextTopDirty=!0)}_onDragEnd(t){const e=!!t.dataTransfer&&t.dataTransfer.dropEffect!==Oe,i=e?this._activeObject:void 0,r={e:t,target:this._dragSource,subTargets:this.targets,dragSource:this._dragSource,didDrop:e,dropTarget:i};He(this.upperCanvasEl,"drag",this._onDragProgress),this.fire("dragend",r),this._dragSource&&this._dragSource.fire("dragend",r),delete this._dragSource,this._onMouseUp(t)}_onDragProgress(t){const e={e:t,target:this._dragSource,dragSource:this._dragSource,dropTarget:this._draggedoverTarget};this.fire("drag",e),this._dragSource&&this._dragSource.fire("drag",e)}findDragTargets(t){return this.targets=[],{target:this._searchPossibleTargets(this._objects,this.getViewportPoint(t)),targets:[...this.targets]}}_onDragOver(t){const e="dragover",{target:i,targets:r}=this.findDragTargets(t),s=this._dragSource,n={e:t,target:i,subTargets:r,dragSource:s,canDrop:!1,dropTarget:void 0};let o;this.fire(e,n),this._fireEnterLeaveEvents(i,n),i&&(i.canDrop(t)&&(o=i),i.fire(e,n));for(let a=0;a<r.length;a++){const l=r[a];l.canDrop(t)&&(o=l),l.fire(e,n)}this._renderDragEffects(t,s,o),this._dropTarget=o}_onDragEnter(t){const{target:e,targets:i}=this.findDragTargets(t),r={e:t,target:e,subTargets:i,dragSource:this._dragSource};this.fire("dragenter",r),this._fireEnterLeaveEvents(e,r)}_onDragLeave(t){const e={e:t,target:this._draggedoverTarget,subTargets:this.targets,dragSource:this._dragSource};this.fire("dragleave",e),this._fireEnterLeaveEvents(void 0,e),this._renderDragEffects(t,this._dragSource),this._dropTarget=void 0,this.targets=[],this._hoveredTargets=[]}_onDrop(t){const{target:e,targets:i}=this.findDragTargets(t),r=this._basicEventHandler("drop:before",E({e:t,target:e,subTargets:i,dragSource:this._dragSource},Bt(this,t)));r.didDrop=!1,r.dropTarget=void 0,this._basicEventHandler("drop",r),this.fire("drop:after",r)}_onContextMenu(t){const e=this.findTarget(t),i=this.targets||[],r=this._basicEventHandler("contextmenu:before",{e:t,target:e,subTargets:i});return this.stopContextMenu&&xs(t),this._basicEventHandler("contextmenu",r),!1}_onClick(t){const e=t.detail;e>3||e<2||(this._cacheTransformEventData(t),e==2&&t.type==="dblclick"&&this._handleEvent(t,"dblclick"),e==3&&this._handleEvent(t,"tripleclick"),this._resetTransformEventData())}getPointerId(t){const e=t.changedTouches;return e?e[0]&&e[0].identifier:this.enablePointerEvents?t.pointerId:-1}_isMainEvent(t){return t.isPrimary===!0||t.isPrimary!==!1&&(t.type==="touchend"&&t.touches.length===0||!t.changedTouches||t.changedTouches[0].identifier===this.mainTouchId)}_onTouchStart(t){let e=!this.allowTouchScrolling;const i=this._activeObject;this.mainTouchId===void 0&&(this.mainTouchId=this.getPointerId(t)),this.__onMouseDown(t),(this.isDrawingMode||i&&this._target===i)&&(e=!0),e&&t.preventDefault(),this._resetTransformEventData();const r=this.upperCanvasEl,s=this._getEventPrefix(),n=Ye(r);vt(n,"touchend",this._onTouchEnd,Le),e&&vt(n,"touchmove",this._onMouseMove,Le),He(r,"".concat(s,"down"),this._onMouseDown)}_onMouseDown(t){this.__onMouseDown(t),this._resetTransformEventData();const e=this.upperCanvasEl,i=this._getEventPrefix();He(e,"".concat(i,"move"),this._onMouseMove,Le);const r=Ye(e);vt(r,"".concat(i,"up"),this._onMouseUp),vt(r,"".concat(i,"move"),this._onMouseMove,Le)}_onTouchEnd(t){if(t.touches.length>0)return;this.__onMouseUp(t),this._resetTransformEventData(),delete this.mainTouchId;const e=this._getEventPrefix(),i=Ye(this.upperCanvasEl);He(i,"touchend",this._onTouchEnd,Le),He(i,"touchmove",this._onMouseMove,Le),this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout((()=>{vt(this.upperCanvasEl,"".concat(e,"down"),this._onMouseDown),this._willAddMouseDown=0}),400)}_onMouseUp(t){this.__onMouseUp(t),this._resetTransformEventData();const e=this.upperCanvasEl,i=this._getEventPrefix();if(this._isMainEvent(t)){const r=Ye(this.upperCanvasEl);He(r,"".concat(i,"up"),this._onMouseUp),He(r,"".concat(i,"move"),this._onMouseMove,Le),vt(e,"".concat(i,"move"),this._onMouseMove,Le)}}_onMouseMove(t){const e=this.getActiveObject();!this.allowTouchScrolling&&(!e||!e.shouldStartDragging(t))&&t.preventDefault&&t.preventDefault(),this.__onMouseMove(t)}_onResize(){this.calcOffset(),this._resetTransformEventData()}_shouldRender(t){const e=this.getActiveObject();return!!e!=!!t||e&&t&&e!==t}__onMouseUp(t){var e;this._cacheTransformEventData(t),this._handleEvent(t,"up:before");const i=this._currentTransform,r=this._isClick,s=this._target,{button:n}=t;if(n)return(this.fireMiddleClick&&n===1||this.fireRightClick&&n===2)&&this._handleEvent(t,"up"),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)return void this._onMouseUpInDrawingMode(t);if(!this._isMainEvent(t))return;let o,a,l=!1;if(i&&(this._finalizeCurrentTransform(t),l=i.actionPerformed),!r){const h=s===this._activeObject;this.handleSelection(t),l||(l=this._shouldRender(s)||!h&&s===this._activeObject)}if(s){const h=s.findControl(this.getViewportPoint(t),Br(t)),{key:c,control:d}=h||{};if(a=c,s.selectable&&s!==this._activeObject&&s.activeOn==="up")this.setActiveObject(s,t),l=!0;else if(d){const g=d.getMouseUpHandler(t,s,d);g&&(o=this.getScenePoint(t),g.call(d,t,i,o.x,o.y))}s.isMoving=!1}if(i&&(i.target!==s||i.corner!==a)){const h=i.target&&i.target.controls[i.corner],c=h&&h.getMouseUpHandler(t,i.target,h);o=o||this.getScenePoint(t),c&&c.call(h,t,i,o.x,o.y)}this._setCursorFromEvent(t,s),this._handleEvent(t,"up"),this._groupSelector=null,this._currentTransform=null,s&&(s.__corner=void 0),l?this.requestRenderAll():r||(e=this._activeObject)!==null&&e!==void 0&&e.isEditing||this.renderTop()}_basicEventHandler(t,e){const{target:i,subTargets:r=[]}=e;this.fire(t,e),i&&i.fire(t,e);for(let s=0;s<r.length;s++)r[s]!==i&&r[s].fire(t,e);return e}_handleEvent(t,e,i){const r=this._target,s=this.targets||[],n=E(E(E({e:t,target:r,subTargets:s},Bt(this,t)),{},{transform:this._currentTransform},e==="up:before"||e==="up"?{isClick:this._isClick,currentTarget:this.findTarget(t),currentSubTargets:this.targets}:{}),e==="down:before"||e==="down"?i:{});this.fire("mouse:".concat(e),n),r&&r.fire("mouse".concat(e),n);for(let o=0;o<s.length;o++)s[o]!==r&&s[o].fire("mouse".concat(e),n)}_onMouseDownInDrawingMode(t){this._isCurrentlyDrawing=!0,this.getActiveObject()&&(this.discardActiveObject(t),this.requestRenderAll());const e=this.getScenePoint(t);this.freeDrawingBrush&&this.freeDrawingBrush.onMouseDown(e,{e:t,pointer:e}),this._handleEvent(t,"down",{alreadySelected:!1})}_onMouseMoveInDrawingMode(t){if(this._isCurrentlyDrawing){const e=this.getScenePoint(t);this.freeDrawingBrush&&this.freeDrawingBrush.onMouseMove(e,{e:t,pointer:e})}this.setCursor(this.freeDrawingCursor),this._handleEvent(t,"move")}_onMouseUpInDrawingMode(t){const e=this.getScenePoint(t);this.freeDrawingBrush?this._isCurrentlyDrawing=!!this.freeDrawingBrush.onMouseUp({e:t,pointer:e}):this._isCurrentlyDrawing=!1,this._handleEvent(t,"up")}__onMouseDown(t){this._isClick=!0,this._cacheTransformEventData(t),this._handleEvent(t,"down:before");let e=this._target,i=!!e&&e===this._activeObject;const{button:r}=t;if(r)return(this.fireMiddleClick&&r===1||this.fireRightClick&&r===2)&&this._handleEvent(t,"down",{alreadySelected:i}),void this._resetTransformEventData();if(this.isDrawingMode)return void this._onMouseDownInDrawingMode(t);if(!this._isMainEvent(t)||this._currentTransform)return;let s=this._shouldRender(e),n=!1;if(this.handleMultiSelection(t,e)?(e=this._activeObject,n=!0,s=!0):this._shouldClearSelection(t,e)&&this.discardActiveObject(t),this.selection&&(!e||!e.selectable&&!e.isEditing&&e!==this._activeObject)){const o=this.getScenePoint(t);this._groupSelector={x:o.x,y:o.y,deltaY:0,deltaX:0}}if(i=!!e&&e===this._activeObject,e){e.selectable&&e.activeOn==="down"&&this.setActiveObject(e,t);const o=e.findControl(this.getViewportPoint(t),Br(t));if(e===this._activeObject&&(o||!n)){this._setupCurrentTransform(t,e,i);const a=o?o.control:void 0,l=this.getScenePoint(t),h=a&&a.getMouseDownHandler(t,e,a);h&&h.call(a,t,this._currentTransform,l.x,l.y)}}s&&(this._objectsToRender=void 0),this._handleEvent(t,"down",{alreadySelected:i}),s&&this.requestRenderAll()}_resetTransformEventData(){this._target=this._pointer=this._absolutePointer=void 0}_cacheTransformEventData(t){this._resetTransformEventData(),this._pointer=this.getViewportPoint(t),this._absolutePointer=Nt(this._pointer,void 0,this.viewportTransform),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(t)}__onMouseMove(t){if(this._isClick=!1,this._cacheTransformEventData(t),this._handleEvent(t,"move:before"),this.isDrawingMode)return void this._onMouseMoveInDrawingMode(t);if(!this._isMainEvent(t))return;const e=this._groupSelector;if(e){const i=this.getScenePoint(t);e.deltaX=i.x-e.x,e.deltaY=i.y-e.y,this.renderTop()}else if(this._currentTransform)this._transformObject(t);else{const i=this.findTarget(t);this._setCursorFromEvent(t,i),this._fireOverOutEvents(t,i)}this.textEditingManager.onMouseMove(t),this._handleEvent(t,"move"),this._resetTransformEventData()}_fireOverOutEvents(t,e){const i=this._hoveredTarget,r=this._hoveredTargets,s=this.targets,n=Math.max(r.length,s.length);this.fireSyntheticInOutEvents("mouse",{e:t,target:e,oldTarget:i,fireCanvas:!0});for(let o=0;o<n;o++)this.fireSyntheticInOutEvents("mouse",{e:t,target:s[o],oldTarget:r[o]});this._hoveredTarget=e,this._hoveredTargets=this.targets.concat()}_fireEnterLeaveEvents(t,e){const i=this._draggedoverTarget,r=this._hoveredTargets,s=this.targets,n=Math.max(r.length,s.length);this.fireSyntheticInOutEvents("drag",E(E({},e),{},{target:t,oldTarget:i,fireCanvas:!0}));for(let o=0;o<n;o++)this.fireSyntheticInOutEvents("drag",E(E({},e),{},{target:s[o],oldTarget:r[o]}));this._draggedoverTarget=t}fireSyntheticInOutEvents(t,e){let{target:i,oldTarget:r,fireCanvas:s,e:n}=e,o=ue(e,fl);const{targetIn:a,targetOut:l,canvasIn:h,canvasOut:c}=pl[t],d=r!==i;if(r&&d){const g=E(E({},o),{},{e:n,target:r,nextTarget:i},Bt(this,n));s&&this.fire(c,g),r.fire(l,g)}if(i&&d){const g=E(E({},o),{},{e:n,target:i,previousTarget:r},Bt(this,n));s&&this.fire(h,g),i.fire(a,g)}}__onMouseWheel(t){this._cacheTransformEventData(t),this._handleEvent(t,"wheel"),this._resetTransformEventData()}_transformObject(t){const e=this.getScenePoint(t),i=this._currentTransform,r=i.target,s=r.group?Nt(e,void 0,r.group.calcTransformMatrix()):e;i.shiftKey=t.shiftKey,i.altKey=!!this.centeredKey&&t[this.centeredKey],this._performTransformAction(t,i,s),i.actionPerformed&&this.requestRenderAll()}_performTransformAction(t,e,i){const{action:r,actionHandler:s,target:n}=e,o=!!s&&s(t,e,i.x,i.y);o&&n.setCoords(),r==="drag"&&o&&(e.target.isMoving=!0,this.setCursor(e.target.moveCursor||this.moveCursor)),e.actionPerformed=e.actionPerformed||o}_setCursorFromEvent(t,e){if(!e)return void this.setCursor(this.defaultCursor);let i=e.hoverCursor||this.hoverCursor;const r=St(this._activeObject)?this._activeObject:null,s=(!r||e.group!==r)&&e.findControl(this.getViewportPoint(t));if(s){const n=s.control;this.setCursor(n.cursorStyleHandler(t,n,e))}else e.subTargetCheck&&this.targets.concat().reverse().map((n=>{i=n.hoverCursor||i})),this.setCursor(i)}handleMultiSelection(t,e){const i=this._activeObject,r=St(i);if(i&&this._isSelectionKeyPressed(t)&&this.selection&&e&&e.selectable&&(i!==e||r)&&(r||!e.isDescendantOf(i)&&!i.isDescendantOf(e))&&!e.onSelect({e:t})&&!i.getActiveControl()){if(r){const s=i.getObjects();if(e===i){const n=this.getViewportPoint(t);if(!(e=this.searchPossibleTargets(s,n)||this.searchPossibleTargets(this._objects,n))||!e.selectable)return!1}e.group===i?(i.remove(e),this._hoveredTarget=e,this._hoveredTargets=[...this.targets],i.size()===1&&this._setActiveObject(i.item(0),t)):(i.multiSelectAdd(e),this._hoveredTarget=i,this._hoveredTargets=[...this.targets]),this._fireSelectionEvents(s,t)}else{i.isEditing&&i.exitEditing();const s=new(N.getClass("ActiveSelection"))([],{canvas:this});s.multiSelectAdd(i,e),this._hoveredTarget=s,this._setActiveObject(s,t),this._fireSelectionEvents([i],t)}return!0}return!1}handleSelection(t){if(!this.selection||!this._groupSelector)return!1;const{x:e,y:i,deltaX:r,deltaY:s}=this._groupSelector,n=new O(e,i),o=n.add(new O(r,s)),a=n.min(o),l=n.max(o).subtract(a),h=this.collectObjects({left:a.x,top:a.y,width:l.x,height:l.y},{includeIntersecting:!this.selectionFullyContained}),c=n.eq(o)?h[0]?[h[0]]:[]:h.length>1?h.filter((d=>!d.onSelect({e:t}))).reverse():h;if(c.length===1)this.setActiveObject(c[0],t);else if(c.length>1){const d=N.getClass("ActiveSelection");this.setActiveObject(new d(c,{canvas:this}),t)}return this._groupSelector=null,!0}clear(){this.textEditingManager.clear(),super.clear()}destroy(){this.removeListeners(),this.textEditingManager.dispose(),super.destroy()}}const Xn={x1:0,y1:0,x2:0,y2:0},ml=E(E({},Xn),{},{r1:0,r2:0}),jt=(u,t)=>isNaN(u)&&typeof t=="number"?t:u,vl=/^(\d+\.\d+)%|(\d+)%$/;function Yn(u){return u&&vl.test(u)}function qn(u,t){const e=typeof u=="number"?u:typeof u=="string"?parseFloat(u)/(Yn(u)?100:1):NaN;return Vt(0,jt(e,t),1)}const yl=/\s*;\s*/,wl=/\s*:\s*/;function xl(u,t){let e,i;const r=u.getAttribute("style");if(r){const n=r.split(yl);n[n.length-1]===""&&n.pop();for(let o=n.length;o--;){const[a,l]=n[o].split(wl).map((h=>h.trim()));a==="stop-color"?e=l:a==="stop-opacity"&&(i=l)}}const s=new le(e||u.getAttribute("stop-color")||"rgb(0,0,0)");return{offset:qn(u.getAttribute("offset"),0),color:s.toRgb(),opacity:jt(parseFloat(i||u.getAttribute("stop-opacity")||""),1)*s.getAlpha()*t}}function _l(u,t){const e=[],i=u.getElementsByTagName("stop"),r=qn(t,1);for(let s=i.length;s--;)e.push(xl(i[s],r));return e}function Zn(u){return u.nodeName==="linearGradient"||u.nodeName==="LINEARGRADIENT"?"linear":"radial"}function Kn(u){return u.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage"}function Ue(u,t){return u.getAttribute(t)}function Tl(u,t){return(function(e,i){let r,{width:s,height:n,gradientUnits:o}=i;return Object.keys(e).reduce(((a,l)=>{const h=e[l];return h==="Infinity"?r=1:h==="-Infinity"?r=0:(r=typeof h=="string"?parseFloat(h):h,typeof h=="string"&&Yn(h)&&(r*=.01,o==="pixels"&&(l!=="x1"&&l!=="x2"&&l!=="r2"||(r*=s),l!=="y1"&&l!=="y2"||(r*=n)))),a[l]=r,a}),{})})(Zn(u)==="linear"?(function(e){return{x1:Ue(e,"x1")||0,y1:Ue(e,"y1")||0,x2:Ue(e,"x2")||"100%",y2:Ue(e,"y2")||0}})(u):(function(e){return{x1:Ue(e,"fx")||Ue(e,"cx")||"50%",y1:Ue(e,"fy")||Ue(e,"cy")||"50%",r1:0,x2:Ue(e,"cx")||"50%",y2:Ue(e,"cy")||"50%",r2:Ue(e,"r")||"50%"}})(u),E(E({},t),{},{gradientUnits:Kn(u)}))}class xi{constructor(t){const{type:e="linear",gradientUnits:i="pixels",coords:r={},colorStops:s=[],offsetX:n=0,offsetY:o=0,gradientTransform:a,id:l}=t||{};Object.assign(this,{type:e,gradientUnits:i,coords:E(E({},e==="radial"?ml:Xn),r),colorStops:s,offsetX:n,offsetY:o,gradientTransform:a,id:l?"".concat(l,"_").concat(wt()):wt()})}addColorStop(t){for(const e in t){const i=new le(t[e]);this.colorStops.push({offset:parseFloat(e),color:i.toRgb(),opacity:i.getAlpha()})}return this}toObject(t){return E(E({},Zt(this,t)),{},{type:this.type,coords:E({},this.coords),colorStops:this.colorStops.map((e=>E({},e))),offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?[...this.gradientTransform]:void 0})}toSVG(t){let{additionalTransform:e}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const i=[],r=this.gradientTransform?this.gradientTransform.concat():Ee.concat(),s=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox",n=this.colorStops.map((c=>E({},c))).sort(((c,d)=>c.offset-d.offset));let o=-this.offsetX,a=-this.offsetY;var l;s==="objectBoundingBox"?(o/=t.width,a/=t.height):(o+=t.width/2,a+=t.height/2),(l=t)&&typeof l._renderPathCommands=="function"&&this.gradientUnits!=="percentage"&&(o-=t.pathOffset.x,a-=t.pathOffset.y),r[4]-=o,r[5]-=a;const h=['id="SVGID_'.concat(this.id,'"'),'gradientUnits="'.concat(s,'"'),'gradientTransform="'.concat(e?e+" ":"").concat(li(r),'"'),""].join(" ");if(this.type==="linear"){const{x1:c,y1:d,x2:g,y2:p}=this.coords;i.push("<linearGradient ",h,' x1="',c,'" y1="',d,'" x2="',g,'" y2="',p,`">
`)}else if(this.type==="radial"){const{x1:c,y1:d,x2:g,y2:p,r1:v,r2:w}=this.coords,x=v>w;i.push("<radialGradient ",h,' cx="',x?c:g,'" cy="',x?d:p,'" r="',x?v:w,'" fx="',x?g:c,'" fy="',x?p:d,`">
`),x&&(n.reverse(),n.forEach((P=>{P.offset=1-P.offset})));const C=Math.min(v,w);if(C>0){const P=C/Math.max(v,w);n.forEach((k=>{k.offset+=P*(1-k.offset)}))}}return n.forEach((c=>{let{color:d,offset:g,opacity:p}=c;i.push("<stop ",'offset="',100*g+"%",'" style="stop-color:',d,p!==void 0?";stop-opacity: "+p:";",`"/>
`)})),i.push(this.type==="linear"?"</linearGradient>":"</radialGradient>",`
`),i.join("")}toLive(t){const{x1:e,y1:i,x2:r,y2:s,r1:n,r2:o}=this.coords,a=this.type==="linear"?t.createLinearGradient(e,i,r,s):t.createRadialGradient(e,i,n,r,s,o);return this.colorStops.forEach((l=>{let{color:h,opacity:c,offset:d}=l;a.addColorStop(d,c!==void 0?new le(h).setAlpha(c).toRgba():h)})),a}static async fromObject(t){const{colorStops:e,gradientTransform:i}=t;return new this(E(E({},t),{},{colorStops:e?e.map((r=>E({},r))):void 0,gradientTransform:i?[...i]:void 0}))}static fromElement(t,e,i){const r=Kn(t),s=e._findCenterFromElement();return new this(E({id:t.getAttribute("id")||void 0,type:Zn(t),coords:Tl(t,{width:i.viewBoxWidth||i.width,height:i.viewBoxHeight||i.height}),colorStops:_l(t,i.opacity),gradientUnits:r,gradientTransform:zr(t.getAttribute("gradientTransform")||"")},r==="pixels"?{offsetX:e.width/2-s.x,offsetY:e.height/2-s.y}:{offsetX:0,offsetY:0}))}}b(xi,"type","Gradient"),N.setClass(xi,"gradient"),N.setClass(xi,"linear"),N.setClass(xi,"radial");const Sl=["type","source","patternTransform"];class Pr{get type(){return"pattern"}set type(t){yt("warn","Setting type has no effect",t)}constructor(t){b(this,"repeat","repeat"),b(this,"offsetX",0),b(this,"offsetY",0),b(this,"crossOrigin",""),this.id=wt(),Object.assign(this,t)}isImageSource(){return!!this.source&&typeof this.source.src=="string"}isCanvasSource(){return!!this.source&&!!this.source.toDataURL}sourceToString(){return this.isImageSource()?this.source.src:this.isCanvasSource()?this.source.toDataURL():""}toLive(t){return this.source&&(!this.isImageSource()||this.source.complete&&this.source.naturalWidth!==0&&this.source.naturalHeight!==0)?t.createPattern(this.source,this.repeat):null}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const{repeat:e,crossOrigin:i}=this;return E(E({},Zt(this,t)),{},{type:"pattern",source:this.sourceToString(),repeat:e,crossOrigin:i,offsetX:he(this.offsetX,re.NUM_FRACTION_DIGITS),offsetY:he(this.offsetY,re.NUM_FRACTION_DIGITS),patternTransform:this.patternTransform?[...this.patternTransform]:null})}toSVG(t){let{width:e,height:i}=t;const{source:r,repeat:s,id:n}=this,o=jt(this.offsetX/e,0),a=jt(this.offsetY/i,0),l=s==="repeat-y"||s==="no-repeat"?1+Math.abs(o||0):jt(r.width/e,0),h=s==="repeat-x"||s==="no-repeat"?1+Math.abs(a||0):jt(r.height/i,0);return['<pattern id="SVGID_'.concat(n,'" x="').concat(o,'" y="').concat(a,'" width="').concat(l,'" height="').concat(h,'">'),'<image x="0" y="0" width="'.concat(r.width,'" height="').concat(r.height,'" xlink:href="').concat(this.sourceToString(),'"></image>'),"</pattern>",""].join(`
`)}static async fromObject(t,e){let{type:i,source:r,patternTransform:s}=t,n=ue(t,Sl);const o=await Xi(r,E(E({},e),{},{crossOrigin:n.crossOrigin}));return new this(E(E({},n),{},{patternTransform:s&&s.slice(0),source:o}))}}b(Pr,"type","Pattern"),N.setClass(Pr),N.setClass(Pr,"pattern");const Cl=["path","left","top"],bl=["d"];class Ct extends Se{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{path:i,left:r,top:s}=e,n=ue(e,Cl);super(),Object.assign(this,Ct.ownDefaults),this.setOptions(n),this._setPath(t||[],!0),typeof r=="number"&&this.set(oe,r),typeof s=="number"&&this.set(De,s)}_setPath(t,e){this.path=tl(Array.isArray(t)?t:cl(t)),this.setBoundingBox(e)}_findCenterFromElement(){const t=this._calcBoundsFromPath();return new O(t.left+t.width/2,t.top+t.height/2)}_renderPathCommands(t){const e=-this.pathOffset.x,i=-this.pathOffset.y;t.beginPath();for(const r of this.path)switch(r[0]){case"L":t.lineTo(r[1]+e,r[2]+i);break;case"M":t.moveTo(r[1]+e,r[2]+i);break;case"C":t.bezierCurveTo(r[1]+e,r[2]+i,r[3]+e,r[4]+i,r[5]+e,r[6]+i);break;case"Q":t.quadraticCurveTo(r[1]+e,r[2]+i,r[3]+e,r[4]+i);break;case"Z":t.closePath()}}_render(t){this._renderPathCommands(t),this._renderPaintInOrder(t)}toString(){return"#<Path (".concat(this.complexity(),'): { "top": ').concat(this.top,', "left": ').concat(this.left," }>")}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return E(E({},super.toObject(t)),{},{path:this.path.map((e=>e.slice()))})}toDatalessObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const e=this.toObject(t);return this.sourcePath&&(delete e.path,e.sourcePath=this.sourcePath),e}_toSVG(){const t=ul(this.path,re.NUM_FRACTION_DIGITS);return["<path ","COMMON_PARTS",'d="'.concat(t,`" stroke-linecap="round" />
`)]}_getOffsetTransform(){const t=re.NUM_FRACTION_DIGITS;return" translate(".concat(he(-this.pathOffset.x,t),", ").concat(he(-this.pathOffset.y,t),")")}toClipPathSVG(t){const e=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:t,additionalTransform:e})}toSVG(t){const e=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:t,additionalTransform:e})}complexity(){return this.path.length}setDimensions(){this.setBoundingBox()}setBoundingBox(t){const{width:e,height:i,pathOffset:r}=this._calcDimensions();this.set({width:e,height:i,pathOffset:r}),t&&this.setPositionByOrigin(r,ee,ee)}_calcBoundsFromPath(){const t=[];let e=0,i=0,r=0,s=0;for(const n of this.path)switch(n[0]){case"L":r=n[1],s=n[2],t.push({x:e,y:i},{x:r,y:s});break;case"M":r=n[1],s=n[2],e=r,i=s;break;case"C":t.push(...Xs(r,s,n[1],n[2],n[3],n[4],n[5],n[6])),r=n[5],s=n[6];break;case"Q":t.push(...Xs(r,s,n[1],n[2],n[1],n[2],n[3],n[4])),r=n[3],s=n[4];break;case"Z":r=e,s=i}return at(t)}_calcDimensions(){const t=this._calcBoundsFromPath();return E(E({},t),{},{pathOffset:new O(t.left+t.width/2,t.top+t.height/2)})}static fromObject(t){return this._fromObject(t,{extraParam:"path"})}static async fromElement(t,e,i){const r=ft(t,this.ATTRIBUTE_NAMES,i),{d:s}=r;return new this(s,E(E(E({},ue(r,bl)),e),{},{left:void 0,top:void 0}))}}b(Ct,"type","Path"),b(Ct,"cacheProperties",[...gt,"path","fillRule"]),b(Ct,"ATTRIBUTE_NAMES",[...xt,"d"]),N.setClass(Ct),N.setSVGClass(Ct);const El=["left","top","radius"],Jn=["radius","startAngle","endAngle","counterClockwise"];class rt extends Se{static getDefaults(){return E(E({},super.getDefaults()),rt.ownDefaults)}constructor(t){super(),Object.assign(this,rt.ownDefaults),this.setOptions(t)}_set(t,e){return super._set(t,e),t==="radius"&&this.setRadius(e),this}_render(t){t.beginPath(),t.arc(0,0,this.radius,pe(this.startAngle),pe(this.endAngle),this.counterClockwise),this._renderPaintInOrder(t)}getRadiusX(){return this.get("radius")*this.get(Me)}getRadiusY(){return this.get("radius")*this.get(Ne)}setRadius(t){this.radius=t,this.set({width:2*t,height:2*t})}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return super.toObject([...Jn,...t])}_toSVG(){const t=(this.endAngle-this.startAngle)%360;if(t===0)return["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',"".concat(this.radius),`" />
`];{const{radius:e}=this,i=pe(this.startAngle),r=pe(this.endAngle),s=ht(i)*e,n=ct(i)*e,o=ht(r)*e,a=ct(r)*e,l=t>180?1:0,h=this.counterClockwise?0:1;return['<path d="M '.concat(s," ").concat(n," A ").concat(e," ").concat(e," 0 ").concat(l," ").concat(h," ").concat(o," ").concat(a,'" '),"COMMON_PARTS",` />
`]}}static async fromElement(t,e,i){const r=ft(t,this.ATTRIBUTE_NAMES,i),{left:s=0,top:n=0,radius:o=0}=r;return new this(E(E({},ue(r,El)),{},{radius:o,left:s-o,top:n-o}))}static fromObject(t){return super._fromObject(t)}}b(rt,"type","Circle"),b(rt,"cacheProperties",[...gt,...Jn]),b(rt,"ownDefaults",{radius:0,startAngle:0,endAngle:360,counterClockwise:!1}),b(rt,"ATTRIBUTE_NAMES",["cx","cy","r",...xt]),N.setClass(rt),N.setSVGClass(rt);const Pl=["x1","y1","x2","y2"],Dl=["x1","y1","x2","y2"],Vr=["x1","x2","y1","y2"];class bt extends Se{constructor(){let[t,e,i,r]=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[0,0,0,0],s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),Object.assign(this,bt.ownDefaults),this.setOptions(s),this.x1=t,this.x2=i,this.y1=e,this.y2=r,this._setWidthHeight();const{left:n,top:o}=s;typeof n=="number"&&this.set(oe,n),typeof o=="number"&&this.set(De,o)}_setWidthHeight(){const{x1:t,y1:e,x2:i,y2:r}=this;this.width=Math.abs(i-t),this.height=Math.abs(r-e);const{left:s,top:n,width:o,height:a}=at([{x:t,y:e},{x:i,y:r}]),l=new O(s+o/2,n+a/2);this.setPositionByOrigin(l,ee,ee)}_set(t,e){return super._set(t,e),Vr.includes(t)&&this._setWidthHeight(),this}_render(t){t.beginPath();const e=this.calcLinePoints();t.moveTo(e.x1,e.y1),t.lineTo(e.x2,e.y2),t.lineWidth=this.strokeWidth;const i=t.strokeStyle;var r;ze(this.stroke)?t.strokeStyle=this.stroke.toLive(t):t.strokeStyle=(r=this.stroke)!==null&&r!==void 0?r:t.fillStyle,this.stroke&&this._renderStroke(t),t.strokeStyle=i}_findCenterFromElement(){return new O((this.x1+this.x2)/2,(this.y1+this.y2)/2)}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return E(E({},super.toObject(t)),this.calcLinePoints())}_getNonTransformedDimensions(){const t=super._getNonTransformedDimensions();return this.strokeLineCap==="butt"&&(this.width===0&&(t.y-=this.strokeWidth),this.height===0&&(t.x-=this.strokeWidth)),t}calcLinePoints(){const{x1:t,x2:e,y1:i,y2:r,width:s,height:n}=this,o=t<=e?-1:1,a=i<=r?-1:1;return{x1:o*s/2,x2:o*-s/2,y1:a*n/2,y2:a*-n/2}}_toSVG(){const{x1:t,x2:e,y1:i,y2:r}=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="'.concat(t,'" y1="').concat(i,'" x2="').concat(e,'" y2="').concat(r,`" />
`)]}static async fromElement(t,e,i){const r=ft(t,this.ATTRIBUTE_NAMES,i),{x1:s=0,y1:n=0,x2:o=0,y2:a=0}=r;return new this([s,n,o,a],ue(r,Pl))}static fromObject(t){let{x1:e,y1:i,x2:r,y2:s}=t,n=ue(t,Dl);return this._fromObject(E(E({},n),{},{points:[e,i,r,s]}),{extraParam:"points"})}}b(bt,"type","Line"),b(bt,"cacheProperties",[...gt,...Vr]),b(bt,"ATTRIBUTE_NAMES",xt.concat(Vr)),N.setClass(bt),N.setSVGClass(bt);class Et extends Se{static getDefaults(){return E(E({},super.getDefaults()),Et.ownDefaults)}constructor(t){super(),Object.assign(this,Et.ownDefaults),this.setOptions(t)}_render(t){const e=this.width/2,i=this.height/2;t.beginPath(),t.moveTo(-e,i),t.lineTo(0,-i),t.lineTo(e,i),t.closePath(),this._renderPaintInOrder(t)}_toSVG(){const t=this.width/2,e=this.height/2;return["<polygon ","COMMON_PARTS",'points="',"".concat(-t," ").concat(e,",0 ").concat(-e,",").concat(t," ").concat(e),'" />']}}b(Et,"type","Triangle"),b(Et,"ownDefaults",{width:100,height:100}),N.setClass(Et),N.setSVGClass(Et);const Qn=["rx","ry"];class st extends Se{static getDefaults(){return E(E({},super.getDefaults()),st.ownDefaults)}constructor(t){super(),Object.assign(this,st.ownDefaults),this.setOptions(t)}_set(t,e){switch(super._set(t,e),t){case"rx":this.rx=e,this.set("width",2*e);break;case"ry":this.ry=e,this.set("height",2*e)}return this}getRx(){return this.get("rx")*this.get(Me)}getRy(){return this.get("ry")*this.get(Ne)}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return super.toObject([...Qn,...t])}_toSVG(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" rx="'.concat(this.rx,'" ry="').concat(this.ry,`" />
`)]}_render(t){t.beginPath(),t.save(),t.transform(1,0,0,this.ry/this.rx,0,0),t.arc(0,0,this.rx,0,Zi,!1),t.restore(),this._renderPaintInOrder(t)}static async fromElement(t,e,i){const r=ft(t,this.ATTRIBUTE_NAMES,i);return r.left=(r.left||0)-r.rx,r.top=(r.top||0)-r.ry,new this(r)}}function Ol(u){if(!u)return[];const t=u.replace(/,/g," ").trim().split(/\s+/),e=[];for(let i=0;i<t.length;i+=2)e.push({x:parseFloat(t[i]),y:parseFloat(t[i+1])});return e}b(st,"type","Ellipse"),b(st,"cacheProperties",[...gt,...Qn]),b(st,"ownDefaults",{rx:0,ry:0}),b(st,"ATTRIBUTE_NAMES",[...xt,"cx","cy","rx","ry"]),N.setClass(st),N.setSVGClass(st);const Rl=["left","top"],$n={exactBoundingBox:!1};class Ge extends Se{static getDefaults(){return E(E({},super.getDefaults()),Ge.ownDefaults)}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),b(this,"strokeDiff",void 0),Object.assign(this,Ge.ownDefaults),this.setOptions(e),this.points=t;const{left:i,top:r}=e;this.initialized=!0,this.setBoundingBox(!0),typeof i=="number"&&this.set(oe,i),typeof r=="number"&&this.set(De,r)}isOpen(){return!0}_projectStrokeOnPoints(t){return ya(this.points,t,this.isOpen())}_calcDimensions(t){t=E({scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,strokeLineCap:this.strokeLineCap,strokeLineJoin:this.strokeLineJoin,strokeMiterLimit:this.strokeMiterLimit,strokeUniform:this.strokeUniform,strokeWidth:this.strokeWidth},t||{});const e=this.exactBoundingBox?this._projectStrokeOnPoints(t).map((l=>l.projectedPoint)):this.points;if(e.length===0)return{left:0,top:0,width:0,height:0,pathOffset:new O,strokeOffset:new O,strokeDiff:new O};const i=at(e),r=cr(E(E({},t),{},{scaleX:1,scaleY:1})),s=at(this.points.map((l=>Pe(l,r,!0)))),n=new O(this.scaleX,this.scaleY);let o=i.left+i.width/2,a=i.top+i.height/2;return this.exactBoundingBox&&(o-=a*Math.tan(pe(this.skewX)),a-=o*Math.tan(pe(this.skewY))),E(E({},i),{},{pathOffset:new O(o,a),strokeOffset:new O(s.left,s.top).subtract(new O(i.left,i.top)).multiply(n),strokeDiff:new O(i.width,i.height).subtract(new O(s.width,s.height)).multiply(n)})}_findCenterFromElement(){const t=at(this.points);return new O(t.left+t.width/2,t.top+t.height/2)}setDimensions(){this.setBoundingBox()}setBoundingBox(t){const{left:e,top:i,width:r,height:s,pathOffset:n,strokeOffset:o,strokeDiff:a}=this._calcDimensions();this.set({width:r,height:s,pathOffset:n,strokeOffset:o,strokeDiff:a}),t&&this.setPositionByOrigin(new O(e+r/2,i+s/2),ee,ee)}isStrokeAccountedForInDimensions(){return this.exactBoundingBox}_getNonTransformedDimensions(){return this.exactBoundingBox?new O(this.width,this.height):super._getNonTransformedDimensions()}_getTransformedDimensions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this.exactBoundingBox){let n;if(Object.keys(t).some((o=>this.strokeUniform||this.constructor.layoutProperties.includes(o)))){var e,i;const{width:o,height:a}=this._calcDimensions(t);n=new O((e=t.width)!==null&&e!==void 0?e:o,(i=t.height)!==null&&i!==void 0?i:a)}else{var r,s;n=new O((r=t.width)!==null&&r!==void 0?r:this.width,(s=t.height)!==null&&s!==void 0?s:this.height)}return n.multiply(new O(t.scaleX||this.scaleX,t.scaleY||this.scaleY))}return super._getTransformedDimensions(t)}_set(t,e){const i=this.initialized&&this[t]!==e,r=super._set(t,e);return this.exactBoundingBox&&i&&((t===Me||t===Ne)&&this.strokeUniform&&this.constructor.layoutProperties.includes("strokeUniform")||this.constructor.layoutProperties.includes(t))&&this.setDimensions(),r}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return E(E({},super.toObject(t)),{},{points:this.points.map((e=>{let{x:i,y:r}=e;return{x:i,y:r}}))})}_toSVG(){const t=[],e=this.pathOffset.x,i=this.pathOffset.y,r=re.NUM_FRACTION_DIGITS;for(let s=0,n=this.points.length;s<n;s++)t.push(he(this.points[s].x-e,r),",",he(this.points[s].y-i,r)," ");return["<".concat(this.constructor.type.toLowerCase()," "),"COMMON_PARTS",'points="'.concat(t.join(""),`" />
`)]}_render(t){const e=this.points.length,i=this.pathOffset.x,r=this.pathOffset.y;if(e&&!isNaN(this.points[e-1].y)){t.beginPath(),t.moveTo(this.points[0].x-i,this.points[0].y-r);for(let s=0;s<e;s++){const n=this.points[s];t.lineTo(n.x-i,n.y-r)}!this.isOpen()&&t.closePath(),this._renderPaintInOrder(t)}}complexity(){return this.points.length}static async fromElement(t,e,i){return new this(Ol(t.getAttribute("points")),E(E({},ue(ft(t,this.ATTRIBUTE_NAMES,i),Rl)),e))}static fromObject(t){return this._fromObject(t,{extraParam:"points"})}}b(Ge,"ownDefaults",$n),b(Ge,"type","Polyline"),b(Ge,"layoutProperties",[Xt,Yt,"strokeLineCap","strokeLineJoin","strokeMiterLimit","strokeWidth","strokeUniform","points"]),b(Ge,"cacheProperties",[...gt,"points"]),b(Ge,"ATTRIBUTE_NAMES",[...xt]),N.setClass(Ge),N.setSVGClass(Ge);class _i extends Ge{isOpen(){return!1}}b(_i,"ownDefaults",$n),b(_i,"type","Polygon"),N.setClass(_i),N.setSVGClass(_i);class eo extends Se{isEmptyStyles(t){if(!this.styles||t!==void 0&&!this.styles[t])return!0;const e=t===void 0?this.styles:{line:this.styles[t]};for(const i in e)for(const r in e[i])for(const s in e[i][r])return!1;return!0}styleHas(t,e){if(!this.styles||e!==void 0&&!this.styles[e])return!1;const i=e===void 0?this.styles:{0:this.styles[e]};for(const r in i)for(const s in i[r])if(i[r][s][t]!==void 0)return!0;return!1}cleanStyle(t){if(!this.styles)return!1;const e=this.styles;let i,r,s=0,n=!0,o=0;for(const a in e){i=0;for(const l in e[a]){const h=e[a][l]||{};s++,h[t]!==void 0?(r?h[t]!==r&&(n=!1):r=h[t],h[t]===this[t]&&delete h[t]):n=!1,Object.keys(h).length!==0?i++:delete e[a][l]}i===0&&delete e[a]}for(let a=0;a<this._textLines.length;a++)o+=this._textLines[a].length;n&&s===o&&(this[t]=r,this.removeStyle(t))}removeStyle(t){if(!this.styles)return;const e=this.styles;let i,r,s;for(r in e){for(s in i=e[r],i)delete i[s][t],Object.keys(i[s]).length===0&&delete i[s];Object.keys(i).length===0&&delete e[r]}}_extendStyles(t,e){const{lineIndex:i,charIndex:r}=this.get2DCursorLocation(t);this._getLineStyle(i)||this._setLineStyle(i);const s=Qr(E(E({},this._getStyleDeclaration(i,r)),e),(n=>n!==void 0));this._setStyleDeclaration(i,r,s)}getSelectionStyles(t,e,i){const r=[];for(let s=t;s<(e||t);s++)r.push(this.getStyleAtPosition(s,i));return r}getStyleAtPosition(t,e){const{lineIndex:i,charIndex:r}=this.get2DCursorLocation(t);return e?this.getCompleteStyleDeclaration(i,r):this._getStyleDeclaration(i,r)}setSelectionStyles(t,e,i){for(let r=e;r<(i||e);r++)this._extendStyles(r,t);this._forceClearCache=!0}_getStyleDeclaration(t,e){var i;const r=this.styles&&this.styles[t];return r&&(i=r[e])!==null&&i!==void 0?i:{}}getCompleteStyleDeclaration(t,e){return E(E({},Zt(this,this.constructor._styleProperties)),this._getStyleDeclaration(t,e))}_setStyleDeclaration(t,e,i){this.styles[t][e]=i}_deleteStyleDeclaration(t,e){delete this.styles[t][e]}_getLineStyle(t){return!!this.styles[t]}_setLineStyle(t){this.styles[t]={}}_deleteLineStyle(t){delete this.styles[t]}}b(eo,"_styleProperties",Ao);const Ml=/  +/g,kl=/"/g;function Dr(u,t,e,i,r){return"		".concat((function(s,n){let{left:o,top:a,width:l,height:h}=n,c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:re.NUM_FRACTION_DIGITS;const d=hi(ye,s,!1),[g,p,v,w]=[o,a,l,h].map((x=>he(x,c)));return"<rect ".concat(d,' x="').concat(g,'" y="').concat(p,'" width="').concat(v,'" height="').concat(w,'"></rect>')})(u,{left:t,top:e,width:i,height:r}),`
`)}const Fl=["textAnchor","textDecoration","dx","dy","top","left","fontSize","strokeWidth"];let Or;class Ce extends eo{static getDefaults(){return E(E({},super.getDefaults()),Ce.ownDefaults)}constructor(t,e){super(),b(this,"__charBounds",[]),Object.assign(this,Ce.ownDefaults),this.setOptions(e),this.styles||(this.styles={}),this.text=t,this.initialized=!0,this.path&&this.setPathInfo(),this.initDimensions(),this.setCoords()}setPathInfo(){const t=this.path;t&&(t.segmentsInfo=Gn(t.path))}_splitText(){const t=this._splitTextIntoLines(this.text);return this.textLines=t.lines,this._textLines=t.graphemeLines,this._unwrappedTextLines=t._unwrappedLines,this._text=t.graphemeText,t}initDimensions(){this._splitText(),this._clearCache(),this.dirty=!0,this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.includes(Je)&&this.enlargeSpaces()}enlargeSpaces(){let t,e,i,r,s,n,o;for(let a=0,l=this._textLines.length;a<l;a++)if((this.textAlign===Je||a!==l-1&&!this.isEndOfWrapping(a))&&(r=0,s=this._textLines[a],e=this.getLineWidth(a),e<this.width&&(o=this.textLines[a].match(this._reSpacesAndTabs)))){i=o.length,t=(this.width-e)/i;for(let h=0;h<=s.length;h++)n=this.__charBounds[a][h],this._reSpaceAndTab.test(s[h])?(n.width+=t,n.kernedWidth+=t,n.left+=r,r+=t):n.left+=r}}isEndOfWrapping(t){return t===this._textLines.length-1}missingNewlineOffset(t){return 1}get2DCursorLocation(t,e){const i=e?this._unwrappedTextLines:this._textLines;let r;for(r=0;r<i.length;r++){if(t<=i[r].length)return{lineIndex:r,charIndex:t};t-=i[r].length+this.missingNewlineOffset(r,e)}return{lineIndex:r-1,charIndex:i[r-1].length<t?i[r-1].length:t}}toString(){return"#<Text (".concat(this.complexity(),'): { "text": "').concat(this.text,'", "fontFamily": "').concat(this.fontFamily,'" }>')}_getCacheCanvasDimensions(){const t=super._getCacheCanvasDimensions(),e=this.fontSize;return t.width+=e*t.zoomX,t.height+=e*t.zoomY,t}_render(t){const e=this.path;e&&!e.isNotVisible()&&e._render(t),this._setTextStyles(t),this._renderTextLinesBackground(t),this._renderTextDecoration(t,"underline"),this._renderText(t),this._renderTextDecoration(t,"overline"),this._renderTextDecoration(t,"linethrough")}_renderText(t){this.paintFirst===Re?(this._renderTextStroke(t),this._renderTextFill(t)):(this._renderTextFill(t),this._renderTextStroke(t))}_setTextStyles(t,e,i){if(t.textBaseline="alphabetic",this.path)switch(this.pathAlign){case ee:t.textBaseline="middle";break;case"ascender":t.textBaseline=De;break;case"descender":t.textBaseline=Ar}t.font=this._getFontDeclaration(e,i)}calcTextWidth(){let t=this.getLineWidth(0);for(let e=1,i=this._textLines.length;e<i;e++){const r=this.getLineWidth(e);r>t&&(t=r)}return t}_renderTextLine(t,e,i,r,s,n){this._renderChars(t,e,i,r,s,n)}_renderTextLinesBackground(t){if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))return;const e=t.fillStyle,i=this._getLeftOffset();let r=this._getTopOffset();for(let s=0,n=this._textLines.length;s<n;s++){const o=this.getHeightOfLine(s);if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",s)){r+=o;continue}const a=this._textLines[s].length,l=this._getLineLeftOffset(s);let h,c,d=0,g=0,p=this.getValueOfPropertyAt(s,0,"textBackgroundColor");for(let v=0;v<a;v++){const w=this.__charBounds[s][v];c=this.getValueOfPropertyAt(s,v,"textBackgroundColor"),this.path?(t.save(),t.translate(w.renderLeft,w.renderTop),t.rotate(w.angle),t.fillStyle=c,c&&t.fillRect(-w.width/2,-o/this.lineHeight*(1-this._fontSizeFraction),w.width,o/this.lineHeight),t.restore()):c!==p?(h=i+l+g,this.direction==="rtl"&&(h=this.width-h-d),t.fillStyle=p,p&&t.fillRect(h,r,d,o/this.lineHeight),g=w.left,d=w.width,p=c):d+=w.kernedWidth}c&&!this.path&&(h=i+l+g,this.direction==="rtl"&&(h=this.width-h-d),t.fillStyle=c,t.fillRect(h,r,d,o/this.lineHeight)),r+=o}t.fillStyle=e,this._removeShadow(t)}_measureChar(t,e,i,r){const s=ii.getFontCache(e),n=this._getFontDeclaration(e),o=i+t,a=i&&n===this._getFontDeclaration(r),l=e.fontSize/this.CACHE_FONT_SIZE;let h,c,d,g;if(i&&s[i]!==void 0&&(d=s[i]),s[t]!==void 0&&(g=h=s[t]),a&&s[o]!==void 0&&(c=s[o],g=c-d),h===void 0||d===void 0||c===void 0){const p=(function(){return Or||(Or=We({width:0,height:0}).getContext("2d")),Or})();this._setTextStyles(p,e,!0),h===void 0&&(g=h=p.measureText(t).width,s[t]=h),d===void 0&&a&&i&&(d=p.measureText(i).width,s[i]=d),a&&c===void 0&&(c=p.measureText(o).width,s[o]=c,g=c-d)}return{width:h*l,kernedWidth:g*l}}getHeightOfChar(t,e){return this.getValueOfPropertyAt(t,e,"fontSize")}measureLine(t){const e=this._measureLine(t);return this.charSpacing!==0&&(e.width-=this._getWidthOfCharSpacing()),e.width<0&&(e.width=0),e}_measureLine(t){let e,i,r=0;const s=this.pathSide===fe,n=this.path,o=this._textLines[t],a=o.length,l=new Array(a);this.__charBounds[t]=l;for(let h=0;h<a;h++){const c=o[h];i=this._getGraphemeBox(c,t,h,e),l[h]=i,r+=i.kernedWidth,e=c}if(l[a]={left:i?i.left+i.width:0,width:0,kernedWidth:0,height:this.fontSize,deltaY:0},n&&n.segmentsInfo){let h=0;const c=n.segmentsInfo[n.segmentsInfo.length-1].length;switch(this.textAlign){case oe:h=s?c-r:0;break;case ee:h=(c-r)/2;break;case fe:h=s?0:c-r}h+=this.pathStartOffset*(s?-1:1);for(let d=s?a-1:0;s?d>=0:d<a;s?d--:d++)i=l[d],h>c?h%=c:h<0&&(h+=c),this._setGraphemeOnPath(h,i),h+=i.kernedWidth}return{width:r,numOfSpaces:0}}_setGraphemeOnPath(t,e){const i=t+e.kernedWidth/2,r=this.path,s=ol(r.path,i,r.segmentsInfo);e.renderLeft=s.x-r.pathOffset.x,e.renderTop=s.y-r.pathOffset.y,e.angle=s.angle+(this.pathSide===fe?Math.PI:0)}_getGraphemeBox(t,e,i,r,s){const n=this.getCompleteStyleDeclaration(e,i),o=r?this.getCompleteStyleDeclaration(e,i-1):{},a=this._measureChar(t,n,r,o);let l,h=a.kernedWidth,c=a.width;this.charSpacing!==0&&(l=this._getWidthOfCharSpacing(),c+=l,h+=l);const d={width:c,left:0,height:n.fontSize,kernedWidth:h,deltaY:n.deltaY};if(i>0&&!s){const g=this.__charBounds[e][i-1];d.left=g.left+g.width+a.kernedWidth-a.width}return d}getHeightOfLine(t){if(this.__lineHeights[t])return this.__lineHeights[t];let e=this.getHeightOfChar(t,0);for(let i=1,r=this._textLines[t].length;i<r;i++)e=Math.max(this.getHeightOfChar(t,i),e);return this.__lineHeights[t]=e*this.lineHeight*this._fontSizeMult}calcTextHeight(){let t,e=0;for(let i=0,r=this._textLines.length;i<r;i++)t=this.getHeightOfLine(i),e+=i===r-1?t/this.lineHeight:t;return e}_getLeftOffset(){return this.direction==="ltr"?-this.width/2:this.width/2}_getTopOffset(){return-this.height/2}_renderTextCommon(t,e){t.save();let i=0;const r=this._getLeftOffset(),s=this._getTopOffset();for(let n=0,o=this._textLines.length;n<o;n++){const a=this.getHeightOfLine(n),l=a/this.lineHeight,h=this._getLineLeftOffset(n);this._renderTextLine(e,t,this._textLines[n],r+h,s+i+l,n),i+=a}t.restore()}_renderTextFill(t){(this.fill||this.styleHas(ye))&&this._renderTextCommon(t,"fillText")}_renderTextStroke(t){(this.stroke&&this.strokeWidth!==0||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this._setLineDash(t,this.strokeDashArray),t.beginPath(),this._renderTextCommon(t,"strokeText"),t.closePath(),t.restore())}_renderChars(t,e,i,r,s,n){const o=this.getHeightOfLine(n),a=this.textAlign.includes(Je),l=this.path,h=!a&&this.charSpacing===0&&this.isEmptyStyles(n)&&!l,c=this.direction==="ltr",d=this.direction==="ltr"?1:-1,g=e.direction;let p,v,w,x,C,P="",k=0;if(e.save(),g!==this.direction&&(e.canvas.setAttribute("dir",c?"ltr":"rtl"),e.direction=c?"ltr":"rtl",e.textAlign=c?oe:fe),s-=o*this._fontSizeFraction/this.lineHeight,h)return this._renderChar(t,e,n,0,i.join(""),r,s),void e.restore();for(let R=0,A=i.length-1;R<=A;R++)x=R===A||this.charSpacing||l,P+=i[R],w=this.__charBounds[n][R],k===0?(r+=d*(w.kernedWidth-w.width),k+=w.width):k+=w.kernedWidth,a&&!x&&this._reSpaceAndTab.test(i[R])&&(x=!0),x||(p=p||this.getCompleteStyleDeclaration(n,R),v=this.getCompleteStyleDeclaration(n,R+1),x=os(p,v,!1)),x&&(l?(e.save(),e.translate(w.renderLeft,w.renderTop),e.rotate(w.angle),this._renderChar(t,e,n,R,P,-k/2,0),e.restore()):(C=r,this._renderChar(t,e,n,R,P,C,s)),P="",p=v,r+=d*k,k=0);e.restore()}_applyPatternGradientTransformText(t){const e=this.width+this.strokeWidth,i=this.height+this.strokeWidth,r=We({width:e,height:i}),s=r.getContext("2d");return r.width=e,r.height=i,s.beginPath(),s.moveTo(0,0),s.lineTo(e,0),s.lineTo(e,i),s.lineTo(0,i),s.closePath(),s.translate(e/2,i/2),s.fillStyle=t.toLive(s),this._applyPatternGradientTransform(s,t),s.fill(),s.createPattern(r,"no-repeat")}handleFiller(t,e,i){let r,s;return ze(i)?i.gradientUnits==="percentage"||i.gradientTransform||i.patternTransform?(r=-this.width/2,s=-this.height/2,t.translate(r,s),t[e]=this._applyPatternGradientTransformText(i),{offsetX:r,offsetY:s}):(t[e]=i.toLive(t),this._applyPatternGradientTransform(t,i)):(t[e]=i,{offsetX:0,offsetY:0})}_setStrokeStyles(t,e){let{stroke:i,strokeWidth:r}=e;return t.lineWidth=r,t.lineCap=this.strokeLineCap,t.lineDashOffset=this.strokeDashOffset,t.lineJoin=this.strokeLineJoin,t.miterLimit=this.strokeMiterLimit,this.handleFiller(t,"strokeStyle",i)}_setFillStyles(t,e){let{fill:i}=e;return this.handleFiller(t,"fillStyle",i)}_renderChar(t,e,i,r,s,n,o){const a=this._getStyleDeclaration(i,r),l=this.getCompleteStyleDeclaration(i,r),h=t==="fillText"&&l.fill,c=t==="strokeText"&&l.stroke&&l.strokeWidth;if(c||h){if(e.save(),e.font=this._getFontDeclaration(l),a.textBackgroundColor&&this._removeShadow(e),a.deltaY&&(o+=a.deltaY),h){const d=this._setFillStyles(e,l);e.fillText(s,n-d.offsetX,o-d.offsetY)}if(c){const d=this._setStrokeStyles(e,l);e.strokeText(s,n-d.offsetX,o-d.offsetY)}e.restore()}}setSuperscript(t,e){this._setScript(t,e,this.superscript)}setSubscript(t,e){this._setScript(t,e,this.subscript)}_setScript(t,e,i){const r=this.get2DCursorLocation(t,!0),s=this.getValueOfPropertyAt(r.lineIndex,r.charIndex,"fontSize"),n=this.getValueOfPropertyAt(r.lineIndex,r.charIndex,"deltaY"),o={fontSize:s*i.size,deltaY:n+s*i.baseline};this.setSelectionStyles(o,t,e)}_getLineLeftOffset(t){const e=this.getLineWidth(t),i=this.width-e,r=this.textAlign,s=this.direction,n=this.isEndOfWrapping(t);let o=0;return r===Je||r===si&&!n||r===ri&&!n||r===ir&&!n?0:(r===ee&&(o=i/2),r===fe&&(o=i),r===si&&(o=i/2),r===ri&&(o=i),s==="rtl"&&(r===fe||r===Je||r===ri?o=0:r===oe||r===ir?o=-i:r!==ee&&r!==si||(o=-i/2)),o)}_clearCache(){this._forceClearCache=!1,this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]}getLineWidth(t){if(this.__lineWidths[t]!==void 0)return this.__lineWidths[t];const{width:e}=this.measureLine(t);return this.__lineWidths[t]=e,e}_getWidthOfCharSpacing(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0}getValueOfPropertyAt(t,e,i){var r;return(r=this._getStyleDeclaration(t,e)[i])!==null&&r!==void 0?r:this[i]}_renderTextDecoration(t,e){if(!this[e]&&!this.styleHas(e))return;let i=this._getTopOffset();const r=this._getLeftOffset(),s=this.path,n=this._getWidthOfCharSpacing(),o=e==="linethrough"?.5:e==="overline"?1:0,a=this.offsets[e];for(let l=0,h=this._textLines.length;l<h;l++){const c=this.getHeightOfLine(l);if(!this[e]&&!this.styleHas(e,l)){i+=c;continue}const d=this._textLines[l],g=c/this.lineHeight,p=this._getLineLeftOffset(l);let v=0,w=0,x=this.getValueOfPropertyAt(l,0,e),C=this.getValueOfPropertyAt(l,0,ye),P=this.getValueOfPropertyAt(l,0,Rt),k=x,R=C,A=P;const j=i+g*(1-this._fontSizeFraction);let I=this.getHeightOfChar(l,0),W=this.getValueOfPropertyAt(l,0,"deltaY");for(let z=0,V=d.length;z<V;z++){const Y=this.__charBounds[l][z];k=this.getValueOfPropertyAt(l,z,e),R=this.getValueOfPropertyAt(l,z,ye),A=this.getValueOfPropertyAt(l,z,Rt);const ie=this.getHeightOfChar(l,z),te=this.getValueOfPropertyAt(l,z,"deltaY");if(s&&k&&R){const se=this.fontSize*A/1e3;t.save(),t.fillStyle=C,t.translate(Y.renderLeft,Y.renderTop),t.rotate(Y.angle),t.fillRect(-Y.kernedWidth/2,a*ie+te-o*se,Y.kernedWidth,se),t.restore()}else if((k!==x||R!==C||ie!==I||A!==P||te!==W)&&w>0){const se=this.fontSize*P/1e3;let Q=r+p+v;this.direction==="rtl"&&(Q=this.width-Q-w),x&&C&&P&&(t.fillStyle=C,t.fillRect(Q,j+a*I+W-o*se,w,se)),v=Y.left,w=Y.width,x=k,P=A,C=R,I=ie,W=te}else w+=Y.kernedWidth}let $=r+p+v;this.direction==="rtl"&&($=this.width-$-w),t.fillStyle=R;const Z=this.fontSize*A/1e3;k&&R&&A&&t.fillRect($,j+a*I+W-o*Z,w-n,Z),i+=c}this._removeShadow(t)}_getFontDeclaration(){let{fontFamily:t=this.fontFamily,fontStyle:e=this.fontStyle,fontWeight:i=this.fontWeight,fontSize:r=this.fontSize}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},s=arguments.length>1?arguments[1]:void 0;const n=t.includes("'")||t.includes('"')||t.includes(",")||Ce.genericFonts.includes(t.toLowerCase())?t:'"'.concat(t,'"');return[e,i,"".concat(s?this.CACHE_FONT_SIZE:r,"px"),n].join(" ")}render(t){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._forceClearCache&&this.initDimensions(),super.render(t)))}graphemeSplit(t){return ns(t)}_splitTextIntoLines(t){const e=t.split(this._reNewline),i=new Array(e.length),r=[`
`];let s=[];for(let n=0;n<e.length;n++)i[n]=this.graphemeSplit(e[n]),s=s.concat(i[n],r);return s.pop(),{_unwrappedLines:i,lines:e,graphemeText:s,graphemeLines:i}}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return E(E({},super.toObject([...Pn,...t])),{},{styles:Ta(this.styles,this.text)},this.path?{path:this.path.toObject()}:{})}set(t,e){const{textLayoutProperties:i}=this.constructor;super.set(t,e);let r=!1,s=!1;if(typeof t=="object")for(const n in t)n==="path"&&this.setPathInfo(),r=r||i.includes(n),s=s||n==="path";else r=i.includes(t),s=t==="path";return s&&this.setPathInfo(),r&&this.initialized&&(this.initDimensions(),this.setCoords()),this}complexity(){return 1}static async fromElement(t,e,i){const r=ft(t,Ce.ATTRIBUTE_NAMES,i),s=E(E({},e),r),{textAnchor:n=oe,textDecoration:o="",dx:a=0,dy:l=0,top:h=0,left:c=0,fontSize:d=Xr,strokeWidth:g=1}=s,p=ue(s,Fl),v=new this((t.textContent||"").replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," "),E({left:c+a,top:h+l,underline:o.includes("underline"),overline:o.includes("overline"),linethrough:o.includes("line-through"),strokeWidth:0,fontSize:d},p)),w=v.getScaledHeight()/v.height,x=((v.height+v.strokeWidth)*v.lineHeight-v.height)*w,C=v.getScaledHeight()+x;let P=0;return n===ee&&(P=v.getScaledWidth()/2),n===fe&&(P=v.getScaledWidth()),v.set({left:v.left-P,top:v.top-(C-v.fontSize*(.07+v._fontSizeFraction))/v.lineHeight,strokeWidth:g}),v}static fromObject(t){return this._fromObject(E(E({},t),{},{styles:Sa(t.styles||{},t.text)}),{extraParam:"text"})}}b(Ce,"textLayoutProperties",En),b(Ce,"cacheProperties",[...gt,...Pn]),b(Ce,"ownDefaults",Lo),b(Ce,"type","Text"),b(Ce,"genericFonts",["serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),b(Ce,"ATTRIBUTE_NAMES",xt.concat("x","y","dx","dy","font-family","font-style","font-weight","font-size","letter-spacing","text-decoration","text-anchor")),Bn(Ce,[class extends Sn{_toSVG(){const u=this._getSVGLeftTopOffsets(),t=this._getSVGTextAndBg(u.textTop,u.textLeft);return this._wrapSVGTextAndBg(t)}toSVG(u){const t=this._createBaseSVGMarkup(this._toSVG(),{reviver:u,noStyle:!0,withShadow:!0}),e=this.path;return e?t+e._createBaseSVGMarkup(e._toSVG(),{reviver:u,withShadow:!0,additionalTransform:li(this.calcOwnMatrix())}):t}_getSVGLeftTopOffsets(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}}_wrapSVGTextAndBg(u){let{textBgRects:t,textSpans:e}=u;const i=this.getSvgTextDecoration(this);return[t.join(""),'		<text xml:space="preserve" ','font-family="'.concat(this.fontFamily.replace(kl,"'"),'" '),'font-size="'.concat(this.fontSize,'" '),this.fontStyle?'font-style="'.concat(this.fontStyle,'" '):"",this.fontWeight?'font-weight="'.concat(this.fontWeight,'" '):"",i?'text-decoration="'.concat(i,'" '):"",this.direction==="rtl"?'direction="'.concat(this.direction,'" '):"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",e.join(""),`</text>
`]}_getSVGTextAndBg(u,t){const e=[],i=[];let r,s=u;this.backgroundColor&&i.push(...Dr(this.backgroundColor,-this.width/2,-this.height/2,this.width,this.height));for(let n=0,o=this._textLines.length;n<o;n++)r=this._getLineLeftOffset(n),this.direction==="rtl"&&(r+=this.width),(this.textBackgroundColor||this.styleHas("textBackgroundColor",n))&&this._setSVGTextLineBg(i,n,t+r,s),this._setSVGTextLineText(e,n,t+r,s),s+=this.getHeightOfLine(n);return{textSpans:e,textBgRects:i}}_createTextCharSpan(u,t,e,i,r){const s=re.NUM_FRACTION_DIGITS,n=this.getSvgSpanStyles(t,u!==u.trim()||!!u.match(Ml)),o=n?'style="'.concat(n,'"'):"",a=t.deltaY,l=a?' dy="'.concat(he(a,s),'" '):"",{angle:h,renderLeft:c,renderTop:d,width:g}=r;let p="";if(c!==void 0){const v=g/2;h&&(p=' rotate="'.concat(he(dt(h),s),'"'));const w=qt({angle:dt(h)});w[4]=c,w[5]=d;const x=new O(-v,0).transform(w);e=x.x,i=x.y}return'<tspan x="'.concat(he(e,s),'" y="').concat(he(i,s),'" ').concat(l).concat(p).concat(o,">").concat(wa(u),"</tspan>")}_setSVGTextLineText(u,t,e,i){const r=this.getHeightOfLine(t),s=this.textAlign.includes(Je),n=this._textLines[t];let o,a,l,h,c,d="",g=0;i+=r*(1-this._fontSizeFraction)/this.lineHeight;for(let p=0,v=n.length-1;p<=v;p++)c=p===v||this.charSpacing||this.path,d+=n[p],l=this.__charBounds[t][p],g===0?(e+=l.kernedWidth-l.width,g+=l.width):g+=l.kernedWidth,s&&!c&&this._reSpaceAndTab.test(n[p])&&(c=!0),c||(o=o||this.getCompleteStyleDeclaration(t,p),a=this.getCompleteStyleDeclaration(t,p+1),c=os(o,a,!0)),c&&(h=this._getStyleDeclaration(t,p),u.push(this._createTextCharSpan(d,h,e,i,l)),d="",o=a,this.direction==="rtl"?e-=g:e+=g,g=0)}_setSVGTextLineBg(u,t,e,i){const r=this._textLines[t],s=this.getHeightOfLine(t)/this.lineHeight;let n,o=0,a=0,l=this.getValueOfPropertyAt(t,0,"textBackgroundColor");for(let h=0;h<r.length;h++){const{left:c,width:d,kernedWidth:g}=this.__charBounds[t][h];n=this.getValueOfPropertyAt(t,h,"textBackgroundColor"),n!==l?(l&&u.push(...Dr(l,e+a,i,o,s)),a=c,o=d,l=n):o+=g}n&&u.push(...Dr(l,e+a,i,o,s))}_getSVGLineTopOffset(u){let t,e=0;for(t=0;t<u;t++)e+=this.getHeightOfLine(t);const i=this.getHeightOfLine(t);return{lineTop:e,offset:(this._fontSizeMult-this._fontSizeFraction)*i/(this.lineHeight*this._fontSizeMult)}}getSvgStyles(u){return"".concat(super.getSvgStyles(u)," text-decoration-thickness: ").concat(he(this.textDecorationThickness*this.getObjectScaling().y/10,re.NUM_FRACTION_DIGITS),"%; white-space: pre;")}getSvgSpanStyles(u,t){const{fontFamily:e,strokeWidth:i,stroke:r,fill:s,fontSize:n,fontStyle:o,fontWeight:a,deltaY:l,textDecorationThickness:h,linethrough:c,overline:d,underline:g}=u,p=this.getSvgTextDecoration({underline:g??this.underline,overline:d??this.overline,linethrough:c??this.linethrough}),v=h||this.textDecorationThickness;return[r?hi(Re,r):"",i?"stroke-width: ".concat(i,"; "):"",e?"font-family: ".concat(e.includes("'")||e.includes('"')?e:"'".concat(e,"'"),"; "):"",n?"font-size: ".concat(n,"px; "):"",o?"font-style: ".concat(o,"; "):"",a?"font-weight: ".concat(a,"; "):"",p?"text-decoration: ".concat(p,"; text-decoration-thickness: ").concat(he(v*this.getObjectScaling().y/10,re.NUM_FRACTION_DIGITS),"%; "):"",s?hi(ye,s):"",l?"baseline-shift: ".concat(-l,"; "):"",t?"white-space: pre; ":""].join("")}getSvgTextDecoration(u){return["overline","underline","line-through"].filter((t=>u[t.replace("-","")])).join(" ")}}]),N.setClass(Ce),N.setSVGClass(Ce);class Al{constructor(t){b(this,"target",void 0),b(this,"__mouseDownInPlace",!1),b(this,"__dragStartFired",!1),b(this,"__isDraggingOver",!1),b(this,"__dragStartSelection",void 0),b(this,"__dragImageDisposer",void 0),b(this,"_dispose",void 0),this.target=t;const e=[this.target.on("dragenter",this.dragEnterHandler.bind(this)),this.target.on("dragover",this.dragOverHandler.bind(this)),this.target.on("dragleave",this.dragLeaveHandler.bind(this)),this.target.on("dragend",this.dragEndHandler.bind(this)),this.target.on("drop",this.dropHandler.bind(this))];this._dispose=()=>{e.forEach((i=>i())),this._dispose=void 0}}isPointerOverSelection(t){const e=this.target,i=e.getSelectionStartFromPointer(t);return e.isEditing&&i>=e.selectionStart&&i<=e.selectionEnd&&e.selectionStart<e.selectionEnd}start(t){return this.__mouseDownInPlace=this.isPointerOverSelection(t)}isActive(){return this.__mouseDownInPlace}end(t){const e=this.isActive();return e&&!this.__dragStartFired&&(this.target.setCursorByClick(t),this.target.initDelayedCursor(!0)),this.__mouseDownInPlace=!1,this.__dragStartFired=!1,this.__isDraggingOver=!1,e}getDragStartSelection(){return this.__dragStartSelection}setDragImage(t,e){var i;let{selectionStart:r,selectionEnd:s}=e;const n=this.target,o=n.canvas,a=new O(n.flipX?-1:1,n.flipY?-1:1),l=n._getCursorBoundaries(r),h=new O(l.left+l.leftOffset,l.top+l.topOffset).multiply(a).transform(n.calcTransformMatrix()),c=o.getScenePoint(t).subtract(h),d=n.getCanvasRetinaScaling(),g=n.getBoundingRect(),p=h.subtract(new O(g.left,g.top)),v=o.viewportTransform,w=p.add(c).transform(v,!0),x=n.backgroundColor,C=ss(n.styles);n.backgroundColor="";const P={stroke:"transparent",fill:"transparent",textBackgroundColor:"transparent"};n.setSelectionStyles(P,0,r),n.setSelectionStyles(P,s,n.text.length),n.dirty=!0;const k=n.toCanvasElement({enableRetinaScaling:o.enableRetinaScaling,viewportTransform:!0});n.backgroundColor=x,n.styles=C,n.dirty=!0,Ur(k,{position:"fixed",left:"".concat(-k.width,"px"),border:Oe,width:"".concat(k.width/d,"px"),height:"".concat(k.height/d,"px")}),this.__dragImageDisposer&&this.__dragImageDisposer(),this.__dragImageDisposer=()=>{k.remove()},Ye(t.target||this.target.hiddenTextarea).body.appendChild(k),(i=t.dataTransfer)===null||i===void 0||i.setDragImage(k,w.x,w.y)}onDragStart(t){this.__dragStartFired=!0;const e=this.target,i=this.isActive();if(i&&t.dataTransfer){const r=this.__dragStartSelection={selectionStart:e.selectionStart,selectionEnd:e.selectionEnd},s=e._text.slice(r.selectionStart,r.selectionEnd).join(""),n=E({text:e.text,value:s},r);t.dataTransfer.setData("text/plain",s),t.dataTransfer.setData("application/fabric",JSON.stringify({value:s,styles:e.getSelectionStyles(r.selectionStart,r.selectionEnd,!0)})),t.dataTransfer.effectAllowed="copyMove",this.setDragImage(t,n)}return e.abortCursorAnimation(),i}canDrop(t){if(this.target.editable&&!this.target.getActiveControl()&&!t.defaultPrevented){if(this.isActive()&&this.__dragStartSelection){const e=this.target.getSelectionStartFromPointer(t),i=this.__dragStartSelection;return e<i.selectionStart||e>i.selectionEnd}return!0}return!1}targetCanDrop(t){return this.target.canDrop(t)}dragEnterHandler(t){let{e}=t;const i=this.targetCanDrop(e);!this.__isDraggingOver&&i&&(this.__isDraggingOver=!0)}dragOverHandler(t){const{e}=t,i=this.targetCanDrop(e);!this.__isDraggingOver&&i?this.__isDraggingOver=!0:this.__isDraggingOver&&!i&&(this.__isDraggingOver=!1),this.__isDraggingOver&&(e.preventDefault(),t.canDrop=!0,t.dropTarget=this.target)}dragLeaveHandler(){(this.__isDraggingOver||this.isActive())&&(this.__isDraggingOver=!1)}dropHandler(t){var e;const{e:i}=t,r=i.defaultPrevented;this.__isDraggingOver=!1,i.preventDefault();let s=(e=i.dataTransfer)===null||e===void 0?void 0:e.getData("text/plain");if(s&&!r){const n=this.target,o=n.canvas;let a=n.getSelectionStartFromPointer(i);const{styles:l}=i.dataTransfer.types.includes("application/fabric")?JSON.parse(i.dataTransfer.getData("application/fabric")):{},h=s[Math.max(0,s.length-1)],c=0;if(this.__dragStartSelection){const d=this.__dragStartSelection.selectionStart,g=this.__dragStartSelection.selectionEnd;a>d&&a<=g?a=d:a>g&&(a-=g-d),n.removeChars(d,g),delete this.__dragStartSelection}n._reNewline.test(h)&&(n._reNewline.test(n._text[a])||a===n._text.length)&&(s=s.trimEnd()),t.didDrop=!0,t.dropTarget=n,n.insertChars(s,l,a),o.setActiveObject(n),n.enterEditing(i),n.selectionStart=Math.min(a+c,n._text.length),n.selectionEnd=Math.min(n.selectionStart+s.length,n._text.length),n.hiddenTextarea.value=n.text,n._updateTextarea(),n.hiddenTextarea.focus(),n.fire(Ki,{index:a+c,action:"drop"}),o.fire("text:changed",{target:n}),o.contextTopDirty=!0,o.requestRenderAll()}}dragEndHandler(t){let{e}=t;if(this.isActive()&&this.__dragStartFired&&this.__dragStartSelection){var i;const r=this.target,s=this.target.canvas,{selectionStart:n,selectionEnd:o}=this.__dragStartSelection,a=((i=e.dataTransfer)===null||i===void 0?void 0:i.dropEffect)||Oe;a===Oe?(r.selectionStart=n,r.selectionEnd=o,r._updateTextarea(),r.hiddenTextarea.focus()):(r.clearContextTop(),a==="move"&&(r.removeChars(n,o),r.selectionStart=r.selectionEnd=n,r.hiddenTextarea&&(r.hiddenTextarea.value=r.text),r._updateTextarea(),r.fire(Ki,{index:n,action:"dragend"}),s.fire("text:changed",{target:r}),s.requestRenderAll()),r.exitEditing())}this.__dragImageDisposer&&this.__dragImageDisposer(),delete this.__dragImageDisposer,delete this.__dragStartSelection,this.__isDraggingOver=!1}dispose(){this._dispose&&this._dispose()}}const Zs=/[ \n\.,;!\?\-]/;class Ll extends Ce{constructor(){super(...arguments),b(this,"_currentCursorOpacity",1)}initBehavior(){this._tick=this._tick.bind(this),this._onTickComplete=this._onTickComplete.bind(this),this.updateSelectionOnMouseMove=this.updateSelectionOnMouseMove.bind(this)}onDeselect(t){return this.isEditing&&this.exitEditing(),this.selected=!1,super.onDeselect(t)}_animateCursor(t){let{toValue:e,duration:i,delay:r,onComplete:s}=t;return Mn({startValue:this._currentCursorOpacity,endValue:e,duration:i,delay:r,onComplete:s,abort:()=>!this.canvas||this.selectionStart!==this.selectionEnd,onChange:n=>{this._currentCursorOpacity=n,this.renderCursorOrSelection()}})}_tick(t){this._currentTickState=this._animateCursor({toValue:0,duration:this.cursorDuration/2,delay:Math.max(t||0,100),onComplete:this._onTickComplete})}_onTickComplete(){var t;(t=this._currentTickCompleteState)===null||t===void 0||t.abort(),this._currentTickCompleteState=this._animateCursor({toValue:1,duration:this.cursorDuration,onComplete:this._tick})}initDelayedCursor(t){this.abortCursorAnimation(),this._tick(t?0:this.cursorDelay)}abortCursorAnimation(){let t=!1;[this._currentTickState,this._currentTickCompleteState].forEach((e=>{e&&!e.isDone()&&(t=!0,e.abort())})),this._currentCursorOpacity=1,t&&this.clearContextTop()}restartCursorIfNeeded(){[this._currentTickState,this._currentTickCompleteState].some((t=>!t||t.isDone()))&&this.initDelayedCursor()}selectAll(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this}cmdAll(){this.selectAll(),this.renderCursorOrSelection()}getSelectedText(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")}findWordBoundaryLeft(t){let e=0,i=t-1;if(this._reSpace.test(this._text[i]))for(;this._reSpace.test(this._text[i]);)e++,i--;for(;/\S/.test(this._text[i])&&i>-1;)e++,i--;return t-e}findWordBoundaryRight(t){let e=0,i=t;if(this._reSpace.test(this._text[i]))for(;this._reSpace.test(this._text[i]);)e++,i++;for(;/\S/.test(this._text[i])&&i<this._text.length;)e++,i++;return t+e}findLineBoundaryLeft(t){let e=0,i=t-1;for(;!/\n/.test(this._text[i])&&i>-1;)e++,i--;return t-e}findLineBoundaryRight(t){let e=0,i=t;for(;!/\n/.test(this._text[i])&&i<this._text.length;)e++,i++;return t+e}searchWordBoundary(t,e){const i=this._text;let r=t>0&&this._reSpace.test(i[t])&&(e===-1||!Yr.test(i[t-1]))?t-1:t,s=i[r];for(;r>0&&r<i.length&&!Zs.test(s);)r+=e,s=i[r];return e===-1&&Zs.test(s)&&r++,r}selectWord(t){var e;t=(e=t)!==null&&e!==void 0?e:this.selectionStart;const i=this.searchWordBoundary(t,-1),r=Math.max(i,this.searchWordBoundary(t,1));this.selectionStart=i,this.selectionEnd=r,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()}selectLine(t){var e;t=(e=t)!==null&&e!==void 0?e:this.selectionStart;const i=this.findLineBoundaryLeft(t),r=this.findLineBoundaryRight(t);this.selectionStart=i,this.selectionEnd=r,this._fireSelectionChanged(),this._updateTextarea()}enterEditing(t){!this.isEditing&&this.editable&&(this.enterEditingImpl(),this.fire("editing:entered",t?{e:t}:void 0),this._fireSelectionChanged(),this.canvas&&(this.canvas.fire("text:editing:entered",{target:this,e:t}),this.canvas.requestRenderAll()))}enterEditingImpl(){this.canvas&&(this.canvas.calcOffset(),this.canvas.textEditingManager.exitTextEditing()),this.isEditing=!0,this.initHiddenTextarea(),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick()}updateSelectionOnMouseMove(t){if(this.getActiveControl())return;const e=this.hiddenTextarea;Ye(e).activeElement!==e&&e.focus();const i=this.getSelectionStartFromPointer(t),r=this.selectionStart,s=this.selectionEnd;(i===this.__selectionStartOnMouseDown&&r!==s||r!==i&&s!==i)&&(i>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=i):(this.selectionStart=i,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===r&&this.selectionEnd===s||(this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}_setEditingProps(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0}fromStringToGraphemeSelection(t,e,i){const r=i.slice(0,t),s=this.graphemeSplit(r).length;if(t===e)return{selectionStart:s,selectionEnd:s};const n=i.slice(t,e);return{selectionStart:s,selectionEnd:s+this.graphemeSplit(n).length}}fromGraphemeToStringSelection(t,e,i){const r=i.slice(0,t).join("").length;return t===e?{selectionStart:r,selectionEnd:r}:{selectionStart:r,selectionEnd:r+i.slice(t,e).join("").length}}_updateTextarea(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){const t=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=t.selectionStart,this.hiddenTextarea.selectionEnd=t.selectionEnd}this.updateTextareaPosition()}}updateFromTextArea(){if(!this.hiddenTextarea)return;this.cursorOffsetCache={};const t=this.hiddenTextarea;this.text=t.value,this.set("dirty",!0),this.initDimensions(),this.setCoords();const e=this.fromStringToGraphemeSelection(t.selectionStart,t.selectionEnd,t.value);this.selectionEnd=this.selectionStart=e.selectionEnd,this.inCompositionMode||(this.selectionStart=e.selectionStart),this.updateTextareaPosition()}updateTextareaPosition(){if(this.selectionStart===this.selectionEnd){const t=this._calcTextareaPosition();this.hiddenTextarea.style.left=t.left,this.hiddenTextarea.style.top=t.top}}_calcTextareaPosition(){if(!this.canvas)return{left:"1px",top:"1px"};const t=this.inCompositionMode?this.compositionStart:this.selectionStart,e=this._getCursorBoundaries(t),i=this.get2DCursorLocation(t),r=i.lineIndex,s=i.charIndex,n=this.getValueOfPropertyAt(r,s,"fontSize")*this.lineHeight,o=e.leftOffset,a=this.getCanvasRetinaScaling(),l=this.canvas.upperCanvasEl,h=l.width/a,c=l.height/a,d=h-n,g=c-n,p=new O(e.left+o,e.top+e.topOffset+n).transform(this.calcTransformMatrix()).transform(this.canvas.viewportTransform).multiply(new O(l.clientWidth/h,l.clientHeight/c));return p.x<0&&(p.x=0),p.x>d&&(p.x=d),p.y<0&&(p.y=0),p.y>g&&(p.y=g),p.x+=this.canvas._offset.left,p.y+=this.canvas._offset.top,{left:"".concat(p.x,"px"),top:"".concat(p.y,"px"),fontSize:"".concat(n,"px"),charHeight:n}}_saveEditingProps(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}}_restoreEditingProps(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor||this.canvas.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor||this.canvas.moveCursor),delete this._savedProps)}_exitEditing(){const t=this.hiddenTextarea;this.selected=!1,this.isEditing=!1,t&&(t.blur&&t.blur(),t.parentNode&&t.parentNode.removeChild(t)),this.hiddenTextarea=null,this.abortCursorAnimation(),this.selectionStart!==this.selectionEnd&&this.clearContextTop()}exitEditingImpl(){this._exitEditing(),this.selectionEnd=this.selectionStart,this._restoreEditingProps(),this._forceClearCache&&(this.initDimensions(),this.setCoords())}exitEditing(){const t=this._textBeforeEdit!==this.text;return this.exitEditingImpl(),this.fire("editing:exited"),t&&this.fire(Ji),this.canvas&&(this.canvas.fire("text:editing:exited",{target:this}),t&&this.canvas.fire("object:modified",{target:this})),this}_removeExtraneousStyles(){for(const t in this.styles)this._textLines[t]||delete this.styles[t]}removeStyleFromTo(t,e){const{lineIndex:i,charIndex:r}=this.get2DCursorLocation(t,!0),{lineIndex:s,charIndex:n}=this.get2DCursorLocation(e,!0);if(i!==s){if(this.styles[i])for(let o=r;o<this._unwrappedTextLines[i].length;o++)delete this.styles[i][o];if(this.styles[s])for(let o=n;o<this._unwrappedTextLines[s].length;o++){const a=this.styles[s][o];a&&(this.styles[i]||(this.styles[i]={}),this.styles[i][r+o-n]=a)}for(let o=i+1;o<=s;o++)delete this.styles[o];this.shiftLineStyles(s,i-s)}else if(this.styles[i]){const o=this.styles[i],a=n-r;for(let l=r;l<n;l++)delete o[l];for(const l in this.styles[i]){const h=parseInt(l,10);h>=n&&(o[h-a]=o[l],delete o[l])}}}shiftLineStyles(t,e){const i=Object.assign({},this.styles);for(const r in this.styles){const s=parseInt(r,10);s>t&&(this.styles[s+e]=i[s],i[s-e]||delete this.styles[s])}}insertNewlineStyleObject(t,e,i,r){const s={},n=this._unwrappedTextLines[t].length,o=n===e;let a=!1;i||(i=1),this.shiftLineStyles(t,i);const l=this.styles[t]?this.styles[t][e===0?e:e-1]:void 0;for(const c in this.styles[t]){const d=parseInt(c,10);d>=e&&(a=!0,s[d-e]=this.styles[t][c],o&&e===0||delete this.styles[t][c])}let h=!1;for(a&&!o&&(this.styles[t+i]=s,h=!0),(h||n>e)&&i--;i>0;)r&&r[i-1]?this.styles[t+i]={0:E({},r[i-1])}:l?this.styles[t+i]={0:E({},l)}:delete this.styles[t+i],i--;this._forceClearCache=!0}insertCharStyleObject(t,e,i,r){this.styles||(this.styles={});const s=this.styles[t],n=s?E({},s):{};i||(i=1);for(const a in n){const l=parseInt(a,10);l>=e&&(s[l+i]=n[l],n[l-i]||delete s[l])}if(this._forceClearCache=!0,r){for(;i--;)Object.keys(r[i]).length&&(this.styles[t]||(this.styles[t]={}),this.styles[t][e+i]=E({},r[i]));return}if(!s)return;const o=s[e?e-1:1];for(;o&&i--;)this.styles[t][e+i]=E({},o)}insertNewStyleBlock(t,e,i){const r=this.get2DCursorLocation(e,!0),s=[0];let n,o=0;for(let a=0;a<t.length;a++)t[a]===`
`?(o++,s[o]=0):s[o]++;for(s[0]>0&&(this.insertCharStyleObject(r.lineIndex,r.charIndex,s[0],i),i=i&&i.slice(s[0]+1)),o&&this.insertNewlineStyleObject(r.lineIndex,r.charIndex+s[0],o),n=1;n<o;n++)s[n]>0?this.insertCharStyleObject(r.lineIndex+n,0,s[n],i):i&&this.styles[r.lineIndex+n]&&i[0]&&(this.styles[r.lineIndex+n][0]=i[0]),i=i&&i.slice(s[n]+1);s[n]>0&&this.insertCharStyleObject(r.lineIndex+n,0,s[n],i)}removeChars(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:t+1;this.removeStyleFromTo(t,e),this._text.splice(t,e-t),this.text=this._text.join(""),this.set("dirty",!0),this.initDimensions(),this.setCoords(),this._removeExtraneousStyles()}insertChars(t,e,i){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:i;r>i&&this.removeStyleFromTo(i,r);const s=this.graphemeSplit(t);this.insertNewStyleBlock(s,i,e),this._text=[...this._text.slice(0,i),...s,...this._text.slice(r)],this.text=this._text.join(""),this.set("dirty",!0),this.initDimensions(),this.setCoords(),this._removeExtraneousStyles()}setSelectionStartEndWithShift(t,e,i){i<=t?(e===t?this._selectionDirection=oe:this._selectionDirection===fe&&(this._selectionDirection=oe,this.selectionEnd=t),this.selectionStart=i):i>t&&i<e?this._selectionDirection===fe?this.selectionEnd=i:this.selectionStart=i:(e===t?this._selectionDirection=fe:this._selectionDirection===oe&&(this._selectionDirection=fe,this.selectionStart=e),this.selectionEnd=i)}}class Bl extends Ll{initHiddenTextarea(){const t=this.canvas&&Ye(this.canvas.getElement())||Gt(),e=t.createElement("textarea");Object.entries({autocapitalize:"off",autocorrect:"off",autocomplete:"off",spellcheck:"false","data-fabric":"textarea",wrap:"off"}).map((n=>{let[o,a]=n;return e.setAttribute(o,a)}));const{top:i,left:r,fontSize:s}=this._calcTextareaPosition();e.style.cssText="position: absolute; top: ".concat(i,"; left: ").concat(r,"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding-top: ").concat(s,";"),(this.hiddenTextareaContainer||t.body).appendChild(e),Object.entries({blur:"blur",keydown:"onKeyDown",keyup:"onKeyUp",input:"onInput",copy:"copy",cut:"copy",paste:"paste",compositionstart:"onCompositionStart",compositionupdate:"onCompositionUpdate",compositionend:"onCompositionEnd"}).map((n=>{let[o,a]=n;return e.addEventListener(o,this[a].bind(this))})),this.hiddenTextarea=e}blur(){this.abortCursorAnimation()}onKeyDown(t){if(!this.isEditing)return;const e=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(t.keyCode in e)this[e[t.keyCode]](t);else{if(!(t.keyCode in this.ctrlKeysMapDown)||!t.ctrlKey&&!t.metaKey)return;this[this.ctrlKeysMapDown[t.keyCode]](t)}t.stopImmediatePropagation(),t.preventDefault(),t.keyCode>=33&&t.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}onKeyUp(t){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:t.keyCode in this.ctrlKeysMapUp&&(t.ctrlKey||t.metaKey)&&(this[this.ctrlKeysMapUp[t.keyCode]](t),t.stopImmediatePropagation(),t.preventDefault(),this.canvas&&this.canvas.requestRenderAll())}onInput(t){const e=this.fromPaste,{value:i,selectionStart:r,selectionEnd:s}=this.hiddenTextarea;if(this.fromPaste=!1,t&&t.stopPropagation(),!this.isEditing)return;const n=()=>{this.updateFromTextArea(),this.fire(Ki),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())};if(this.hiddenTextarea.value==="")return this.styles={},void n();const o=this._splitTextIntoLines(i).graphemeText,a=this._text.length,l=o.length,h=this.selectionStart,c=this.selectionEnd,d=h!==c;let g,p,v,w,x=l-a;const C=this.fromStringToGraphemeSelection(r,s,i),P=h>C.selectionStart;d?(p=this._text.slice(h,c),x+=c-h):l<a&&(p=P?this._text.slice(c+x,c):this._text.slice(h,h-x));const k=o.slice(C.selectionEnd-x,C.selectionEnd);if(p&&p.length&&(k.length&&(g=this.getSelectionStyles(h,h+1,!1),g=k.map((()=>g[0]))),d?(v=h,w=c):P?(v=c-p.length,w=c):(v=c,w=c+p.length),this.removeStyleFromTo(v,w)),k.length){const{copyPasteData:R}=$e();e&&k.join("")===R.copiedText&&!re.disableStyleCopyPaste&&(g=R.copiedTextStyle),this.insertNewStyleBlock(k,h,g)}n()}onCompositionStart(){this.inCompositionMode=!0}onCompositionEnd(){this.inCompositionMode=!1}onCompositionUpdate(t){let{target:e}=t;const{selectionStart:i,selectionEnd:r}=e;this.compositionStart=i,this.compositionEnd=r,this.updateTextareaPosition()}copy(){if(this.selectionStart===this.selectionEnd)return;const{copyPasteData:t}=$e();t.copiedText=this.getSelectedText(),re.disableStyleCopyPaste?t.copiedTextStyle=void 0:t.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0}paste(){this.fromPaste=!0}_getWidthBeforeCursor(t,e){let i,r=this._getLineLeftOffset(t);return e>0&&(i=this.__charBounds[t][e-1],r+=i.left+i.width),r}getDownCursorOffset(t,e){const i=this._getSelectionForOffset(t,e),r=this.get2DCursorLocation(i),s=r.lineIndex;if(s===this._textLines.length-1||t.metaKey||t.keyCode===34)return this._text.length-i;const n=r.charIndex,o=this._getWidthBeforeCursor(s,n),a=this._getIndexOnLine(s+1,o);return this._textLines[s].slice(n).length+a+1+this.missingNewlineOffset(s)}_getSelectionForOffset(t,e){return t.shiftKey&&this.selectionStart!==this.selectionEnd&&e?this.selectionEnd:this.selectionStart}getUpCursorOffset(t,e){const i=this._getSelectionForOffset(t,e),r=this.get2DCursorLocation(i),s=r.lineIndex;if(s===0||t.metaKey||t.keyCode===33)return-i;const n=r.charIndex,o=this._getWidthBeforeCursor(s,n),a=this._getIndexOnLine(s-1,o),l=this._textLines[s].slice(0,n),h=this.missingNewlineOffset(s-1);return-this._textLines[s-1].length+a-l.length+(1-h)}_getIndexOnLine(t,e){const i=this._textLines[t];let r,s,n=this._getLineLeftOffset(t),o=0;for(let a=0,l=i.length;a<l;a++)if(r=this.__charBounds[t][a].width,n+=r,n>e){s=!0;const h=n-r,c=n,d=Math.abs(h-e);o=Math.abs(c-e)<d?a:a-1;break}return s||(o=i.length-1),o}moveCursorDown(t){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",t)}moveCursorUp(t){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",t)}_moveCursorUpOrDown(t,e){const i=this["get".concat(t,"CursorOffset")](e,this._selectionDirection===fe);if(e.shiftKey?this.moveCursorWithShift(i):this.moveCursorWithoutShift(i),i!==0){const r=this.text.length;this.selectionStart=Vt(0,this.selectionStart,r),this.selectionEnd=Vt(0,this.selectionEnd,r),this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea()}}moveCursorWithShift(t){const e=this._selectionDirection===oe?this.selectionStart+t:this.selectionEnd+t;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,e),t!==0}moveCursorWithoutShift(t){return t<0?(this.selectionStart+=t,this.selectionEnd=this.selectionStart):(this.selectionEnd+=t,this.selectionStart=this.selectionEnd),t!==0}moveCursorLeft(t){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",t)}_move(t,e,i){let r;if(t.altKey)r=this["findWordBoundary".concat(i)](this[e]);else{if(!t.metaKey&&t.keyCode!==35&&t.keyCode!==36)return this[e]+=i==="Left"?-1:1,!0;r=this["findLineBoundary".concat(i)](this[e])}return r!==void 0&&this[e]!==r&&(this[e]=r,!0)}_moveLeft(t,e){return this._move(t,e,"Left")}_moveRight(t,e){return this._move(t,e,"Right")}moveCursorLeftWithoutShift(t){let e=!0;return this._selectionDirection=oe,this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(e=this._moveLeft(t,"selectionStart")),this.selectionEnd=this.selectionStart,e}moveCursorLeftWithShift(t){return this._selectionDirection===fe&&this.selectionStart!==this.selectionEnd?this._moveLeft(t,"selectionEnd"):this.selectionStart!==0?(this._selectionDirection=oe,this._moveLeft(t,"selectionStart")):void 0}moveCursorRight(t){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",t)}_moveCursorLeftOrRight(t,e){const i="moveCursor".concat(t).concat(e.shiftKey?"WithShift":"WithoutShift");this._currentCursorOpacity=1,this[i](e)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())}moveCursorRightWithShift(t){return this._selectionDirection===oe&&this.selectionStart!==this.selectionEnd?this._moveRight(t,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection=fe,this._moveRight(t,"selectionEnd")):void 0}moveCursorRightWithoutShift(t){let e=!0;return this._selectionDirection=fe,this.selectionStart===this.selectionEnd?(e=this._moveRight(t,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,e}}const Ks=u=>!!u.button;class Il extends Bl{constructor(){super(...arguments),b(this,"draggableTextDelegate",void 0)}initBehavior(){this.on("mousedown",this._mouseDownHandler),this.on("mouseup",this.mouseUpHandler),this.on("mousedblclick",this.doubleClickHandler),this.on("mousetripleclick",this.tripleClickHandler),this.draggableTextDelegate=new Al(this),super.initBehavior()}shouldStartDragging(){return this.draggableTextDelegate.isActive()}onDragStart(t){return this.draggableTextDelegate.onDragStart(t)}canDrop(t){return this.draggableTextDelegate.canDrop(t)}doubleClickHandler(t){this.isEditing&&(this.selectWord(this.getSelectionStartFromPointer(t.e)),this.renderCursorOrSelection())}tripleClickHandler(t){this.isEditing&&(this.selectLine(this.getSelectionStartFromPointer(t.e)),this.renderCursorOrSelection())}_mouseDownHandler(t){let{e,alreadySelected:i}=t;this.canvas&&this.editable&&!Ks(e)&&!this.getActiveControl()&&(this.draggableTextDelegate.start(e)||(this.canvas.textEditingManager.register(this),i&&(this.inCompositionMode=!1,this.setCursorByClick(e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()),this.selected||(this.selected=i||this.isEditing)))}mouseUpHandler(t){let{e,transform:i}=t;const r=this.draggableTextDelegate.end(e);if(this.canvas){this.canvas.textEditingManager.unregister(this);const s=this.canvas._activeObject;if(s&&s!==this)return}!this.editable||this.group&&!this.group.interactive||i&&i.actionPerformed||Ks(e)||r||this.selected&&!this.getActiveControl()&&(this.enterEditing(e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection())}setCursorByClick(t){const e=this.getSelectionStartFromPointer(t),i=this.selectionStart,r=this.selectionEnd;t.shiftKey?this.setSelectionStartEndWithShift(i,r,e):(this.selectionStart=e,this.selectionEnd=e),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())}getSelectionStartFromPointer(t){const e=this.canvas.getScenePoint(t).transform(qe(this.calcTransformMatrix())).add(new O(-this._getLeftOffset(),-this._getTopOffset()));let i=0,r=0,s=0;for(let l=0;l<this._textLines.length&&i<=e.y;l++)i+=this.getHeightOfLine(l),s=l,l>0&&(r+=this._textLines[l-1].length+this.missingNewlineOffset(l-1));let n=Math.abs(this._getLineLeftOffset(s));const o=this._textLines[s].length,a=this.__charBounds[s];for(let l=0;l<o;l++){const h=n+a[l].kernedWidth;if(e.x<=h){Math.abs(e.x-h)<=Math.abs(e.x-n)&&r++;break}n=h,r++}return Math.min(this.flipX?o-r:r,this._text.length)}}const Ti="moveCursorUp",Si="moveCursorDown",Ci="moveCursorLeft",bi="moveCursorRight",Ei="exitEditing",Js=(u,t)=>{const e=t.getRetinaScaling();u.setTransform(e,0,0,e,0,0);const i=t.viewportTransform;u.transform(i[0],i[1],i[2],i[3],i[4],i[5])},Hl=E({selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,keysMap:{9:Ei,27:Ei,33:Ti,34:Si,35:bi,36:Ci,37:Ci,38:Ti,39:bi,40:Si},keysMapRtl:{9:Ei,27:Ei,33:Ti,34:Si,35:Ci,36:bi,37:bi,38:Ti,39:Ci,40:Si},ctrlKeysMapDown:{65:"cmdAll"},ctrlKeysMapUp:{67:"copy",88:"cut"}},{_selectionDirection:null,_reSpace:/\s|\r?\n/,inCompositionMode:!1});class ot extends Il{static getDefaults(){return E(E({},super.getDefaults()),ot.ownDefaults)}get type(){const t=super.type;return t==="itext"?"i-text":t}constructor(t,e){super(t,E(E({},ot.ownDefaults),e)),this.initBehavior()}_set(t,e){return this.isEditing&&this._savedProps&&t in this._savedProps?(this._savedProps[t]=e,this):(t==="canvas"&&(this.canvas instanceof or&&this.canvas.textEditingManager.remove(this),e instanceof or&&e.textEditingManager.add(this)),super._set(t,e))}setSelectionStart(t){t=Math.max(t,0),this._updateAndFire("selectionStart",t)}setSelectionEnd(t){t=Math.min(t,this.text.length),this._updateAndFire("selectionEnd",t)}_updateAndFire(t,e){this[t]!==e&&(this._fireSelectionChanged(),this[t]=e),this._updateTextarea()}_fireSelectionChanged(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})}initDimensions(){this.isEditing&&this.initDelayedCursor(),super.initDimensions()}getSelectionStyles(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.selectionStart||0,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.selectionEnd,i=arguments.length>2?arguments[2]:void 0;return super.getSelectionStyles(t,e,i)}setSelectionStyles(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.selectionStart||0,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.selectionEnd;return super.setSelectionStyles(t,e,i)}get2DCursorLocation(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.selectionStart,e=arguments.length>1?arguments[1]:void 0;return super.get2DCursorLocation(t,e)}render(t){super.render(t),this.cursorOffsetCache={},this.renderCursorOrSelection()}toCanvasElement(t){const e=this.isEditing;this.isEditing=!1;const i=super.toCanvasElement(t);return this.isEditing=e,i}renderCursorOrSelection(){if(!this.isEditing||!this.canvas)return;const t=this.clearContextTop(!0);if(!t)return;const e=this._getCursorBoundaries(),i=this.findAncestorsWithClipPath(),r=i.length>0;let s,n=t;if(r){s=We(t.canvas),n=s.getContext("2d"),Js(n,this.canvas);const o=this.calcTransformMatrix();n.transform(o[0],o[1],o[2],o[3],o[4],o[5])}if(this.selectionStart!==this.selectionEnd||this.inCompositionMode?this.renderSelection(n,e):this.renderCursor(n,e),r)for(const o of i){const a=o.clipPath,l=We(t.canvas),h=l.getContext("2d");if(Js(h,this.canvas),!a.absolutePositioned){const c=o.calcTransformMatrix();h.transform(c[0],c[1],c[2],c[3],c[4],c[5])}a.transform(h),a.drawObject(h,!0,{}),this.drawClipPathOnCache(n,a,l)}r&&(t.setTransform(1,0,0,1,0,0),t.drawImage(s,0,0)),this.canvas.contextTopDirty=!0,t.restore()}findAncestorsWithClipPath(){const t=[];let e=this;for(;e;)e.clipPath&&t.push(e),e=e.parent;return t}_getCursorBoundaries(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.selectionStart,e=arguments.length>1?arguments[1]:void 0;const i=this._getLeftOffset(),r=this._getTopOffset(),s=this._getCursorBoundariesOffsets(t,e);return{left:i,top:r,leftOffset:s.left,topOffset:s.top}}_getCursorBoundariesOffsets(t,e){return e?this.__getCursorBoundariesOffsets(t):this.cursorOffsetCache&&"top"in this.cursorOffsetCache?this.cursorOffsetCache:this.cursorOffsetCache=this.__getCursorBoundariesOffsets(t)}__getCursorBoundariesOffsets(t){let e=0,i=0;const{charIndex:r,lineIndex:s}=this.get2DCursorLocation(t);for(let l=0;l<s;l++)e+=this.getHeightOfLine(l);const n=this._getLineLeftOffset(s),o=this.__charBounds[s][r];o&&(i=o.left),this.charSpacing!==0&&r===this._textLines[s].length&&(i-=this._getWidthOfCharSpacing());const a={top:e,left:n+(i>0?i:0)};return this.direction==="rtl"&&(this.textAlign===fe||this.textAlign===Je||this.textAlign===ri?a.left*=-1:this.textAlign===oe||this.textAlign===ir?a.left=n-(i>0?i:0):this.textAlign!==ee&&this.textAlign!==si||(a.left=n-(i>0?i:0))),a}renderCursorAt(t){this._renderCursor(this.canvas.contextTop,this._getCursorBoundaries(t,!0),t)}renderCursor(t,e){this._renderCursor(t,e,this.selectionStart)}getCursorRenderingData(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.selectionStart,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this._getCursorBoundaries(t);const i=this.get2DCursorLocation(t),r=i.lineIndex,s=i.charIndex>0?i.charIndex-1:0,n=this.getValueOfPropertyAt(r,s,"fontSize"),o=this.getObjectScaling().x*this.canvas.getZoom(),a=this.cursorWidth/o,l=this.getValueOfPropertyAt(r,s,"deltaY"),h=e.topOffset+(1-this._fontSizeFraction)*this.getHeightOfLine(r)/this.lineHeight-n*(1-this._fontSizeFraction);return{color:this.cursorColor||this.getValueOfPropertyAt(r,s,"fill"),opacity:this._currentCursorOpacity,left:e.left+e.leftOffset-a/2,top:h+e.top+l,width:a,height:n}}_renderCursor(t,e,i){const{color:r,opacity:s,left:n,top:o,width:a,height:l}=this.getCursorRenderingData(i,e);t.fillStyle=r,t.globalAlpha=s,t.fillRect(n,o,a,l)}renderSelection(t,e){const i={selectionStart:this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,selectionEnd:this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd};this._renderSelection(t,i,e)}renderDragSourceEffect(){const t=this.draggableTextDelegate.getDragStartSelection();this._renderSelection(this.canvas.contextTop,t,this._getCursorBoundaries(t.selectionStart,!0))}renderDropTargetEffect(t){const e=this.getSelectionStartFromPointer(t);this.renderCursorAt(e)}_renderSelection(t,e,i){const r=e.selectionStart,s=e.selectionEnd,n=this.textAlign.includes(Je),o=this.get2DCursorLocation(r),a=this.get2DCursorLocation(s),l=o.lineIndex,h=a.lineIndex,c=o.charIndex<0?0:o.charIndex,d=a.charIndex<0?0:a.charIndex;for(let g=l;g<=h;g++){const p=this._getLineLeftOffset(g)||0;let v=this.getHeightOfLine(g),w=0,x=0,C=0;if(g===l&&(x=this.__charBounds[l][c].left),g>=l&&g<h)C=n&&!this.isEndOfWrapping(g)?this.width:this.getLineWidth(g)||5;else if(g===h)if(d===0)C=this.__charBounds[h][d].left;else{const j=this._getWidthOfCharSpacing();C=this.__charBounds[h][d-1].left+this.__charBounds[h][d-1].width-j}w=v,(this.lineHeight<1||g===h&&this.lineHeight>1)&&(v/=this.lineHeight);let P=i.left+p+x,k=v,R=0;const A=C-x;this.inCompositionMode?(t.fillStyle=this.compositionColor||"black",k=1,R=v):t.fillStyle=this.selectionColor,this.direction==="rtl"&&(this.textAlign===fe||this.textAlign===Je||this.textAlign===ri?P=this.width-P-A:this.textAlign===oe||this.textAlign===ir?P=i.left+p-C:this.textAlign!==ee&&this.textAlign!==si||(P=i.left+p-C)),t.fillRect(P,i.top+i.topOffset+R,A,k),i.topOffset+=w}}getCurrentCharFontSize(){const t=this._getCurrentCharIndex();return this.getValueOfPropertyAt(t.l,t.c,"fontSize")}getCurrentCharColor(){const t=this._getCurrentCharIndex();return this.getValueOfPropertyAt(t.l,t.c,ye)}_getCurrentCharIndex(){const t=this.get2DCursorLocation(this.selectionStart,!0),e=t.charIndex>0?t.charIndex-1:0;return{l:t.lineIndex,c:e}}dispose(){this.exitEditingImpl(),this.draggableTextDelegate.dispose(),super.dispose()}}b(ot,"ownDefaults",Hl),b(ot,"type","IText"),N.setClass(ot),N.setClass(ot,"i-text");class Pt extends ot{static getDefaults(){return E(E({},super.getDefaults()),Pt.ownDefaults)}constructor(t,e){super(t,E(E({},Pt.ownDefaults),e))}static createControls(){return{controls:pa()}}initDimensions(){this.initialized&&(this.isEditing&&this.initDelayedCursor(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.includes(Je)&&this.enlargeSpaces(),this.height=this.calcTextHeight())}_generateStyleMap(t){let e=0,i=0,r=0;const s={};for(let n=0;n<t.graphemeLines.length;n++)t.graphemeText[r]===`
`&&n>0?(i=0,r++,e++):!this.splitByGrapheme&&this._reSpaceAndTab.test(t.graphemeText[r])&&n>0&&(i++,r++),s[n]={line:e,offset:i},r+=t.graphemeLines[n].length,i+=t.graphemeLines[n].length;return s}styleHas(t,e){if(this._styleMap&&!this.isWrapping){const i=this._styleMap[e];i&&(e=i.line)}return super.styleHas(t,e)}isEmptyStyles(t){if(!this.styles)return!0;let e,i=0,r=t+1,s=!1;const n=this._styleMap[t],o=this._styleMap[t+1];n&&(t=n.line,i=n.offset),o&&(r=o.line,s=r===t,e=o.offset);const a=t===void 0?this.styles:{line:this.styles[t]};for(const l in a)for(const h in a[l]){const c=parseInt(h,10);if(c>=i&&(!s||c<e))for(const d in a[l][h])return!1}return!0}_getStyleDeclaration(t,e){if(this._styleMap&&!this.isWrapping){const i=this._styleMap[t];if(!i)return{};t=i.line,e=i.offset+e}return super._getStyleDeclaration(t,e)}_setStyleDeclaration(t,e,i){const r=this._styleMap[t];super._setStyleDeclaration(r.line,r.offset+e,i)}_deleteStyleDeclaration(t,e){const i=this._styleMap[t];super._deleteStyleDeclaration(i.line,i.offset+e)}_getLineStyle(t){const e=this._styleMap[t];return!!this.styles[e.line]}_setLineStyle(t){const e=this._styleMap[t];super._setLineStyle(e.line)}_wrapText(t,e){this.isWrapping=!0;const i=this.getGraphemeDataForRender(t),r=[];for(let s=0;s<i.wordsData.length;s++)r.push(...this._wrapLine(s,e,i));return this.isWrapping=!1,r}getGraphemeDataForRender(t){const e=this.splitByGrapheme,i=e?"":" ";let r=0;return{wordsData:t.map(((s,n)=>{let o=0;const a=e?this.graphemeSplit(s):this.wordSplit(s);return a.length===0?[{word:[],width:0}]:a.map((l=>{const h=e?[l]:this.graphemeSplit(l),c=this._measureWord(h,n,o);return r=Math.max(c,r),o+=h.length+i.length,{word:h,width:c}}))})),largestWordWidth:r}}_measureWord(t,e){let i,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,s=0;for(let n=0,o=t.length;n<o;n++)s+=this._getGraphemeBox(t[n],e,n+r,i,!0).kernedWidth,i=t[n];return s}wordSplit(t){return t.split(this._wordJoiners)}_wrapLine(t,e,i){let{largestWordWidth:r,wordsData:s}=i,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0;const o=this._getWidthOfCharSpacing(),a=this.splitByGrapheme,l=[],h=a?"":" ";let c=0,d=[],g=0,p=0,v=!0;e-=n;const w=Math.max(e,r,this.dynamicMinWidth),x=s[t];let C;for(g=0,C=0;C<x.length;C++){const{word:P,width:k}=x[C];g+=P.length,c+=p+k-o,c>w&&!v?(l.push(d),d=[],c=k,v=!0):c+=o,v||a||d.push(h),d=d.concat(P),p=a?0:this._measureWord([h],t,g),g++,v=!1}return C&&l.push(d),r+n>this.dynamicMinWidth&&(this.dynamicMinWidth=r-o+n),l}isEndOfWrapping(t){return!this._styleMap[t+1]||this._styleMap[t+1].line!==this._styleMap[t].line}missingNewlineOffset(t,e){return this.splitByGrapheme&&!e?this.isEndOfWrapping(t)?1:0:1}_splitTextIntoLines(t){const e=super._splitTextIntoLines(t),i=this._wrapText(e.lines,this.width),r=new Array(i.length);for(let s=0;s<i.length;s++)r[s]=i[s].join("");return e.lines=r,e.graphemeLines=i,e}getMinWidth(){return Math.max(this.minWidth,this.dynamicMinWidth)}_removeExtraneousStyles(){const t=new Map;for(const e in this._styleMap){const i=parseInt(e,10);if(this._textLines[i]){const r=this._styleMap[e].line;t.set("".concat(r),!0)}}for(const e in this.styles)t.has(e)||delete this.styles[e]}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return super.toObject(["minWidth","splitByGrapheme",...t])}}b(Pt,"type","Textbox"),b(Pt,"textLayoutProperties",[...ot.textLayoutProperties,"width"]),b(Pt,"ownDefaults",{minWidth:20,dynamicMinWidth:2,lockScalingFlip:!0,noScaleCache:!1,_wordJoiners:/[ \t\r]/,splitByGrapheme:!1}),N.setClass(Pt);class Qs extends pr{shouldPerformLayout(t){return!!t.target.clipPath&&super.shouldPerformLayout(t)}shouldLayoutClipPath(){return!1}calcLayoutResult(t,e){const{target:i}=t,{clipPath:r,group:s}=i;if(!r||!this.shouldPerformLayout(t))return;const{width:n,height:o}=at(jn(i,r)),a=new O(n,o);if(r.absolutePositioned)return{center:Nt(r.getRelativeCenterPoint(),void 0,s?s.calcTransformMatrix():void 0),size:a};{const l=r.getRelativeCenterPoint().transform(i.calcOwnMatrix(),!0);if(this.shouldPerformLayout(t)){const{center:h=new O,correction:c=new O}=this.calcBoundingBox(e,t)||{};return{center:h.add(l),correction:c.subtract(l),size:a}}return{center:i.getRelativeCenterPoint().add(l),size:a}}}}b(Qs,"type","clip-path"),N.setClass(Qs);class $s extends pr{getInitialSize(t,e){let{target:i}=t,{size:r}=e;return new O(i.width||r.x,i.height||r.y)}}b($s,"type","fixed"),N.setClass($s);class jl extends ui{subscribeTargets(t){const e=t.target;t.targets.reduce(((i,r)=>(r.parent&&i.add(r.parent),i)),new Set).forEach((i=>{i.layoutManager.subscribeTargets({target:i,targets:[e]})}))}unsubscribeTargets(t){const e=t.target,i=e.getObjects();t.targets.reduce(((r,s)=>(s.parent&&r.add(s.parent),r)),new Set).forEach((r=>{!i.some((s=>s.parent===r))&&r.layoutManager.unsubscribeTargets({target:r,targets:[e]})}))}}class Dt extends Ot{static getDefaults(){return E(E({},super.getDefaults()),Dt.ownDefaults)}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),Object.assign(this,Dt.ownDefaults),this.setOptions(e);const{left:i,top:r,layoutManager:s}=e;this.groupInit(t,{left:i,top:r,layoutManager:s??new jl})}_shouldSetNestedCoords(){return!0}__objectSelectionMonitor(){}multiSelectAdd(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.multiSelectionStacking==="selection-order"?this.add(...e):e.forEach((r=>{const s=this._objects.findIndex((o=>o.isInFrontOf(r))),n=s===-1?this.size():s;this.insertAt(n,r)}))}canEnterGroup(t){return this.getObjects().some((e=>e.isDescendantOf(t)||t.isDescendantOf(e)))?(yt("error","ActiveSelection: circular object trees are not supported, this call has no effect"),!1):super.canEnterGroup(t)}enterGroup(t,e){t.parent&&t.parent===t.group?t.parent._exitGroup(t):t.group&&t.parent!==t.group&&t.group.remove(t),this._enterGroup(t,e)}exitGroup(t,e){this._exitGroup(t,e),t.parent&&t.parent._enterGroup(t,!0)}_onAfterObjectsChange(t,e){super._onAfterObjectsChange(t,e);const i=new Set;e.forEach((r=>{const{parent:s}=r;s&&i.add(s)})),t===ls?i.forEach((r=>{r._onAfterObjectsChange(rr,e)})):i.forEach((r=>{r._set("dirty",!0)}))}onDeselect(){return this.removeAll(),!1}toString(){return"#<ActiveSelection: (".concat(this.complexity(),")>")}shouldCache(){return!1}isOnACache(){return!1}_renderControls(t,e,i){t.save(),t.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1;const r=E(E({hasControls:!1},i),{},{forActiveSelection:!0});for(let s=0;s<this._objects.length;s++)this._objects[s]._renderControls(t,r);super._renderControls(t,e),t.restore()}}b(Dt,"type","ActiveSelection"),b(Dt,"ownDefaults",{multiSelectionStacking:"canvas-stacking"}),N.setClass(Dt),N.setClass(Dt,"activeSelection");class zl{constructor(){b(this,"resources",{})}applyFilters(t,e,i,r,s){const n=s.getContext("2d");if(!n)return;n.drawImage(e,0,0,i,r);const o={sourceWidth:i,sourceHeight:r,imageData:n.getImageData(0,0,i,r),originalEl:e,originalImageData:n.getImageData(0,0,i,r),canvasEl:s,ctx:n,filterBackend:this};t.forEach((l=>{l.applyTo(o)}));const{imageData:a}=o;return a.width===i&&a.height===r||(s.width=a.width,s.height=a.height),n.putImageData(a,0,0),o}}class to{constructor(){let{tileSize:t=re.textureSize}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};b(this,"aPosition",new Float32Array([0,0,0,1,1,0,1,1])),b(this,"resources",{}),this.tileSize=t,this.setupGLContext(t,t),this.captureGPUInfo()}setupGLContext(t,e){this.dispose(),this.createWebGLCanvas(t,e)}createWebGLCanvas(t,e){const i=We({width:t,height:e}),r=i.getContext("webgl",{alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1});r&&(r.clearColor(0,0,0,0),this.canvas=i,this.gl=r)}applyFilters(t,e,i,r,s,n){const o=this.gl,a=s.getContext("2d");if(!o||!a)return;let l;n&&(l=this.getCachedTexture(n,e));const h={originalWidth:e.width||e.naturalWidth||0,originalHeight:e.height||e.naturalHeight||0,sourceWidth:i,sourceHeight:r,destinationWidth:i,destinationHeight:r,context:o,sourceTexture:this.createTexture(o,i,r,l?void 0:e),targetTexture:this.createTexture(o,i,r),originalTexture:l||this.createTexture(o,i,r,l?void 0:e),passes:t.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:s},c=o.createFramebuffer();return o.bindFramebuffer(o.FRAMEBUFFER,c),t.forEach((d=>{d&&d.applyTo(h)})),(function(d){const g=d.targetCanvas,p=g.width,v=g.height,w=d.destinationWidth,x=d.destinationHeight;p===w&&v===x||(g.width=w,g.height=x)})(h),this.copyGLTo2D(o,h),o.bindTexture(o.TEXTURE_2D,null),o.deleteTexture(h.sourceTexture),o.deleteTexture(h.targetTexture),o.deleteFramebuffer(c),a.setTransform(1,0,0,1,0,0),h}dispose(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()}clearWebGLCaches(){this.programCache={},this.textureCache={}}createTexture(t,e,i,r,s){const{NEAREST:n,TEXTURE_2D:o,RGBA:a,UNSIGNED_BYTE:l,CLAMP_TO_EDGE:h,TEXTURE_MAG_FILTER:c,TEXTURE_MIN_FILTER:d,TEXTURE_WRAP_S:g,TEXTURE_WRAP_T:p}=t,v=t.createTexture();return t.bindTexture(o,v),t.texParameteri(o,c,s||n),t.texParameteri(o,d,s||n),t.texParameteri(o,g,h),t.texParameteri(o,p,h),r?t.texImage2D(o,0,a,a,l,r):t.texImage2D(o,0,a,e,i,0,a,l,null),v}getCachedTexture(t,e,i){const{textureCache:r}=this;if(r[t])return r[t];{const s=this.createTexture(this.gl,e.width,e.height,e,i);return s&&(r[t]=s),s}}evictCachesForKey(t){this.textureCache[t]&&(this.gl.deleteTexture(this.textureCache[t]),delete this.textureCache[t])}copyGLTo2D(t,e){const i=t.canvas,r=e.targetCanvas,s=r.getContext("2d");if(!s)return;s.translate(0,r.height),s.scale(1,-1);const n=i.height-r.height;s.drawImage(i,0,n,r.width,r.height,0,0,r.width,r.height)}copyGLTo2DPutImageData(t,e){const i=e.targetCanvas.getContext("2d"),r=e.destinationWidth,s=e.destinationHeight,n=r*s*4;if(!i)return;const o=new Uint8Array(this.imageBuffer,0,n),a=new Uint8ClampedArray(this.imageBuffer,0,n);t.readPixels(0,0,r,s,t.RGBA,t.UNSIGNED_BYTE,o);const l=new ImageData(a,r,s);i.putImageData(l,0,0)}captureGPUInfo(){if(this.gpuInfo)return this.gpuInfo;const t=this.gl,e={renderer:"",vendor:""};if(!t)return e;const i=t.getExtension("WEBGL_debug_renderer_info");if(i){const r=t.getParameter(i.UNMASKED_RENDERER_WEBGL),s=t.getParameter(i.UNMASKED_VENDOR_WEBGL);r&&(e.renderer=r.toLowerCase()),s&&(e.vendor=s.toLowerCase())}return this.gpuInfo=e,e}}let Rr;function Nl(){const{WebGLProbe:u}=$e();return u.queryWebGL(ut()),re.enableGLFiltering&&u.isSupported(re.textureSize)?new to({tileSize:re.textureSize}):new zl}function Mr(){return!Rr&&(!(arguments.length>0&&arguments[0]!==void 0)||arguments[0])&&(Rr=Nl()),Rr}const Wl=["filters","resizeFilter","src","crossOrigin","type"],io=["cropX","cropY"];class je extends Se{static getDefaults(){return E(E({},super.getDefaults()),je.ownDefaults)}constructor(t,e){super(),b(this,"_lastScaleX",1),b(this,"_lastScaleY",1),b(this,"_filterScalingX",1),b(this,"_filterScalingY",1),this.filters=[],Object.assign(this,je.ownDefaults),this.setOptions(e),this.cacheKey="texture".concat(wt()),this.setElement(typeof t=="string"?(this.canvas&&Ye(this.canvas.getElement())||Gt()).getElementById(t):t,e)}getElement(){return this._element}setElement(t){var e;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.removeTexture(this.cacheKey),this.removeTexture("".concat(this.cacheKey,"_filtered")),this._element=t,this._originalElement=t,this._setWidthHeight(i),(e=t.classList)===null||e===void 0||e.add(je.CSS_CANVAS),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters()}removeTexture(t){const e=Mr(!1);e instanceof to&&e.evictCachesForKey(t)}dispose(){super.dispose(),this.removeTexture(this.cacheKey),this.removeTexture("".concat(this.cacheKey,"_filtered")),this._cacheContext=null,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((t=>{const e=this[t];e&&$e().dispose(e),this[t]=void 0}))}getCrossOrigin(){return this._originalElement&&(this._originalElement.crossOrigin||null)}getOriginalSize(){const t=this.getElement();return t?{width:t.naturalWidth||t.width,height:t.naturalHeight||t.height}:{width:0,height:0}}_stroke(t){if(!this.stroke||this.strokeWidth===0)return;const e=this.width/2,i=this.height/2;t.beginPath(),t.moveTo(-e,-i),t.lineTo(e,-i),t.lineTo(e,i),t.lineTo(-e,i),t.lineTo(-e,-i),t.closePath()}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const e=[];return this.filters.forEach((i=>{i&&e.push(i.toObject())})),E(E({},super.toObject([...io,...t])),{},{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:e},this.resizeFilter?{resizeFilter:this.resizeFilter.toObject()}:{})}hasCrop(){return!!this.cropX||!!this.cropY||this.width<this._element.width||this.height<this._element.height}_toSVG(){const t=[],e=this._element,i=-this.width/2,r=-this.height/2;let s=[],n=[],o="",a="";if(!e)return[];if(this.hasCrop()){const l=wt();s.push('<clipPath id="imageCrop_'+l+`">
`,'	<rect x="'+i+'" y="'+r+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),o=' clip-path="url(#imageCrop_'+l+')" '}if(this.imageSmoothing||(a=' image-rendering="optimizeSpeed"'),t.push("	<image ","COMMON_PARTS",'xlink:href="'.concat(this.getSvgSrc(!0),'" x="').concat(i-this.cropX,'" y="').concat(r-this.cropY,'" width="').concat(e.width||e.naturalWidth,'" height="').concat(e.height||e.naturalHeight,'"').concat(a).concat(o,`></image>
`)),this.stroke||this.strokeDashArray){const l=this.fill;this.fill=null,n=['	<rect x="'.concat(i,'" y="').concat(r,'" width="').concat(this.width,'" height="').concat(this.height,'" style="').concat(this.getSvgStyles(),`" />
`)],this.fill=l}return s=this.paintFirst!==ye?s.concat(n,t):s.concat(t,n),s}getSrc(t){const e=t?this._element:this._originalElement;return e?e.toDataURL?e.toDataURL():this.srcFromAttribute?e.getAttribute("src")||"":e.src:this.src||""}getSvgSrc(t){return this.getSrc(t)}setSrc(t){let{crossOrigin:e,signal:i}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return Xi(t,{crossOrigin:e,signal:i}).then((r=>{e!==void 0&&this.set({crossOrigin:e}),this.setElement(r)}))}toString(){return'#<Image: { src: "'.concat(this.getSrc(),'" }>')}applyResizeFilters(){const t=this.resizeFilter,e=this.minimumScaleTrigger,i=this.getTotalObjectScaling(),r=i.x,s=i.y,n=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!t||r>e&&s>e)return this._element=n,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=r,void(this._lastScaleY=s);const o=We(n),{width:a,height:l}=n;this._element=o,this._lastScaleX=t.scaleX=r,this._lastScaleY=t.scaleY=s,Mr().applyFilters([t],n,a,l,this._element),this._filterScalingX=o.width/this._originalElement.width,this._filterScalingY=o.height/this._originalElement.height}applyFilters(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.filters||[];if(t=t.filter((s=>s&&!s.isNeutralState())),this.set("dirty",!0),this.removeTexture("".concat(this.cacheKey,"_filtered")),t.length===0)return this._element=this._originalElement,this._filteredEl=void 0,this._filterScalingX=1,void(this._filterScalingY=1);const e=this._originalElement,i=e.naturalWidth||e.width,r=e.naturalHeight||e.height;if(this._element===this._originalElement){const s=We({width:i,height:r});this._element=s,this._filteredEl=s}else this._filteredEl&&(this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,i,r),this._lastScaleX=1,this._lastScaleY=1);Mr().applyFilters(t,this._originalElement,i,r,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height)}_render(t){t.imageSmoothingEnabled=this.imageSmoothing,this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(t),this._renderPaintInOrder(t)}drawCacheOnCanvas(t){t.imageSmoothingEnabled=this.imageSmoothing,super.drawCacheOnCanvas(t)}shouldCache(){return this.needsItsOwnCache()}_renderFill(t){const e=this._element;if(!e)return;const i=this._filterScalingX,r=this._filterScalingY,s=this.width,n=this.height,o=Math.max(this.cropX,0),a=Math.max(this.cropY,0),l=e.naturalWidth||e.width,h=e.naturalHeight||e.height,c=o*i,d=a*r,g=Math.min(s*i,l-c),p=Math.min(n*r,h-d),v=-s/2,w=-n/2,x=Math.min(s,l/i-o),C=Math.min(n,h/r-a);e&&t.drawImage(e,c,d,g,p,v,w,x,C)}_needsResize(){const t=this.getTotalObjectScaling();return t.x!==this._lastScaleX||t.y!==this._lastScaleY}_resetWidthHeight(){this.set(this.getOriginalSize())}_setWidthHeight(){let{width:t,height:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const i=this.getOriginalSize();this.width=t||i.width,this.height=e||i.height}parsePreserveAspectRatioAttribute(){const t=Fo(this.preserveAspectRatio||""),e=this.width,i=this.height,r={width:e,height:i};let s,n=this._element.width,o=this._element.height,a=1,l=1,h=0,c=0,d=0,g=0;return!t||t.alignX===Oe&&t.alignY===Oe?(a=e/n,l=i/o):(t.meetOrSlice==="meet"&&(a=l=Za(this._element,r),s=(e-n*a)/2,t.alignX==="Min"&&(h=-s),t.alignX==="Max"&&(h=s),s=(i-o*l)/2,t.alignY==="Min"&&(c=-s),t.alignY==="Max"&&(c=s)),t.meetOrSlice==="slice"&&(a=l=Ka(this._element,r),s=n-e/a,t.alignX==="Mid"&&(d=s/2),t.alignX==="Max"&&(d=s),s=o-i/l,t.alignY==="Mid"&&(g=s/2),t.alignY==="Max"&&(g=s),n=e/a,o=i/l)),{width:n,height:o,scaleX:a,scaleY:l,offsetLeft:h,offsetTop:c,cropX:d,cropY:g}}static fromObject(t,e){let{filters:i,resizeFilter:r,src:s,crossOrigin:n,type:o}=t,a=ue(t,Wl);return Promise.all([Xi(s,E(E({},e),{},{crossOrigin:n})),i&&ai(i,e),r&&ai([r],e),ur(a,e)]).then((l=>{let[h,c=[],[d]=[],g={}]=l;return new this(h,E(E({},a),{},{src:s,filters:c,resizeFilter:d},g))}))}static fromURL(t){let{crossOrigin:e=null,signal:i}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return Xi(t,{crossOrigin:e,signal:i}).then((s=>new this(s,r)))}static async fromElement(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;const r=ft(t,this.ATTRIBUTE_NAMES,i);return this.fromURL(r["xlink:href"]||r.href,e,r).catch((s=>(yt("log","Unable to parse Image",s),null)))}}b(je,"type","Image"),b(je,"cacheProperties",[...gt,...io]),b(je,"ownDefaults",{strokeWidth:0,srcFromAttribute:!1,minimumScaleTrigger:.5,cropX:0,cropY:0,imageSmoothing:!0}),b(je,"CSS_CANVAS","canvas-img"),b(je,"ATTRIBUTE_NAMES",[...xt,"x","y","width","height","preserveAspectRatio","xlink:href","href","crossOrigin","image-rendering"]),N.setClass(je),N.setSVGClass(je);gr(["pattern","defs","symbol","metadata","clipPath","mask","desc"]);const vr=u=>u.webgl!==void 0,hs="precision highp float",Ul=`
    `.concat(hs,`;
    varying vec2 vTexCoord;
    uniform sampler2D uTexture;
    void main() {
      gl_FragColor = texture2D(uTexture, vTexCoord);
    }`),Vl=["type"],Gl=["type"],Xl=new RegExp(hs,"g");class we{get type(){return this.constructor.type}constructor(){let t=ue(arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},Vl);Object.assign(this,this.constructor.defaults,t)}getFragmentSource(){return Ul}getVertexSource(){return`
    attribute vec2 aPosition;
    varying vec2 vTexCoord;
    void main() {
      vTexCoord = aPosition;
      gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
    }`}createProgram(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.getFragmentSource(),i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.getVertexSource();const{WebGLProbe:{GLPrecision:r="highp"}}=$e();r!=="highp"&&(e=e.replace(Xl,hs.replace("highp",r)));const s=t.createShader(t.VERTEX_SHADER),n=t.createShader(t.FRAGMENT_SHADER),o=t.createProgram();if(!s||!n||!o)throw new Qe("Vertex, fragment shader or program creation error");if(t.shaderSource(s,i),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Qe("Vertex shader compile error for ".concat(this.type,": ").concat(t.getShaderInfoLog(s)));if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Qe("Fragment shader compile error for ".concat(this.type,": ").concat(t.getShaderInfoLog(n)));if(t.attachShader(o,s),t.attachShader(o,n),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw new Qe('Shader link error for "'.concat(this.type,'" ').concat(t.getProgramInfoLog(o)));const a=this.getUniformLocations(t,o)||{};return a.uStepW=t.getUniformLocation(o,"uStepW"),a.uStepH=t.getUniformLocation(o,"uStepH"),{program:o,attributeLocations:this.getAttributeLocations(t,o),uniformLocations:a}}getAttributeLocations(t,e){return{aPosition:t.getAttribLocation(e,"aPosition")}}getUniformLocations(t,e){const i=this.constructor.uniformLocations,r={};for(let s=0;s<i.length;s++)r[i[s]]=t.getUniformLocation(e,i[s]);return r}sendAttributeData(t,e,i){const r=e.aPosition,s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s),t.enableVertexAttribArray(r),t.vertexAttribPointer(r,2,t.FLOAT,!1,0,0),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW)}_setupFrameBuffer(t){const e=t.context;if(t.passes>1){const i=t.destinationWidth,r=t.destinationHeight;t.sourceWidth===i&&t.sourceHeight===r||(e.deleteTexture(t.targetTexture),t.targetTexture=t.filterBackend.createTexture(e,i,r)),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t.targetTexture,0)}else e.bindFramebuffer(e.FRAMEBUFFER,null),e.finish()}_swapTextures(t){t.passes--,t.pass++;const e=t.targetTexture;t.targetTexture=t.sourceTexture,t.sourceTexture=e}isNeutralState(t){return!1}applyTo(t){vr(t)?(this._setupFrameBuffer(t),this.applyToWebGL(t),this._swapTextures(t)):this.applyTo2d(t)}applyTo2d(t){}getCacheKey(){return this.type}retrieveShader(t){const e=this.getCacheKey();return t.programCache[e]||(t.programCache[e]=this.createProgram(t.context)),t.programCache[e]}applyToWebGL(t){const e=t.context,i=this.retrieveShader(t);t.pass===0&&t.originalTexture?e.bindTexture(e.TEXTURE_2D,t.originalTexture):e.bindTexture(e.TEXTURE_2D,t.sourceTexture),e.useProgram(i.program),this.sendAttributeData(e,i.attributeLocations,t.aPosition),e.uniform1f(i.uniformLocations.uStepW,1/t.sourceWidth),e.uniform1f(i.uniformLocations.uStepH,1/t.sourceHeight),this.sendUniformData(e,i.uniformLocations),e.viewport(0,0,t.destinationWidth,t.destinationHeight),e.drawArrays(e.TRIANGLE_STRIP,0,4)}bindAdditionalTexture(t,e,i){t.activeTexture(i),t.bindTexture(t.TEXTURE_2D,e),t.activeTexture(t.TEXTURE0)}unbindAdditionalTexture(t,e){t.activeTexture(e),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE0)}sendUniformData(t,e){}createHelpLayer(t){if(!t.helpLayer){const{sourceWidth:e,sourceHeight:i}=t,r=We({width:e,height:i});t.helpLayer=r}}toObject(){const t=Object.keys(this.constructor.defaults||{});return E({type:this.type},t.reduce(((e,i)=>(e[i]=this[i],e)),{}))}toJSON(){return this.toObject()}static async fromObject(t,e){return new this(ue(t,Gl))}}b(we,"type","BaseFilter"),b(we,"uniformLocations",[]);const Yl={multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,difference:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`
    if (uColor.r < 0.5) {
      gl_FragColor.r *= 2.0 * uColor.r;
    } else {
      gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
    }
    if (uColor.g < 0.5) {
      gl_FragColor.g *= 2.0 * uColor.g;
    } else {
      gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
    }
    if (uColor.b < 0.5) {
      gl_FragColor.b *= 2.0 * uColor.b;
    } else {
      gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
    }
    `,tint:`
    gl_FragColor.rgb *= (1.0 - uColor.a);
    gl_FragColor.rgb += uColor.rgb;
    `};class Pi extends we{getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return`
      precision highp float;
      uniform sampler2D uTexture;
      uniform vec4 uColor;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        gl_FragColor = color;
        if (color.a > 0.0) {
          `.concat(Yl[this.mode],`
        }
      }
      `)}applyTo2d(t){let{imageData:{data:e}}=t;const i=new le(this.color).getSource(),r=this.alpha,s=i[0]*r,n=i[1]*r,o=i[2]*r,a=1-r;for(let l=0;l<e.length;l+=4){const h=e[l],c=e[l+1],d=e[l+2];let g,p,v;switch(this.mode){case"multiply":g=h*s/255,p=c*n/255,v=d*o/255;break;case"screen":g=255-(255-h)*(255-s)/255,p=255-(255-c)*(255-n)/255,v=255-(255-d)*(255-o)/255;break;case"add":g=h+s,p=c+n,v=d+o;break;case"difference":g=Math.abs(h-s),p=Math.abs(c-n),v=Math.abs(d-o);break;case"subtract":g=h-s,p=c-n,v=d-o;break;case"darken":g=Math.min(h,s),p=Math.min(c,n),v=Math.min(d,o);break;case"lighten":g=Math.max(h,s),p=Math.max(c,n),v=Math.max(d,o);break;case"overlay":g=s<128?2*h*s/255:255-2*(255-h)*(255-s)/255,p=n<128?2*c*n/255:255-2*(255-c)*(255-n)/255,v=o<128?2*d*o/255:255-2*(255-d)*(255-o)/255;break;case"exclusion":g=s+h-2*s*h/255,p=n+c-2*n*c/255,v=o+d-2*o*d/255;break;case"tint":g=s+h*a,p=n+c*a,v=o+d*a}e[l]=g,e[l+1]=p,e[l+2]=v}}sendUniformData(t,e){const i=new le(this.color).getSource();i[0]=this.alpha*i[0]/255,i[1]=this.alpha*i[1]/255,i[2]=this.alpha*i[2]/255,i[3]=this.alpha,t.uniform4fv(e.uColor,i)}}b(Pi,"defaults",{color:"#F95C63",mode:"multiply",alpha:1}),b(Pi,"type","BlendColor"),b(Pi,"uniformLocations",["uColor"]),N.setClass(Pi);const ql={multiply:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform sampler2D uImage;
    uniform vec4 uColor;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      vec4 color2 = texture2D(uImage, vTexCoord2);
      color.rgba *= color2.rgba;
      gl_FragColor = color;
    }
    `,mask:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform sampler2D uImage;
    uniform vec4 uColor;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      vec4 color2 = texture2D(uImage, vTexCoord2);
      color.a = color2.a;
      gl_FragColor = color;
    }
    `},Zl=["type","image"];class Di extends we{getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return ql[this.mode]}getVertexSource(){return`
    attribute vec2 aPosition;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    uniform mat3 uTransformMatrix;
    void main() {
      vTexCoord = aPosition;
      vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
      gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
    }
    `}applyToWebGL(t){const e=t.context,i=this.createTexture(t.filterBackend,this.image);this.bindAdditionalTexture(e,i,e.TEXTURE1),super.applyToWebGL(t),this.unbindAdditionalTexture(e,e.TEXTURE1)}createTexture(t,e){return t.getCachedTexture(e.cacheKey,e.getElement())}calculateMatrix(){const t=this.image,{width:e,height:i}=t.getElement();return[1/t.scaleX,0,0,0,1/t.scaleY,0,-t.left/e,-t.top/i,1]}applyTo2d(t){let{imageData:{data:e,width:i,height:r},filterBackend:{resources:s}}=t;const n=this.image;s.blendImage||(s.blendImage=ut());const o=s.blendImage,a=o.getContext("2d");o.width!==i||o.height!==r?(o.width=i,o.height=r):a.clearRect(0,0,i,r),a.setTransform(n.scaleX,0,0,n.scaleY,n.left,n.top),a.drawImage(n.getElement(),0,0,i,r);const l=a.getImageData(0,0,i,r).data;for(let h=0;h<e.length;h+=4){const c=e[h],d=e[h+1],g=e[h+2],p=e[h+3],v=l[h],w=l[h+1],x=l[h+2],C=l[h+3];switch(this.mode){case"multiply":e[h]=c*v/255,e[h+1]=d*w/255,e[h+2]=g*x/255,e[h+3]=p*C/255;break;case"mask":e[h+3]=C}}}sendUniformData(t,e){const i=this.calculateMatrix();t.uniform1i(e.uImage,1),t.uniformMatrix3fv(e.uTransformMatrix,!1,i)}toObject(){return E(E({},super.toObject()),{},{image:this.image&&this.image.toObject()})}static async fromObject(t,e){let{type:i,image:r}=t,s=ue(t,Zl);return je.fromObject(r,e).then((n=>new this(E(E({},s),{},{image:n}))))}}b(Di,"type","BlendImage"),b(Di,"defaults",{mode:"multiply",alpha:1}),b(Di,"uniformLocations",["uTransformMatrix","uImage"]),N.setClass(Di);class Oi extends we{getFragmentSource(){return`
    precision highp float;
    uniform sampler2D uTexture;
    uniform vec2 uDelta;
    varying vec2 vTexCoord;
    const float nSamples = 15.0;
    vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
    float random(vec3 scale) {
      /* use the fragment position for a different seed per-pixel */
      return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
    }
    void main() {
      vec4 color = vec4(0.0);
      float totalC = 0.0;
      float totalA = 0.0;
      float offset = random(v3offset);
      for (float t = -nSamples; t <= nSamples; t++) {
        float percent = (t + offset - 0.5) / nSamples;
        vec4 sample = texture2D(uTexture, vTexCoord + uDelta * percent);
        float weight = 1.0 - abs(percent);
        float alpha = weight * sample.a;
        color.rgb += sample.rgb * alpha;
        color.a += alpha;
        totalA += weight;
        totalC += alpha;
      }
      gl_FragColor.rgb = color.rgb / totalC;
      gl_FragColor.a = color.a / totalA;
    }
  `}applyTo(t){vr(t)?(this.aspectRatio=t.sourceWidth/t.sourceHeight,t.passes++,this._setupFrameBuffer(t),this.horizontal=!0,this.applyToWebGL(t),this._swapTextures(t),this._setupFrameBuffer(t),this.horizontal=!1,this.applyToWebGL(t),this._swapTextures(t)):this.applyTo2d(t)}applyTo2d(t){let{imageData:{data:e,width:i,height:r}}=t;this.aspectRatio=i/r,this.horizontal=!0;let s=this.getBlurValue()*i;const n=new Uint8ClampedArray(e),o=15,a=4*i;for(let l=0;l<e.length;l+=4){let h=0,c=0,d=0,g=0,p=0;const v=l-l%a,w=v+a;for(let x=-14;x<o;x++){const C=x/o,P=4*Math.floor(s*C),k=1-Math.abs(C);let R=l+P;R<v?R=v:R>w&&(R=w);const A=e[R+3]*k;h+=e[R]*A,c+=e[R+1]*A,d+=e[R+2]*A,g+=A,p+=k}n[l]=h/g,n[l+1]=c/g,n[l+2]=d/g,n[l+3]=g/p}this.horizontal=!1,s=this.getBlurValue()*r;for(let l=0;l<n.length;l+=4){let h=0,c=0,d=0,g=0,p=0;const v=l%a,w=n.length-a+v;for(let x=-14;x<o;x++){const C=x/o,P=Math.floor(s*C)*a,k=1-Math.abs(C);let R=l+P;R<v?R=v:R>w&&(R=w);const A=n[R+3]*k;h+=n[R]*A,c+=n[R+1]*A,d+=n[R+2]*A,g+=A,p+=k}e[l]=h/g,e[l+1]=c/g,e[l+2]=d/g,e[l+3]=g/p}}sendUniformData(t,e){const i=this.chooseRightDelta();t.uniform2fv(e.uDelta,i)}isNeutralState(){return this.blur===0}getBlurValue(){let t=1;const{horizontal:e,aspectRatio:i}=this;return e?i>1&&(t=1/i):i<1&&(t=i),t*this.blur*.12}chooseRightDelta(){const t=this.getBlurValue();return this.horizontal?[t,0]:[0,t]}}b(Oi,"type","Blur"),b(Oi,"defaults",{blur:0}),b(Oi,"uniformLocations",["uDelta"]),N.setClass(Oi);class Ri extends we{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uBrightness;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color.rgb += uBrightness;
    gl_FragColor = color;
  }
`}applyTo2d(t){let{imageData:{data:e}}=t;const i=Math.round(255*this.brightness);for(let r=0;r<e.length;r+=4)e[r]+=i,e[r+1]+=i,e[r+2]+=i}isNeutralState(){return this.brightness===0}sendUniformData(t,e){t.uniform1f(e.uBrightness,this.brightness)}}b(Ri,"type","Brightness"),b(Ri,"defaults",{brightness:0}),b(Ri,"uniformLocations",["uBrightness"]),N.setClass(Ri);const ro={matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],colorsOnly:!0};class zt extends we{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  varying vec2 vTexCoord;
  uniform mat4 uColorMatrix;
  uniform vec4 uConstants;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color *= uColorMatrix;
    color += uConstants;
    gl_FragColor = color;
  }`}applyTo2d(t){const e=t.imageData.data,i=this.matrix,r=this.colorsOnly;for(let s=0;s<e.length;s+=4){const n=e[s],o=e[s+1],a=e[s+2];if(e[s]=n*i[0]+o*i[1]+a*i[2]+255*i[4],e[s+1]=n*i[5]+o*i[6]+a*i[7]+255*i[9],e[s+2]=n*i[10]+o*i[11]+a*i[12]+255*i[14],!r){const l=e[s+3];e[s]+=l*i[3],e[s+1]+=l*i[8],e[s+2]+=l*i[13],e[s+3]=n*i[15]+o*i[16]+a*i[17]+l*i[18]+255*i[19]}}}sendUniformData(t,e){const i=this.matrix,r=[i[0],i[1],i[2],i[3],i[5],i[6],i[7],i[8],i[10],i[11],i[12],i[13],i[15],i[16],i[17],i[18]],s=[i[4],i[9],i[14],i[19]];t.uniformMatrix4fv(e.uColorMatrix,!1,r),t.uniform4fv(e.uConstants,s)}toObject(){return E(E({},super.toObject()),{},{matrix:[...this.matrix]})}}function Mt(u,t){var e;const i=(b(e=class extends zt{toObject(){return{type:this.type,colorsOnly:this.colorsOnly}}},"type",u),b(e,"defaults",{colorsOnly:!1,matrix:t}),e);return N.setClass(i,u),i}b(zt,"type","ColorMatrix"),b(zt,"defaults",ro),b(zt,"uniformLocations",["uColorMatrix","uConstants"]),N.setClass(zt);Mt("Brownie",[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0]);Mt("Vintage",[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0]);Mt("Kodachrome",[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0]);Mt("Technicolor",[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0]);Mt("Polaroid",[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0]);Mt("Sepia",[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0]);Mt("BlackWhite",[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]);class en extends we{constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(t),this.subFilters=t.subFilters||[]}applyTo(t){vr(t)&&(t.passes+=this.subFilters.length-1),this.subFilters.forEach((e=>{e.applyTo(t)}))}toObject(){return{type:this.type,subFilters:this.subFilters.map((t=>t.toObject()))}}isNeutralState(){return!this.subFilters.some((t=>!t.isNeutralState()))}static fromObject(t,e){return Promise.all((t.subFilters||[]).map((i=>N.getClass(i.type).fromObject(i,e)))).then((i=>new this({subFilters:i})))}}b(en,"type","Composed"),N.setClass(en);class Mi extends we{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uContrast;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
    color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
    gl_FragColor = color;
  }`}isNeutralState(){return this.contrast===0}applyTo2d(t){let{imageData:{data:e}}=t;const i=Math.floor(255*this.contrast),r=259*(i+255)/(255*(259-i));for(let s=0;s<e.length;s+=4)e[s]=r*(e[s]-128)+128,e[s+1]=r*(e[s+1]-128)+128,e[s+2]=r*(e[s+2]-128)+128}sendUniformData(t,e){t.uniform1f(e.uContrast,this.contrast)}}b(Mi,"type","Contrast"),b(Mi,"defaults",{contrast:0}),b(Mi,"uniformLocations",["uContrast"]),N.setClass(Mi);const Kl={Convolute_3_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[9];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 3.0; h+=1.0) {
        for (float w = 0.0; w < 3.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_3_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[9];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 3.0; h+=1.0) {
        for (float w = 0.0; w < 3.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_5_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[25];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 5.0; h+=1.0) {
        for (float w = 0.0; w < 5.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_5_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[25];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 5.0; h+=1.0) {
        for (float w = 0.0; w < 5.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_7_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[49];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 7.0; h+=1.0) {
        for (float w = 0.0; w < 7.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_7_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[49];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 7.0; h+=1.0) {
        for (float w = 0.0; w < 7.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_9_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[81];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 9.0; h+=1.0) {
        for (float w = 0.0; w < 9.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_9_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[81];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 9.0; h+=1.0) {
        for (float w = 0.0; w < 9.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `};class ki extends we{getCacheKey(){return"".concat(this.type,"_").concat(Math.sqrt(this.matrix.length),"_").concat(this.opaque?1:0)}getFragmentSource(){return Kl[this.getCacheKey()]}applyTo2d(t){const e=t.imageData,i=e.data,r=this.matrix,s=Math.round(Math.sqrt(r.length)),n=Math.floor(s/2),o=e.width,a=e.height,l=t.ctx.createImageData(o,a),h=l.data,c=this.opaque?1:0;let d,g,p,v,w,x,C,P,k,R,A,j,I;for(A=0;A<a;A++)for(R=0;R<o;R++){for(w=4*(A*o+R),d=0,g=0,p=0,v=0,I=0;I<s;I++)for(j=0;j<s;j++)C=A+I-n,x=R+j-n,C<0||C>=a||x<0||x>=o||(P=4*(C*o+x),k=r[I*s+j],d+=i[P]*k,g+=i[P+1]*k,p+=i[P+2]*k,c||(v+=i[P+3]*k));h[w]=d,h[w+1]=g,h[w+2]=p,h[w+3]=c?i[w+3]:v}t.imageData=l}sendUniformData(t,e){t.uniform1fv(e.uMatrix,this.matrix)}toObject(){return E(E({},super.toObject()),{},{opaque:this.opaque,matrix:[...this.matrix]})}}b(ki,"type","Convolute"),b(ki,"defaults",{opaque:!1,matrix:[0,0,0,0,1,0,0,0,0]}),b(ki,"uniformLocations",["uMatrix","uOpaque","uHalfSize","uSize"]),N.setClass(ki);const so="Gamma";class Fi extends we{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform vec3 uGamma;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    vec3 correction = (1.0 / uGamma);
    color.r = pow(color.r, correction.r);
    color.g = pow(color.g, correction.g);
    color.b = pow(color.b, correction.b);
    gl_FragColor = color;
    gl_FragColor.rgb *= color.a;
  }
`}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(t),this.gamma=t.gamma||this.constructor.defaults.gamma.concat()}applyTo2d(t){let{imageData:{data:e}}=t;const i=this.gamma,r=1/i[0],s=1/i[1],n=1/i[2];this.rgbValues||(this.rgbValues={r:new Uint8Array(256),g:new Uint8Array(256),b:new Uint8Array(256)});const o=this.rgbValues;for(let a=0;a<256;a++)o.r[a]=255*Math.pow(a/255,r),o.g[a]=255*Math.pow(a/255,s),o.b[a]=255*Math.pow(a/255,n);for(let a=0;a<e.length;a+=4)e[a]=o.r[e[a]],e[a+1]=o.g[e[a+1]],e[a+2]=o.b[e[a+2]]}sendUniformData(t,e){t.uniform3fv(e.uGamma,this.gamma)}isNeutralState(){const{gamma:t}=this;return t[0]===1&&t[1]===1&&t[2]===1}toObject(){return{type:so,gamma:this.gamma.concat()}}}b(Fi,"type",so),b(Fi,"defaults",{gamma:[1,1,1]}),b(Fi,"uniformLocations",["uGamma"]),N.setClass(Fi);const Jl={average:`
    precision highp float;
    uniform sampler2D uTexture;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      float average = (color.r + color.b + color.g) / 3.0;
      gl_FragColor = vec4(average, average, average, color.a);
    }
    `,lightness:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform int uMode;
    varying vec2 vTexCoord;
    void main() {
      vec4 col = texture2D(uTexture, vTexCoord);
      float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
      gl_FragColor = vec4(average, average, average, col.a);
    }
    `,luminosity:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform int uMode;
    varying vec2 vTexCoord;
    void main() {
      vec4 col = texture2D(uTexture, vTexCoord);
      float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
      gl_FragColor = vec4(average, average, average, col.a);
    }
    `};class Ai extends we{applyTo2d(t){let{imageData:{data:e}}=t;for(let i,r=0;r<e.length;r+=4){const s=e[r],n=e[r+1],o=e[r+2];switch(this.mode){case"average":i=(s+n+o)/3;break;case"lightness":i=(Math.min(s,n,o)+Math.max(s,n,o))/2;break;case"luminosity":i=.21*s+.72*n+.07*o}e[r+2]=e[r+1]=e[r]=i}}getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return Jl[this.mode]}sendUniformData(t,e){t.uniform1i(e.uMode,1)}isNeutralState(){return!1}}b(Ai,"type","Grayscale"),b(Ai,"defaults",{mode:"average"}),b(Ai,"uniformLocations",["uMode"]),N.setClass(Ai);const Ql=E(E({},ro),{},{rotation:0});class kr extends zt{calculateMatrix(){const t=this.rotation*Math.PI,e=ht(t),i=ct(t),r=1/3,s=Math.sqrt(r)*i,n=1-e;this.matrix=[e+n/3,r*n-s,r*n+s,0,0,r*n+s,e+r*n,r*n-s,0,0,r*n-s,r*n+s,e+r*n,0,0,0,0,0,1,0]}isNeutralState(){return this.rotation===0}applyTo(t){this.calculateMatrix(),super.applyTo(t)}toObject(){return{type:this.type,rotation:this.rotation}}}b(kr,"type","HueRotation"),b(kr,"defaults",Ql),N.setClass(kr);class Li extends we{applyTo2d(t){let{imageData:{data:e}}=t;for(let i=0;i<e.length;i+=4)e[i]=255-e[i],e[i+1]=255-e[i+1],e[i+2]=255-e[i+2],this.alpha&&(e[i+3]=255-e[i+3])}getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform int uInvert;
  uniform int uAlpha;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    if (uInvert == 1) {
      if (uAlpha == 1) {
        gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,1.0 -color.a);
      } else {
        gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
      }
    } else {
      gl_FragColor = color;
    }
  }
`}isNeutralState(){return!this.invert}sendUniformData(t,e){t.uniform1i(e.uInvert,Number(this.invert)),t.uniform1i(e.uAlpha,Number(this.alpha))}}b(Li,"type","Invert"),b(Li,"defaults",{alpha:!1,invert:!0}),b(Li,"uniformLocations",["uInvert","uAlpha"]),N.setClass(Li);class Bi extends we{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uStepH;
  uniform float uNoise;
  uniform float uSeed;
  varying vec2 vTexCoord;
  float rand(vec2 co, float seed, float vScale) {
    return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
  }
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
    gl_FragColor = color;
  }
`}applyTo2d(t){let{imageData:{data:e}}=t;const i=this.noise;for(let r=0;r<e.length;r+=4){const s=(.5-Math.random())*i;e[r]+=s,e[r+1]+=s,e[r+2]+=s}}sendUniformData(t,e){t.uniform1f(e.uNoise,this.noise/255),t.uniform1f(e.uSeed,Math.random())}isNeutralState(){return this.noise===0}}b(Bi,"type","Noise"),b(Bi,"defaults",{noise:0}),b(Bi,"uniformLocations",["uNoise","uSeed"]),N.setClass(Bi);class Ii extends we{applyTo2d(t){let{imageData:{data:e,width:i,height:r}}=t;for(let s=0;s<r;s+=this.blocksize)for(let n=0;n<i;n+=this.blocksize){const o=4*s*i+4*n,a=e[o],l=e[o+1],h=e[o+2],c=e[o+3];for(let d=s;d<Math.min(s+this.blocksize,r);d++)for(let g=n;g<Math.min(n+this.blocksize,i);g++){const p=4*d*i+4*g;e[p]=a,e[p+1]=l,e[p+2]=h,e[p+3]=c}}}isNeutralState(){return this.blocksize===1}getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uBlocksize;
  uniform float uStepW;
  uniform float uStepH;
  varying vec2 vTexCoord;
  void main() {
    float blockW = uBlocksize * uStepW;
    float blockH = uBlocksize * uStepH;
    int posX = int(vTexCoord.x / blockW);
    int posY = int(vTexCoord.y / blockH);
    float fposX = float(posX);
    float fposY = float(posY);
    vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
    vec4 color = texture2D(uTexture, squareCoords);
    gl_FragColor = color;
  }
`}sendUniformData(t,e){t.uniform1f(e.uBlocksize,this.blocksize)}}b(Ii,"type","Pixelate"),b(Ii,"defaults",{blocksize:4}),b(Ii,"uniformLocations",["uBlocksize"]),N.setClass(Ii);class Hi extends we{getFragmentSource(){return`
precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
  gl_FragColor = texture2D(uTexture, vTexCoord);
  if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
    gl_FragColor.a = 0.0;
  }
}
`}applyTo2d(t){let{imageData:{data:e}}=t;const i=255*this.distance,r=new le(this.color).getSource(),s=[r[0]-i,r[1]-i,r[2]-i],n=[r[0]+i,r[1]+i,r[2]+i];for(let o=0;o<e.length;o+=4){const a=e[o],l=e[o+1],h=e[o+2];a>s[0]&&l>s[1]&&h>s[2]&&a<n[0]&&l<n[1]&&h<n[2]&&(e[o+3]=0)}}sendUniformData(t,e){const i=new le(this.color).getSource(),r=this.distance,s=[0+i[0]/255-r,0+i[1]/255-r,0+i[2]/255-r,1],n=[i[0]/255+r,i[1]/255+r,i[2]/255+r,1];t.uniform4fv(e.uLow,s),t.uniform4fv(e.uHigh,n)}}b(Hi,"type","RemoveColor"),b(Hi,"defaults",{color:"#FFFFFF",distance:.02,useAlpha:!1}),b(Hi,"uniformLocations",["uLow","uHigh"]),N.setClass(Hi);class ji extends we{sendUniformData(t,e){t.uniform2fv(e.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),t.uniform1fv(e.uTaps,this.taps)}getFilterWindow(){const t=this.tempScale;return Math.ceil(this.lanczosLobes/t)}getCacheKey(){const t=this.getFilterWindow();return"".concat(this.type,"_").concat(t)}getFragmentSource(){const t=this.getFilterWindow();return this.generateShader(t)}getTaps(){const t=this.lanczosCreate(this.lanczosLobes),e=this.tempScale,i=this.getFilterWindow(),r=new Array(i);for(let s=1;s<=i;s++)r[s-1]=t(s*e);return r}generateShader(t){const e=new Array(t);for(let i=1;i<=t;i++)e[i-1]="".concat(i,".0 * uDelta");return`
      precision highp float;
      uniform sampler2D uTexture;
      uniform vec2 uDelta;
      varying vec2 vTexCoord;
      uniform float uTaps[`.concat(t,`];
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        float sum = 1.0;
        `).concat(e.map(((i,r)=>`
              color += texture2D(uTexture, vTexCoord + `.concat(i,") * uTaps[").concat(r,"] + texture2D(uTexture, vTexCoord - ").concat(i,") * uTaps[").concat(r,`];
              sum += 2.0 * uTaps[`).concat(r,`];
            `))).join(`
`),`
        gl_FragColor = color / sum;
      }
    `)}applyToForWebgl(t){t.passes++,this.width=t.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=t.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),t.destinationWidth=this.dW,super.applyTo(t),t.sourceWidth=t.destinationWidth,this.height=t.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),t.destinationHeight=this.dH,super.applyTo(t),t.sourceHeight=t.destinationHeight}applyTo(t){vr(t)?this.applyToForWebgl(t):this.applyTo2d(t)}isNeutralState(){return this.scaleX===1&&this.scaleY===1}lanczosCreate(t){return e=>{if(e>=t||e<=-t)return 0;if(e<11920929e-14&&e>-11920929e-14)return 1;const i=(e*=Math.PI)/t;return Math.sin(e)/e*Math.sin(i)/i}}applyTo2d(t){const e=t.imageData,i=this.scaleX,r=this.scaleY;this.rcpScaleX=1/i,this.rcpScaleY=1/r;const s=e.width,n=e.height,o=Math.round(s*i),a=Math.round(n*r);let l;l=this.resizeType==="sliceHack"?this.sliceByTwo(t,s,n,o,a):this.resizeType==="hermite"?this.hermiteFastResize(t,s,n,o,a):this.resizeType==="bilinear"?this.bilinearFiltering(t,s,n,o,a):this.resizeType==="lanczos"?this.lanczosResize(t,s,n,o,a):new ImageData(o,a),t.imageData=l}sliceByTwo(t,e,i,r,s){const n=t.imageData,o=.5;let a=!1,l=!1,h=e*o,c=i*o;const d=t.filterBackend.resources;let g=0,p=0;const v=e;let w=0;d.sliceByTwo||(d.sliceByTwo=ut());const x=d.sliceByTwo;(x.width<1.5*e||x.height<i)&&(x.width=1.5*e,x.height=i);const C=x.getContext("2d");for(C.clearRect(0,0,1.5*e,i),C.putImageData(n,0,0),r=Math.floor(r),s=Math.floor(s);!a||!l;)e=h,i=c,r<Math.floor(h*o)?h=Math.floor(h*o):(h=r,a=!0),s<Math.floor(c*o)?c=Math.floor(c*o):(c=s,l=!0),C.drawImage(x,g,p,e,i,v,w,h,c),g=v,p=w,w+=c;return C.getImageData(g,p,r,s)}lanczosResize(t,e,i,r,s){const n=t.imageData.data,o=t.ctx.createImageData(r,s),a=o.data,l=this.lanczosCreate(this.lanczosLobes),h=this.rcpScaleX,c=this.rcpScaleY,d=2/this.rcpScaleX,g=2/this.rcpScaleY,p=Math.ceil(h*this.lanczosLobes/2),v=Math.ceil(c*this.lanczosLobes/2),w={},x={x:0,y:0},C={x:0,y:0};return(function P(k){let R,A,j,I,W,$,Z,z,V,Y,ie;for(x.x=(k+.5)*h,C.x=Math.floor(x.x),R=0;R<s;R++){for(x.y=(R+.5)*c,C.y=Math.floor(x.y),W=0,$=0,Z=0,z=0,V=0,A=C.x-p;A<=C.x+p;A++)if(!(A<0||A>=e)){Y=Math.floor(1e3*Math.abs(A-x.x)),w[Y]||(w[Y]={});for(let te=C.y-v;te<=C.y+v;te++)te<0||te>=i||(ie=Math.floor(1e3*Math.abs(te-x.y)),w[Y][ie]||(w[Y][ie]=l(Math.sqrt(Math.pow(Y*d,2)+Math.pow(ie*g,2))/1e3)),j=w[Y][ie],j>0&&(I=4*(te*e+A),W+=j,$+=j*n[I],Z+=j*n[I+1],z+=j*n[I+2],V+=j*n[I+3]))}I=4*(R*r+k),a[I]=$/W,a[I+1]=Z/W,a[I+2]=z/W,a[I+3]=V/W}return++k<r?P(k):o})(0)}bilinearFiltering(t,e,i,r,s){let n,o,a,l,h,c,d,g,p,v,w,x,C,P=0;const k=this.rcpScaleX,R=this.rcpScaleY,A=4*(e-1),j=t.imageData.data,I=t.ctx.createImageData(r,s),W=I.data;for(d=0;d<s;d++)for(g=0;g<r;g++)for(h=Math.floor(k*g),c=Math.floor(R*d),p=k*g-h,v=R*d-c,C=4*(c*e+h),w=0;w<4;w++)n=j[C+w],o=j[C+4+w],a=j[C+A+w],l=j[C+A+4+w],x=n*(1-p)*(1-v)+o*p*(1-v)+a*v*(1-p)+l*p*v,W[P++]=x;return I}hermiteFastResize(t,e,i,r,s){const n=this.rcpScaleX,o=this.rcpScaleY,a=Math.ceil(n/2),l=Math.ceil(o/2),h=t.imageData.data,c=t.ctx.createImageData(r,s),d=c.data;for(let g=0;g<s;g++)for(let p=0;p<r;p++){const v=4*(p+g*r);let w=0,x=0,C=0,P=0,k=0,R=0,A=0;const j=(g+.5)*o;for(let I=Math.floor(g*o);I<(g+1)*o;I++){const W=Math.abs(j-(I+.5))/l,$=(p+.5)*n,Z=W*W;for(let z=Math.floor(p*n);z<(p+1)*n;z++){let V=Math.abs($-(z+.5))/a;const Y=Math.sqrt(Z+V*V);Y>1&&Y<-1||(w=2*Y*Y*Y-3*Y*Y+1,w>0&&(V=4*(z+I*e),A+=w*h[V+3],C+=w,h[V+3]<255&&(w=w*h[V+3]/250),P+=w*h[V],k+=w*h[V+1],R+=w*h[V+2],x+=w))}}d[v]=P/x,d[v+1]=k/x,d[v+2]=R/x,d[v+3]=A/C}return c}}b(ji,"type","Resize"),b(ji,"defaults",{resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3}),b(ji,"uniformLocations",["uDelta","uTaps"]),N.setClass(ji);class zi extends we{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uSaturation;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float rgMax = max(color.r, color.g);
    float rgbMax = max(rgMax, color.b);
    color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
    color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
    color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
    gl_FragColor = color;
  }
`}applyTo2d(t){let{imageData:{data:e}}=t;const i=-this.saturation;for(let r=0;r<e.length;r+=4){const s=e[r],n=e[r+1],o=e[r+2],a=Math.max(s,n,o);e[r]+=a!==s?(a-s)*i:0,e[r+1]+=a!==n?(a-n)*i:0,e[r+2]+=a!==o?(a-o)*i:0}}sendUniformData(t,e){t.uniform1f(e.uSaturation,-this.saturation)}isNeutralState(){return this.saturation===0}}b(zi,"type","Saturation"),b(zi,"defaults",{saturation:0}),b(zi,"uniformLocations",["uSaturation"]),N.setClass(zi);class Ni extends we{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uVibrance;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float max = max(color.r, max(color.g, color.b));
    float avg = (color.r + color.g + color.b) / 3.0;
    float amt = (abs(max - avg) * 2.0) * uVibrance;
    color.r += max != color.r ? (max - color.r) * amt : 0.00;
    color.g += max != color.g ? (max - color.g) * amt : 0.00;
    color.b += max != color.b ? (max - color.b) * amt : 0.00;
    gl_FragColor = color;
  }
`}applyTo2d(t){let{imageData:{data:e}}=t;const i=-this.vibrance;for(let r=0;r<e.length;r+=4){const s=e[r],n=e[r+1],o=e[r+2],a=Math.max(s,n,o),l=(s+n+o)/3,h=2*Math.abs(a-l)/255*i;e[r]+=a!==s?(a-s)*h:0,e[r+1]+=a!==n?(a-n)*h:0,e[r+2]+=a!==o?(a-o)*h:0}}sendUniformData(t,e){t.uniform1f(e.uVibrance,-this.vibrance)}isNeutralState(){return this.vibrance===0}}b(Ni,"type","Vibrance"),b(Ni,"defaults",{vibrance:0}),b(Ni,"uniformLocations",["uVibrance"]),N.setClass(Ni);class $l{viewer(){return this._viewer}canvas(){return this._canvas}fabricCanvas(){return this._fabricCanvas}clearFabric(){this._fabricCanvas.clear()}renderAllFabric(){this._fabricCanvas.renderAll()}resizeCanvas(){this._containerWidth!==this._viewer.container.clientWidth&&(this._containerWidth=this._viewer.container.clientWidth,this._canvasDiv.setAttribute("width",String(this._containerWidth)),this._canvas.setAttribute("width",String(this._containerWidth))),this._containerHeight!==this._viewer.container.clientHeight&&(this._containerHeight=this._viewer.container.clientHeight,this._canvasDiv.setAttribute("height",String(this._containerHeight)),this._canvas.setAttribute("height",String(this._containerHeight)))}resizeFabric(){let t=new qi.Point(0,0),e=this._viewer.viewport.getZoom(!0),i=this._viewer.viewport.viewportToImageZoom(e);this._fabricCanvas.setWidth(this._containerWidth),this._fabricCanvas.setHeight(this._containerHeight),this._fabricCanvas.setZoom(e),this._fabricCanvas.setZoom(i);let r=this._viewer.viewport.viewportToWindowCoordinates(t),s=Math.round(r.x),n=Math.round(r.y),o=this._canvasDiv.getBoundingClientRect(),a=qi.getPageScroll();this._fabricCanvas.absolutePan(new O(o.left-s+a.x,o.top-n+a.y))}clearFabricSelection(){this._fabricCanvas.isDrawingMode?(this._fabricCanvas.isDrawingMode=!1,this._fabricCanvas.clearContext(this._fabricCanvas.getContext())):this._fabricCanvas.discardActiveObject(),this._fabricCanvas.requestRenderAll()}setViewerMouseNavEnabled(t=!0){this._viewer&&this._viewer.setMouseNavEnabled(t)}updateCanvasRotation(t){t<0||t>360||this._viewer.world.getItemAt(0).setRotation(t,!0)}constructor(t,{fabricCanvasOptions:e={selection:!1}},i){let r=this;this._viewer=t,this._containerWidth=0,this._containerHeight=0,this._canvasDiv=document.createElement("div"),this._canvasDiv.style.position="absolute",this._canvasDiv.style.left="0px",this._canvasDiv.style.top="0px",this._canvasDiv.style.width="100%",this._canvasDiv.style.height="100%",this._viewer.canvas.appendChild(this._canvasDiv),this._canvas=document.createElement("canvas"),this._id="osd-canvas-"+i,this._canvas.setAttribute("id",this._id),this._canvasDiv.appendChild(this._canvas),this.resizeCanvas(),this._fabricCanvas=new or(this._canvas,e),this._fabricCanvas.on("mouse:down",function(s){s.target&&(s.e.preventDefault(),s.e.stopPropagation())}),this._fabricCanvas.on("mouse:up",function(s){s.target&&(s.e.preventDefault(),s.e.stopPropagation())}),this._viewer.addHandler("update-viewport",function(){r.resizeFabric(),r.resizeCanvas(),r.renderAllFabric()}),this._viewer.addHandler("open",function(){r.resizeFabric(),r.resizeCanvas()}),window.addEventListener("resize",function(){r.resizeFabric(),r.resizeCanvas()})}}const eh=()=>qi?or?!0:(console.error("[fabric-js] requires FabricJS"),console.error("Please import FabricJS before importing this package"),!1):(console.error("[openseadragon-canvas-overlay] requires OpenSeadragon"),!1);function th(u,t,e){if(!eh())throw new Error("[openseadragon-fabric-overlay] required plugins are not installed");return new $l(u,t,e)}const no=qi({id:"openseadragon",prefixUrl:"https://openseadragon.github.io/openseadragon/images/",tileSources:"https://openseadragon.github.io/example-images/highsmith/highsmith.dzi"}),ih=th(no,{fabricCanvasOptions:{selection:!1}},"1");no.addHandler("open",()=>{const u=new Xe({width:500,height:300,top:600,left:600,fill:"rgba(0, 128, 255, 0.5)",stroke:"blue",strokeWidth:4});ih.fabricCanvas().add(u)});
